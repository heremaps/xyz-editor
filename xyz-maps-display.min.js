/*
 * @here/xyz-maps-display
 * (c) 2019-2021 HERE
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@here/xyz-maps-common"),require("@here/xyz-maps-core")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common","@here/xyz-maps-core"],e):e(((t=t||self).here=t.here||{},t.here.xyz=t.here.xyz||{},t.here.xyz.maps=t.here.xyz.maps||{},t.here.xyz.maps.Map=t.here.xyz.maps.Map||{}),t.here.xyz.maps.common,t.here.xyz.maps)}(this,function(t,X,A){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var v=function(){return(v=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function i(t,a,s,l){return new(s=s||Promise)(function(i,e){function n(t){try{o(l.next(t))}catch(t){e(t)}}function r(t){try{o(l.throw(t))}catch(t){e(t)}}function o(t){var e;t.done?i(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(n,r)}o((l=l.apply(t,a||[])).next())})}function s(i,n){var r,o,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,o&&(a=2&e[0]?o.return:e[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,e[1])).done)return a;switch(o=0,(e=a?[2&e[0],a.value]:e)[0]){case 0:case 1:a=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,o=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!a||e[1]>a[0]&&e[1]<a[3])){s.label=e[1];break}if(6===e[0]&&s.label<a[1]){s.label=a[1],a=e;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(e);break}a[2]&&s.ops.pop(),s.trys.pop();continue}e=n.call(i,s)}catch(t){e=[6,t],o=0}finally{r=a=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function G(e,t,i,n){("string"==typeof t?[t]:t).forEach(function(t){e.addEventListener(t,i,n)})}function Z(e,t,i,n){("string"==typeof t?[t]:t).forEach(function(t){e.removeEventListener(t,i,n)})}var f=function(t,e){return Math.round(parseFloat((i=e,n=(t=(e=t).ownerDocument.defaultView.getComputedStyle(e,null))&&""===(n=t.getPropertyValue(i))?e.style[i]:n)))||0;var i,n},u=function(t,e,i,n,r){var o,a,s,l=document.createElement("canvas"),h=l.style;return o=i,(i=l).setAttribute("width",e),i.setAttribute("height",o),l.setAttribute("oncontextmenu","return false;"),a=l,s="none",["-webkit-user-select","-moz-user-select","-ms-user-select","user-select"].forEach(function(t){a.style[t]=s}),h.top=h.left="0px",h.position="absolute",1!=r&&(h.opacity=String(r)),t.querySelectorAll("canvas[type=layer]"),l.setAttribute("type","layer"),(n=t.querySelectorAll("canvas")[n])?t.insertBefore(l,n):t.appendChild(l),l},x=function(t,e,i,n){this.lrTs=!1,this.x=t,this.y=e,this.size=i,this.tile=n},r=(o.prototype.getZ=function(t){var e=this.z;if(this.zd){var i,n=0;for(i in e)e[i]=n++;this.zLength=n,this.zd=!1,this.z3d=e[this._z3d]}return e[t]||0},o.prototype.getAbsoluteZ=function(t){for(var e=this.index,i=this.layers,n=0,r=0;n<e;)r+=i[n++].zLength;return null!=t&&(r+=this.getZ(t)),r},o.prototype.addZ=function(t,e){var i=this.z;null==i[t]&&(i[t]=0,this.zd=!0,e&&t<this._z3d&&(this._z3d=t))},o.prototype.getZ3d=function(){for(var t,e=this.layers,i=0,n=0;t=e[i++];){if(0<=t._z3d)return n+t.z3d;n+=t.zLength}return n},o);function o(t,e){this.ready=!1,this.cnt=0,this.z={},this.zLength=0,this.zd=!1,this._z3d=1/0,this.layer=t,this.tileSize=t.tileSize,this.layers=e,this.id=Math.floor(1e16*Math.random())}var a,c=(e(l,a=Array),l.prototype.indexOf=function(t){t=this._map[t.id];return a.prototype.indexOf.call(this,t)},l.prototype.fixZ=function(){for(var t=0;t<this.length;t++)this[t].index=t},l.prototype.add=function(t,e){var i=t.id,n=this._map[i],n=n?(this.splice(a.prototype.indexOf.call(this,n),1),this.splice(e,0,n),!1):(n=this._map[i]=new r(t,this),this.splice(e,0,n),!0);return this.fixZ(),n},l.prototype.remove=function(t){var e=this.indexOf(t);return-1!==e&&(this.splice(e,1),delete this._map[t.id],this.fixZ()),e},l.prototype.get=function(t){return"string"!=typeof t&&(t=t.id),this._map[t]},l.prototype.reset=function(t){for(var e=new Set,i=0;i<this.length;i++){var n=this[i],r=n.layer;n.error=!1,n.cnt=0,n.tiles=[],(n.visible=t>=r.min&&t<=r.max)?(n.ready=!1,e.add(r.tileSize)):n.ready=!0}return Array.from(e)},l);function l(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var i=a.apply(this,t)||this;return i._map={},Object.setPrototypeOf(i,l.prototype),i}var p=(h.prototype.forEachTile=function(t,e){t.getProvider().getCachedTilesOfBBox(t.getBBox()).forEach(e)},h.prototype.remove=function(t,e,i){for(var n=0,r=e;n<r.length;n++){var o=r[n];this.removeFromTile(t,o,i)}},h.prototype.modifyInTile=function(t,e,i,n){var r=this.isVertexDataInitialized(e);return!!r&&(this.display.updateTile(e,r,n,t),!0)},h.prototype.isVertexDataInitialized=function(t){return this.display.getBucket(t.quadkey)},h.prototype.addToTile=function(t,e,i){var n=this.isVertexDataInitialized(e);n&&this.display.updateTile(e,n,i,t)},h.prototype.removeFromTile=function(t,e,i){var n=this.isVertexDataInitialized(e);n&&this.display.updateTile(e,n,i,t)},h.prototype.add=function(t,e,i){for(var n=0,r=e;n<r.length;n++){var o=r[n];this.addToTile(t,o,i)}},h.prototype.updateGeometry=function(t,e,i,n){for(var r=n.getProvider(),o=r.getCachedTilesOfBBox(e),a=r.getCachedTilesOfBBox(t.getBBox()),s=0,l=a.length;s<l;s++){var h=o.indexOf(a[s]);-1===h?this.addToTile(t,a[s],n):(this.modifyInTile(t,a[s],i,n),o.splice(h,1))}for(s=0,l=o.length;s<l;s++)this.removeFromTile(t,o[s],n),this.removeFromTile(t,o[s],n)},h.prototype.repaint=function(i,t,n){var r=this;r.forEachTile(i,function(t){var e=r.isVertexDataInitialized(t);e?r.display.updateTile(t,e,n,i):t.preview&&(t.preview=void 0)})},h.prototype.clear=function(e,i){i=i||[];var t=this.display,n=t.layers.indexOf(e);t.buckets.forEach(function(t){i.length&&!function(t,e){for(var i,n,r=t.length,o=0;o<e.length;o++)if(n=t,i=e[o],r>e[o].length&&(i=t,n=e[o]),0===i.search(n))return!0}(t.quadkey,i)||(t.clear(n),t.ready(n,!1),t.cancelTasks(e),t.luTs=null)}),t.update()},h);function h(t,e){this.display=t,this.render=e}var y=[],d=(g.prototype.lookUp=function(t,e,i,n,r,o){var a=t.quadkey,t=i-n,i=Number(a[t]);if(o.x+=i%2*e/2,o.y+=Number(1<i)*e/2,t=a.substring(0,t),this.hasData(t,r)){r=e/Math.pow(2,n);return this.add(n=[],t,o.x,o.y,r,0,0,e),n}o.x/=2,o.y/=2},g.prototype.add=function(t,e,i,n,r,o,a,s){t.push([e,i,n,r,r,0^o,0^a,s,s])},g.prototype.hasData=function(t,e){t=this.display.buckets.get(t,!0);if(t)return t.ready(e)&&t.getData(e)},g.prototype.lookDown=function(t,e,i,n,r){for(var o,a,s,l=A.tileUtils.getTilesOfLevel(t.quadkey,i+n),h=0;h<l.length;h++)for(var u=o=0,c=e,f=0;f<n;f++)u+=(a=l[h][i+f])%2*(c/=2),o+=Number(1<a)*c,f==n-1&&this.hasData(l[h],r)&&this.add(s=s||[],l[h],0,0,e,u,o,c);return s},g.prototype.create=function(t,e,i,n){for(var r,o=t.quadkey.length,a=e.min,s=e.max,l=s-o,h=o-a,u={x:0,y:0},c=0,f=e.tileSize,p=(i=l<(i=i||this.down)?l:i)<(n=h<(n=n||this.up)?h:n)?n:i,d=t.index(e);c++<p;){if(a<=o-c&&(r=this.lookUp(t,f,o,c,d,u)))return r;if(o+c<=s&&c<i&&(r=this.lookDown(t,f,o,c,d)))return r}return y},g);function g(t,e){this.display=t,"number"==typeof e?(this.down=e,this.up=e):(this.down=e[0],this.up=e[1])}function m(t,e,i,n){t.font=e.font||xt,"number"==typeof e.strokeWidth?t.lineWidth=e.strokeWidth:t.lineWidth=1,t.strokeStyle=n,t.fillStyle=i,t.textAlign=e.textAlign||"start",t.lineCap="round",t.lineJoin="round"}function _(t,e,i,n,r){var o=r.fill,a=r.stroke,r=r.strokeWidth;a&&0!=r&&t.strokeText(e,i,n),o&&t.fillText(e,i,n)}function w(t,e,i,n,r){n=n||128,r=r||128,t.fillStyle="#000",t.fillRect(0,0,n,r),m(t,e,"#fff","#fff"),_(t,i,0,0,e);for(var o=t.getImageData(0,0,n,r).data,a=-1,s=-1,l=0;l<r;l++)for(var h=0;h<n;h++){if(0!=o[4*(l*n+h)]){-1==a&&(a=l);break}if(h==n-1&&-1!==a){s=l,l=r;break}}return t.clearRect(0,0,n,r),{height:s-a,min:a,max:s}}function b(t){var e=(t=void 0===t?{}:t).font,i=t.strokeWidth,i=(e=e||xt)+(i=i||0);return C[i]||(M.font=e,M.textBaseline="top",C[i]={width:M.measureText(z).width/E,height:w(M,t,"gM").height}),C[i]}function T(t,e){if(!1===e)return[t];null!=e&&!0!==e||(e=14);for(var i,n=[],r=0,o=-1,a=0,s=void 0,l=void 0,h=t.length;a<h;a++)l=a-r," "==(i=t.charAt(a))?o=a:"\n"==i&&(l=1/0,o=a),e<=l&&r<=o&&(s=t.substring(r,o),r=o+1,n.push(s)),a==h-1&&r<=a&&(s=t.substring(r,a+1),n.push(s));return n}function L(t){return t.length<5?[parseInt(""+t[1]+t[1],16)/255,parseInt(""+t[2]+t[2],16)/255,parseInt(""+t[3]+t[3],16)/255,1]:[parseInt(t.slice(1,3),16)/255,parseInt(t.slice(3,5),16)/255,parseInt(t.slice(5,7),16)/255,1]}var S,M=document.createElement("canvas").getContext("2d"),z="abcdefghijklmnopqrstuvwxyz",E=(z="abcdefghijklmnopqrstuvwxyz"+"abcdefghijklmnopqrstuvwxyz".toUpperCase()+" 0123456789").length,C={},xt="normal 12px Arial",I={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgrey:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",grey:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightslategrey:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(S in I)I[S]=L("#"+I[S]);function _t(t){var e;return t&&(Array.isArray(t)?3==(e=t).length&&(e[3]=1):e="#"==t[0]?L(t):(e=I[t])?e.slice():function(t){t=t.match(/^rgba?\s*\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*(?:\.\d+)?))?\)$/);return t&&3<t.length&&[t[1]/255,t[2]/255,t[3]/255,null==t[4]?1:Number(t[4])]}(t)),e}function P(t,e,i,n,r){var o=Math.sin(r);return[(r=Math.cos(r))*(t=t-i)-o*(e=e-n)+i,o*t+r*e+n]}function O(t,e,i,n,r){var o=(n=void 0===n?0:n)-(e*=.5),a=n+e,s=(r=void 0===r?0:r)-(i*=.5),l=r+i,e=P(o,s,n,r,t),i=P(a,l,n,r,t),l=P(o,l,n,r,t),t=P(a,s,n,r,t);return[Math.min(e[0],i[0],l[0],t[0]),Math.min(e[1],i[1],l[1],t[1]),Math.max(e[0],i[0],l[0],t[0]),Math.max(e[1],i[1],l[1],t[1])]}function U(t,e,i,n,r,o){return i<t&&t<r&&n<e&&e<o}function H(t,e,i,n){return i=t-i,n=e-n,Math.sqrt(i*i+n*n)}function k(t){return 47<t&&t<58}var D,R=(N.getInstance=function(){return this.instance=this.instance||new N},N.prototype.getFontId=function(t,e){return""+(t.font||"normal 12px Arial")+(t.strokeWidth||1)+e},N.prototype.initFont=function(t,e){var i,n,r,o,a,s,l,h,u,c=this.fonts,f=this.getFontId(t,e=void 0===e?1:e);return c[f]||(h=l=i=96*e,(u=document.createElement("canvas")).width=l,u.height=h,(r=(n=u).getContext("2d")).textBaseline="bottom",o=w(r,t,"gM").height,r.textBaseline="top",a=w(r,t,"gM").height,m(r,t,"#fff","#000"),r.setTransform(e,0,0,e,0,0),s=r.lineWidth,l=Math.floor(s),u=a+2*(h=Math.floor(s)),c[f]={name:f,size:0,glyphs:new Map,paddingX:l,paddingY:h,canvas:n,ctx:r,width:i,offsetX:2*s*e,scale:e,style:t,charWidthCache:new Map,rowHeight:u*e,letterHeightBottom:o,letterHeight:a,spaceWidth:r.measureText(" ").width*e,baselineOffset:e*((a-o)/2+h)}),c[f]},N.prototype.hasGlyph=function(t,e){return e.glyphs.has(t)},N.prototype.getGlyph=function(t,e){var i,n,r,o,a,s=e.glyphs.get(t);return s||(r=e.canvas.width,i=e.offsetX,o=e.scale,e.ctx.clearRect(0,0,r,r),_(e.ctx,t,e.paddingX,e.paddingY,e.style),null==(n=e.charWidthCache.get(t))?n=e.ctx.measureText(t).width:e.charWidthCache.delete(t),a=Math.round((n||0)+2*e.paddingX)*o,s={char:t,width:n,data:r=e.ctx.getImageData(0,0,a,e.rowHeight),direction:(o=t.charCodeAt(0),32<=(a=o)&&a<=47||58<=a&&a<=64||91<=a&&a<=96||123<=a&&a<=126||k(o)?0:1424<=(o=o)&&o<=1791||1872<=o&&o<=1919||2208<=o&&o<=2303||64336<=o&&o<=65023||65136<=o&&o<=65279?-1:1),advanceX:n?r.width-i:0},e.glyphs.set(t,s),e.size++),s},N.prototype.getTextWidth=function(t,e){for(var i=e.ctx,n=0,r=0,o=t;r<o.length;r++){var a=o[r],s=e.glyphs.get(a);s?n+=s.width:(null==(s=e.charWidthCache.get(a))&&(s=i.measureText(a).width,e.charWidthCache.set(a,s)),n+=s)}return n},N);function N(){this.fonts={}}function F(t){return 0^Math.min(t,20)}function wt(t,e,i){var n=Lt("text",t,e,i);if(!n&&t.textRef&&((n=at.get(t.textRef))==tt&&(n=new Function("f","return f."+t.textRef),at.set(t.textRef,n)),n=n(e,i)),""!=n)return n=n!==tt&&"string"!=typeof n?String(n):n}function bt(t,e){void 0===e&&(e=!1);var i="px",n=t;return"string"==typeof t&&(n=parseFloat(t)||0,"m"==t.charAt(t.length-1))?(i="m",[n=Math.round(10*n)/10,i]):(e||(n^=0),[n,i])}function B(t,e,i,n){return e=Lt(t,e,i,n),i=bt(e),e=i[0],"m"==i[1]&&(i=F(n),e=Math.pow(2,n%i)*nt(e,i)),e}function W(t,e,i,n){var r=Lt("zIndex",t,e,i);return 1e6*(i="number"!=typeof(i=Lt("zLayer",t,e,i))?n+1:i)+r}function Y(t,e,i,n){for(var r=0,o=F(i),a=0,s=t;a<s.length;a++){var l=s[a],l=W(l,e,o,n);r<l&&(r=l)}return r}function j(t,e,i,n){for(var r=0,o=0,a=F(i),s=0;s<t.length;s++){var l=t[s],h=W(l,e,a,n);o<h&&(o=h);h=Lt("strokeWidth",l,e,a);isNaN(h)&&(h=1);l=bt(h,!0),h=l[0];r<(h="m"==l[1]?Math.pow(2,i%a)*nt(h,a):h)&&(r=h)}return[r,o]}function Tt(t,e,i,n,r,o){var a=F(i),s=Lt("type",t,e,a);r=r||[1/0,1/0,-1/0,-1/0];var l=Lt("fill",t,e,a),i=!o&&Lt("stroke",t,e,a);if("Image"!=s&&!l&&!i)return null;if("Text"==s){o=wt(t,e,a);if(!o)return null;var h=Lt("strokeWidth",t,e,a),u=Lt("font",t,e,a),c=it.initFont({font:u,strokeWidth:h,fill:l,stroke:i},n),u=void 0,f=0;if("LineString"==e.geometry.type||"MultiLineString"==e.geometry.type)f=it.getTextWidth(o,c),x=c.letterHeight;else{for(var n=Lt("lineWrap",t,e,a),p=0,d=u=T(o,n);p<d.length;p++){var v=d[p],v=it.getTextWidth(v,c);f<v&&(f=v)}x=u.length*c.letterHeight}}else{h=Lt("strokeWidth",t,e,a);isNaN(h)&&(h=1),x="Circle"==s?f=2*B("radius",t,e,a)^0:(f=0^B("width",t,e,a),0^((x=B("height",t,e,a))||f)),x+=h,f+=h}var y,g,m,x,u=0^Lt("offsetX",t,e,a),h=0^Lt("offsetY",t,e,a),a="Circle"!=s&&0^Lt("rotation",t,e,a);return x=a?(y=(a=O(a,f,x,u,h))[0],g=a[1],m=a[2],a[3]):(m=(y=u-.5*f)+f,(g=h-.5*x)+x),y<r[0]&&(r[0]=y),m>r[2]&&(r[2]=m),g<r[1]&&(r[1]=g),x>r[3]&&(r[3]=x),r}function q(t,e,i,n,r){for(var o=F(i),a=0,s=0,l=t;s<l.length;s++){var h=l[s],u=Tt(h,e,i,n,u,!0)||u;a<(h=W(h,e,o,r))&&(a=h)}if(u)return u[4]=a,u}function V(t,e,i,n,r){return i=i,n=n,t=st((r-t)/(e-t)),i*(1-t)+n*t}function K(t,e){for(var i=1;i<=20;i++)t[i]=function(t,e){var i,n,r,o,a=0;for(o in t){var s=Number(o),l=t[s],h=Array.isArray(l),u=void 0,c=void 0;if(h?u=l:(u=(y=bt(l))[0],c=y[1]),"px"==c&&(l=u),e<=s){if(0==a)return"m"==c?t[s]:u;if(h){for(var f=[],p=0;p<u.length;p++)f[p]=V(r,s,i[p],u[p],e);return f}if(1<s-r){var d=i,v=u,y=c!=n,h="m"==c;return y&&(h?d=rt(i,r):v=rt(v,s)),V(r,s,d,v,e)+(y||h?"m":0)}return l}r=s,i=u,n=c,a++}return l}(e,i);return t}function Q(i){function t(t,e){return i[e]}return t.map=i,t}function J(t){if(!t.__p){t.__p=!0;for(var e=0,i=t;e<i.length;e++){var n,r,o=i[e];for(n in o)n in ot&&("object"!=typeof(r=o[n])||Array.isArray(r)||("stroke"!=n&&"fill"!=n||function(t){for(var e in t)t[e]=_t(t[e])}(r),r=K({},r),o[n]=Q(r)))}}}function $(){return 1}var tt,et,it=R.getInstance(),nt=A.webMercator.meterToPixel,rt=A.webMercator.pixelToMeter,ot={type:1,zIndex:1,fill:1,stroke:1,strokeWidth:1,radius:1,width:1,height:1,font:1,text:1,textRef:1,offsetX:1,offsetY:1,alignment:1,rotation:1,priority:1,repeat:1,collide:1,offset:1,from:1,to:1},at=new Map,Lt=function(t,e,i,n){t=e[t];return"function"==typeof t?t(i,n,e):t},st=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=1),Math.min(i,Math.max(e,t))},lt="*",ht=(ut.prototype.exclusiveRuntime=function(t){this.ms=t},ut.prototype.spawn=function(t,e,i,n,r,o,a,s){a=this.createTask(t,e,i,n,r,o,a);return this.tm.start(a,s),a},ut.prototype.createTask=function(t,i,n,r,o,S,e){var a=[],s=this.ms,l=this.tm.create({time:s,priority:t,init:function(){if(r){for(var t=r.length,e=Date.now();t--;)r[t];l.time=s-(Date.now()-e)}return[n,r,o,0,a,300,i,{}]},name:"cluster",onDone:function(){var t=i.getStyle(),t=t&&(t.strokeWidthZoomScale||t.LineStringZoomScale)||$;a.swzs=t(n.z),e(a,this)},exec:function(t){var e,i,n,r,o,a,s,l,h,u,c,f,p,d,v,y,g=t[0],m=t[1],x=t[2],_=t[6],w=m.length,b=t[4],T=g.z;if(m&&!(t[3]>=w)){for(;t[5]--&&(r=m[t[3]++]);)if(!x[o=r.id]&&(x[o]=!0,i=_.getStyleGroup(r,T)))for(var L=0,A=(i=!i.length?[i]:i).length;L<A;L++)n=i[L],(y=n).type&&y.zIndex!=tt&&(s=Lt("zIndex",n,r,T),a=Lt("type",n,r,T),f=Lt("opacity",n,r,T),y=d=p=v=c=u=l=h=et,"Image"==a?e="I":(l=Lt("fill",n,r,T),u=Lt("stroke",n,r,T),c=Lt("strokeWidth",n,r,T),e="Line"==a?(p=Lt("strokeLinecap",n,r,T),d=Lt("strokeLinejoin",n,r,T),v=Lt("strokeDasharray",n,r,T),"L"+(p||lt)+(d||lt)+(v||lt)):"Text"==a?"T"+((h=Lt("font",n,r,T)||"normal 12px Arial")||lt):"Circle"==a?"C"+Lt("radius",n,r,T)||lt:"R"+(y=Lt("width",n,r,T))+(Lt("height",n,r,T)||y),e+=(u||lt)+(c||lt)+(l||lt)),f!=et&&(e+=100*f^0),((s=(y=b[s]=b[s]||[])[e])==et?(s=y[e]=y.length,y[s]={shared:{font:h,fill:l,opacity:f,stroke:u,strokeWidth:c,strokeLinecap:p,strokeLinejoin:d,strokeDasharray:v},data:new S}):y[s]).data.add(r,n));return t[5]=300,t[3]<w}}});return l},ut);function ut(t,e){this.tm=t,this.ms=e}var ct=(ft.prototype.init=function(t,e,i,n,r){this.cwpx=t[0],this.cwpy=t[1],this.width=i,this.height=n;for(var o=1/0,a=-o,s=1/0,l=-s,h=0,u=this.bounds=r;h<u.length;h++){var c=u[h];c[0]<o&&(o=c[0]),c[0]>a&&(a=c[0]),c[1]<s&&(s=c[1]),c[1]>l&&(l=c[1])}this.minX=o,this.maxX=a,this.minY=s,this.maxY=l},ft.prototype.getTiles=function(t,e){void 0===e&&(e=this.size);for(var i=this.width,n=this.height,r=Math.pow(2,t)*e,o=this.bounds,a=[],s=this.cwpx*r,l=this.cwpy*r,h=s-i/2+this.minX,r=l-n/2+this.minY,i=s+i/2+this.maxX-i,l=l+n/2+this.maxY-n,n=A.tileUtils.pixelToGrid(h/e,r/e,t),t=A.tileUtils.pixelToGrid(i/e,l/e,t),u=t[0]-n[0]+1,c=t[1]-n[1]+1,f=A.tileUtils.getTilesIds(n,t),p=n[0]*e-h+this.minX,d=n[1]*e-r+this.minY,v=0,y=0;v<c;v++)for(var g=0;g<u;g++){var m=p+g*e,x=d+v*e,_=m+e,w=x+e,b=f[y++];!function(t,e){for(var i=0,n=[t,e];i<n.length;i++)for(var r=n[i],o=0;o<r.length;o++){for(var a=D,s=D,l=D,h=D,u=void 0,c=(o+1)%r.length,f=r[o],c=r[c],p=[c[1]-f[1],f[0]-c[0]],d=0,v=t;d<v.length;d++){var y=v[d],u=p[0]*y[0]+p[1]*y[1];(a===D||u<a)&&(a=u),(s===D||s<u)&&(s=u)}for(var g=0,m=e;g<m.length;g++){y=m[g];u=p[0]*y[0]+p[1]*y[1],(l===D||u<l)&&(l=u),(h===D||h<u)&&(h=u)}if(s<l||h<a)return!1}return!0}(o,[[m,x],[_,x],[_,w],[m,w]])||a.push({quadkey:b,x:m,y:x})}return this.tiles[e]=a},ft);function ft(t){this.tiles={},this.size=t}function pt(t,e,i){if(e[t+="EventListener"])for(var n in i)e[t](n,i[n])}var dt=4,vt=(yt.getPixelRatio=function(t){return(t="auto"==t?Math.min(2,X.global.devicePixelRatio||1):t||1)<1?1:t},yt.prototype.addLayer=function(e,t,i){var n,r=this,o=r.layers,a=!1;return o.add(e,i)&&((n=o.get(e)).handleTile=function(t){r.isVisible(t,n)&&r.handleTile(t,e)},pt("add",e,r.listeners),0==i&&r.setLayerBgColor(e.getStyle(),n),r.buckets.forEach(function(t){t.addLayer(i)}),a=!0),a},yt.prototype.removeLayer=function(e){var t=this.layers,i=t.get(e),n=i.tiles,r=t.indexOf(e);if(-1!==r){this.buckets.forEach(function(t){t.cancelTasks(e),t.removeLayer(r)});for(var o=0,a=n;o<a.length;o++){var s=a[o].tile.quadkey;this.releaseTile(s,i),this.cancel(s,e)}t.remove(e),pt("remove",e,this.listeners)}return r},yt.prototype.getBucket=function(t,e){t=e?this.buckets.create(t,this.layers):this.buckets.get(t);return t},yt.prototype.handleTile=function(i,t,e,n){var r,o,a=this,s=!1;e?s=!0:e=a.getBucket(i.quadkey,!0),null==n&&(n=a.layers.indexOf(t)),i.error&&(a.layers[n].error=!0),e.ready(n)||e.busy(t)||(r=i.data)&&(e.ready(n,!(o=function(t,e){i.isLoaded()&&t.ready(t.index(e),!0),a.update(s)})),(n=t.render)?n(i,r,t,e,o):a.prepareTile(i,r,t,e,o))},yt.prototype.setLayerBgColor=function(t,e){t=t.backgroundColor;t&&(e.bgColor=this.render.convertColor(t))},yt.prototype.isVisible=function(t,e){for(var i=t.quadkey,n=0,r=e.tiles;n<r.length;n++)if(r[n].tile.quadkey==i)return!0;return!1},yt.prototype.updateTile=function(t,e,i,n){var r;e&&!e.busy(i)&&(r=e.index(i),e.ready(r,!1),this.isVisible(t,this.layers[r])&&this.handleTile(t,i,e,r))},yt.prototype.setSize=function(t,e){var i=this.dpr,n=this.canvas;this.w=t,this.h=e,n.width=t*i,n.height=e*i,n.style.width=t+"px",n.style.height=e+"px"},yt.prototype.cancel=function(t,e){t=this.buckets.get(t,!0);t&&t.cancelTasks(e)},yt.prototype.preview=function(t,e,i){e=this.previewer.create(t,e);return t.preview(i,e),e},yt.prototype.initVpTiles=function(t,e,s){for(var l=this,h=this.layers,i=l.tiles[s],u=l.tiles[s]=[],n=[],r=0,o=t;r<o.length;r++){var a=o[r],c=a.x,f=a.y,p=a.quadkey,d=l.getBucket(p,!0),f=new x(c,f,s,d);d.i=++this.ti,n.push(f),u.push(f);for(var v=0,y=h;v<y.length;v++){var g=y[v],m=g.layer;(m.tileSize||256)==s&&(g.tiles!=n&&(g.tiles=n),e>=m.min&&e<=m.max&&(l.initTile(d,g),m.getTile(p,g.handleTile)))}}i.forEach(function(t){for(var e=t.tile.quadkey,i=0,n=u;i<n.length;i++)if(n[i].tile.quadkey==e)return;for(var r=0,o=h;r<o.length;r++){var a=o[r];a.layer.tileSize==s&&l.releaseTile(e,a)}l.cancel(e)})},yt.prototype.updateGrid=function(t,e,i,n){this.viewChange=!0,this.sx=i,this.sy=n;var r=this,o=this.rz,a=this.w,s=this.h,l=a,i=s,n=this.grid,i=[r.unproject(0,0),r.unproject(l-1,0),r.unproject(l-1,i-1),r.unproject(0,i-1)];n.init(t,o,a,s,i);for(var i=this.layers.reset(e+Math.log(this.s)/Math.LN2),h=this.ti=0,u=i;h<u.length;h++){var c=u[h],f=r.grid.getTiles(e-Number(512==c),c);this.initVpTiles(f,e,c)}-1==i.indexOf(512)&&r.grid.getTiles(e-1,512),this.dirty=!0,r.update()},yt.prototype.releaseTile=function(t,e){t=e.layer.getCachedTile(t);t&&t.loadStartTs&&(t.isLoaded()||e.layer.cancelTile(t,e.handleTile))},yt.prototype.initTile=function(t,e){var i=e.index;e.visible?t.ready(i)||t.preview(i)||this.preview(t,e.layer,i):t.ready(i,!0)},yt.prototype.update=function(t){var e=this;e.updating||(e.updating=!0,requestAnimationFrame(function(){e.viewport(t),e.updating=!1}))},yt.prototype.setBGColor=function(t){var e=this.render,t=t||X.global.getComputedStyle(this.canvas.parentElement,null).getPropertyValue("background-color"),t=e.convertColor(t=!t||"rgba(0, 0, 0, 0)"==t||"transparent"==t?"#ffffff":t);this.globalBgc=t,e.setBackgroundColor(t)},yt.prototype.showGrid=function(t){this.render.grid(!!t)},yt.prototype.setTransform=function(t,e,i){this.render.setScale(this.s=t,0,0),this.render.setRotation(this.rz=e,this.rx=i),this.render.applyTransform()},yt.prototype.getLayers=function(){return this.layers},yt.prototype.destroy=function(){this.render.destroy();var t=this.canvas;t.parentElement.removeChild(t),t.width=t.height=1},yt.prototype.clearLayer=function(t){var e=this.getLayers().indexOf(t);this.buckets.forEach(function(t){t.preview(e,!1),t.ready(e,!1)})},yt.prototype.viewChangeDone=function(){this.viewChange=!1},yt);function yt(t,e,i,n,r,o){this.updating=!1,this.dirty=!1,this.globalBgc=!1;var a=this,s=f(t,"width"),l=f(t,"height"),t=u(t,s,l,0);a.previewer=new d(a,o),a.cluster=new ht(X.TaskManager.getInstance(),dt),a.grid=new ct(e),a.tiles={256:[],512:[]},a.render=r,a.tileSize=e,a.buckets=n,a.layers=new c,a.w=s,a.h=l,(a.canvas=t).className="tmc",a.dpr=yt.getPixelRatio(i),a.setSize(s,l),a.setBGColor();var h=new p(a,r);a.listeners={clear:function(t){var e=t.detail,t=e.tiles,e=e.layer;h.clear(e,t)},featureAdd:function(t){var e=t.detail,i=e.feature,t=e.tiles,e=e.layer;t&&h.add(i,t,e)},featureRemove:function(t){var e=t.detail,i=e.feature,t=e.tiles,e=e.layer;t&&h.remove(i,t,e)},featureCoordinatesChange:function(t){var e=t.detail,i=e.feature,n=e.prevBBox,t=e.prevCoordinates,e=e.layer;h.updateGeometry(i,n,t,e)},styleGroupChange:function(t){var e=t.detail,i=e.feature,t=e.styleGroup,e=e.layer;h.repaint(i,t,e)},styleChange:function(t){var e=t.detail,t=e.layer,e=e.style,i=a.layers.indexOf(t);a.setLayerBgColor(e,a.layers[i]),a.buckets.tiles.forEach(function(t){return t.clear(i)})}}}var gt=document.createElement("canvas");gt.width=1,gt.height=1;var mt=gt.getContext("2d");function At(){var t,e=this._s;for(t in mt.drawImage(this,0,0),this.ready=!0,e)e[t][0](this,e[t][1])}var St=(Mt.prototype.isRequested=function(t){return!!this.src[t]},Mt.prototype.isReady=function(t){return this.src[t]&&this.src[t].ready},Mt.prototype.get=function(t,e,i,n){var r,o=this.src;return null==o[t]?((r=o[t]=new Image).ready=!1,r._s={},e&&(r._s[i]=[e,n]),r.crossOrigin="Anonymous",r.onload=At,r.src=t):e&&(o[t].ready?e(o[t],n):o[t]._s[i]=[e,n]),o[t]},Mt);function Mt(){this.src={}}var zt=(Et.prototype.bind=function(){var t=this.gl,e=this.texture;e&&t.bindTexture(t.TEXTURE_2D,e)},Et.prototype.set=function(t,e,i){var n=this.gl,r=this.texture,o=this.format,a=t.width,s=t.height,l=o,h="number"==typeof e;r||(this.texture=r=n.createTexture()),n.bindTexture(n.TEXTURE_2D,r),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),h||this.width==a&&!this.height&&!s?n.texSubImage2D(n.TEXTURE_2D,0,e||0,i||0,o,n.UNSIGNED_BYTE,t):(t instanceof HTMLCanvasElement||t instanceof HTMLImageElement?n.texImage2D(n.TEXTURE_2D,0,l,o,n.UNSIGNED_BYTE,t):n.texImage2D(n.TEXTURE_2D,0,l,a,s,0,o,n.UNSIGNED_BYTE,t.pixels),this.width=a,this.height=s),a==s&&0==(s&s-1)?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.generateMipmap(n.TEXTURE_2D)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR))},Et.prototype.destroy=function(){var t=this.gl,e=this.texture;e&&(t.deleteTexture(e),this.texture=null)},Et);function Et(t,e,i){this.gl=t,this.format=i||t.RGBA,e&&this.set(e)}var Ct,It=(e(Pt,Ct=zt),Pt.prototype.destroy=function(t){t&&Ct.prototype.destroy.call(this)},Pt);function Pt(){return null!==Ct&&Ct.apply(this,arguments)||this}var kt=function(t,e,i,n,r){this.i=t,this.u1=e,this.v1=n,this.u2=i,this.v2=r},Dt=(Rt.prototype.get=function(t){return this.c.get(t)},Rt.prototype.init=function(){this.texture,this.gl;var t=this.maxSize,e=this.d;this.texture||(this.texture=new It(this.gl,{width:t=e*t,height:t}))},Rt.prototype.set=function(t,e){var i,n=this.c,r=this.d,o=this.maxSize,a=n.get(t),s=!1;a?i=a.i:((i=n.length)>=n.max&&(i=(a=n.tail.data).i),s=!0);var l=i%r^0,h=i/r^0,u=l*o,c=h*o,f=u+e.width,r=c+e.height;return a?(a.u1=u,a.u2=f,a.v1=c,a.v2=r):a=new kt(i,u,f,c,r),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(this.init(),this.texture.set(e,l*o,h*o)),s&&n.set(t,a),a},Rt.prototype.destroy=function(){var t=this.texture;t&&t.destroy(!0)},Rt);function Rt(t){var e=t.gl,i=t.maxImgSize||256,n=Math.pow(1024/i,2),t=Math.sqrt(n);this.c=new X.LRU(n),this.max=n,this.maxSize=i,this.gl=e,this.d=t}var Ut=(Ot.prototype.getTexture=function(){return this.atlas.texture},Ot.prototype.get=function(e,t,i,n){var r=this.atlas,o=this.images,a=this.onLoad,s=r.get(e);if(!s&&!o.get(e,function(t){s=r.set(e,t),n&&n(s),a&&a(s)}).ready)return!1;return s},Ot.prototype.destroy=function(){this.atlas.destroy()},Ot);function Ot(t,e){this.images=new St,this.atlas=new Dt({gl:t,maxImgSize:64})}function Nt(t,e,i,n){return n=n||Wt,i=t.createShader(i),t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(n("compileShader "+t.getShaderInfoLog(i)),t.deleteShader(i),null)}function Ft(t,e,i){return function(t,e,i){i=i||Wt;for(var n=t.createProgram(),r=0,o=e;r<o.length;r++){var a=o[r];t.attachShader(n,a)}return t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)?n:(i("linkProgram "+t.getProgramInfoLog(n)),t.deleteProgram(n),null)}(t,[Nt(t,e,t.VERTEX_SHADER),Nt(t,i,t.FRAGMENT_SHADER)])}var Bt,Wt=window.console.error,Xt=function(t){for(var e in t)this[e]=t[e]};(ai=Bt=Bt||{})[ai.OPAQUE=0]="OPAQUE",ai[ai.ALPHA=1]="ALPHA",ai[ai.POST_ALPHA=2]="POST_ALPHA";var Gt,Zt=(Ht.prototype.createUniformSetter=function(t,e){var i=this.gl;switch(t.type){case i.FLOAT:return function(t){return i.uniform1f(e,t)};case i.FLOAT_MAT4:return function(t){return i.uniformMatrix4fv(e,!1,t)};case i.FLOAT_VEC2:return function(t){return i.uniform2fv(e,t)};case i.FLOAT_VEC3:return function(t){return i.uniform3fv(e,t)};case i.FLOAT_VEC4:return function(t){return i.uniform4fv(e,t)};case i.BOOL:case i.SAMPLER_2D:return function(t){return i.uniform1i(e,t)}}return function(){}},Ht.prototype.getUniformLocation=function(t){return this.uniforms[t]},Ht.prototype.setUniform=function(t,e){(t=this.uniformSetters[t])&&t(e)},Ht.prototype.initUniforms=function(t){for(var e in t){var i=this.uniformSetters[e];i&&i(t[e])}},Ht.prototype.initAttributes=function(t,e){var i,n,r,o=this.gl;for(r in t)i=t[r],n=this.attributes[r],o.bindBuffer(o.ARRAY_BUFFER,e.get(i)),o.vertexAttribPointer(n,i.size,i.type,i.normalized,i.stride,i.offset),o.enableVertexAttribArray(n)},Ht.prototype.initIndex=function(t,e){var i=this.gl,n=e.get(t),r=!0;n||(n=i.createBuffer(),e.set(t,n),r=!1),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n),r?delete t.data:i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.data,i.STATIC_DRAW)},Ht.prototype.pass=function(t){return t==Bt.OPAQUE},Ht.prototype.draw=function(t,e){var i=this.gl,n=t.index,r=t.texture,o=t.mode||this.mode;r&&(i.activeTexture(i.TEXTURE0),r.bind()),n?(this.initIndex(n,e),i.drawElements(o,n.length,n.type,0)):i.drawArrays(o,t.arrays.first,t.arrays.count)},Ht.prototype.setStates=function(t,e,i,n){var r=this.gl;t?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),n?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e?r.enable(r.BLEND):r.disable(r.BLEND),i?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST)},Ht.prototype.init=function(t,e,i){var n=this.gl,r=e==Bt.OPAQUE,o=this.glStates,a=o.blend,e=o.scissor,o=o.depth;t.scissor!=Gt&&(e=t.scissor),t.blend!=Gt&&(a=t.blend),t.depth!=Gt&&(o=t.depth),this.setStates(e,a,o,i&&!r&&a&&e),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.depthMask(r)},Ht);function Ht(t,e,i,n,r){this.attributes={},this.uniforms={},this.uniformSetters={},this.macros=["#define M_PI 3.1415927410125732"];var r=this.macros.concat("#define DEVICE_PIXEL_RATIO "+r.toFixed(1)+"\n").join("\n"),o=Ft(t,r+"vec2 round(vec2 point){\n    vec2 fractPoint = fract(point);\n    point += step(0.5, fractPoint) - fractPoint;\n    return point;\n}\n\nvec4 snapToScreenPixel(vec4 position, vec2 resolution){\n    resolution *= DEVICE_PIXEL_RATIO;\n    vec2 screenPixel = ((position.xy / position.w + 1.0) / 2.0) * resolution;\n    position.xy = (round(screenPixel) / resolution * 2.0 - 1.0) * position.w;\n    return position;\n}\n"+i,r+n);this.mode=e,this.usage=t.STATIC_DRAW,this.gl=t,this.prog=o,this.glStates=new Xt({scissor:!0,blend:!1,depth:!0});for(var a=t.getProgramParameter(o,t.ACTIVE_ATTRIBUTES),s=0;s<a;++s){var l=t.getActiveAttrib(o,s).name;this.attributes[l]=t.getAttribLocation(o,l)}for(var h=t.getProgramParameter(o,t.ACTIVE_UNIFORMS),u=0;u<h;u++){var c=t.getActiveUniform(o,u),l=c.name,f=t.getUniformLocation(o,l);this.uniforms[l]=f,this.uniformSetters[c.name]=this.createUniformSetter(c,f)}}var Yt,jt=(e(qt,Yt=Zt),qt);function qt(t,e){e=Yt.call(this,t,t.TRIANGLES,"precision lowp float;\n\nattribute highp vec2 a_position;\nuniform float u_scale;\n\nuniform vec4 u_size;\nuniform mat4 u_matrix;\nuniform float u_strokeWidth;\nuniform vec2 u_topLeft;\nuniform float u_rotation;\nuniform vec4 u_offset;\nuniform bool u_alignMap;\nuniform vec2 u_resolution;\n\nvarying vec2 vSize;\nvarying vec2 vDir;\n\nconst float EXTENT_SCALE = 1.0 / 32.0;// 8912->512\n\nfloat toPixel(vec2 size){\n    float pixel = size.x;\n    if (size.y > 0.0){\n        // value is defined in meters -> convert to pixels at current zoom\n        pixel *= u_scale * size.y;\n    }\n    return pixel;\n}\n\nvoid main(void){\n    // LSB defines visibility\n    if (mod(a_position.x, 2.0) == 1.0)\n    {\n        // bit1 is direction/normal vector [-1,+1]\n        vec2 dir = mod(floor(a_position / 2.0), 2.0) * 2.0 - 1.0;\n        vec2 pos = floor(a_position / 4.0) * EXTENT_SCALE;\n        vec2 size = vec2(toPixel(u_size.xy), toPixel(u_size.zw));\n\n        size = (size + u_strokeWidth) * .5;\n\n        float rotation = u_rotation;\n\n        if (!u_alignMap){\n            rotation *= -1.0;\n        }\n\n        float rotSin = sin(rotation);\n        float rotCos = cos(rotation);\n        mat2 mRotate = mat2(rotCos, -rotSin, rotSin, rotCos);\n\n        vec2 pixel_offset = vec2(toPixel(u_offset.xy), toPixel(u_offset.zw));\n\n        if (u_alignMap){\n\n            vec2 shift = (pixel_offset + dir * size * mRotate) / u_scale;\n            gl_Position = u_matrix * vec4(u_topLeft + pos + shift, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4(u_topLeft + pos, 0.0, 1.0);\n            vec2 shift = dir * size * mRotate;\n            vec2 offset = pixel_offset * vec2(1.0, -1.0);\n\n            gl_Position = vec4(cpos.xy / cpos.w + (offset + shift) / u_resolution * 2.0, 0.0, 1.0);\n        }\n\n        vSize = size;\n        vDir = dir;\n\n    }\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\nuniform vec4 u_stroke;\nuniform float u_strokeWidth;\n\nvarying vec2 vSize;\nvarying vec2 vDir;\n\n#define COLOR_UNDEF -1.0\n\nvoid main(void){\n    float dx = distance(vDir.x, 0.0) * vSize.x;\n    float dy = distance(vDir.y, 0.0) * vSize.y;\n\n    if (dx > vSize.x-u_strokeWidth || dy > vSize.y-u_strokeWidth){\n        gl_FragColor = u_stroke;\n    } else {\n        gl_FragColor = u_fill;\n        if(u_fill[0] == COLOR_UNDEF){\n//            discard;\n            gl_FragColor.a = 0.0;\n        };\n\n    }\n}\n",e)||this;return e.name="Rect",e.glStates=new Xt({scissor:!1,blend:!1,depth:!0}),e}var Vt,Kt=(e(Qt,Vt=Zt),Qt);function Qt(t,e){e=Vt.call(this,t,t.TRIANGLES,"precision lowp float;\n\nattribute highp vec2 a_position;\nuniform vec2 u_radius;\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\nuniform vec4 u_offset;\nuniform float u_scale;\nuniform vec2 u_resolution;\nuniform bool u_alignMap;\nuniform float u_strokeWidth;\n\nvarying vec2 v_position;\nvarying float v_radius;\n\nconst float EXTENT_SCALE = 1.0 / 32.0;// 8912->512\n\nfloat toPixel(vec2 size){\n    float value = size.x;\n    if (size.y > 0.0){\n        // value is defined in meters -> convert to pixels at current zoom\n        value *= u_scale * size.y;\n    }\n    return value;\n}\n\nvoid main(void){\n\n    if (mod(a_position.x, 2.0) == 1.0)\n    {\n        // LSB is direction/normal vector [-1,+1]\n        vec2 dir = mod(floor(a_position / 2.0), 2.0) * 2.0 - 1.0;\n        vec2 pos = floor(a_position / 4.0) * EXTENT_SCALE;\n\n        float radius = toPixel(u_radius);\n\n        radius = radius + u_strokeWidth / 2.0;\n\n        v_position = dir * radius;\n        v_radius = radius;\n\n        vec2 pixel_offset = vec2(toPixel(u_offset.xy), toPixel(u_offset.zw));\n\n        if (u_alignMap){\n            vec2 shift = (pixel_offset + v_position) / u_scale;\n            gl_Position = u_matrix * vec4(u_topLeft + pos + shift, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4(u_topLeft + pos, 0.0, 1.0);\n            vec2 offset = pixel_offset * vec2(1.0, -1.0);\n            gl_Position = vec4(cpos.xy / cpos.w + (offset + v_position) / u_resolution * 2.0, 0.0, 1.0);\n        }\n    }\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\nuniform vec4 u_stroke;\nuniform float u_strokeWidth;\n\nvarying float v_radius;\nvarying vec2 v_position;\n\n#define COLOR_UNDEF -1.0\n\nvoid main(void){\n    float r = length(v_position);\n\n    if (r > v_radius) discard;\n\n    if (r < v_radius - u_strokeWidth){\n        if(u_fill[0] == COLOR_UNDEF) discard;\n        gl_FragColor = u_fill;\n    } else {\n        gl_FragColor = u_stroke;\n    }\n}\n",e)||this;return e.name="Circle",e.glStates=new Xt({scissor:!1,blend:!1,depth:!0}),e}var Jt,$t="precision lowp float;\n\nattribute vec2 a_position;\nattribute highp vec4 a_normal;\nattribute float a_lengthSoFar;\n\nuniform mat4 u_matrix;\nuniform highp vec2 u_strokeWidth;\nuniform highp float u_scale;\nuniform vec2 u_topLeft;\nuniform float u_texWidth;\nvarying vec2 v_normal;\nvarying float v_lengthSoFar;\nvarying vec2 v_width;\n\nuniform vec2 u_offset;\nuniform float u_tileScale;\n\nconst float N_SCALE = 1.0 / 8192.0;\n\n\nfloat toPixel(vec2 size){\n    float value = size.x;\n    if (size.y > 0.0){\n        // value is defined in meters -> convert to pixels at current zoom\n        value *= u_scale * size.y;\n    }\n    return value;\n}\n\nvoid main(void){\n\n    float strokeWidth = toPixel(u_strokeWidth);\n    float alias = strokeWidth<1. ? .65 : 1.;\n    float width = (strokeWidth+alias) / u_scale;\n    v_width = vec2(strokeWidth, alias * .5);\n    // LSB is direction/normal vector [-1,+1]\n    vec2 dir2 = mod(a_normal.zw, 2.0) * 2.0 - 1.0;\n    vec2 aliasNormal = floor(a_normal.zw * .5) * N_SCALE;\n    v_normal = dir2 * aliasNormal;\n    // LSB is direction/normal vector [-1,+1]\n    vec2 dir = mod(a_normal.xy, 2.0) * 2.0 - 1.0;\n    vec2 normal = floor(a_normal.xy * .5) * N_SCALE;\n\n    v_lengthSoFar = a_lengthSoFar / u_texWidth;\n\n    float lineOffset = toPixel(u_offset);\n\n    vec2 position = a_position + normal * -lineOffset / u_scale;\n\n    gl_Position = u_matrix * vec4(u_topLeft + position * u_tileScale + dir * normal * width, 0.0, 1.0);\n}\n\n",te=(e(ee,Jt=Zt),ee.prototype.pass=function(t){return t==Bt.ALPHA},ee.prototype.init=function(t,e,i){Jt.prototype.init.call(this,t,e,i),this.gl.depthMask(!1)},ee);function ee(t,e){e=Jt.call(this,t,t.TRIANGLES,$t,"precision lowp float;\n\nuniform sampler2D u_pattern;\nuniform vec4 u_fill;\nvarying vec2 v_normal;\nvarying float v_lengthSoFar;\nvarying vec2 texCoord;\nvarying vec2 v_width;\n\nvoid main(void){\n\n    float width = length(v_normal) * (v_width.s + v_width.t);\n    float alpha = 1.0 - clamp(.5 * (width - v_width.s + v_width.t) / v_width.t, .0, 1.);\n\n    gl_FragColor = u_fill;\n    gl_FragColor.a *= alpha;\n}\n",e)||this;return e.name="Line",e.glStates=new Xt({blend:!0,scissor:!0,depth:!0}),e}var ie,ne=(e(re,ie=Zt),re.prototype.pass=function(t){return t==Bt.ALPHA},re.prototype.init=function(t,e,i){var n=this.gl;ie.prototype.init.call(this,t,e,i),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA)},re);function re(t,e){e=ie.call(this,t,t.TRIANGLES,$t,"precision lowp float;\n\nuniform vec4 u_fill;\nvarying vec2 v_normal;\nvarying vec2 v_width;\nvarying float v_lengthSoFar;\n\nuniform sampler2D u_pattern;\n\nvoid main(void){\n\n    float width = length(v_normal) * (v_width.s + v_width.t);\n    float alpha = 1.0 - clamp(.5 * (width - v_width.s + v_width.t) / v_width.t, .0, 1.);\n\n    gl_FragColor = u_fill;\n    gl_FragColor.a *= alpha * texture2D(u_pattern, vec2(fract(v_lengthSoFar))).r;\n}\n",e)||this;return e.name="Line",e.glStates=new Xt({blend:!0,scissor:!0,depth:!0}),e}var oe,ae=(e(se,oe=Zt),se);function se(t,e){e=oe.call(this,t,t.TRIANGLES,"precision lowp float;\n\nattribute vec2 a_position;\n\nuniform float u_tileScale;\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\n\nvoid main(void){\n    gl_Position = u_matrix * vec4( u_topLeft + a_position * u_tileScale, 0.0, 1.0 );\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\n\nvoid main(void){\n    gl_FragColor = u_fill;\n}\n",e)||this;return e.name="Polygon",e}var le,he=(e(ue,le=Zt),ue.prototype.draw=function(t,e){var i=this.gl,n=t.texture;n&&(i.activeTexture(i.TEXTURE0),n.bind()),le.prototype.draw.call(this,t,e)},ue);function ue(t,e){e=le.call(this,t,t.TRIANGLES,"precision lowp float;\n\nattribute vec2 a_position;\nattribute vec2 a_textureCoord;\n\nuniform highp mat4 u_matrix;\nuniform highp vec2 u_topLeft;\nuniform highp vec2 u_resolution;\n\nvarying vec2 v_textureCoord;\n\nvoid main(void){\n    v_textureCoord = a_textureCoord;\n\n    vec4 position = u_matrix * vec4( u_topLeft + a_position, 0.0, 1.0 );\n\n    gl_Position = snapToScreenPixel(position, u_resolution);\n}\n","precision lowp float;\n\nvarying vec2 v_textureCoord;\nuniform sampler2D u_sampler;\n\nvoid main(void){\n    gl_FragColor = texture2D(u_sampler, v_textureCoord);\n}\n",e)||this;return e.name="Image",e.glStates=new Xt({scissor:!0,blend:!1,depth:!0}),e}var ce,fe=(e(pe,ce=Zt),pe.prototype.pass=function(t){return t==Bt.ALPHA},pe.prototype.init=function(t,e,i){var n=this.gl;ce.prototype.init.call(this,t,e,i),n.depthMask(!1),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA)},pe.prototype.draw=function(t,e){var i=this.gl,n=this.uniforms;i.uniform1f(n.u_strokeOnly,1),ce.prototype.draw.call(this,t,e),i.uniform1f(n.u_strokeOnly,0),ce.prototype.draw.call(this,t,e)},pe);function pe(t,e){e=ce.call(this,t,t.TRIANGLES,"precision highp float;\n\nattribute vec2 a_point;\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nuniform vec2 u_resolution;\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\nuniform vec2 u_offset;\nuniform float u_scale;\nuniform float u_rotate;\nuniform bool u_alignMap;\nuniform bool u_fixedView;\nuniform float u_atlasScale;\n\nvarying vec2 v_texcoord;\nvarying vec4 vColor;\n\nconst float EXTENT_SCALE = 1.0 / 128.0;// 32768->512\nconst float OFFSET_SCALE = 1.0 / 32.0;\n\nconst float PI_05 = M_PI * 0.5;\nconst float PI_15 = M_PI * 1.5;\nconst float PI_20 = M_PI * 2.0;\n\nvec2 rotate(vec2 point, float rad){\n    float s = sin(rad);\n    float c = cos(rad);\n    return vec2(point.x * c + point.y * s, point.y * c - point.x * s);\n}\n\nvoid main(void){\n    if (mod(a_texcoord.x, 2.0) == 1.0)\n    {\n        vec2 rotLowHi = mod(a_texcoord, 32.0);\n        float rotation = rotLowHi.x - 1.0 + floor(rotLowHi.y * 32.0);\n        // texture coodrinates bit6->bit16\n        v_texcoord = floor(a_texcoord / 32.0) * u_atlasScale;\n\n        vec2 labelOffset = u_offset;\n\n        labelOffset *= DEVICE_PIXEL_RATIO;\n\n        rotation = rotation / 512.0 * PI_20;// 9bit -> 2PI;\n\n        if (u_alignMap){\n            float absRotation = mod(u_rotate + rotation, PI_20);\n\n            if (absRotation > PI_05 && absRotation < PI_15){\n                rotation += M_PI;\n                labelOffset *= -1.0;\n            }\n\n            vec2 posOffset = rotate(a_point.xy * OFFSET_SCALE + labelOffset, -rotation) / u_scale / DEVICE_PIXEL_RATIO;\n            gl_Position = u_matrix * vec4(u_topLeft + a_position * EXTENT_SCALE + posOffset, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4((u_topLeft + a_position * EXTENT_SCALE), 0.0, 1.0);\n            vec2 offset = rotate(a_point * OFFSET_SCALE + labelOffset, -rotation);\n            gl_Position = vec4(cpos.xy / cpos.w + vec2(1, -1) * offset / DEVICE_PIXEL_RATIO / u_resolution * 2.0, 0.0, 1.0);\n        }\n\n        if (u_fixedView){\n            // round/snap to pixelgrid if mapview is static -> crisp\n            gl_Position = snapToScreenPixel(gl_Position, u_resolution);\n        }\n    }\n}\n","precision mediump float;\n\nvarying vec2 v_texcoord;\nuniform sampler2D u_texture;\nuniform bool u_strokeOnly;\nuniform vec4 u_fillColor;\nuniform vec4 u_strokeColor;\n\nvoid main() {\n    vec4 glyph = texture2D(u_texture, v_texcoord);\n    vec4 color;\n    float glyphAlpha;\n\n    if (u_strokeOnly){\n        color = u_strokeColor;\n        glyphAlpha = glyph.a;\n    } else {\n        color = u_fillColor;\n        glyphAlpha = glyph.r;\n    }\n\n    gl_FragColor = glyphAlpha * vec4(color.rgb * color.a, color.a);\n}\n",e)||this;return e.name="Text",e.glStates=new Xt({blend:!0,scissor:!1,depth:!0}),e}var de,ve=(e(ye,de=Zt),ye.prototype.pass=function(t){return t==Bt.ALPHA},ye.prototype.init=function(t,e,i){var n=this.gl;de.prototype.init.call(this,t,e,i),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA)},ye);function ye(t,e){e=de.call(this,t,t.TRIANGLES,"precision lowp float;\n\nattribute vec2 a_size;\nattribute highp vec2 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\nuniform float u_scale;\nuniform float u_atlasScale;\nuniform vec2 u_offset;\nuniform bool u_alignMap;\nuniform vec2 u_resolution;\nuniform bool u_fixedView;\n\nvarying float vOpacity;\nvarying vec2 v_texcoord;\n\nconst float EXTENT_SCALE = 1.0 / 32.0;// 8912->512\n\nvoid main(void){\n\n    // LSB defines visibility\n    if (mod(a_position.x, 2.0) == 1.0)\n    {\n        vec2 rotLowHi = mod(a_texcoord, 32.0);\n        float rotation = rotLowHi.x + floor(rotLowHi.y * 32.0);\n\n        rotation = rotation / 1024.0 * 2.0 * M_PI;// 10bit -> 2PI;\n\n        // bit1 is direction/normal vector [-1,+1]\n        vec2 dir = mod(floor(a_position / 2.0), 2.0) * 2.0 - 1.0;\n        vec2 pos = floor(a_position / 4.0) * EXTENT_SCALE;\n\n\n        if (!u_alignMap){\n            rotation *= -1.0;\n        }\n\n        float rotSin = sin(rotation);\n        float rotCos = cos(rotation);\n        mat2 mRotate = mat2(rotCos, -rotSin, rotSin, rotCos);\n\n        if (u_alignMap){\n            vec2 shift = ((u_offset + dir * vec2(a_size.x, -a_size.y) * 0.5) * mRotate) / u_scale;\n            gl_Position = u_matrix * vec4(u_topLeft + pos + shift, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4(u_topLeft + pos, 0.0, 1.0);\n            vec2 shift = dir * a_size * 0.5 * mRotate;\n            vec2 offset = vec2(u_offset.x, -u_offset.y);\n            gl_Position = vec4(cpos.xy / cpos.w + (offset + shift) / u_resolution * 2.0, 0.0, 1.0);\n        }\n\n        if (u_fixedView){\n            gl_Position = snapToScreenPixel(gl_Position, u_resolution);\n        }\n\n        // textcoords bit6->bit16\n        v_texcoord = floor(a_texcoord / 32.0) * u_atlasScale;\n    }\n}\n","precision mediump float;\n\nvarying vec2 v_texcoord;\nuniform float u_opacity;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n\n   gl_FragColor.a *= u_opacity;\n}\n",e)||this;return e.name="icon",e.glStates=new Xt({blend:!0,scissor:!1,depth:!0}),e}var ge,me=(e(xe,ge=Zt),xe.prototype.init=function(t,e,i){var n=this.gl;this._pass=e,ge.prototype.init.call(this,t,e,i),n.depthMask(!0),e==Bt.POST_ALPHA&&(n.enable(n.STENCIL_TEST),n.stencilFunc(n.GREATER,1,255),n.stencilOp(n.KEEP,n.KEEP,n.REPLACE))},xe.prototype.draw=function(t,e){var i=this.gl;this._pass==Bt.ALPHA?(i.colorMask(!1,!1,!1,!1),ge.prototype.draw.call(this,t,e),i.colorMask(!0,!0,!0,!1)):ge.prototype.draw.call(this,t,e)},xe);function xe(t,e){e=ge.call(this,t,t.TRIANGLES,"precision lowp float;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n\nuniform mat4 u_matrix;\n\nuniform vec2 u_topLeft;\nuniform float u_zoom;\n\nvarying vec4 v_fill;\nvarying vec3 v_normal;\n\n\nvoid main(void){\n    gl_Position = u_matrix * vec4(u_topLeft + a_position.xy, -a_position.z / u_zoom, 1.0);\n    v_normal = a_normal;\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\nvarying vec3 v_normal;\n\n#define lightDir normalize(vec3(0.5, 0.0, -1.0))\n#define top vec2(0.0)\n\nvoid main(void){\n\n    if (v_normal.xy == top){\n        gl_FragColor.rgb = u_fill.rgb;\n    } else {\n        float diffuse = 0.3 + dot(v_normal, lightDir) * 0.7;\n        gl_FragColor.rgb = u_fill.rgb * diffuse;\n    }\n\n    gl_FragColor.a = u_fill.a;\n}\n",e)||this;return e.name="Extrude",e.glStates=new Xt({scissor:!1,blend:!1,depth:!0}),e}var _e=(we.prototype.setIndex=function(t,e){this.index=e?{data:new Uint32Array(t),type:5125,length:t.length}:{data:new Uint16Array(t),type:5123,length:t.length}},we.prototype.setArrays=function(t){this.arrays=t},we.prototype.addUniform=function(t,e){this.uniforms[t]=e},we.prototype.getUniform=function(t){return this.uniforms[t]},we.prototype.addAttribute=function(t,e){var i,n=e.data;e.type=(i=n)instanceof Int8Array?5120:i instanceof Uint8Array?5121:i instanceof Int16Array?5122:i instanceof Uint16Array?5123:i instanceof Int32Array?5124:i instanceof Uint32Array?5125:i instanceof Float32Array?5126:void 0,null==e.stride&&(e.stride=0),null==e.dirty&&(e.dirty=!0),this.attributes[t]=e,this.size=n.length},we.prototype.getAttributes=function(){return this.attributes},we.prototype.destroy=function(){},we);function we(t,e,i){this.attributes={},this.uniforms={},this.flat=!0,t&&(t instanceof Array?this.setIndex(t,i):this.setArrays(t),this.type=e)}function be(t){var e=t[0],i=t[1],n=e*e+i*i;return 0<n&&(n=1/Math.sqrt(n),t[0]=e*n,t[1]=i*n),t}function Te(t,e,i,n,r,o,a,s){void 0===s&&(s=1),t==Ae?(o.push(e,i,e,i,e,i),n*=Math.SQRT2*s,r*=Math.SQRT2*s,a.push(n<<1|0,r<<1|1,n<<1|0,r<<1|1,n<<1|1,r<<1|0,n<<1|1,r<<1|0,r<<1|1,n<<1|1,r<<1|1,n<<1|1)):"square"==t&&(o.push(e,i,e,i,e,i,e,i,e,i,e,i),a.push(n<<1|0,r<<1|1,0,0,(i=n+r)<<1|1,(a=r-n)<<1|0,0,0,n<<1|1,r<<1|0,0,0,a<<1|1,i<<1|1,n<<1|1,r<<1|1,i<<1|1,a<<1|0,n<<1|1,r<<1|1,n<<1|0,r<<1|1,0,0))}function Le(t,e,i,n,r,o,a,s,l,h,u,c,f,p){h*=.5;var d,v,y,g,m,x,_,w,b,T=(f=void 0===f?0:f)*r,L=(p=void 0===p?0:p)*r,A=!0,S=0,M=null;for(T&&L&&p<f&&(r=T,T=L,L=r),c&&(s="butt","none"!=l&&(l=Se)),u&&(s="butt",c||(l="none")),y=0;y<n;y+=2){var z,E,C,I,P,k=i[y],D=i[y+1],R=U(k,D,0,0,o,o);R?A?null==M&&(M=y):M=y-2:y&&(A?(S=Ee(t,e,i,M,y+2,o,s,l,h,u,S,T,L,c),M=null):(z=k,E=d,C=D,P=v,d<k&&(z=d,E=k),v<D&&(C=v,P=D),I=o+16,a&&(g=d,m=v,x=k,_=D,w=o,(b=void 0)===b&&(b=1),!(Math.abs(m)<b&&Math.abs(_)<b||Math.abs(g-w)<b&&Math.abs(x-w)<b||Math.abs(m-w)<b&&Math.abs(_-w)<b||Math.abs(g)<b&&Math.abs(x)<b))||!a&&z<=I&&-16<=E&&C<=I&&-16<=P?(S=Ee(t,e,i,y-2,y+2,o,s,l,h,u,S,T,L,c),M=null):(u||f||p)&&(I=d-k,P=v-D,S+=Math.sqrt(I*I+P*P)))),A=R,d=k,v=D}null!=M&&Ee(t,e,i,M,y,o,s,l,h,u,S,T,L,c)}var Ae="round",Se="miter",Me="bevel",ze=8192,Ee=function(t,e,i,n,r,o,a,s,l,h,u,c,f,p){void 0===u&&(u=0);var d,v,y,g,m,x,_,w,b=r,T=i[n],L=i[n+1],A=null,S=null,M=null,z=null;if(f&&f<u)return u;for(var E=n+2;E<b;E+=2){X=i[E],G=i[E+1];var C,I,P,k=E==b-2,D=void 0,R=null,U=!1,O=void 0,N=s,F=(P=be([C=T-X,I=L-G]))[1],B=P[0],S=null==S;length=Math.sqrt(C*C+I*I);var W,X,G,Z,H,Y,j,q,V,K,Q=length,J=u;if(u+=length,f&&f<u&&J<f&&(X=T-C*(W=(f-J)/Q),G=L-I*W,length*=W,k=!0,b=0),c){if(!(c<u)){T=X,L=G;continue}J<c&&(T-=C*(Q=(c-J)/Q),L-=I*Q,length*=1-Q,S=!0)}S&&k&&(s="none"),k||(A=i[E+2],D=C*(w=G-i[E+3])-I*(_=X-A)<0,(O=1/((Z=[H=(R=be([_,w]))[1]+F,Y=-R[0]-B])[0]*F-Z[1]*B))==1/0?(U=!0,Y=H=2):(s==Se&&2<O&&(N=Me),H=Z[0]*O,Y=Z[1]*O,(U=1<(j=Math.sqrt(H*H+Y*Y)/2))&&(H/=j,Y/=j)),H*=-ze,Y*=-ze),Z=R=I=[1^(C=[-(F*=ze)<<1|1,(B*=ze)<<1|1])[0],1^C[1]],j=O=C,"none"!=s&&(!k&&N==Se&&4<b&&(Z=[H<<1|0,Y<<1|0],j=[H<<1|1,Y<<1|1]),S||m||(x?(O=[y<<1|1,g<<1|1],"miter"==s&&(R=[y<<1|0,g<<1|0])):(R=[y<<1|0,g<<1|0],"miter"==s&&(O=[y<<1|1,g<<1|1]))),U||k||s!=Se&&(V=l*H/-ze,q=l*Y/-ze,D&&(V*=-1,q*=-1),V=P[0]*V+P[1]*q,length<V?U=!0:D?j=[H<<1|1,Y<<1|1]:Z=[H<<1|0,Y<<1|0]),S&&!k||!u||(s==Ae&&(x?e.push(v[0],v[1],v[0],v[1],R[0],R[1],R[0],R[1],y<<1|0,g<<1|0,y<<1|0,g<<1|0):e.push(y<<1|1,g<<1|1,y<<1|1,g<<1|1,O[0],O[1],O[0],O[1],d[0],d[1],d[0],d[1]),t.push(M,z,M,z,M,z)),S||(m?p||(V=q=0,s!=Ae&&(q=(K=be([H,Y]))[0]*ze,V=K[1]*ze),q=q<<1|1,V=V<<1|1,x?e.push(0,0,0,0,I[0],I[1],q,V,v[0],v[1],q,V):e.push(0,0,0,0,C[0],C[1],q,V,d[0],d[1],q,V),t.push(M,z,M,z,M,z)):s!=Se&&((K=be([y,g]))[0]*=ze,K[1]*=ze,x?s==Me?e.push(y<<1|1,g<<1|1,K[0]<<1|1,K[1]<<1|1,R[0],R[1],K[0]<<1|0,K[1]<<1|0,v[0],v[1],K[0]<<1|0,K[1]<<1|0):e.push(y<<1|1,g<<1|1,K[0]<<1|1,K[1]<<1|1,R[0],R[1],R[0],R[1],v[0],v[1],v[0],v[1]):s==Me?e.push(O[0],O[1],K[0]<<1|1,K[1]<<1|1,y<<1|0,g<<1|0,K[0]<<1|0,K[1]<<1|0,d[0],d[1],K[0]<<1|1,K[1]<<1|1):e.push(O[0],O[1],O[0],O[1],y<<1|0,g<<1|0,K[0]<<1|0,K[1]<<1|0,d[0],d[1],d[0],d[1]),t.push(M,z,M,z,M,z))))),e.push(O[0],O[1],C[0],C[1],Z[0],Z[1],I[0],I[1],R[0],R[1],I[0],I[1],O[0],O[1],C[0],C[1],j[0],j[1],C[0],C[1],Z[0],Z[1],I[0],I[1]),t.push(T,L,X,G,T,L,T,L,X,G,X,G),S&&Te(a,T,L,F,B,t,e),k&&Te(a,X,G,-F,-B,t,e),h&&(B=u-length,h.push(B,u,B,B,u,u)),d=C,v=I,y=H,g=Y,T=M=X,L=z=G,x=D,m=U}return u},Ce=(Ie.prototype.get=function(t){return this.data[t]},Ie.prototype.push=function(t){var e=arguments.length;this.reserve(e);for(var i=0;i<e;i++)this.data[this.length++]=arguments[i];return this.length},Ie.prototype.reserve=function(t){var e=this.data,t=t-(this.size-this.length);0<t&&(this.size+=Math.max(t,this.size),this.data=new e.constructor(this.size),this.length&&this.data.set(e))},Ie.prototype.trim=function(){return this.data=this.data.slice(0,this.length)},Ie);function Ie(t,e){void 0===e&&(e=128),this.length=0,this.data=new t(this.size=e)}function Pe(t,e,i,n,r,o){var a,s,l,h=o.offset,u=e.spaceWidth,c=e.glyphInfos[t],f=o.x,p=0,d=n.data,v=n.length,y=r.data,g=r.length,m=i>>5,x=31&i;c?(l=c.glyph,a=c.u1<<5|x,s=c.u2<<5|x,e=c.v1<<5|m,i=c.v2<<5|m,x=l.advanceX,m=(c=l.data).width,l=c.height,l*=32,p=(c=32*f)+32*m,d[v++]=c,d[v++]=0,d[v++]=p,d[v++]=l,d[v++]=c,d[v++]=l,d[v++]=p,d[v++]=0,d[v++]=p,d[v++]=l,d[v++]=c,d[v++]=0,y[g++]=a,y[g++]=e,y[g++]=s,y[g++]=i,y[g++]=a,y[g++]=i,y[g++]=s,y[g++]=e,y[g++]=s,y[g++]=i,y[g++]=a,y[g++]=e,f+=x,h+=12):" "==t&&(f+=u),n.length=v,r.length=g,o.x=f,o.offset=h,o.x2=p}function ke(t,e,i,n,r,o,a,s,l){for(var h,u,c=e,f=i;c<f;c++){if(u=t.charAt(h=n?e+(f-1-c):c),n&&k(t.charCodeAt(h))){for(var p=h,d=0;0<=--p;)if(!k(t.charCodeAt(p))){for(;++p<=h;)Pe(t.charAt(p),r,o,a,s,l),d++;break}if(d){c+=d-1;continue}}Pe(u,r,o,a,s,l)}}function De(t,e,i,n,r){void 0===i&&(i=0);var o=t.length;n?n.reserve(18*o):n=new Ce(Int16Array,18*o),r?r.reserve(12*o):r=new Ce(Uint16Array,12*o);var a,s,l,h={x:0,x2:0,offset:0},u=0;i=Math.round(1|i);for(var c=0;c<o;c++){var f,p,d=t.charAt(c),v=e.glyphInfos[d],y=c==o-1,g=(null===(f=null==v?void 0:v.glyph)||void 0===f?void 0:f.direction)||0;if(!a){if(" "==d)continue;a=g=g||1}void 0!==s&&(v=!0,(v=!g?(f=function(t,e,i){for(;++e<t.length;){var n=t.charAt(e),n=null===(n=i.glyphInfos[n])||void 0===n?void 0:n.glyph;if(n){n=n.direction;if(n)return n}}}(t,c,e))&&f!=s:v)&&g!=s&&(p=c-1," "==l&&1==g&&p--,ke(t,u,++p,-1==s,e,i,n,r,h),u=p)),y&&u<=c&&(p=c+Number(" "!=d),ke(t,u,p,g?-1==g:s!=a,e,i,n,r,h)),g&&(s=g),l=d}return{count:h.offset/2,position:n.data,texcoord:r.data,width:h.x2/32/e.scale}}var Re=R.getInstance(),Ue=(Oe.prototype.getTextWidth=function(t){return Re.getTextWidth(t,this.font)},Oe.prototype.placeGlyph=function(t){var e=this.rowHeight;this.x+t>this.width&&((t=this.y+2*e)>this.maxHeight?t>this.height?(this.height*=2,this.width*=2,0==this.x?this.maxWidth=this.maxWidth=this.width:(this.x=this.maxWidth,this.y=0)):(this.x=0,this.y+=e,this.maxHeight=this.height,this.maxWidth=this.width):(this.y+=e,this.maxHeight<this.height?this.x=this.maxWidth:this.x=0))},Oe.prototype.addChars=function(t){for(var e=this.glyphInfos,i=this.rowHeight,n=!1,r=0,o=t;r<o.length;r++){var a,s,l,h,u=o[r];" "==u||e[u]||(a=Re.getGlyph(u,this.font),l=u.charCodeAt(0),s=a.data.width,h=a.width,l&&(this.avgCharWidth=(this.avgCharWidth*this.glyphs+h)/++this.glyphs,n=!0,this.placeGlyph(s),l=this.x,h=this.y,e[u]={u1:l,v1:h,u2:l+s,v2:h+i,glyph:a},this.x+=s))}return n},Oe);function Oe(t,e,i,n){this.x=0,this.y=0,this.glyphInfos={},this.avgCharWidth=0,this.glyphs=0;var r=Re.initFont(t,e);if(this.style=t,this.letterHeight=r.letterHeight,this.lineHeight=r.letterHeight*e,this.baselineOffset=r.baselineOffset,this.rowHeight=r.rowHeight,this.spaceWidth=r.spaceWidth,this.fontScale=r.fontScale,!i)for(i=1;i<r.rowHeight;)i*=2;this.width=i*=e,this.height=i,this.maxWidth=i,this.maxHeight=i,this.style=t,this.scale=e,this.font=r,n&&this.addChars(n)}var Ne,Fe=(e(Be,Ne=zt),Be.prototype.addChars=function(t){this.dirty=this.atlas.addChars(t)||this.dirty},Be.prototype.bufferLength=function(t){for(var e=0,i=0,n=t;i<n.length;i++)" "!=n[i]&&e++;return 6*e*2},Be.prototype.getAtlas=function(){return this.atlas},Be.prototype.sync=function(){if(this.dirty){var t,e=this.atlas,i=(this.gl,e.glyphInfos);for(t in this.set({width:e.width,height:e.height}),i){var n=i[t];this.set(n.glyph.data,n.u1,n.v1)}}},Be.prototype.destroy=function(){this.atlas=null,Ne.prototype.destroy.call(this)},Be);function Be(t,e,i){var n=Ne.call(this,t)||this;n.dirty=!1;var r=t.dpr;return n.atlas=new Ue(e,r,i),n.format=t.LUMINANCE_ALPHA,n}We.prototype.count=function(){var t=this.attributes.a_position;return t.data.length/t.size-this.first},We.prototype.index=function(){return this._index=this._index||[]},We.prototype.hasIndex=function(){return!!this._index},We.prototype.isEmpty=function(){return 0==this.count()},We.prototype.trimAttribute=function(t){return t.data=t.data.trim(),t},We.prototype.isFlat=function(){return this._flat},We.prototype.finalize=function(t){var e,i,n=this,r=n.attributes;if(n.hasIndex()){var o=n.index();if(!o.length)return null;e=new _e(o,t,n.i32)}else e=new _e({first:n.first,count:n.count()},t);for(i in r){var a=r[i];a.data.length&&e.addAttribute(i,n.trimAttribute(a))}return e},gt=We;function We(t){this.i32=!1,this._flat=!0,this.scissor=t}var Xe,Ge=(e(Ze,Xe=gt),Ze);function Ze(){var t=Xe.call(this,!0)||this;return t.attributes={a_position:{data:new Ce(Float32Array),size:2},a_normal:{data:new Ce(Int16Array),size:4},a_lengthSoFar:{data:new Ce(Uint16Array),size:1}},t.first=0,t}var He,Ye="undefined"!=typeof Float32Array?Float32Array:Array;function je(t,e,i){var n=e[0],r=e[1],o=e[2],e=i[3]*n+i[7]*r+i[11]*o+i[15];return t[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])/(e=e||1),t[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])/e,t[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])/e,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var qe,Ve;qe=new Ye(3),Ye!=Float32Array&&(qe[0]=0,qe[1]=0,qe[2]=0),Ve=qe;function Ke(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Qe(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],c=e[9],f=e[10],p=e[11],d=e[12],v=e[13],y=e[14],g=e[15],m=i*s-n*a,x=i*l-r*a,_=i*h-o*a,w=n*l-r*s,b=n*h-o*s,T=r*h-o*l,L=u*v-c*d,A=u*y-f*d,S=u*g-p*d,M=c*y-f*v,z=c*g-p*v,E=f*g-p*y,e=m*E-x*z+_*M+w*S-b*A+T*L;return e?(t[0]=(s*E-l*z+h*M)*(e=1/e),t[1]=(r*z-n*E-o*M)*e,t[2]=(v*T-y*b+g*w)*e,t[3]=(f*b-c*T-p*w)*e,t[4]=(l*S-a*E-h*A)*e,t[5]=(i*E-r*S+o*A)*e,t[6]=(y*_-d*T-g*x)*e,t[7]=(u*T-f*_+p*x)*e,t[8]=(a*z-s*S+h*L)*e,t[9]=(n*S-i*z-o*L)*e,t[10]=(d*b-v*_+g*m)*e,t[11]=(c*_-u*b-p*m)*e,t[12]=(s*A-a*M-l*L)*e,t[13]=(i*M-n*A+r*L)*e,t[14]=(v*x-d*w-y*m)*e,t[15]=(u*w-c*x+f*m)*e,t):null}function Je(t,e){return Math.round((t+1)/2*e)}var $e={create:function(){var t=new Ye(16);return Ye!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},lookAt:function(t,e,i,n){var r,o=e[0],a=e[1],s=e[2],l=n[0],h=n[1],u=n[2],c=i[0],f=i[1],p=i[2];return Math.abs(o-c)<1e-6&&Math.abs(a-f)<1e-6&&Math.abs(s-p)<1e-6?Ke(t):(r=o-c,e=a-f,n=s-p,c=h*(n*=i=1/Math.hypot(r,e,n))-u*(e*=i),f=u*(r*=i)-l*n,p=l*e-h*r,(i=Math.hypot(c,f,p))?(c*=i=1/i,f*=i,p*=i):p=f=c=0,u=e*p-n*f,l=n*c-r*p,h=r*f-e*c,(i=Math.hypot(u,l,h))?(u*=i=1/i,l*=i,h*=i):h=l=u=0,t[0]=c,t[1]=u,t[2]=r,t[3]=0,t[4]=f,t[5]=l,t[6]=e,t[7]=0,t[8]=p,t[9]=h,t[10]=n,t[11]=0,t[12]=-(c*o+f*a+p*s),t[13]=-(u*o+l*a+h*s),t[14]=-(r*o+e*a+n*s),t[15]=1,t)},multiply:function(t,e,i){var n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],p=e[10],d=e[11],v=e[12],y=e[13],g=e[14],m=e[15],x=i[0],_=i[1],w=i[2],e=i[3];return t[0]=x*n+_*s+w*c+e*v,t[1]=x*r+_*l+w*f+e*y,t[2]=x*o+_*h+w*p+e*g,t[3]=x*a+_*u+w*d+e*m,x=i[4],_=i[5],w=i[6],e=i[7],t[4]=x*n+_*s+w*c+e*v,t[5]=x*r+_*l+w*f+e*y,t[6]=x*o+_*h+w*p+e*g,t[7]=x*a+_*u+w*d+e*m,x=i[8],_=i[9],w=i[10],e=i[11],t[8]=x*n+_*s+w*c+e*v,t[9]=x*r+_*l+w*f+e*y,t[10]=x*o+_*h+w*p+e*g,t[11]=x*a+_*u+w*d+e*m,x=i[12],_=i[13],w=i[14],e=i[15],t[12]=x*n+_*s+w*c+e*v,t[13]=x*r+_*l+w*f+e*y,t[14]=x*o+_*h+w*p+e*g,t[15]=x*a+_*u+w*d+e*m,t},perspective:function(t,e,i,n,r){return e=1/Math.tan(e/2),t[0]=e/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(t[10]=(r+n)*(e=1/(n-r)),t[14]=2*r*n*e):(t[10]=-1,t[14]=-2*n),t},rotateX:function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[4],a=e[5],s=e[6],l=e[7],h=e[8],u=e[9],c=e[10],i=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*r+h*n,t[5]=a*r+u*n,t[6]=s*r+c*n,t[7]=l*r+i*n,t[8]=h*r-o*n,t[9]=u*r-a*n,t[10]=c*r-s*n,t[11]=i*r-l*n,t},rotateZ:function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[0],a=e[1],s=e[2],l=e[3],h=e[4],u=e[5],c=e[6],i=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r+h*n,t[1]=a*r+u*n,t[2]=s*r+c*n,t[3]=l*r+i*n,t[4]=h*r-o*n,t[5]=u*r-a*n,t[6]=c*r-s*n,t[7]=i*r-l*n,t},translate:function(t,e,i){var n,r,o,a,s,l,h,u,c,f,p,d=i[0],v=i[1],y=i[2];return e===t?(t[12]=e[0]*d+e[4]*v+e[8]*y+e[12],t[13]=e[1]*d+e[5]*v+e[9]*y+e[13],t[14]=e[2]*d+e[6]*v+e[10]*y+e[14],t[15]=e[3]*d+e[7]*v+e[11]*y+e[15]):(n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],c=e[8],f=e[9],p=e[10],i=e[11],t[0]=n,t[1]=r,t[2]=o,t[3]=a,t[4]=s,t[5]=l,t[6]=h,t[7]=u,t[8]=c,t[9]=f,t[10]=p,t[11]=i,t[12]=n*d+s*v+c*y+e[12],t[13]=r*d+l*v+f*y+e[13],t[14]=o*d+h*v+p*y+e[14],t[15]=a*d+u*v+i*y+e[15]),t},scale:function(t,e,i){var n=i[0],r=i[1],i=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*i,t[9]=e[9]*i,t[10]=e[10]*i,t[11]=e[11]*i,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},clone:function(t){var e=new Ye(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},invert:Qe,identity:Ke},ti=45*Math.PI/180,ei="OES_element_index_uint",ii={font:"bold 14px Arial",stroke:"red",fill:"white",strokeWidth:3},ni=(ri.prototype.setPass=function(t){var e=this.gl;this.pass=t,this.depthFnc=t!=Bt.OPAQUE?e.LEQUAL:e.LESS,t==Bt.POST_ALPHA&&e.clear(e.STENCIL_BUFFER_BIT)},ri.prototype.convertColor=_t,ri.prototype.setBackgroundColor=function(t){this.gl&&this.gl.clearColor(t[0],t[1],t[2],1)},ri.prototype.setScale=function(t,e,i){},ri.prototype.setRotation=function(t,e){},ri.prototype.clear=function(t){var e=this.gl;t&&this.setBackgroundColor(t),e.colorMask(!0,!0,!0,!0),e.disable(e.SCISSOR_TEST),e.depthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.colorMask(!0,!0,!0,!1)},ri.prototype.init=function(t,e){this.dpr=e;var i=t.getContext("webgl",this.ctxAttr);i.dpr=e,i.getExtension(ei),i.enable(i.CULL_FACE),i.cullFace(i.FRONT),i.enable(i.DEPTH_TEST),i.enable(i.SCISSOR_TEST),i.clearStencil(0);t=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.icons=new Ut(i,t-2),this.programs={Rect:new jt(i,e),Line:new te(i,e),DashedLine:new ne(i,e),Text:new fe(i,e),Image:new he(i,e),Circle:new Kt(i,e),Polygon:new ae(i,e),Extrude:new me(i,e),Icon:new ve(i,e)},i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.gl=i},ri.prototype.grid=function(t){this.tileGrid=t},ri.prototype.applyTransform=function(){},ri.prototype.initView=function(t,e,i,n,r){var o=this.pMat,a=this.vMat,s=.5*ti,l=.5*t,h=.5*e,u=h/Math.tan(s),c=Math.cos(s),f=Math.sin(s)*u,p=.5*Math.PI-s+n,s=.25*u,p=c*(c*u+f/Math.tan(p));p*=1.005,this.tilePreviewTransform.tx=null,this.tilePreviewTransform.ty=null,this.tilePreviewTransform.s=null,this.w=t,this.h=e,this.rz=r,this.rx=n,this.scale=i,this.gl.viewport(0,0,t*this.dpr,e*this.dpr),$e.perspective(o,ti,t/e,s,p),$e.lookAt(a,[l,h,-u],[l,h,0],[0,-1,0]),$e.translate(a,a,[l,h,0]),$e.rotateX(a,a,n),$e.rotateZ(a,a,r),$e.scale(a,a,[i,i,i]),$e.translate(a,a,[-l,-h,0]),$e.multiply(o,o,a),Qe(this.invPMat,this.pMat);a=$e.identity(this.screenMat);$e.scale(a,a,[l,-h,1]),$e.translate(a,a,[1,-1,0]),$e.multiply(a,a,this.pMat),Qe(this.invScreenMat,a)},ri.prototype.initBuffers=function(t){var e,i,n,r=this.gl;for(n in t)e=t[n],(i=this.buffers.get(e))||(i=r.createBuffer(),this.buffers.set(e,i)),e.dirty&&(e.dirty=!1,r.bindBuffer(r.ARRAY_BUFFER,i),r.bufferData(r.ARRAY_BUFFER,e.data,r.STATIC_DRAW))},ri.prototype.useProgram=function(t){var e=this.prog;if(e==t)return!1;var i=this.gl;if(e){var n,r=e.attributes;for(n in r)i.disableVertexAttribArray(r[n])}return i.useProgram(t.prog),this.prog=t,!0},ri.prototype.drawGrid=function(t,e,i,n){var r=this.pass;this.pass=Bt.ALPHA,this.drawBuffer(this.dbgTile,t,e,null,null,n);n=this.gridTextBuf.get(i);n||(n=function(t,e,i){He||((He=new Fe(e,i)).addChars("L0123456789"),He.sync());var n=De(t+" L"+t.length,He.atlas),e=n.position,t=new _e({first:0,count:n.count},"Text");return t.addAttribute("a_point",{data:e,size:2,stride:0}),t.addAttribute("a_texcoord",{data:n.texcoord,size:2,stride:0}),t.depth=!1,t.scissor=!1,t.texture=He,t.addUniform("u_texture",0),t.addUniform("u_atlasScale",1/He.width),t.addUniform("u_opacity",1),t.addUniform("u_alignMap",!0),t.addUniform("u_fillColor",_t(i.fill)),t.addUniform("u_strokeColor",_t(i.stroke)),t}(i.quadkey,this.gl,ii),this.gridTextBuf.set(i,n)),this.drawBuffer(n,t+4,e+4),this.pass=r},ri.prototype.deleteBuffer=function(t){var e,i=this.buffers,n=this.gl,r=t.attributes,o=t.texture,t=t.index;for(e in o&&o.destroy(),r){var a=r[e],a=i.get(a);n.deleteBuffer(a)}t&&n.deleteBuffer(i.get(t))},ri.prototype.drawBuffer=function(t,e,i,n,r,o){var a,s,l,h,u,c=this.gl,f=this.buffers,p=this.pass,d=this.programs[t.type];d&&(a=d.pass(p),r=r||1,s=(u=this.zIndex)>this.min3dZIndex,l=t.alpha==Bt.POST_ALPHA&&p==Bt.POST_ALPHA,(a=t.alpha||s?p==Bt.ALPHA||l:a)&&(this.stencilVal&&t.alpha&&(h=this.stencilVal,this.stencilVal=null,this.drawStencil(h)),h=t.getAttributes(),this.initBuffers(h),this.useProgram(d),c.depthFunc(this.depthFnc),u=1-(1+u)/65536,c.depthRange(t.flat?u:0,u),d.init(t,p,Boolean(this.rx||this.rz)),s&&c.disable(this.gl.DEPTH_TEST),d.initAttributes(h,f),d.initUniforms(t.uniforms),h=d.uniforms,c.uniform1i(h.u_fixedView,this.fixedView),c.uniform1f(h.u_rotate,this.rz),c.uniform2f(h.u_resolution,this.w,this.h),c.uniform1f(h.u_scale,this.scale*r),c.uniform2f(h.u_topLeft,e,i),c.uniform1f(h.u_tileScale,o||1),c.uniformMatrix4fv(h.u_matrix,!1,n||this.pMat),d.draw(t,f)))},ri.prototype.initStencil=function(t,e,i,n){this.stencilVal=t,this.stencilSize=n,this.stencilX=e,this.stencilY=i},ri.prototype.drawStencil=function(t){var e,i,n,r;(this.rx||this.rz)&&(e=this.gl,i=this.stencilTile,n=this.stencilX,r=this.stencilY,e.stencilFunc(e.ALWAYS,t,255),e.stencilOp(e.REPLACE,e.REPLACE,e.REPLACE),e.colorMask(!1,!1,!1,!1),this.drawBuffer(i,n,r,null,1/0,this.stencilSize),e.stencilFunc(e.EQUAL,t,255),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.colorMask(!0,!0,!0,!1))},ri.prototype.initScissor=function(t,e,i,n,r){if(t.scissor){var t=this.gl,o=t.canvas.width,a=t.canvas.height;if(4<this.scale)return t.scissor(0,0,o,a),!(this.scissorX=null);if(this.scissorX!=e||this.scissorY!=i||this.scissorSize!=n){this.scissorX=e,this.scissorY=i;for(var n=e+(this.scissorSize=n),r=i+r,s=1/0,l=-s,h=s,u=l,c=0,f=[[e,r,0],[n,r,0],[e,i,0],[n,i,0]];c<f.length;c++){var p=je([],p=f[c],this.pMat),d=Je(p[0],o),p=Je(p[1],a);d<s&&(s=d),l<d&&(l=d),p<h&&(h=p),u<p&&(u=p)}t.scissor(s,h,l-s,u-h)}return!0}},ri.prototype.draw=function(t,e){var i,n,r,o=!1,a=!1,s=t,l=s.tile,h=l.tile,u=l.size,c=l.x,f=l.y,p=s.b,d=s.preview;this.zIndex=s.z,this.min3dZIndex=e,d?(i=s.previewTile,n=d[0],r=d[1],t=d[2],l=d[3],e=d[5],s=d[6],l=(d=d[7])/l,n=Math.pow(2,h.quadkey.length-n.length),r=e/l-r,t=s/l-t,this.initScissor(p,c+e,f+s,d,d),n<1?this.initStencil(i.i,c+e,f+s,u*n):a||(a=!0,this.initStencil(h.i,c,f,u)),l=this.initPreviewMatrix(c,f,l),this.drawBuffer(p,r,t,l,n)):(o=o||this.initScissor(p,c,f,u,u),a||(this.initStencil(h.i,c,f,u),a=!0),this.drawBuffer(p,c,f))},ri.prototype.initPreviewMatrix=function(t,e,i){var n=this.tilePreviewTransform,r=n.m;return n.tx==t&&n.ty==e&&n.s==i||($e.copy(r,this.pMat),$e.translate(r,r,[t,e,0]),$e.scale(r,r,[i,i,i]),n.tx=t,n.ty=e,n.s=i),r},ri.prototype.destroy=function(){this.icons.destroy()},ri.prototype.prepare=function(t,e,i,n,r,o){},ri);function ri(t){this.gridTextBuf=new WeakMap,this.tileGrid=!1,this.tileSize=256,this.dbgTile=function(t,e){void 0===t&&(t=[1,0,0,1]),void 0===e&&(e=2);var i=new Ge,n=i.attributes;Le(n.a_position.data,n.a_normal.data,new Float32Array([0,0,1,0,1,1,0,1,0,0]),10,4,1,!1,"butt","none",e);i=i.finalize("Line");return i.addUniform("u_zIndex",0),i.addUniform("u_fill",t),i.addUniform("u_strokeWidth",[e,0]),i.addUniform("u_offset",[0,0]),i.scissor=!1,i.depth=!1,i}(),this.buffers=new WeakMap,this.ctxAttr=v({alpha:!0,antialias:!1,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1},t),this.pMat=$e.create(),this.vMat=$e.create(),this.invPMat=$e.create(),this.screenMat=$e.create(),this.invScreenMat=$e.create(),this.tilePreviewTransform={m:$e.create(),tx:0,ty:0,s:0};var e,i,i=(i=new _e([0,e=1,3,3,1,2],"Polygon"),t=256<e?Int16Array:Int8Array,i.addAttribute("a_position",{data:new t([0,0,e,0,e,e,0,e]),size:2}),i.addUniform("u_zIndex",0),i.addUniform("u_fill",[1,1,1,1]),i.scissor=!0,i.depth=!1,i.alpha=0,i);i.alpha=Bt.ALPHA,i.blend=!0,this.stencilTile=i}var oi,ai=(si.prototype.init=function(t,e){this.luTs=null,this.quadkey=t,this.layers=e,this.tasks={},this.r.length=0,this.p.length=0},si.prototype.busy=function(t){var e,i=t.id;for(e in this.tasks)if(i==this.tasks[e]._lid)return!0},si.prototype.addTask=function(t,e){t._lid=e.id,this.tasks[t.id]=t},si.prototype.cancelTasks=function(t){var e,i,n=this.tasks;for(i in n)e=n[i],t&&t.id!=e._lid||(e.cancel(),delete n[i])},si.prototype.removeTask=function(t,e){delete this.tasks[t.id]},si.prototype.index=function(t){return this.layers.indexOf(t)},si.prototype.ready=function(t,e){return 2==arguments.length&&(this.r[t]=e)&&(this.luTs=Date.now()),this.r[t]},si.prototype.addLayer=function(t){this.r.splice(t,0,!1),this.p.splice(t,0,void 0)},si.prototype.removeLayer=function(t){this.r.splice(t,1),this.p.splice(t,1)},si.prototype.preview=function(t,e){return 2==arguments.length&&(this.p[t]=e),this.p[t]},si);function si(){this.r=[],this.p=[]}var li,hi=(e(ui,li=ai),ui.prototype.clear=function(t){this.setData(t,oi),this.ready(t,!1),this.preview(t,!1)},ui.prototype.init=function(t,e){li.prototype.init.call(this,t,e),this.data.length=0},ui.prototype.setData=function(t,e){var i="number"==typeof t?t:this.layers.indexOf(t),t=this.data[i];return t&&t.length&&this.onDrop&&this.onDrop(t,i),this.data[i]=e,i},ui.prototype.getData=function(t){return this.data[t]},ui.prototype.addLayer=function(t){li.prototype.addLayer.call(this,t),this.data.splice(t,0,oi)},ui.prototype.removeLayer=function(t){li.prototype.removeLayer.call(this,t),this.setData(t,oi),this.preview(t,oi),this.data.splice(t,1)},ui);function ui(t,e,i){var n=li.call(this)||this;return n.data=[],n.onDrop=i,n.init(t,e),n}ci.prototype.setSize=function(t){this.tiles.setSize(t)},ci.prototype.get=function(t,e){if(e){e=this.tiles._[t];return e&&e.data}return this.tiles.get(t)},ci.prototype.forEach=function(t){return this.tiles.forEach(t)},Zt=ci;function ci(t){this.tiles=new X.LRU(t)}var fi,pi=(e(di,fi=Zt),di.prototype.create=function(t,e){var i,n,r=this.tiles,o=this.onDrop,a=r.get(t);if(!a&&(a=new hi(t,e,o),(i=r.set(t,a))&&(n=i.data))){for(var s=0;s<n.length;s++)i.setData(s,null),i.preview(s,null);i.data=null}return a},di);function di(t){return fi.call(this,t)||this}function vi(t,e,i,n,r,o,a){void 0===a&&(a=0);for(var s=t.z,l=!0,h=0,u=n;h<u.length;h++){var c,f,p=u[h],d=p.type,v=Lt("type",p,e,s);if("Polygon"==v||"Line"==v){if(Lt("stroke",p,e,s)){p.type="Line";for(var y=0,g=i;y<g.length;y++)var m=g[y],l=l&&t.create(e,"LineString",m,[p],r,o.clipped);p.type=d}}else 0==a&&(c=o.bounds,d=(v=[(f=e.bbox)[0]+(f[2]-f[0])/2,f[1]+(f[3]-f[1])/2])[1],(f=v[0])>=c[0]&&d>=c[1]&&f<c[2]&&d<c[3]&&(l=l&&t.create(e,"Point",v,[p],r)))}return l}function yi(t,e,i){var n=i.length,r=2|(t=32*t<<2|1),o=2|(e=32*e<<2|1);return i.push(t,e,t,o,r,o,t,e,r,o,r,e),n+12}function gi(t,e,i,n,r){for(var o=t.length,a=[],s=0,l=0;l<e.length;l++){for(var h,u,c=0;c<e[l].length;c++)h=i.lon2x(e[l][c][0],n),u=i.lat2y(e[l][c][1],n),r?t.push(h,u,r):t.push(h,u);0<l&&(s+=e[l-1].length,a[a.length]=s)}return{dimensions:r?3:2,vertices:t,holes:a,start:o,stop:t.length}}function mi(t,e,i,n,r){if("number"!=typeof e[0][0][0])for(var o=[],a=0,s=e;a<s.length;a++){var l=s[a];o.push(gi(t,l,i,n,r))}else o=[gi(t,e,i,n,r)];return o}function xi(t,e,i){for(var n=0,r=e,o=i-1;r<o;r+=3){var a=t[r],s=t[r+1];n+=(t[r+3]-a)*(s+t[r+4])}return n}function _i(t,e,i,n,r,o,a){for(var s=t.length,r=mi(t,n,r,o,a);s<t.length;)e.push(0,0),s+=3;for(var l=0,h=r;l<h.length;l++)!function(t,e,i,n,r,o){for(var a=t.holes,s=t.vertices,l=t.stop-3,h=t.start,u=0,c=h+3*a[u]-6,f=0<=xi(e.data,h,c?c+3:l);h<l;){var p=void 0,d=void 0,v=void 0,y=void 0;y=f?(g=t.start+l-h,p=s.get(g),v=s.get(1+g),d=s.get(g-3),s.get(g-2)):(p=s.get(h),v=s.get(h+1),d=s.get(h+3),s.get(h+4));var g,m=Math.round(p)-Math.round(d),x=Math.round(v)-Math.round(y);(m||x)&&(U(p,v,0,0,r,r)||U(d,y,0,0,r,r))&&(g=e.length/3,n[n.length]=2+g,n[n.length]=g,n[n.length]=1+g,n[n.length]=3+g,n[n.length]=2+g,n[n.length]=1+g,e.push(p,v,o,p,v,0,d,y,o,d,y,0),y=m*m+x*x,x=x,m=-m,x*=y=127/Math.sqrt(y),m*=y,i.push(x,m,x,m,x,m,x,m)),h==c?(h+=6,c=t.start+3*a[++u]-6,f=xi(e.data,h,c?c+3:l)<0):h+=3}}(h[l],t,e,i,o,a);return r}var wi=X.TaskManager.getInstance(),bi=Math.PI/180,Ti=new Float32Array([-1,-1,-1,-1]),Li=[0,0,1,0,1,1,0,0,1,1,0,1],Ai=Si,R=Si;function Si(t,e,i){i=i||2;var n,r,o,a,s,l=e&&e.length,h=l?e[0]*i:t.length,u=Mi(t,0,h,i,!0),c=[];if(!u||u.next===u.prev)return c;if(l&&(u=function(t,e,i,n){var r,o,a,s,l=[];for(r=0,o=e.length;r<o;r++)a=e[r]*n,s=r<o-1?e[r+1]*n:t.length,(s=Mi(t,a,s,n,!1))===s.next&&(s.steiner=!0),l.push(function(t){var e=t,i=t;for(;(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next,e!==t;);return i}(s));for(l.sort(Ci),r=0;r<l.length;r++)!function(t,e){(e=function(t,e){var i,n=e,r=t.x,o=t.y,a=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var s=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=r&&a<s){if((a=s)===r){if(o===n.y)return n;if(o===n.next.y)return n.next}i=n.x<n.next.x?n:n.next}}}while(n=n.next,n!==e);if(!i)return null;if(r===a)return i;var l,h=i,u=i.x,c=i.y,f=1/0;n=i;for(;r>=n.x&&n.x>=u&&r!==n.x&&Pi(o<c?r:a,o,u,c,o<c?a:r,o,n.x,n.y)&&(l=Math.abs(o-n.y)/(r-n.x),Ni(n,t)&&(l<f||l===f&&(n.x>i.x||n.x===i.x&&function(t,e){return ki(t.prev,t,e.prev)<0&&ki(e.next,t,t.next)<0}(i,n)))&&(i=n,f=l)),n=n.next,n!==h;);return i}(t,e))&&(t=Fi(e,t),zi(e,e.next),zi(t,t.next))}(l[r],i),i=zi(i,i.next);return i}(t,e,u,i)),t.length>80*i){for(var f=n=t[0],p=r=t[1],d=i;d<h;d+=i)(o=t[d])<f&&(f=o),(a=t[d+1])<p&&(p=a),n<o&&(n=o),r<a&&(r=a);s=0!==(s=Math.max(n-f,r-p))?1/s:0}return Ei(u,c,i,f,p,s),c}function Mi(t,e,i,n,r){var o,a;if(r===0<Gi(t,e,i,n))for(o=e;o<i;o+=n)a=Bi(o,t[o],t[o+1],a);else for(o=i-n;e<=o;o-=n)a=Bi(o,t[o],t[o+1],a);return a&&Di(a,a.next)&&(Wi(a),a=a.next),a}function zi(t,e){if(!t)return t;e=e||t;var i,n=t;do{if(i=!1,n.steiner||!Di(n,n.next)&&0!==ki(n.prev,n,n.next))n=n.next;else{if(Wi(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}function Ei(t,e,i,n,r,o,a){if(t){!a&&o&&function(t,e,i,n){var r=t;for(;null===r.z&&(r.z=Ii(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next,r!==t;);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,i,n,r,o,a,s,l,h=1;do{for(i=t,o=t=null,a=0;i;){for(a++,n=i,e=s=0;e<h&&(s++,n=n.nextZ);e++);for(l=h;0<s||0<l&&n;)0!==s&&(0===l||!n||i.z<=n.z)?(i=(r=i).nextZ,s--):(n=(r=n).nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=n}}while(o.nextZ=null,h*=2,1<a)}(r)}(t,n,r,o);for(var s,l,h=t;t.prev!==t.next;)if(s=t.prev,l=t.next,o?function(t,e,i,n){var r=t.prev,o=t,a=t.next;if(0<=ki(r,o,a))return!1;var s=(r.x<o.x?r.x<a.x?r:a:o.x<a.x?o:a).x,l=(r.y<o.y?r.y<a.y?r:a:o.y<a.y?o:a).y,h=(r.x>o.x?r.x>a.x?r:a:o.x>a.x?o:a).x,u=(r.y>o.y?r.y>a.y?r:a:o.y>a.y?o:a).y,c=Ii(s,l,e,i,n),f=Ii(h,u,e,i,n),p=t.prevZ,d=t.nextZ;for(;p&&p.z>=c&&d&&d.z<=f;){if(p!==t.prev&&p!==t.next&&Pi(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&0<=ki(p.prev,p,p.next))return!1;if(p=p.prevZ,d!==t.prev&&d!==t.next&&Pi(r.x,r.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=ki(d.prev,d,d.next))return!1;d=d.nextZ}for(;p&&p.z>=c;){if(p!==t.prev&&p!==t.next&&Pi(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&0<=ki(p.prev,p,p.next))return!1;p=p.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&Pi(r.x,r.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=ki(d.prev,d,d.next))return!1;d=d.nextZ}return!0}(t,n,r,o):function(t){var e=t.prev,i=t,n=t.next;if(0<=ki(e,i,n))return!1;var r=t.next.next;for(;r!==t.prev;){if(Pi(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)&&0<=ki(r.prev,r,r.next))return!1;r=r.next}return!0}(t))e.push(s.i/i),e.push(t.i/i),e.push(l.i/i),Wi(t),t=l.next,h=l.next;else if((t=l)===h){a?1===a?Ei(t=function(t,e,i){var n=t;do{var r=n.prev,o=n.next.next}while(!Di(r,o)&&Ri(r,n,n.next,o)&&Ni(r,o)&&Ni(o,r)&&(e.push(r.i/i),e.push(n.i/i),e.push(o.i/i),Wi(n),Wi(n.next),n=t=o),n=n.next,n!==t);return zi(n)}(zi(t),e,i),e,i,n,r,o,2):2===a&&function(t,e,i,n,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&function(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Ri(i,i.next,t,e))return!0}while(i=i.next,i!==t);return!1}(t,e)&&(Ni(t,e)&&Ni(e,t)&&function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next,i!==t;);return n}(t,e)&&(ki(t.prev,t,e.prev)||ki(t,e.prev,e))||Di(t,e)&&0<ki(t.prev,t,t.next)&&0<ki(e.prev,e,e.next))}(a,s)){var l=Fi(a,s);return a=zi(a,a.next),l=zi(l,l.next),Ei(a,e,i,n,r,o),Ei(l,e,i,n,r,o)}s=s.next}}while(a=a.next,a!==t)}(t,e,i,n,r,o):Ei(zi(t),e,i,n,r,o,1);break}}}function Ci(t,e){return t.x-e.x}function Ii(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Pi(t,e,i,n,r,o,a,s){return 0<=(r-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(n-s)-(i-a)*(e-s)&&0<=(i-a)*(o-s)-(r-a)*(n-s)}function ki(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function Di(t,e){return t.x===e.x&&t.y===e.y}function Ri(t,e,i,n){var r=Oi(ki(t,e,i)),o=Oi(ki(t,e,n)),a=Oi(ki(i,n,t)),s=Oi(ki(i,n,e));return r!==o&&a!==s||(0===r&&Ui(t,i,e)||(0===o&&Ui(t,n,e)||(0===a&&Ui(i,t,n)||!(0!==s||!Ui(i,e,n)))))}function Ui(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Oi(t){return 0<t?1:t<0?-1:0}function Ni(t,e){return ki(t.prev,t,t.next)<0?0<=ki(t,e,t.next)&&0<=ki(t,t.prev,e):ki(t,e,t.prev)<0||ki(t,t.next,e)<0}function Fi(t,e){var i=new Xi(t.i,t.x,t.y),n=new Xi(e.i,e.x,e.y),r=t.next,o=e.prev;return(t.next=e).prev=t,(i.next=r).prev=i,(n.next=i).prev=n,(o.next=n).prev=o,n}function Bi(t,e,i,n){i=new Xi(t,e,i);return n?(i.next=n.next,(i.prev=n).next.prev=i,n.next=i):(i.prev=i).next=i,i}function Wi(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Xi(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Gi(t,e,i,n){for(var r=0,o=e,a=i-n;o<i;o+=n)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}Si.deviation=function(t,e,i,n){var r=e&&e.length,o=r?e[0]*i:t.length,a=Math.abs(Gi(t,0,o,i));if(r)for(var s=0,l=e.length;s<l;s++){var h=e[s]*i,u=s<l-1?e[s+1]*i:t.length;a-=Math.abs(Gi(t,h,u,i))}for(var c=0,s=0;s<n.length;s+=3){var f=n[s]*i,p=n[s+1]*i,d=n[s+2]*i;c+=Math.abs((t[f]-t[d])*(t[1+p]-t[1+f])-(t[f]-t[p])*(t[1+d]-t[1+f]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},Si.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var a=0;a<e;a++)i.vertices.push(t[r][o][a]);0<r&&(n+=t[r-1].length,i.holes.push(n))}return i},Ai.default=R;var Zi=(Hi.prototype.create=function(t){var e=t.reduce(function(t,e){return t+e})*(t.length%2+1);e*=Math.ceil(512/e);for(var i=new Uint8Array(e),n=!0,r=0;r<e;)for(var o=0,a=t;o<a.length;o++){var s=a[o];n&&i.fill(255,r,r+s),r+=s,n=!n}return new It(this.gl,{width:i.length,height:1,pixels:i},this.gl.LUMINANCE)},Hi.prototype.get=function(t){var e=String(t);return this.data[e]||(this.data[e]=this.create(t))},Hi);function Hi(t){this.data={},this.gl=t}var Yi=(ji.prototype.setMinDistance=function(t){return this.sqDistance=t*t},ji.prototype.add=function(t,e){var i=this.points;i[this.length++]=t,i[this.length++]=e},ji.prototype.clear=function(){this.length=0,this.points.length=0},ji.prototype.hasSpace=function(t,e){var i=this.length,n=this.points,r=this.sqDistance,o=0;if(r)for(;o<i;){var a=t-n[o++],s=e-n[o++];if(a*a+s*s<r)return!1}return!0},ji);function ji(t){void 0===t&&(t=256),this.length=0,this.points=[],this.sqDistance=this.setMinDistance(t)}var qi=180/Math.PI,Vi=(Ki.prototype.getDistanceGrp=function(){return this.repeat[this.dId]},Ki.prototype.projectLine=function(t,e,i){var n=this.pixels,r=this.decimals;if(!this.length){for(var o=0,a=0,s=0,l=t.length,h=void 0,u=void 0;s<l;s++){var c,f,p=e.lon2x(t[s][0],i),d=e.lat2y(t[s][1],i);(!s||Math.round(h*r)-Math.round(p*r)||Math.round(u*r)-Math.round(d*r))&&(n[o++]=p,n[o++]=d,2<o&&(c=h-p,f=u-d,a+=Math.sqrt(c*c+f*f))),h=p,u=d}this.length=o,this.lineLength=a}return this.length},Ki.prototype.initTile=function(){var t,e=this.repeat;for(t in e)e[t].clear()},Ki.prototype.initFeature=function(t,e,i){this.decimals=t>=20-Number(512==e)?100:1,this.length=0,this.collisions=null;e=this.repeat;(this.dId=i)&&!e[i]&&(e[i]=new Yi)},Ki.prototype.createLine=function(t,e,i,n,r,o,a,s,l,h,u,c){o&&(e.texture=this.dashes.get(o)),e.buffer||(e.buffer=new Ge);e=e.buffer;this.projectLine(t,i,n),Le(e.attributes.a_position.data,e.attributes.a_normal.data,this.pixels,this.length,this.lineLength,n,r,a,s,l,o&&e.attributes.a_lengthSoFar.data,h,u,c)},Ki.prototype.placeAtSegments=function(t,e,i,n,r,o,a,s,l,h,u,c,f){this.projectLine(t,e,i),null!==(t=this.getDistanceGrp())&&void 0!==t&&t.setMinDistance(null==o?256:o),this.placeAlongLine(e,i,n,r,a,s,l,h,u,c,f)},Ki.prototype.placeAtPoints=function(t,e,i,n,r,o,a,s,l,h){if(this.projectLine(t,e,i),this.collisions)for(var u=0,c=this.collisions;u<c.length;u++){var f=c[u];h(f.cx,f.cy,0,f)}else{for(var p=n&&[],d=0,v=this.pixels,y=this.length;d<y;d++){var g,m=v[d],x=v[++d],_=void 0;0<=m&&0<=x&&m<i&&x<i&&(g=void 0,p&&((g=this.getDistanceGrp())&&!g.hasSpace(m,x)||(_=n.insert(m,x,s,l,o,a,e,i,r))&&p.push(_)),p&&!_||(h(m,x,0,_),null!=g&&g.add(m,x)))}null!=p&&p.length&&(this.collisions=p)}},Ki.prototype.placeAlongLine=function(t,e,i,n,r,o,a,s,l,h,u){if(this.collisions)for(var c,f=0;f<this.collisions.length;f++)u((c=this.collisions[f]).cx,c.cy,l?this.alpha[f]:0,c);else{for(var p,d,v,y,g,m=i&&[],x=this.length/2,_=this.pixels,w=Math.pow(2*r+a,2),b=Math.floor(x/2)-1,T=1,L=_[2*b],A=_[2*b+1],S=L,M=A,f=1;f<x;f++){var z,E,C,I,P,k,D,R,U=b+T*f;x<=U&&(T=-1,U=b-1,b=x-1,L=S,A=M),p=_[2*U],g=.5*(P=(d=_[2*U+1])-A)+A,0<=(y=.5*(v=p-L)+L)&&0<=g&&y<e&&g<e&&w<(h?v*v+P*P:1/0)&&(z=Math.atan2(P,v),-1==T&&(z+=Math.PI),R=E=void 0,m&&((R=this.getDistanceGrp())&&!R.hasSpace(y,g)||(k=a,D=s,C=r,I=o,l&&z&&(k=(U=O(z,a,s,y,g))[2]-U[0],D=U[3]-U[1],r&&(C=(I=Math.sin(z)*r)*v/P),o&&(P=Math.PI-z,C+=Math.sin(P)*-o,I+=Math.cos(P)*-o)),(E=i.insert(y,g,C,I,k/2,D/2,t,e,n))&&(this.alpha[m.length]=z*qi,m.push(E)))),m&&!E||(u(y,g,l?z*qi:0,E),null!=R&&R.add(y,g))),L=p,A=d}null!=m&&m.length&&(this.collisions=m)}},Ki);function Ki(t){this.length=0,this.dashes=new Zi(t),this.gl=t,this.pixels=new Float32Array(262144),this.alpha=new Float32Array(131072),this.repeat={}}var Qi,Ji=(e($i,Qi=gt),$i);function $i(){var t=Qi.call(this,!1)||this;return t.attributes={a_position:{data:new Ce(Uint16Array),size:2},a_point:{data:new Ce(Int16Array),size:2},a_texcoord:{data:new Ce(Uint16Array),size:2}},t.first=0,t}var tn,en=(e(nn,tn=gt),nn);function nn(){var t=tn.call(this,!1)||this;return t.attributes={a_position:{data:new Ce(Uint16Array),size:2},a_size:{data:new Ce(Uint8Array),size:2},a_texcoord:{data:new Ce(Uint16Array),size:2}},t.first=0,t}var rn,on=(e(an,rn=gt),an);function an(){var t=rn.call(this,!1)||this;return t.attributes={a_position:{data:new Ce(Uint16Array),size:2}},t.first=0,t}var sn,ln=(e(hn,sn=gt),hn);function hn(){var t=sn.call(this,!0)||this;return t.attributes={a_position:{data:new Ce(Float32Array),size:2}},t.first=0,t}var un,cn=(e(fn,un=gt),fn);function fn(){var t=un.call(this,!0)||this;return t._flat=!1,t.attributes={a_position:{data:new Ce(Float32Array),size:3},a_normal:{data:new Ce(Int8Array),size:2,normalized:!0}},t.first=0,t}var pn,dn=new Map;[[pn,pn,pn],[pn,pn,65154],[pn,pn,65156],[pn,pn,65158],[pn,pn,65160],[65163,65164,65162],[pn,pn,65166],[65169,65170,65168],[pn,pn,65172],[65175,65176,65174],[65179,65180,65178],[65183,65184,65182],[65187,65188,65186],[65191,65192,65190],[pn,pn,65194],[pn,pn,65196],[pn,pn,65198],[pn,pn,65200],[65203,65204,65202],[65207,65208,65206],[65211,65212,65210],[65215,65216,65214],[65219,65220,65218],[65223,65224,65222],[65227,65228,65226],[65231,65232,65230],pn,pn,pn,pn,pn,[1600,1600,1600],[65235,65236,65234],[65239,65240,65238],[65243,65244,65242],[65247,65248,65246],[65251,65252,65250],[65255,65256,65254],[65259,65260,65258],[pn,pn,65262],[pn,pn,65264],[65267,65268,65266]].forEach(function(t,e){dn.set(1569+e,t&&{initial:t[0],medial:t[1],final:t[2]})}),dn.set(1662,{initial:64344,medial:64345,final:64343}),dn.set(1740,{initial:64510,medial:64511,final:64509}),dn.set(1670,{initial:64380,medial:64381,final:64379}),dn.set(1705,{initial:64400,medial:64401,final:64399}),dn.set(1711,{initial:64404,medial:64405,final:64403}),dn.set(1688,{final:64395});function vn(t,e,i){for(var n,r=0<i?t.length-e:e+1,o=1;o<r;o++)if(n=t.charCodeAt(e+i*o),!gn.has(n))return{cp:n,map:dn.get(n)}}var yn,gn=new Set([1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773]),mn={1570:{isolated:65269,final:65270},1571:{isolated:65271,final:65272},1573:{isolated:65273,final:65274},1575:{isolated:65275,final:65276}},xn=(_n.prototype.init=function(t,e,i,n){this.tile=t,this.groups=e,this.tileSize=i,this.z=n,this.lineFactory.initTile(),this.pendingCollisions.length=0},_n.prototype.createPoint=function(t,e,i,n,r,o,a,s,l,h){var u=this.z;if(s=((s=void 0===s?0:s)+360)%360,"Text"==t){e.texture||(e.texture=new Fe(this.gl,e.shared),e.buffer=new Ji);var c=e.texture,f=e.buffer.attributes;c.addChars(l);var p=c.getAtlas(),d=Lt("lineWrap",r,o,u),v=T(l,d=d==yn?h:d),y=f.a_texcoord,c=(d=f.a_texcoord.data.length)+c.bufferLength(l);(function(t,e,i,n,r,o,a,s){void 0===s&&(s=0);var l=i.length,h=a.lineHeight,u=32*(a.baselineOffset+(l-1)*h*.5);t*=128,e*=128,s=Math.round(512*s/360);for(var c=0,f=i;c<f.length;c++){var p=f[c],d=r.length,p=De(p,a,s,n,o),v=p.width*a.scale/2*32,p=2*p.count;r.reserve(p);for(var y=n.data,g=r.data,m=d+p;d<m;d+=2)y[d]-=v,y[d+1]-=u,g[d]=t,g[d+1]=e;r.length+=p,u-=32*h}})(i,n,v,f.a_point.data,f.a_position.data,f.a_texcoord.data,p,s)}else{if("Icon"==t){e.buffer||(e.buffer=new en),y=e.buffer.attributes.a_position;v=Lt("src",r,o,u),p=Lt("width",r,o,u),u=Lt("height",r,o,u)||p,f=e.buffer.attributes,v=this.icons.get(v,p,u);if(!v)return void(this.iconsLoaded=!1);!function(t,e,i,n,r,o,a,s,l){void 0===l&&(l=0);var h=i.u1,u=i.u2,c=i.v1,i=i.v2;yi(t,e,a);a=(l=Math.round(1024*l/360))>>5,l&=31,h=h<<5|l,u=u<<5|l,c=c<<5|a,i=i<<5|a;o.push(n,r,n,r,n,r,n,r,n,r,n,r),s.push(h,i,h,c,u,c,h,i,u,c,u,i)}(i,n,v,p,u,f.a_size.data,y.data,f.a_texcoord.data,s),e.texture=this.icons.getTexture()}else{if("Circle"!=t&&"Rect"!=t)return;e.buffer||(e.buffer=new on),y=e.buffer.attributes.a_position,yi(i,n,y.data)}d=(c=y.data.length)-12}a&&y&&a.attrs.push({buffer:y,start:d,stop:c})},_n.prototype.create=function(r,t,e,i,n,o,a,s){var l,h,u,c,f,p,d,v,y,g,m,x,_,w,b,T,L,A=this,S=this.tile,M=this.groups,z=this.tileSize,E=this.z,C=Number.MAX_SAFE_INTEGER,I=-Number.MAX_SAFE_INTEGER,P="";if(this.iconsLoaded=!0,this.lineFactory.initFeature(E,z,null==s?void 0:s.id),a===yn&&"Point"===t&&!S.isInside(e))return this.iconsLoaded;for(var k,D,R,U,O,N=0,F=i.length;N<F;N++)if(u=i[N],(c=Lt("type",u,r,E))&&0!==(f=Lt("opacity",u,r,E))){var B="Polygon"==t||Lt("collide",u,r,E);if(a!=yn||("Text"!=c||B)&&!1!==B){if((f==yn||.98<=f)&&(f=1),"Image"==c&&(c="Icon"),Q=n,Z="px",$=V=b=x=m=Y=H=W=G=y=d=J=tt=p=yn,v=(w=j=0)^Lt("rotation",u,r,E),"Icon"==c)j=0^Lt("offsetX",u,r,E),w=0^Lt("offsetY",u,r,E),V=Lt("alignment",u,r,E)||"viewport",q="I"+j+w;else{if(J=Lt("stroke",u,r,E),G=Lt("strokeWidth",u,r,E),"Line"==c){if(!J||!G)continue;var W,X=bt(G),G=X[0],Z=X[1],H=Lt("strokeLinecap",u,r,E)||"round",Y=Lt("strokeLinejoin",u,r,E)||"round";(W=Lt("strokeDasharray",u,r,E))instanceof Array&&W.length&&W[0]||(W=yn);var j,X=Lt("offset",u,r,E),q="L"+Z+(j=(X=bt(X))[0])+($=X[1])+H+Y+(W||"*")}else if(tt=Lt("fill",u,r,E),"Polygon"==c){if(!tt||"Polygon"!=t)continue;(g=Lt("extrude",u,r,E))?(q="E",c="Extrude"):q="P"}else{if("Polygon"==t)continue;if(V=Lt("alignment",u,r,E),"Text"==c){if(!(b=wt(u,r,E)))continue;b=function(t){if(!/[\u0600-\u06FF]/.test(t))return t;for(var e="",i=0;i<t.length;++i){var n,r,o,a,s=t.charCodeAt(i);dn.has(s)&&(!(n=null===(a=vn(t,i,-1))||void 0===a?void 0:a.map)||n.initial||n.medial||(n=pn),!(o=null==(r=vn(t,i,1))?void 0:r.map)||o.medial||o.final||(o=pn),a=void 0,(a=1604==s&&mn[null==r?void 0:r.cp])?(s=n?a.final:a.isolated,i++):(a=dn.get(s),n&&o&&a.medial?s=a.medial:n&&a.final?s=a.final:o&&a.initial&&(s=a.initial))),e+=String.fromCharCode(s)}return e}(b),p=Lt("font",u,r,E)||xt,V==yn&&(V="Point"==t?"viewport":"map"),q="T"+(p||"*")}else if("Circle"==c)m=x=Lt("radius",u,r,E),m=(X=bt(m))[0],q="C"+(Z=X[1])+m||"*";else{if("Rect"!=c)continue;m=Lt("width",u,r,E),m=(l=bt(m))[0],Z=l[1],x=(x=Lt("height",u,r,E))?bt(x)[0]:m,q="R"+v+Z+m+x}j=Lt("offsetX",u,r,E),w=Lt("offsetY",u,r,E),$=new Array(2),j=(l=bt(j))[0],$[0]=l[1],w=(l=bt(w))[0],$[1]=l[1],q+=j+$[0]+w+$[1]}tt&&((d=_t(tt))?d[3]*=f:tt=null),J&&((y=_t(J))?y[3]*=f:J=null,"Text"==c&&(Q=1),("number"!=typeof G||(G*=Q)<0)&&(G=1)),q+=(J||"*")+(G||"*")+(tt||"*")}q+=100*f^0;var V,K,Q=Lt("zIndex",u,r,E),J=Lt("zLayer",u,r,E);if(null!=J&&(q=J+":"+q),Q=(tt=M[Q]=M[Q]||[])[q],_=Q==yn?(Q=tt[q]=tt.length,tt[Q]={type:c,zLayer:J,shared:{unit:Z,font:p,fill:d,opacity:f,stroke:y,strokeWidth:G,strokeLinecap:H,strokeLinejoin:Y,strokeDasharray:W,width:m,height:x,rotation:v,offsetX:j,offsetY:w,offsetUnit:$,alignment:V}}):tt[Q],"Point"==t){var $=S.lon2x(e[0],z),tt=S.lat2y(e[1],z),Q=void 0;if(s){if(!(Q=this.collisions.insert($,tt,s.offsetX,s.offsetY,s.width,s.height,S,z,s.priority)))return this.iconsLoaded;s=null}this.createPoint(c,_,$,tt,u,r,Q,v,b)}else if("LineString"==t)"Line"==c?this.lineFactory.createLine(e,_,S,z,o,W,H,Y,G,j,Lt("from",u,r,E),Lt("to",u,r,E)):(H=Lt("anchor",u,r,E),Y="Text"==c?!B:!1===B,B=G=void 0,"Line"==(H=H==yn?"Text"==c?"Line":"Coordinate":H)?(V="map"==V,s?(G=2*s.width,B=2*s.height):"Icon"==c?(G=Lt("width",u,r,E),B=Lt("height",u,r,E)||m):"Text"==c?((K=_.texture)||(K=_.texture=new Fe(this.gl,u),_.buffer=new Ji),G=(K=K.getAtlas()).getTextWidth(b),B=K.letterHeight):(G=m,B=x,"Circle"==c&&(G*=2,B*=2)),(K=Lt("checkLineSpace",u,r,E))==yn&&(K=!0),this.lineFactory.placeAtSegments(e,S,z,Y&&this.collisions,a,Lt("repeat",u,r,E),j,w,G,B,V,K,function(t,e,i,n){A.createPoint(c,_,t,e,u,r,n,i+v,b,!1)})):(B=s?(G=s.width,s.height):(G=m/2,x/2),this.lineFactory.placeAtPoints(e,S,z,Y&&this.collisions,a,G,B,j,w,function(t,e,i,n){A.createPoint(c,_,t,e,u,r,n,i+v,b)})));else if("Polygon"==c||"Extrude"==c){_.buffer||(_.buffer=new("Polygon"==c?ln:cn));var et=_.buffer,it=et.index(),nt=et.attributes,rt=nt.a_position.data,ot=rt.length;if("Extrude"==c?h=_i(rt,nt.a_normal.data,it,e,S,z,g):"Polygon"==c&&(h=mi(rt,e,S,z)),!st){var at=r.geometry;if(at._xyz)st=at._xyz;else{for(var st=[],lt=0,ht=h;lt<ht.length;lt++)for(var ut=ht[lt],ct=ut.dimensions,ft=rt.data.subarray(ut.start,ut.stop),ft=Ai(ft,ut.holes,ct),pt=(ut.start-ot)/ct,dt=0,vt=ft;dt<vt.length;dt++){var yt=vt[dt];st.push(pt+yt)}S.clipped||(at._xyz=st)}}for(var gt,yt=0,mt=ot/h[0].dimensions;yt<st.length;yt++)gt=mt+st[yt],et.i32=et.i32||65535<gt,it.push(gt)}}else{nt=Tt(u,r,E,this.dpr,L);nt&&(L=nt||L,(T=T||[]).push(u),(at=Lt("priority",u,r,E))<C&&(C=at),I<(nt=Lt("repeat",u,r,E))&&(I=nt),P+=c+(at||"?")+(nt||"?"))}}return T&&(D=L[0],R=L[1],U=.5*(L[2]-D),O=.5*(L[3]-R),(k={id:P,priority:C,repeat:I,styleGrp:T,feature:r,geomType:t,coordinates:e}).offsetX=D+U,k.offsetY=R+O,k.width=U,k.height=O,this.pendingCollisions.push(k)),this.iconsLoaded},_n);function _n(t,e,i,n){this.pendingCollisions=[],this.gl=t,this.icons=e,this.dpr=n,this.dashes=new Zi(t),this.collisions=i,this.lineFactory=new Vi(t)}var wn=(bn.prototype.getTileCacheKey=function(t,e){return 256==e.tileSize?t.slice(0,-1):t},bn.prototype.getDataKey=function(t,e){return e.id+"-"+t},bn.prototype.intersects=function(t,e,i){void 0===i&&(i=0);for(var n,r=e.length;i<r;i++)if(n=e[i],t.minX<=n.maxX&&n.minX<=t.maxX&&t.minY<=n.maxY&&n.minY<=t.maxY)return!0},bn.prototype.initTile=function(t,e){var i=[],n=t.quadkey,r=t.x,o=t.y,a=t.z;this.clearTile(n,e),256==e.tileSize&&(a--,o=.5*o^0,r=.5*r^0);for(var s=-1;s<2;s++)for(var l=-1;l<2;l++)if(0!=l||0!=s){var h=A.tileUtils.tileXYToQuadKey(a,o+s,r+l),u=this.tiles.get(h);if(u)for(var c in u)for(var f=0,p=u[c];f<p.length;f++){var d=p[f];i[i.length]=d}}t=this.getTileCacheKey(n,e);this.curLayerTileCollision={tileKey:t,data:[],dataKey:this.getDataKey(n,e),existing:v({neighbours:i},this.tiles.get(t)||{})},this.updated=!1},bn.prototype.insert=function(t,e,i,n,r,o,a,s,l){void 0===l&&(l=Number.MAX_SAFE_INTEGER);var h=a.x*s,u=a.y*s,c=h+t-r,f=h+t+r,r=u+e-o,o=u+e+o;256==s&&(t-=512*(.5*a.x^0)-h,e-=512*(.5*a.y^0)-u);var p,d={cx:t+i,cy:e+n,offsetX:i,offsetY:n,minX:c-3,maxX:f+3,minY:r-3,maxY:o+3,priority:l,attrs:[]},o=this.curLayerTileCollision,l=o.data,v=o.existing;if(this.intersects(d,l))return!1;for(p in v)if(this.intersects(d,v[p]))return!1;return d.cx-=i,d.cy-=n,this.updated=!0,l.push(d),d},bn.prototype.completeTile=function(){this.updated&&(this.rx=this.rz=this.s=null);var t=this.curLayerTileCollision,e=t.tileKey,i=t.dataKey,n=t.data,t=this.tiles.get(e)||{};t[i]=n,this.tiles.set(e,t),this.curLayerTileCollision=null},bn.prototype.clearTile=function(t,e){var i=this.getTileCacheKey(t,e),t=this.getDataKey(t,e);if((null===(e=this.curLayerTileCollision)||void 0===e?void 0:e.dataKey)!=t){e=this.tiles.get(i);if(e){for(var n in delete e[t],e)return;this.tiles.delete(i)}}},bn.prototype.update=function(t,e,i,n){if(this.rx!=e||this.rz!=i||this.s!=n){this.rx=e,this.rz=i,this.s=n;for(var r=this.display,o=[],a=0,s=t;a<s.length;a++){var l=s[a],h=l.quadkey,u=this.tiles.get(h);if(u)for(var c in u)for(var f=u[c],p=0;p<f.length;p++){var d=(b=f[p]).attrs,v=b.minX,y=b.maxX,g=b.minY,m=.5*(y-v),y=.5*(b.maxY-g),v=l.x+b.cx,g=l.y+b.cy,g=r.project(v+b.offsetX/n,g+b.offsetY/n,0,0);o.push({minX:g[0]-m,maxX:g[0]+m,minY:g[1]-y,maxY:g[1]+y,attrs:d,priority:b.priority})}}o.sort(function(t,e){return t.priority-e.priority});for(var x=[],_=0,w=o;_<w.length;_++){var b=w[_],T=this.intersects(b,x);T||x.push(b);for(var L=0,A=b.attrs;L<A.length;L++){var S=A[L],M=S.buffer,z=S.start,E=S.stop,C=M.data,I=M.size,S=1==(1&C[z]);if(T&&S||!T&&!S){for(;z<E;)C[z]^=1,z+=I;M.dirty=!0}}}}},bn.prototype.removeTiles=function(t){var i=t.id;this.tiles.forEach(function(t){for(var e in t)Number(e.split("-")[0])==i&&delete t[e]})},bn);function bn(t){this.tiles=new Map,this.display=t}var Tn,Ln=[3,9],An=(e(Sn,Tn=vt),Sn.prototype.releaseBuffers=function(t){var e=this.render;if(t)for(var i=0,n=t;i<n.length;i++){var r=n[i];e.deleteBuffer(r)}},Sn.prototype.removeLayer=function(t){return this.collision.removeTiles(this.layers.get(t)),Tn.prototype.removeLayer.call(this,t)},Sn.prototype.unproject=function(t,e){var i=this.render.invScreenMat,n=[t,e,0],t=[t,e,1];je(n,n,i),je(t,t,i);e=n[2],i=t[2],e=e===i?0:(0-e)/(i-e);return[n[0]*(1-e)+t[0]*e,n[1]*(1-e)+t[1]*e]},Sn.prototype.project=function(t,e,i,n){n=[t-(i=void 0===i?this.sx:i),e-(n=void 0===n?this.sy:n),0];return je(n,n,this.render.screenMat)},Sn.prototype.setSize=function(t,e){Tn.prototype.setSize.call(this,t,e),this.render.gl&&this.render.initView(this.w,this.h,this.s,this.rx,this.rz)},Sn.prototype.setTransform=function(t,e,i){var n;this.s==t&&this.rz==e&&this.rx==i||(this.s=t,this.rz=e,this.rx=i,n=2*Math.PI,this.render.initView(this.w,this.h,t,i,e=(e+n)%n))},Sn.prototype.prepareTile=function(t,e,i,n,r){var o,a,y,s,g,T,l,m,x,_,L,h,u,c,f,p=this,d=this,v=d.render.gl,w=i.tileSize,b=this.layers.get(i.id);"image"==t.type?(h=e,u=v,c=w,f=new _e({first:0,count:6},"Image"),(v=new Int16Array(12))[0]=0,v[1]=0,v[2]=c,v[3]=0,v[4]=c,v[5]=c,v[6]=0,v[7]=0,v[8]=c,v[9]=c,v[10]=0,v[11]=c,f.addAttribute("a_position",{data:v,size:2,stride:0}),f.addAttribute("a_textureCoord",{data:new Int8Array(Li),size:2,stride:0}),f.texture=new zt(u,h),f.addUniform("u_sampler",0),f.zIndex=0,f.scissor=!0,b.addZ((f=f).zIndex),n.preview(n.setData(i,[f]),null),r(n,i)):e.length?(a=e,y=b,s=w,g=t,T=this.factory,l=function(){d.collision.initTile(t,b)},m=function(t,e){n.removeTask(o,i),n.preview(n.setData(i,t),null),e||d.tilesNotReady.push({quadkey:n.quadkey,layerId:i.id}),p.dirty=!0,d.collision.completeTile(),r(n,i)},x=y.layer,_={},L=!0,w=wi.create({time:4,priority:4,init:function(){var t=g.z+x.levelOffset,e=x.getStyle(),i=1;return!e||(e=e.strokeWidthZoomScale||e.LineStringZoomScale)&&(i=e(t)),l&&l(),T.init(g,_,s,t),[g,a,i,0,16,x,t,!1]},name:"createBuffer",onDone:function(t){var e,i,t=t[6],n=Math.pow(2,17-t),r=1/A.webMercator.getGroundResolution(t),o=[];for(i in _)if(e=_[i])for(var a=0;a<e.length;a++){var s,l,h,u,c,f=(u=e[a]).type,p=(h=u.shared).stroke,d=h.strokeWidth,v=u.buffer;"Text"==f&&!u.texture||!v||v.isEmpty()||null==(c=v.finalize(f))||(o.push(c),"Line"==f?(h.strokeDasharray&&(c.type="DashedLine",c.texture=u.texture,c.addUniform("u_texWidth",u.texture.width),c.addUniform("u_pattern",0)),c.addUniform("u_fill",p),c.addUniform("u_strokeWidth",[.5*d,"m"==h.unit?r:0]),c.addUniform("u_offset",[h.offsetX,"m"==h.offsetUnit?r:0]),c.alpha=1):"Polygon"==f||"Extrude"==f?(c.addUniform("u_fill",h.fill),"Extrude"==f&&(c.addUniform("u_zoom",n),c.scissor=!1)):"Text"==f||"Icon"==f?(c.scissor=v.scissor,c.texture=u.texture,"Text"==f?(c.texture.sync(),c.addUniform("u_fillColor",h.fill||Ti),c.addUniform("u_strokeColor",h.stroke||Ti)):c.addUniform("u_opacity",h.opacity),c.addUniform("u_texture",0),c.addUniform("u_atlasScale",1/c.texture.width),c.addUniform("u_alignMap","map"==h.alignment),c.addUniform("u_offset",[h.offsetX,h.offsetY])):"Rect"!=f&&"Circle"!=f||(c.scissor=v.scissor,s=h.fill||Ti,c.addUniform("u_fill",s),p&&(c.addUniform("u_stroke",p),null==d&&(d=1)),c.addUniform("u_strokeWidth",0^d),l="m"==h.unit?r:0,"Circle"==f?c.addUniform("u_radius",[h.width,l]):(s==Ti&&(c.alpha=1,c.blend=!0),c.addUniform("u_size",[h.width,l,h.height,l]),c.addUniform("u_rotation",h.rotation*bi)),c.addUniform("u_alignMap","map"==h.alignment),c.addUniform("u_offset",[h.offsetX,"m"==h.offsetUnit[0]?r:0,h.offsetY,"m"==h.offsetUnit[1]?r:0])),l=h.fill&&h.fill[3],h=h.stroke&&h.stroke[3],(h=(l=l<1)||h<1)&&(c.alpha=l&&"Extrude"==f?2:1,c.blend=!0,c.depth=!0),u=u.zLayer,"top"==i&&(u=1/0,i=0),i=Number(i),c.flat=v.isFlat(),y.addZ(i,!c.flat),c.zIndex=i,c.zLayer="number"==typeof u?Math.ceil(u):null,null==c.scissor&&(c.scissor=!g.clipped||0<x.getMargin()||h))}m(o.reverse(),L)},exec:function(t){var e,i,n,r=t[0],o=t[1],a=t[2],s=t[5],l=o.length,h=t[6],u=!1;if(!t[7]){for(;t[4]--&&(i=o[t[3]++]);)if(e=s.getStyleGroup(i,h)){n=i.geometry.type,e.length||(e=[e]),J(e);var c=i.getProvider().decCoord(i),f=!0;if("MultiLineString"==n||"MultiPoint"==n)for(var p="MultiPoint"==n?"Point":"LineString",d=0,v=c;d<v.length;d++)var y=v[d],f=f&&T.create(i,p,y,e,a);else if("MultiPolygon"==n){f=T.create(i,"Polygon",c,e,a);for(var g=0;g<c.length;g++){var m=c[g];f=f&&vi(T,i,m,e,a,r,g)}}else f=T.create(i,n,c,e,a),"Polygon"==n&&(f=f&&vi(T,i,c,e,a,r));L=L&&f}u=t[3]<l}if(!u&&T.pendingCollisions.length){t[7]||(t[7]=T.pendingCollisions.sort(function(t,e){return t.priority-e.priority}),t[3]=0);var x,_=t[7];if(0<=t[4])for(;t[4]--&&(x=_[t[3]++]);){var c=x.coordinates,w=x.priority,b=x.geomType;"Point"!=b&&"LineString"!=b||(w=T.create(x.feature,b,c,x.styleGrp,a,!1,w,x),L=L&&w)}u=t[3]<_.length}return t[4]=16,u}}),wi.start(w),n.addTask(o=w,i)):(n.preview(n.setData(i,[]),null),r(n,i))},Sn.prototype.orderBuffers=function(t,e,i,n,r,o,a){for(var s=0,l=e;s<l.length;s++){var h=l[s],u=h.zLayer,c=h.zIndex,c=1e6*(u=null==u?i.index+1:u)+c;n[c]=0,r[r.length]={b:h,z:c,tile:t,preview:o,previewTile:a}}},Sn.prototype.viewport=function(t){var e=this,i=e.buckets,n=e.layers,r=e.render,o=n.length;(e.dirty||t)&&(e.dirty=!1,e.collision.update(e.grid.tiles[512],this.rx,this.rz,this.s)),r.clear(o&&n[0].bgColor||e.globalBgc),r.fixedView=Number(!this.viewChange);for(var a=[],s={},l=0,h=n;l<h.length;l++){var u=h[l],c=u.tiles;if(u.cnt=0,c)for(var f=u.index,p=c.length,d=0;d<p;){var v=(D=c[d++]).tile,y=v.data[u.index];if(!u.ready&&v.ready(f)&&++u.cnt==p&&(u.ready=!0),y)y.length&&this.orderBuffers(D,y,u,s,a);else if((y=v.preview(f))&&y.length)for(var g=0,m=y;g<m.length;g++){var x=m[g],_=x[0],w=i.get(_,!0),_=void 0;null!=(_=null==w?void 0:w.getData(f))&&_.length&&this.orderBuffers(D,_,u,s,a,x,w)}}}var b=-1;for(d in s)s[d]=++b;for(var T,L=1/0,d=0,A=void 0;d<a.length;d++)T=(A=a[d]).z=s[A.z],!A.b.flat&&T<L&&(L=T);r.setPass(Bt.OPAQUE);for(var S=a.length;S--;)(z=a[S])&&r.draw(z,L);r.setPass(Bt.ALPHA);var a=a.sort(function(t,e){return t.z-e.z}),M=0;do{for(var z,E=!1,S=0,C=a.length;S<C;S++)2==(z=a[S]).b.alpha&&(E=!0),z&&z.z==M&&r.draw(z,L)}while(r.pass==Bt.POST_ALPHA?r.setPass(Bt.ALPHA):E&&(r.setPass(Bt.POST_ALPHA),M--),++M<=b);if(r.tileGrid)for(var I in e.tiles)if((c=e.tiles[I]).length){for(var P=0,k=c;P<k.length;P++){var D=k[P];r.drawGrid(D.x,D.y,D.tile,I)}break}},Sn.prototype.destroy=function(){Tn.prototype.destroy.call(this)},Sn.prototype.viewChangeDone=function(){this.viewChange=!1,this.update()},Sn.zoomBehavior="float",Sn);function Sn(t,e,i,n){var s=Tn.call(this,t,e,i||"auto",new pi(512),new ni(n),Ln)||this;s.name="gl-test",s.dpr<2&&s.buckets.setSize(1024);var r=s;return s.collision=new wn(r),s.buckets.onDrop=function(t,e){var i=this.quadkey,n=this.layers;r.collision.clearTile(i,n[e]),r.releaseBuffers(t)},s.render.init(s.canvas,s.dpr),s.factory=new xn(s.render.gl,s.render.icons,s.collision,s.dpr),s.tilesNotReady=[],s.render.icons.onLoad=function(t){for(var e=0,i=s.tilesNotReady;e<i.length;e++){var n=i[e],r=n.quadkey,o=n.layerId,a=s.layers.get(o);!a||(n=s.buckets.get(r,!0))&&(o=a.layer,r=a.index,n.preview(r,!1),n.ready(r,!1),n.cancelTasks(o),(a=o.getCachedTile(n.quadkey))&&s.handleTile(a,o,n,r))}s.tilesNotReady=[]},s}function Mn(t,e,i,n,r,o,a,s,l,h,u,c){var f=a.z;e+=0^Lt("offsetX",n,r,f),i+=0^Lt("offsetY",n,r,f);var p,d,v,y=Lt("rotation",n,r,f),g=e+512<<In|i+512^0|(y+360)%360<<Pn;u[g]||(u[g]=1,y&&(y*=Cn,l.translate(e,i),l.rotate(y),d=e,v=i,i=e=0),"Text"==t?(n.stroke&&0!=n.strokeWidth&&l.strokeText(o,e,i),n.fill&&l.fillText(o,e,i)):"Circle"==t?(p=Lt("radius",n,r,f),l.moveTo(e+p,i),l.arc(e,i,p,0,En,!1)):(e-=(o=Lt("width",n,r,f))/2,i-=(p=Lt("height",n,r,f)||o)/2,"Image"==t?(f=Lt("src",n,r,f),zn.isReady(f)?l.drawImage(zn.get(f),e,i,o,p):zn.get(f,function(){return c.updateTile(a,s,h)},a.quadkey)):"Rect"==t&&l.rect(e,i,o,p)),y&&(l.rotate(-y),l.translate(-d,-v)))}var zn=new St,En=2*Math.PI,Cn=Math.PI/180,In=Math.log(2048)/Math.log(2),Pn=9+In,kn=Math,R=(Dn.prototype.init=function(t){return this.o=t,!0},Dn.prototype.createSymbol=function(t,e){e="Circle"==e.type?e.radius:e.width;return 0<t-e},Dn.prototype.drawSymbol=function(t,e,i,n,r,o,a,s,l,h,u){Mn(r.type,e,i,r,a,!1,o,s,n,l,h,u)},Dn.prototype.angle=function(t,e){return Math.atan2(t,e)},Dn.prototype.place=function(t,e,i,n,r,o,a,s,l,h){for(var u,c,f,p,d,v,y,g,m,x=this.o,_=0;_<t.length;_++)f=Math.round(e.lon2x(t[_][0])),p=Math.round(e.lat2y(t[_][1])),_&&(m=p-c,y=kn.sqrt(kn.pow(g=f-u,2)+kn.pow(m,2))-16,(d=this.createSymbol(y,r))&&(i.setTransform(h,0,0,h,v=(g*x+u)*h,y=(m*x+c)*h),i.rotate(this.angle(m,g)),i.translate(-v,-y),this.drawSymbol(d,v,y,i,r,e,n,o,a,s,l),i.setTransform(h,0,0,h,0,0))),u=f,c=p},Dn);function Dn(){this.o=.5}var Rn,gt=(e(Un,Rn=R),Un.prototype.setCharWidth=function(t){this.cw=t},Un.prototype.init=function(t){return"string"!=typeof t&&(t=String(t)),this.lw=t.length*this.cw,this.label=t,!0},Un.prototype.angle=function(t,e){return Math.atan(t/e)},Un.prototype.createSymbol=function(t){var e,i=this.label,n=this.cw,r=this.lw,o=Math.floor(t/r);return 0<o&&(e=i,1<o&&(o=1+Math.floor((o-1)/8),n=new Array(Math.floor(1.5*(t-r)/n/o)).join(" "),e=i+new Array(o).join(n+i))),e},Un.prototype.drawSymbol=function(t,e,i,n,r){r.stroke&&n.strokeText(t,e,i),r.fill&&n.fillText(t,e,i)},Un);function Un(t){var e=Rn.call(this)||this;return Rn.prototype.init.call(e,.5),e.setCharWidth(t),e}function On(t,e,i){var n,r,o,a,s=t.length-1;for(e.moveTo(o=Math.round(i.lon2x(t[s][0])),a=Math.round(i.lat2y(t[s][1])));s--;)n=Math.round(i.lon2x(t[s][0])),r=Math.round(i.lat2y(t[s][1])),(o-n||a-r)&&e.lineTo(o=n,a=r)}var Nn,Fn=[],Bn=new gt(b({font:xt}).width),Wn=new R,Xn=function(t,e,i){t.globalAlpha=null==e.opacity?1:e.opacity;var n,r=e.font,o=e.stroke;return o&&(t.strokeStyle=o,o=e.strokeWidth,t.lineWidth=(o=!o||"number"!=typeof o?1:o)*(i=r?1:i)),e.fill&&(t.fillStyle=e.fill),r?(n=e.font||xt,Bn.setCharWidth(b(e).width),t.font=n,t.textAlign=e.textAlign||"center",t.textBaseline=e.textBaseline||"middle"):(t.lineCap=e.strokeLinecap||"round",t.lineJoin=e.strokeLinejoin||"round",(n=e.strokeDasharray)instanceof Array?t.setLineDash(n):t.setLineDash(Fn),(e.fill||e.stroke)&&t.beginPath()),!0},Gn=function(t,e,i,n,r,o,a,s,l,h){var u=i.getProvider().decCoord(i),c=i.geometry.type,f=t.z,p=Lt("type",r,i,f);if("LineString"==c){if("Circle"==p||"Rect"==p||"Image"==p){var d=Lt("offset",r,i,f);if(null!=d)return Wn.init(d),void Wn.place(u,t,e,i,r,o,a,s,l,h);c="MultiPoint"}}else if(("Polygon"==c||"MultiPolygon"==c)&&"Polygon"!=p&&"Line"!=p){d=i.bbox;return Mn(p,Math.round(t.lon2x(d[0]+(d[2]-d[0])/2)),Math.round(t.lat2y(d[1]+(d[3]-d[1])/2)),r,i,n,t,o,e,a,s,l)}if("Point"==c)Mn(p,Math.round(t.lon2x(u[0])),Math.round(t.lat2y(u[1])),r,i,n,t,o,e,a,s,l);else if("Text"==p){if(Bn.init(n))if("MultiLineString"==c)for(var v=0;v<u.length;v++)Bn.place(u[v],t,e,i,r,o,a,s,l,h);else"LineString"==c&&Bn.place(u,t,e,i,r,o,a,s,l,h)}else if("LineString"==c)On(u,e,t);else if("Polygon"==c||"MultiLineString"==c)for(var y=0;y<u.length;y++)On(u[y],e,t);else if("MultiPolygon"==c)for(v=0;v<u.length;v++)for(y=0;y<u[v].length;y++)On(u[v][y],e,t);else if("MultiPoint"==c)for(var g=u.length;g--;)Mn(p,Math.round(t.lon2x(u[g][0])),Math.round(t.lat2y(u[g][1])),r,i,n,t,o,e,a,s,l)},Zn=(Hn.prototype.spawn=function(t,e,i,n,r,o,a,s,l){l=this.createTask(t,e,i,n,r,i.bounds,o,a,s,l);return this.tm.start(l),l},Hn.prototype.createTask=function(t,p,e,i,n,r,o,a,s,l){var d=this.dpr,h=n.index(i),u=n.getContext(h);return this.tm.create({priority:t,delay:l,time:this.exclusiveTimeMS,init:function(){var t;return s||(u.setTransform(d,0,0,d,0,0),(t=i.getStyle().backgroundColor)?(u.fillStyle=t,u.globalAlpha=1,u.fillRect(0,0,256,256)):u.clearRect(0,0,256,256)),{tile:e,ctx:u,data:o,lI:0,gI:0,fI:0,style:Nn,dTile:n,layer:i,bI:100}},onDone:function(){n.dirty(h),a(u,this)},exec:function(t){var e,i=t.tile,n=t.data,r=n.length;if(r){for(;!(e=n[t.lI])&&t.lI<r;)++t.lI;if(e){var o=e[t.gI];if(o){var a=t.ctx,s=o.shared,l=s.font!=Nn;if(t.style!=s){t.style=s;var h=Xn(a,s,n.swzs);if(t.pmap={},!h)return t.fI=0,t.gI++,t.bI=100,this.CONTINUE}for(;t.bI--;){var u=t.fI++,c=o.data,f=c.features[u];if(!f){l?a.setTransform(d,0,0,d,0,0):(s.fill&&a.fill(),s.stroke&&(s.strokeWidth||s.strokeWidth==Nn)&&a.stroke()),t.fI=0,t.gI++;break}c=c.styles[u],u=void 0;l&&!(u=wt(c,f,i.z))||Gn(i,a,f,u,c,t.dTile,t.layer,t.pmap,p,d)}}else t.fI=0,t.gI=0,t.lI++;return t.bI=100,this.CONTINUE}}}})},Hn);function Hn(t,e,i){this.tm=t,this.exclusiveTimeMS=i,this.dpr=e}var Yn,jn=(qn.prototype.drawGrid=function(t,e,i){var n=i+"  L"+i.length,i=this.ctx;i.strokeRect(t,e,256,256),i.strokeText(n,t+8,e+16),i.fillText(n,t+8,e+16)},qn.prototype.applyTransform=function(){var t,e,i,n,r,o=this,a=o.s,s=o.rz;o._s==a&&o._rz==s||(o._s=a,o._rz=s,t=o.ctx,e=(r=o.canvas).width,i=r.height,n=e/2-o.sx,r=i/2-o.sy,o=o.dpr,t.setTransform(1,0,0,1,e/2,i/2),t.rotate(s),t.translate(-e/2+n,-i/2+r),t.scale(a,a),t.translate(-n,-r),t.scale(o,o))},qn.prototype.init=function(t){var e=t.getContext("2d",{alpha:!1});e.font="bold 14px Arial",e.lineWidth=3,e.strokeStyle="red",e.fillStyle="white",e.textAlign="start",e.textBaseline="alphabetic",this.ctx=e,this.canvas=t},qn.prototype.setBuckets=function(t){this.buckets=t},qn.prototype.clear=function(){},qn.prototype.convertColor=function(t){return t},qn.prototype.setBackgroundColor=function(t){this.buckets.bgColor(t)},qn.prototype.grid=function(t){this.debug=t},qn.prototype.setScale=function(t,e,i){this.s=t,this.sx=e,this.sy=i},qn.prototype.setRotation=function(t,e){this.rz=t},qn.prototype.prepare=function(t,e,i,n,r,o){return this.painter.spawn(3,n,e,i,r,t,o)},qn.prototype.tile=function(t,e,i){e=Math.round(e),i=Math.round(i),this.ctx.drawImage(t.combine(),e,i,256,256),this.debug&&this.drawGrid(e,i,t.quadkey)},qn.prototype.preview=function(t,e,i,n){var r=t.getContext(n);r.clearRect(0,0,t.size,t.size);for(var o=0,a=e.length;o<a;o++){var s=e[o],l=this.buckets.get(s[0],!0),h=void 0;l&&(h=l.getData(n))&&(r.setTransform(1,0,0,1,0,0),r.drawImage(h,s[1],s[2],s[3],s[4],0+s[5],0+s[6],s[7],s[8]),t.dirty(n))}},qn.prototype.destroy=function(){},qn);function qn(t,e){this.dpr=1,this.debug=!1,this.rz=0,this.sx=0,this.sy=0,this.s=1;var i=X.TaskManager.getInstance();this.ts=t,this.dpr=e,this.painter=new Zn(i,e,4)}var Vn,Kn=(e(Qn,Vn=ai),Qn.prototype.destroy=function(t){if(t!=Yn)(e=this.c[t])&&(e.canvas&&this.bPool.releaseCtx(e),this.c[t]=Yn);else for(var e,i=this.c.length;i--;)(e=this.c[i])&&e.canvas&&(this.bPool.releaseCtx(e),this.c[i]=Yn)},Qn.prototype.init=function(t,e){Vn.prototype.init.call(this,t,e);var i=e.length;for(this.c.length=i;i--;)this.c[i]=Yn;this._c=!1,this._ready=!1},Qn.prototype.dirty=function(t,e){var i=this.c[t],n=e!=i;e&&i&&n&&this.destroy(t),e||(n=!0,e=this.c[t]),n&&(this.c[t]=e,this._c=!1)},Qn.prototype.clear=function(t){var e;(e=this.c[t])&&(e.setTransform&&this.bPool.releaseCtx(e),this.c[t]=Yn,this.preview(t,Yn),this.ready(t,!1),this._c=!1,this.combine())},Qn.prototype.getContext=function(t){return this.c[t]||(this.c[t]=this.bPool.claimCtx(this.size)),this.c[t]},Qn.prototype.getData=function(t){return this.c[t]&&(this.c[t].canvas||this.c[t])},Qn.prototype.combine=function(){var t,e=this,i=e.size;if(!e._c){e._c=!0,e.ctx.fillRect(0,0,i,i);for(var n=0;n<e.c.length;n++)(t=this.getData(n))&&e.ctx.drawImage(t,0,0,i,i)}return e.canvas},Qn.prototype.addLayer=function(t){Vn.prototype.addLayer.call(this,t);this.c.splice(t,0,Yn),this._c=!1,this._ready=!1},Qn.prototype.removeLayer=function(t){Vn.prototype.removeLayer.call(this,t);this.destroy(t),this.c.splice(t,1),this._c=!1},Qn);function Qn(t,e,i,n,r){var o=Vn.call(this)||this,a=i.length;return o.c=new Array(a),o.init(e,i),o.size=n,o.bPool=t,o.ctx=t.claimCtx(n),o.canvas=o.ctx.canvas,o.ctx.fillStyle=r,o}var Jn,$n=[],tr={length:0,max:128,clear:function(){this.length=0},create:function(t){var e=document.createElement("canvas");return e.width=e.height=t,this.length++,e.getContext("2d")},get:function(t){return $n.length?(this.length++,$n.shift()):this.create(t)},release:function(t){t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.lineWidth=1,t.globalAlpha=1,$n.push(t),this.length--}},er=(e(ir,Jn=Zt),ir.prototype.bgColor=function(e){this._bgc=e,this.forEach(function(t){t.ctx.fillStyle=e})},ir.prototype.clear=function(){this.tiles.clear(),tr.clear()},ir.prototype.setSize=function(t){this.tiles.setSize(t)},ir.prototype.releaseCtx=function(t){return tr.release(t)},ir.prototype.claimCtx=function(t){if(tr.length<tr.max)return tr.get(t);var e=this.tiles.tail.data;return e.destroy(),tr.release(e.ctx),e.ctx=null,e.canvas=null,this.tiles.remove(e.quadkey),e.cancelTasks(),this.claimCtx(t)},ir.prototype.create=function(t,e){var i=this.tiles.get(t);return i||(this.tiles.length>=this.tiles.max?((i=this.tiles.tail.data).destroy(),i.init(t,e),i.size=this.tSize):i=new Kn(this,t,e,this.tSize,this._bgc),this.tiles.set(t,i)),i},ir);function ir(t,e){t=Jn.call(this,t||256)||this;return t.ctxCache=tr,t._bgc=null,t.tSize=e,t}function nr(t,e,i,n,r){var o=Math.sin(r);return[(r=Math.cos(r))*(t=t-i)-o*(e=e-n)+i,o*t+r*e+n]}var rr={1:[512,3,512],2:[128,2,128],3:[64,1,128]},or=(ar.prototype.add=function(t,e){this.features.push(t),this.styles.push(e)},ar);function ar(){this.features=[],this.styles=[]}var sr,lr=(e(hr,sr=vt),hr.prototype.preview=function(t,e,i){var n=sr.prototype.preview.call(this,t,e,i);return n&&this.render.preview(t,n,e,i),n},hr.prototype.prepareTile=function(i,t,n,r,o){var e,a=this,s=a.render;"image"==i.type?(e=r.index(n),r.dirty(e,t),o(r,n)):t.length?r.addTask(a.cluster.spawn(4,n,i,t,{},or,function(t,e){r.removeTask(e,n),(r=null==r?void 0:r).addTask(s.prepare(t,i,n,a,r,function(t,e){r.removeTask(e,n),o(r,n)}),n)}),n):(e=r.index(n),r.destroy(e),r.dirty(e),o(r,n))},hr.prototype.viewport=function(t){var e,i=this.tiles,n=this.render,r=this.layers,o=r.length;this.buckets;for(e in(this.dirty||t)&&(this.render.clear(),this.dirty=!1),i)if("512"!=e)for(var a=i[e],s=a.length,l=0,h=a;l<h.length;l++){var u,c=h[l],f=(u=c.tile).luTs;if(c.lrTs!=f||t){c.lrTs=f,n.tile(u,c.x,c.y);for(var p,d=0;d<o;d++)!(p=r[d]).ready&&u.ready(d)&&++p.cnt==s&&(p.ready=!0)}}},hr.prototype.addLayer=function(t,e,i){t.tileSize=256;i=sr.prototype.addLayer.call(this,t,e,i);return i&&this.setupTilePool(),i},hr.prototype.removeLayer=function(t){t=sr.prototype.removeLayer.call(this,t);return-1!==t&&this.setupTilePool(),t},hr.prototype.setSize=function(t,e){var i=this;sr.prototype.setSize.call(this,t,e),i.setupTilePool(),i.render._s=void 0,i.setTransform(i.s,i.rz,i.rx)},hr.prototype.destroy=function(){sr.prototype.destroy.call(this),this.buckets.clear()},hr.prototype.setupTilePool=function(){var t=this,e=(Math.ceil(t.w/256)+1)*(Math.ceil(t.h/256)+1),i=e,n=rr[t.dpr],e=e*t.getLayers().length;i<n[0]&&(i=n[0]),t.buckets.setSize(i),e<n[2]&&(e=n[2]),t.buckets.ctxCache.max=e},hr.prototype.update=function(t){sr.prototype.update.call(this)},hr.prototype.project=function(t,e){var i=this.s;return nr(t*=i,e*=i,this.w/2,this.h/2,this.rz)},hr.prototype.unproject=function(t,e){var i=this.s,n=this.w/2,r=this.h/2,e=nr(t,e,n,r,-this.rz);return e[0]=(e[0]-n)/i+n,e[1]=(e[1]-r)/i+r,e},hr.zoomBehavior="fixed",hr);function hr(t,e,i,n){var r;e=e||256,i=0^vt.getPixelRatio(i);var o=rr[i][1],a=new jn(e*i,i),s=rr[i][0],s=new er(s,e*i);return a.setBuckets(s),r=sr.call(this,t,e,i,s,a,o)||this,a.init(r.canvas),r}var ur=0===navigator.platform.indexOf("Win")?.0025:.0015,cr=(fr.prototype.onSpin=function(t){var e,i,n=this.settings,r=this.el,o=this.map,a=n.zoom;a&&(e=-(t=t||X.global.event).deltaY,t.deltaMode===t.DOM_DELTA_LINE&&(e*=32.001953125),e&&(i=o.getZoomlevel(),o=n=void 0,"fixed"==a?t.shiftKey?n=i+(0<e?.1:-.1):(n=Math.round(i+(e<0?-1:1)),o=!0):n=i+e*ur,r=r.getBoundingClientRect(),this.zoom(n,t.pageX-r.left,t.pageY-r.top,o))),t.preventDefault&&t.preventDefault(),t.returnValue=!1},fr.prototype.enable=function(){G(this.el,["wheel","DOMMouseScroll"],this.onSpin)},fr.prototype.disable=function(){Z(this.el,["wheel","DOMMouseScroll"],this.onSpin)},fr.prototype.zoom=function(t,e,i,n){var r=this.map,o=this.ams;r.setZoomlevel(t,e,i,n&&o)},fr);function fr(t,e,i,n){var r=this;this.passive=!1;try{var o=Object.defineProperty({},"passive",{get:function(){r.passive=!0}});window.addEventListener("testPassive",null,o),window.removeEventListener("testPassive",null,o)}catch(t){}this.el=t,this.settings=i,this.map=e,this.ams=0^n,this.onSpin=this.onSpin.bind(this)}function pr(t){return t}function dr(t){return Math.sin(Math.PI*t*.5)}var vr=Object.freeze({__proto__:null,linear:pr,easeOutSine:dr,easeOutCubic:function(t){return 1-(t=1-t)*t*t}}),yr=(gr.prototype.animate=function(){var i=this,n=this.duration,r=Math.min(Date.now()-this.ts,n),t=this.from.map(function(t,e){e=i.to[e];return t+i.easing(r/n)*(e-t)});this.animator(1==t.length?t[0]:t),r<n?this.af=requestAnimationFrame(this.animate):(this.af=null,this.done())},gr.prototype.start=function(){return i(this,void 0,void 0,function(){var e=this;return s(this,function(t){return[2,new Promise(function(t){e.done=t,e.ts?t():(e.ts=Date.now(),e.animate())})]})})},gr.prototype.stop=function(){null!=this.af&&(cancelAnimationFrame(this.af),this.af=null)},gr);function gr(t,e,i,n,r){this.ts=0,this.af=null,this.from="number"==typeof t?[t]:t,this.to="number"==typeof e?[e]:e,this.duration=i,"function"==typeof n&&(r=n,n="linear"),this.easing=vr[n]||pr,this.animator=r,this.animate=this.animate.bind(this)}function mr(t,e){var i,n,r,o,a,s,l=t.targetTouches;return l?(r=l[(n=l.length)-1],o=void 0,n&&(a=e.getBoundingClientRect(),e=r.pageX-a.left,s=r.pageY-a.top,s=1<n?(i=(e+(o=l[n-2]).pageX-a.left)/2,(s+o.pageY-a.top)/2):(i=e,s))):(i=t.clientX,s=t.clientY),[0^i,0^s]}function xr(t){var e=t.targetTouches,i=e.length;if(t=e[i-2]){e=e[i-1],i=t.clientX-e.clientX,e=t.clientY-e.clientY;return 180*Math.atan2(e,i)/Math.PI}}var _r=function(s,l,r,h,o){var i=this;this.scrollHandler=new cr(s,l,h,o.zoomAnimationMs);var a,u,c,f,p,d,v,y,g,m,x,_,w,b,T,L=this,A=8,S=null,M=Date.now(),z=[],E=[],C=function(){v=0,z.length=0,E.length=0};function I(t){var e=1;if(null!=t.scale)return t.scale;var i=t.targetTouches,n=i.length,t=i[n-1],n=i[n-2];return e=n?(n=H(t.clientX,t.clientY,n.clientX,n.clientY))/(S=null==S?n:S):e}function P(t,e){if(!p){var i=o.minPanMapThreshold;if(Math.abs(t-a)<i&&Math.abs(e-u)<i)return 1;r.cancel()}var n;d=Date.now(),h.drag&&!l.lockViewport().pan&&(n=t-c,i=e-f,v<A?(z[v]=n,E[v]=i,v++):v=0,l.pan(n,i),p=!0),c=t,f=e}function k(){var t;!p||(t=Date.now())-d<25&&r.pan(t,3*z.reduce(function(t,e){return t+e},0),3*E.reduce(function(t,e){return t+e},0))}var D,R=null;function n(t){C();var e=t.targetTouches,i=e.length,n=mr(t,s);c=n[0],f=n[1],a=c,u=f,I(t),p=!1,2==i&&(D=0,n=e[i-1],i=e[i-2],_=n.clientX,w=n.clientY,b=i.clientX,T=i.clientY,S=H(_,w,b,T),x=l.getZoomlevel(),y=l.rotate(),g=l.pitch(),m=xr(t))}function U(t){var e=t.targetTouches,i=e.length,n=mr(t,s),r=I(t);if(1<i){if(h.pitch){if(++D<5)return void t.preventDefault();var o=e[i-1],a=e[i-2],e=w-o.clientY,i=T-a.clientY;if(R||0!=R&&Math.abs(a.clientY-o.clientY)<110&&Math.sign(e)==Math.sign(i))return R=!0,l.pitch(g+.2*e),void t.preventDefault();R=!1}h.zoom&&L.scrollHandler.zoom(x+Math.log2(r),n[0],n[1],!1),h.rotate&&l.rotate(y+xr(t)-m),0}P(n[0],n[1]),c=n[0],f=n[1],t.preventDefault()}function O(t){var e=mr(t,s),i=t.targetTouches.length;R=null,e&&(c=e[0],f=e[1],a=c,u=f),i<2&&(S=null);var n=Date.now(),e=n-M;i&&(M=n),I(t),0==i&&1==t.changedTouches.length&&350<e&&k()}var N=null;function F(t){N=t.button,C(),p=!1,G(s,"mousemove",B),y=l.rotate(),g=l.pitch(),c=t.clientX,f=t.clientY,a=c,u=f}function B(t){var e;null!==(e=L.resetAnimation)&&void 0!==e&&e.stop(),0==N?P(t.clientX,t.clientY):2==N&&(h.rotate&&l.rotate(y+.25*(c-t.clientX)),h.pitch&&l.pitch(g+.1*(f-t.clientY)))}function W(t){var e;N=null,Z(s,"mousemove",B),p?k():h.rotate&&(e=l.rotate(),y!=e&&Math.abs(e)<=5&&(L.resetAnimation=new yr(e,0,500,"easeOutSine",function(t){return l.rotate(t)}),L.resetAnimation.start()))}L.scroll=function(t){var e=i.scrollHandler;t?e.enable():e.disable()},L.drag=function(t){var e=t?G:Z;setTimeout(function(){e(s,"touchstart",n),e(X.global,"touchend",O),e(s,"touchmove",U),e(s,"mousedown",F),e(X.global,"mouseup",W)},0)},L.getOptions=function(){return h}},wr=(br.prototype.stopPropagation=function(){var t=this.nativeEvent;if("mousemove"==t.type||"touchmove"==t.type)return t.stopImmediatePropagation(),t.preventDefault()},br.prototype.toString=function(){return"MapEvent "+this.type},br);function br(t,e,i,n,r){this.type=t,this.timeStamp=Date.now(),null!=e&&(this.data=this.detail=e),i&&(this.mapX=n,this.mapY=r,this.nativeEvent=i,this.button=i.button)}var Tr="pointerup",Lr="pointerenter",Ar="pointerleave",Sr="pointerdown",Mr="pointermove",zr="pressmove",Er=[Tr,Lr,Ar,Sr,Mr,zr,"tap","dbltap"];function Cr(t){return-1!==Er.indexOf(t)}function Ir(t,e){var i=e.type;"touchstart"!=i&&"touchmove"!=i&&"touchend"!=i||(e=e.changedTouches[e.changedTouches.length-1]);t=t.getBoundingClientRect();return[e.pageX-t.left,e.pageY-t.top]}var Pr=(kr.prototype.getGlobalHandlers=function(){var t=this.onPointerDown,e=this.onPointerMove,i=this.onPointerUp;return{touchstart:t,touchmove:e,touchend:i,mousedown:t,mouseup:i,mousemove:e}},kr.prototype.enable=function(t){Cr(t)&&delete this.disabled[t]},kr.prototype.disable=function(t){Cr(t)&&(this.disabled[t]=!0)},kr.prototype.destroy=function(){var t=this.getGlobalHandlers();if(this.hActive){for(var e in t)Z(this.el,e,t[e]);this.hActive=!1}},kr.prototype.addEventListener=function(t,e,i){if(Cr(t)&&this.cbs.add(t,e,i)){this.cnt++;var n=this.getGlobalHandlers();if(!this.hActive)for(var r in n){var o=n[r],a=this.el;if("mouseup"==r)for(;a.parentNode;)a=a.parentNode;G(a,r,o),this.hActive=!0}}},kr.prototype.removeEventListener=function(t,e,i){var n=this.cbs,r=this.el;if(Cr(t)&&n.remove(t,e,i)&&!--this.cnt&&this.hActive){var o,a=this.getGlobalHandlers();for(o in a)n.isListened(o)||Z(r,o,a[o]);this.hActive=!1}},kr);function kr(o,a,t,s){this.disabled={},this.hActive=!1,this.cnt=0,this.el=o,this.cbs=new X.Listener(["click"]);var l,h,n,r,u,c,f=this.disabled,p=!1,d=!1,v=0,y=!1,g=this.cbs;g.sync(!0),Er.forEach(function(t){g.addEvent(t),f[t]=!1});var m=X.TaskManager.getInstance().create({delay:40,priority:5,exec:function(){!function(t){var e=Ir(o,t),i=w(e);_(Mr,t,e,i),i?u?u.feature.id!==i.feature.id&&(_(Ar,t,e,u),_(Lr,t,e,i)):_(Lr,t,e,i):u&&_(Ar,t,e,u);u=i}(c),y=!1}});function x(t,e,i,n,r){n=new wr(t,r,e,i,n);return r&&(n.target=r.feature,n.detail.display=a),n}function _(t,e,i,n){g.trigger(t,[x(t,e,i[0],i[1],n)],!1)}function w(t){return a.getFeatureAt({x:t[0],y:t[1]},{layers:a._layers.filter(function(t){return t.pointerEvents()})})}this.onPointerDown=function(t){n=a.getCenter(),p=!(d=!0),l=Ir(o,t),h=w(l),_(Sr,t,l,h),"touchstart"==t.type&&t.target.parentNode==o&&t.preventDefault()},this.onPointerMove=function(t){var e,i,n;if(d){var r=s.minPanMapThreshold;if(!p&&(i=(e=Ir(o,t))[0]-l[0],n=e[1]-l[1],Math.abs(i)<r&&Math.abs(n)<r))return}p=!0,d?h&&g.isListened(zr)&&(i=(e=Ir(o,t))[0]-l[0],n=e[1]-l[1],g.trigger(zr,[x(zr,t,e[0],e[1],h),i,n],!1)):"touchmove"!=t.type&&(g.isListened(Lr)||g.isListened(Ar)||g.isListened(Mr))&&(c=t,f.pointerenter||f.pointerleave||y||(y=!0,m.start()))},this.onPointerUp=function(t){var e,i;d&&(e=a.getCenter(),n.longitude!=e.longitude||n.latitude!=e.latitude||t.target.parentNode!=o||!h&&p||(_("tap",t,i=Ir(o,t),h),_(Tr,t,i,h),e=t,i=Date.now(),t=h&&h.feature,i-v<250&&!p&&r==t&&_("dbltap",e,l,h),r=t,v=i),d=p=!1)}}var Dr=(Rr.prototype.feature=function(t,e,i,n,r,o){return this.geometry(t,e,i.geometry.coordinates,i.geometry.type,n,r,i,o)},Rr.prototype.geometry=function(t,e,i,n,r,o,a,s,l){var h,u,c,f,p,d,v,y,g,m,x,_,w,b,T,L=!1,A=this.dpr,S=this.map;if("Point"==n)(l=l||q(r,a,s,A,o))&&(_=S.geoToPixel(i[0],i[1]),x=Math.round(_.x+l[0]),b=Math.round(_.y+l[1]),w=Math.round(_.x+l[2]),T=Math.round(_.y+l[3]),_=e,w=w,b=b,T=T,L=x<=(x=t)&&x<=w&&b<=_&&_<=T);else if("LineString"==n){for(var M,z=(l=l||j(r,a,s,o))[0],E=i.length,C=1/0,I=S.geoToPixel(i[0][0],i[0][1]),P=void 0,k=1;k<E;k++)M=S.geoToPixel(i[k][0],i[k][1]),h=t,u=e,c=I.x,f=I.y,p=M.x,d=M.y,y=m=y=g=g=y=v=void 0,y=(g=0!=(g=(v=p-c)*v+(y=d-f)*y)?((h-c)*v+(u-f)*y)/g:-1)<0?(m=c,f):1<g?(m=p,d):(m=c+g*v,f+g*y),m=h-m,y=u-y,(P=Math.sqrt(m*m+y*y))<C&&(C=P),I=M;L=C<=z/2}else if("Polygon"==n){for(var z=S.pixelToGeo(t,e),D=z.longitude,R=z.latitude,U=0;U<i.length;U++)if(function(t,e,i){for(var n,r,o,a,s=!1,l=0,h=i.length-1;l<i.length;h=l++)n=i[l][0],o=i[l][1],r=i[h][0],e<o!=e<(a=i[h][1])&&t<(r-n)*(e-o)/(a-o)+n&&(s=!s);return s}(D,R,i[U])!=!U)return!1;L=!0,l=l||[Y(r,a,s,o)]}else{var O=void 0;if("MultiPolygon"==n?(O="Polygon",l=[Y(r,a,s,o)]):"MultiPoint"==n?(O="Point",l=q(r,a,s,A,o)):"MultiLineString"==n&&(O="LineString",l=j(r,a,s,o)),O)for(var U=0,N=i.length;U<N;U++)if(this.geometry(t,e,i[U],O,r,o,a,s,l)){L=!0;break}}return L&&l},Rr);function Rr(t,e){this.map=t,this.dpr=e}function Ur(t){return"number"==typeof t}var Or=Array.from({length:33},function(t,e){return 32*Math.pow(2,Math.max(0,e-20+2))}),Nr=(Fr.prototype.getFeaturesInRect=function(t,e,i,n,r,o,a){for(var s,l,h,u,c,f=this.map,p=this.hit,d=0^Math.min(20,o),v={},y=t+(i-t)/2,g=e+(n-e)/2,m=180,x=-180,_=180,w=-180,b=[f.pixelToGeo(t,e),f.pixelToGeo(i,e),f.pixelToGeo(i,n),f.pixelToGeo(t,n)],T=4,L=[];T--;){var A=b[T].longitude,S=b[T].latitude;A<m&&(m=A),x<A&&(x=A),S<_&&(_=S),w<S&&(w=S)}for(var M=[m,_,x,w],z=(r=r&&!Array.isArray(r)?[]:r).length;z--;)if(s=(l=r[z]).getProvider(o),o<=l.max&&o>=l.min&&s.search)for(u=(h=s.search(M)).length;u--;){var E,C=h[u];(E=l.getStyleGroup(C,d))&&(c=p.feature(y,g,C,E,z,o))&&((E=v[E=c[c.length-1]]=v[E]||[])[z]=E[z]||[]).push(C)}var I,P={layer:null,features:null};for(I in v)for(var k,D,R=v[I],U=0;U<R.length;U++)(k=R[U])&&(D=r[U],P.layer==D?P.features=P.features.concat(k):L.push({layer:D,features:k}));return L},Fr.prototype.search=function(t,e,i,n,r,o){var a=this.map,s=a._layers;if(r=r?r instanceof Array?r.slice().sort(function(t,e){return Number(s.indexOf(t)>s.indexOf(e))}):[r]:s,Ur(t)&&Ur(e)&&Ur(i)&&Ur(n)){var l=a.getZoomlevel(),a=Or[Math.ceil(l)];return this.getFeaturesInRect(t-a,e-a,i+a,n+a,r,l,o)}},Fr);function Fr(t,e){this.map=t,this.hit=new Dr(t,e)}var Br,Wr=X.global.setTimeout,Xr=X.global.setInterval,Gr="mapviewchange",Zr=100,Hr=(Yr.prototype.centerChanged=function(t){return this.center.longitude!=t.longitude||this.center.latitude!=t.latitude},Yr.prototype.vpChanged=function(t,e,i){var n=this.viewport,r=this.rz,o=this.rx;return!(n.minLon!=t.minLon||n.maxLon!=t.maxLon||n.minLat!=t.minLat||n.maxLat!=t.maxLat||r!=e||o!=i)},Yr.prototype.changeWatcher=function(){var t=this.map,e=this.readyTimer,i=this.watchTimer,n=this.viewport,r=(this.center,t.getViewBounds()),o=t.getCenter(),a=t.rotate(),s=t.pitch(),l=Gr,t={changed:{center:!0}};if(n){if(t.changed.center=this.centerChanged(o),this.vpChanged(r,a,s))return clearInterval(i),this.watchTimer=this.viewport=this.rz=this.rx=null,e&&clearTimeout(e),this.readyTimer=Wr(this.readyWatcher,Zr);this.viewport=r,this.rz=a,this.rx=s,this.center=o}else this.triggeredLayers={},l="mapviewchangestart",this.viewport=r,this.rz=a,this.center=o,this.endTriggered=!0;this.trigger(l,t,!0)},Yr.prototype.readyWatcher=function(){var t,e=this.map,i=this.triggeredLayers,n=this.renderInfo.getLayers(),r=!0;this.endTriggered&&(this.endTriggered=!1,t=e.getCenter(),this.trigger("mapviewchangeend",{changed:{center:this.centerChanged(t)}},!0));for(var o,a,s=0;s<n.length;s++){var l,h,u=(h=(l=n[s]).layer).id;l.ready?i[u]||(i[u]=!0,l.error||(o="viewportReady",a=e,u=h,l=void 0,"function"==typeof Event?l=new Event(o):(l=document.createEvent("Event")).initEvent(o,!0,!0),l.detail=l.data={map:a,layer:u},h._l.trigger("viewportReady",l,!0))):r=!1}r||(this.readyTimer=Wr(this.readyWatcher,Zr))},Yr.prototype.watch=function(t){var e=this.readyTimer,i=this.watchTimer;e&&(clearTimeout(e),this.readyTimer=null),t?i||(this.watchTimer=Xr(this.changeWatcher,1e3/30)):i&&(clearInterval(i),this.watchTimer=null)},Yr);function Yr(t,e,i){this.watchTimer=null,this.map=t,this.trigger=e,this.renderInfo=i,Zr=X.global.__XYZTST_MVCEDelayMs||Zr,this.changeWatcher=this.changeWatcher.bind(this),this.readyWatcher=this.readyWatcher.bind(this)}jr.prototype.show=function(){this.html||this.create(this.parent,this.opt),this.html.style.display="inline"},jr.prototype.hide=function(){var t=this.html;t&&(t.style.display="none")},jr.prototype.enable=function(){this.active=!0,this.toggleListeners(!0)},jr.prototype.disable=function(){this.active=!1,this.toggleListeners(!1)},jr.prototype.destroy=function(){this.disable(),this.parent.removeChild(this.html)},jr.prototype.toggleListeners=function(r){function t(n){var t,e=o.querySelectorAll(n);for(t in a[n])!function(i){e.forEach(function(t){var e=a[n][i];r?t.addEventListener(i,a[n][i]._=e.bind(o)):t.removeEventListener(i,e._)})}(t)}var e,o=this,a=o.listeners;for(e in a)t(e)},jr.prototype.insertRule=function(t,e){var i=(Br=Br||(i=document.createElement("style"),document.head.appendChild(i),i)).sheet;i.insertRule?i.insertRule(t+" {"+e+"}",i.cssRules.length):i.addRule&&i.addRule(t,e)},jr.prototype.create=function(t,e){var i,n=(n=this.templ.replace(/class\=\"/g,'class="'+this.cPrefix)).replace(/\>[\s]+\</g,"><"),n=(n=n,(new DOMParser).parseFromString(n,"text/html").body.childNodes[0]),r=n.style,o=e.position,a="."+t.className+" ";for(i in o)r[i]=o[i];if(this.style)for(var s in this.style)this.insertRule(a+this.prefixClass(s),this.style[s]);this.html=t.appendChild(n)},jr.prototype.prefixClass=function(t){return t=t.replace(/\./g,"."+this.cPrefix)},jr.prototype.querySelector=function(t){return this.html.querySelector(this.prefixClass(t))},jr.prototype.querySelectorAll=function(t){return this.html.querySelectorAll(this.prefixClass(t))},gt=jr;function jr(t,e,i,n){this._v=!0;this.map=i,this.cPrefix=t.className+"-ui-",this.parent=t,(this.opt=e).visible&&(this.create(t,e),this.enable())}var qr,R=(e(Vr,qr=gt),Vr.prototype.enable=function(){qr.prototype.enable.call(this);var e=this.querySelector(".needle"),i=this.map;i.addEventListener("mapviewchange",this._rl=function(t){e.style.transform="rotate("+i.rotate()+"deg) rotateX("+i.pitch()+"deg) scale(0.7,1.1)"}),this._rl()},Vr.prototype.disable=function(){qr.prototype.disable.call(this),this.map.removeEventListener("mapviewchange",this._rl),this.a&&(this.a.stop(),this.a=null)},Vr);function Vr(t,e,i,n){i=qr.call(this,t,e,i)||this;return i.maxPitch=n.maxPitch,i}R.prototype.listeners={".needle":{click:function(t){return i(this,void 0,void 0,function(){var e,i,n,r;return s(this,function(t){switch(t.label){case 0:return this.aip?[3,2]:(e=this.map,i=e.rotate(),n=e.pitch(),r=[0,0],i||n||(r=[0,this.maxPitch]),this.a=new yr([i,n],r,500,"easeOutCubic",function(t){e.rotate(t[0]),e.pitch(t[1])}),[4,this.a.start()]);case 1:t.sent(),this.a=null,t.label=2;case 2:return[2]}})})}}},R.prototype.style={".compass":"        position: absolute;        right:  10px;        bottom: 96px;        text-align: center;        font-family: sans-serif;        color: white;        height: 28px;        background-color: #0f1621;        user-select: none;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;        overflow: hidden;",".compass .needle":"        padding: 4px 0px;        line-height: 10px;",".compass:hover":"        background-color: #383c45;        cursor: pointer;"},R.prototype.templ='<div class="compass">        <div class="needle">&#9650;<br>&#9661;</div>    </div>';var Kr,ai=(e(Qr,Kr=gt),Qr.prototype.enable=function(){Kr.prototype.enable.call(this);var e=this.querySelector(".info"),i=this.map;e.innerText=i.getZoomlevel(),i.addEventListener("mapviewchangeend",this._zll=function(t){e.innerText=Math.round(10*i.getZoomlevel())/10})},Qr.prototype.disable=function(){Kr.prototype.disable.call(this),this.map.removeEventListener("mapviewchangeend",this._zll)},Qr);function Qr(t,e,i,n){i=Kr.call(this,t,e,i)||this;return i.ams=250,n&&n.zoomAnimationMs&&(i.ams=n.zoomAnimationMs),i}ai.prototype.listeners={".zoomBtn":{click:function(t){t=0^t.srcElement.getAttribute("dir");this.map.setZoomlevel(this.map.getZoomlevel()+t,this.ams)}}},ai.prototype.style={".zoomctrl":"        position: absolute;        right:  10px;        bottom: 20px;        text-align: center;        font-family: sans-serif;        color: white;        user-select: none;",".zoomctrl div":"        background-color: #0f1621;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;",".zoomctrl .zoomBtn":"        height: 28px;        font-size: 32px;        /* border: 1px solid white; */        line-height: 22px;        font-weight: 200;",".zoomctrl .zoomBtn:hover":"        background-color: #383c45;        cursor: pointer;"},ai.prototype.templ='<div class="zoomctrl">         <div class="zoomBtn" dir="1">+</div>         <div class="info">L</div>        <div class="zoomBtn" dir="-1">-</div>     </div>';var Jr,$r=(e(to,Jr=gt),to.prototype.add=function(t){!function(t,e,i,n){t=document.createElement(t);e&&(t.className=e),i&&(t.innerText=i),n&&n.appendChild(t)}("div",this.prefixClass(".src").substr(1)," "+t.label,this.html)},to.prototype.setData=function(t){if(this.data=t,this.html){this.html.innerText="";for(var e=0,i=t;e<i.length;e++){var n=i[e];this.add(n)}}},to);function to(t,e,i){return Jr.call(this,t,e,i)||this}$r.prototype.style={".copyright-popup":"        user-select: none;        background-color: rgba(0,0,0,0.1);        position: absolute;        bottom: 15px;        padding: 2px;        right: 120px;        z-index: 1;        width:  auto;        color: #fff;        font-family: arial;        font-size: 11px;        opacity: 0.8;        height: auto;",".src":"        opacity: 0.8;        margin: 4px;    "},$r.prototype.templ='<div class="copyright-popup"></div>';function eo(t,e){var i=t.scopes,n=i.length;if(!n)return!0;for(;a=i[--n];){var r=a.layer.getProvider(e),o=r&&r.level||e,r=a.minLevel||-1/0,a=a.maxLevel||1/0;if(r<=o&&o<=a)return!0}return!1}function io(t,e){t.style.display=e?"inline":"none"}var no,ro=X.global.document,oo="addLayer removeLayer",ao="zoomlevel",so={defaultOwner:"XYZ",termsAndConditions:{label:"Terms and Conditions",url:!1}},Zt=(e(lo,no=gt),lo.prototype.setTermsAndConditions=function(t){var e=t.url,i=t.label,t=this.querySelector(".terms");e?(t.lastChild.href=e,i&&(t.lastChild.innerText=i)):io(t,!1)},lo.prototype.setDefaultOwner=function(t){"string"==typeof t&&this.setOwnerLabel(this.$cDefault,t)},lo.prototype.enable=function(){var n=this;no.prototype.enable.call(this),n.map.addObserver(ao,n.onZoomChange=function(t,e,i){Math.abs((0^e)-(0^i))&&(n.sources.forEach(function(t){io(t.el,eo(t,e))}),n.showDetails(!1),n.handleOverflow())}),n.map.addEventListener(oo,n.onLayerChange=function(e){var i=e.detail.layer;i.getCopyright(function(t){n.active&&("addLayer"==e.type?t.forEach(function(t){return n.addSource(t,i)}):t.forEach(function(t){return n.removeSource(t,i)}))})}),n.map.addEventListener("resize",n.onResize=function(){return n.handleOverflow()})},lo.prototype.disable=function(){no.prototype.disable.call(this),this.map.removeObserver(ao,this.onZoomChange),this.map.removeEventListener(oo,this.onLayerChange),this.map.removeEventListener("resize",this.onResize)},lo.prototype.calcWidth=function(){var e=0^this.map.getZoomlevel(),t=this.sources,i=0;return t.forEach(function(t){i+=eo(t,e)&&t.width}),i},lo.prototype.handleOverflow=function(){var t=this.$btn,e=this.map.getWidth(),i=this.calcWidth(),e=e-132^0;this.$src.style.width=(e<i?e-10:i)+"px",i>Math.min(e,384)?io(t,!0):(io(t,!1),this.showDetails(!1))},lo.prototype.showDetails=function(t){var e=this.details,i=this.map.getZoomlevel();this.$btn.innerText=t?"-":"+",t?(e.show(),e.setData(this.sources.values().filter(function(t){return eo(t,i)}))):e.hide()},lo.prototype.setOwnerLabel=function(t,e){t.innerText=" "+e},lo.prototype.addSource=function(t,e){var i,n=this.sources,r=t.label,o=t.scopes,t=0^this.map.getZoomlevel(),a=n.get(r);a?(i=a.el,a.cnt++):((i=ro.createElement("span")).className=this.prefixClass(".source").substr(1),this.setOwnerLabel(i,r),this.$src.appendChild(i),a={label:r,scopes:[],el:i,cnt:1,width:i.getBoundingClientRect().width},n.set(r,a),this.sLen++,this.srcWidth+=a.width),null!=o&&o.forEach(function(t){return a.scopes.push({minLevel:t.minLevel,maxLevel:t.maxLevel,layer:e})}),io(this.$cDefault,!1),io(i,eo(a,t)),this.handleOverflow()},lo.prototype.removeSource=function(t,e){var i,n,r=t.label,o=this.sources.get(r);if(o){if(n=o.scopes,i=t.scopes)for(var a=0;a<i.length;a++)for(var s,l=i[a],h=0;a<n.length;h++)if((s=n[h]).layer==e&&s.minLevel==l.minLevel&&s.maxLevel==l.maxLevel){n.splice(h,1);break}--o.cnt||(this.$src.removeChild(o.el),this.sources.delete(r),this.handleOverflow(),--this.sLen||io(this.$cDefault,!0))}},lo);function lo(t,e,i){var n=no.call(this,t,X.JSUtils.extend(!0,X.JSUtils.clone(so),e),i)||this;n.sources=new X.Map,n.sLen=0,n.srcWidth=0;var r=n,o=r.opt,e=o.termsAndConditions,o=o.defaultOwner;return r.$src=r.querySelector(".sources"),r.$cDefault=r.querySelector(".cDefault"),r.$btn=r.querySelector(".btn"),n.details=new $r(t,{visible:!1},i),n.setDefaultOwner(o),n.setTermsAndConditions(e),n}Zt.prototype.listeners={".btn":{click:function(t){var e="+"==this.$btn.innerText;this.showDetails(e)}}},Zt.prototype.style={".copyright *":"        color: #fff;        font-family: arial;        opacity: 0.8;        text-decoration: none;",".copyright":"        right: 0px;        bottom: 0px;        padding: 1px 4px;        margin: 0px;        background-color: rgba(0,0,0,.1);        position: absolute;        font-size: 11px;        line-height: 13px;        overflow: hidden;        white-space: nowrap;        user-select: none;",".sources":"        width:auto;        max-width: 384px;        float: left;        white-space: nowrap;        overflow: hidden;        text-overflow: ellipsis;        border-right: 2px;",".btn":"        display: none;        font-family: sans-serif;        font-weight: bold;        text-align: center;        height: 12px;        width: 12px;        float: left;        padding: 0px;        line-height: 9px;        margin: 1px 2px 0px;        background-color: inherit;        box-sizing: border-box;        border-radius: 3px;        border: 1px solid;",".terms, .cDefault, .source":"        white-space: nowrap;        padding-right: 4px;"},Zt.prototype.templ='<div class="copyright">        <span style="float: left; white-space: nowrap;">            <span class="sources"></span>            <span class="cDefault"></span>         </span>        <span class="tac" style="float: right; white-space: nowrap;">            <span class="btn">+</span>            <span class="terms" style="white-space: nowrap;">|            <a target="_blank" style="white-space: nowrap;" href="">Terms and Conditions</a></span>        </span>    </div>';var ho,gt=(e(uo,ho=gt),uo.prototype.setSrc=function(t){this.html.style.backgroundImage="url("+t+")"},uo);function uo(t,e,i){i=ho.call(this,t,e,i)||this,e=e.url;return e&&i.setSrc(e),i}gt.prototype.style={".logo":"        position: absolute;        bottom: 6px;        left: 6px;        z-index: 1;        margin:  0px;        background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjdweCIgaGVpZ2h0PSIzMnB4IiB2aWV3Qm94PSIwIDAgMjcgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUyLjYgKDY3NDkxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5Hcm91cCAzPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9Ikdyb3VwLTMiPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzA0QjZDOCIgcG9pbnRzPSItNy44NjQyMTYxOWUtMTQgOSAxMyAxNS45Njg4NjgxIDEzIDMyIDAgMjQuNDc4MDIyNiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzBBNTdENCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAuNTAwMDAwLCAyMC41MDAwMDApIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTIwLjUwMDAwMCwgLTIwLjUwMDAwMCkgIiBwb2ludHM9IjE0IDkgMjcgMTUuOTY4ODY4MSAyNyAzMiAxNCAyNC40NzgwMjI2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTIiIGZpbGw9IiMwQTk0REUiIHBvaW50cz0iMCA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMCAyNyA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMTUiPjwvcG9seWdvbj4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==);        background-repeat: no-repeat;        background-size: contain;        width:  32px;        height: 32px;        cursor: pointer;"},gt.prototype.templ='<div class="logo"></div>';var co={Compass:R,ZoomControl:ai,Copyright:Zt,Logo:gt},fo=(po.initComponentOptions=function(){},po.prototype.get=function(t){return this.components[t]},po.prototype.destroy=function(){var t,e=this.components;for(t in e)e[t].destroy(),delete e[t]},po);function po(t,e,i){var n,r=v({},e.UI||e.ui||{}),o=this.components={};for(n in this.el=t,null!=r.HERE&&(r.Logo=r.HERE),co){var a=r[n];!1!==a&&(null==(a="object"!=typeof a?{}:a).visible&&(a.visible=!0),a.visible&&(o[n]=new co[n](t,a,i,e)))}}var vo=X.JSUtils.isFunction,yo=(go.prototype.onStart=function(){},go.prototype.onStop=function(){},go.prototype.animate=function(n,r,o,a){return i(this,void 0,void 0,function(){var e,i;return s(this,function(t){switch(t.label){case 0:return(i=(e=this).map,e.active)?[3,2]:(e.active=!0,e.onStart(),[4,new yr(i.getZoomlevel(),n,a,"easeOutCubic",function(t){i.setZoomlevel(t,r,o)}).start()]);case 1:t.sent(),e.onStop(),e.active=!1,t.label=2;case 2:return[2]}})})},go);function go(t,e){void 0===e&&(e={});this.map=t,vo(e.onStart)&&(this.onStart=e.onStart),vo(e.onStop)&&(this.onStop=e.onStop)}var mo=X.JSUtils.isFunction,xo=(_o.prototype._pan=function(){var t=this,e=t.deltaX,i=t.deltaY,n=t.duration,r=t.startTs,r=Math.min(Date.now()-r,n)/n,n=dr(r)*e,r=dr(r)*i;if(t.map.pan(n-t.lastDx||0,r-t.lastDy||0),n!=e||r!=i)return t.lastDx=n,t.lastDy=r,!0;t.onStop()},_o.prototype.pan=function(t,e,i){this.startTs=t,this.deltaX=e,this.deltaY=i,this.onStart(),this.raf()},_o.prototype.cancel=function(){var t=this.rafId;t&&(cancelAnimationFrame(t),this.rafId=null),this.onStop(),this.startTs=0,this.lastDx=0,this.lastDy=0},_o.prototype.onStart=function(){},_o.prototype.onStop=function(){},_o);function _o(t,e){e=e||{};var i=this;i.map=t,i.duration=e.duration||500,mo(e.onStart)&&(i.onStart=e.onStart),mo(e.onStop)&&(i.onStop=e.onStop),i.raf=function(){i._pan()&&(i.rafId=requestAnimationFrame(i.raf))}}var wo,bo={ui:{},behavior:{drag:!0,pitch:!1,rotate:!1},rotate:0,pitch:0,zoomlevel:18,center:{longitude:8.534,latitude:50.162},layers:null,maxLevel:20,minLevel:2,debug:!1,minPanMapThreshold:4,zoomAnimationMs:100,maxPitch:50},To=A.webMercator,Lo="fixed",Ao=85.05112878,So=-Ao,Mo="longitude",zo="latitude",Eo="zoom",Co="addLayer",Io="removeLayer",Po=[];ko.getInstances=function(){return Po.slice()},ko.prototype._layerClearListener=function(t){this.refresh(t.detail.layer)},ko.prototype.initViewPort=function(){var t=this._s,e=this._w/2,i=this._h/2,n=this._cw.x,r=this._cw.y,o=n-e/t,a=r-i/t;this._tlwx=o,this._tlwy=a,this._ox=n-e-o,this._oy=r-i-a;var s=this._wSize,o=To.x2lon(o,s),a=To.y2lat(a,s),i=r+i/t,t=To.x2lon(n+e/t,s),i=To.y2lat(i,s);return this._vp=new A.GeoRect(o,i,t,a),[n/s,r/s]},ko.prototype.updateGrid=function(){var t=this._display,e=this._c,i=this._pc;this._mvcRecognizer.watch(!0),t.setTransform(this._s,this._rz,this._rx),t.updateGrid(this.initViewPort(),this._z,this._ox,this._oy),i[Mo]==e[Mo]&&i[zo]==e[zo]||(this._l.trigger("center",["center",e,i],!0),this._pc=e)},ko.prototype._setCenter=function(t,e){var i=this._wSize;return 2!=arguments.length&&(t=t instanceof Array?(e=t[1],t[0]):(e=(t=t||this._c)[zo],t[Mo])),!isNaN(t)&&!isNaN(e)&&"number"==typeof t&&"number"==typeof e&&(180<t?t-=360:t<-180&&(t+=360),e<So?e=So:Ao<e&&(e=Ao),this._c=new A.GeoPoint(t,e),this._cw=new A.PixelPoint(To.lon2x(t,i),To.lat2y(e,i)),!0)},ko.prototype.repaint=function(){this.updateGrid()},ko.prototype.debug=function(t){this._display.showGrid(t),this.updateGrid()},ko.prototype.pitch=function(t){var e;return t!==wo&&(e=this._cfg.maxPitch,t=Math.max(0,Math.min(e,Math.round(t%360*10)/10)),this._rx=-t*Math.PI/180,this.updateGrid()),180*-this._rx/Math.PI},ko.prototype.rotate=function(t){var e,i,n,r,o;return t===wo||(e=Math.round(10*t||0)*Math.PI/1800)!==(i=this._rz)&&(n=this._cx,r=this._cy,o=this._display.unproject(n,r),(t=this._cw).x+=o[0]-n,t.y+=o[1]-r,this._rz=e,this.updateGrid(),this._l.trigger("rotation",["rotation",this._rz,i],!0)),this._rz/Math.PI*180},ko.prototype.setBackgroundColor=function(t){this._display.setBGColor(t),this.refresh()},ko.prototype.addEventListener=function(t,e){var i=this,n=this._l;t.split(" ").forEach(function(t){return n.isDefined(t)?n.add(t,e):void i._evDispatcher.addEventListener(t,e)})},ko.prototype.removeEventListener=function(t,e){var i=this,n=this._l;t.split(" ").forEach(function(t){return n.isDefined(t)?n.remove(t,e):void i._evDispatcher.removeEventListener(t,e)})},ko.prototype.getViewBounds=function(){var t=this._vp,e=t.minLon,i=t.maxLon,n=t.minLat,t=t.maxLat;return new A.GeoRect(e=e<-180?-180:e,n=n<=So?-90:n,i=180<i?180:i,t=Ao<=t?90:t)},ko.prototype.setViewBounds=function(t){var e=arguments;if("number"==typeof t?t=[e[0],e[1],e[2],e[3]]:"FeatureCollection"==t.type?t=t.features:"Feature"==t.type&&(t=[t]),Array.isArray(t)){if("object"==typeof t[0]){for(var i=[1/0,1/0,-1/0,-1/0],n=0,r=t;n<r.length;n++){var o=r[n];A.utils.calcBBox(o,i)}t=i}a=t[0],s=t[1],l=t[2],h=t[3]}else var a=t.minLon,s=t.minLat,l=t.maxLon,h=t.maxLat;this.setZoomlevel(function(t,e,i,n,r,o){for(var a,s,l=256*Math.pow(2,20),h=20;0<=h;--h)if(s=20-h,a=(To.lon2x(i,l)>>s)-(To.lon2x(t,l)>>s),s=(To.lat2y(e,l)>>s)-(To.lat2y(n,l)>>s),a<=r&&s<=o)return h;return 0}(a,s,l,h,this.getWidth(),this.getHeight())),this.setCenter(a+(l-a)/2,s+(h-s)/2)},ko.prototype.getFeatureAt=function(t,e){(e=e||{}).topOnly=!0;e=this.getFeaturesAt(t,e);if(e.length){e=e[e.length-1];return e.feature=e.features[0],e}},ko.prototype.getFeaturesAt=function(t,e){var i,n,r,o,a;return e=e||{},t.x!=wo&&t.y!=wo?(a=t.x,i=t.y,n=a-(o=0^e.width)/2,r=a+o/2,o=i-(a=e.height||o)/2,a=i+a/2):t.minX!=wo&&t.maxX!=wo&&(n=t.minX,o=t.minY,r=t.maxX,a=t.maxY),n!=wo&&this._search.search(n,o,r,a,e.layers,e.topOnly)},ko.prototype.getBehavior=function(){var t,e={},i=this._b.getOptions();for(t in i)e[t]=!!i[t];return e},ko.prototype.setBehavior=function(t,e){var i=typeof t,n="object"==i?t:{},r=this._b.getOptions();"string"==i&&(n[t]=e);e=n[Eo];e!=wo&&(r[Eo]="fixed"==e||"float"==e?e:!!e&&Lo);for(var o=0,a=["drag","pitch","rotate"];o<a.length;o++){var s=a[o],l=n[s];l!=wo&&(r[s]=!!l)}},ko.prototype.getZoomlevel=function(){return this._z+Math.log(this._s)/Math.LN2},ko.prototype.setZoomlevel=function(t,e,i,n){var r,o=this._vplock,a=this._z,s=this._s;t=Math.round(1e3*t)/1e3,t=Math.max(Math.min(t,o.maxLevel),o.minLevel),2==arguments.length&&(n=e,e=wo),e!=wo&&i!=wo||(e=this._cx,i=this._cy),a==t&&1==s||(n?this.zoomAnimator.animate(t,e,i,"number"==typeof n?n:250):(r=this.getZoomlevel(),o=this._display.unproject(e,i),n=a-(s=0^Math.min(20,t)),a=this._wSize,s=Math.pow(2,t-s),n&&(this._z=0^Math.min(20,t),this._wSize=256*Math.pow(2,this._z)),this._display.setTransform(s*Math.pow(.5,n),this._rz,this._rx),i=this._display.unproject(e,i),this._setCenter(To.x2lon(this._cw.x+o[0]-i[0],a),To.y2lat(this._cw.y+o[1]-i[1],a)),this._s=s,this.updateGrid(),this._l.trigger("zoomlevel",["zoomlevel",this.getZoomlevel(),r],!0)))},ko.prototype.setCenter=function(t,e){this._setCenter.apply(this,arguments)&&this.updateGrid()},ko.prototype.getCenter=function(){return new A.GeoPoint(this._c.longitude,this._c.latitude)},ko.prototype.lockViewport=function(t){var e,i,n=this._vplock;return t&&(e=t.pan,i=t.minLevel,t=t.maxLevel,i=!1===i?this._cfg.minLevel:i,t=!1===t?this._cfg.maxLevel:t,e!=wo&&(n.pan=e),"number"==typeof i&&(n.minLevel=i),"number"==typeof t&&(n.maxLevel=t)),n},ko.prototype.pan=function(t,e){var i,n,r,o;0==t&&0==e||(i=this._wSize,r=this._cx,o=this._cy,n=this._cw,e=this._display.unproject(r+t,o+e),r=n.x-e[0]+r,o=n.y-e[1]+o,this.setCenter(To.x2lon(r,i),To.y2lat(o,i)))},ko.prototype.getLayers=function(t){var e=this._layers;return t!=wo?e[t]:e.slice()},ko.prototype.addLayer=function(t,e){var i=this._layers;-1==i.indexOf(t)&&(e==wo&&(e=i.length),this._display.addLayer(t,t.getStyle(),e),t.addEventListener("clear",this._layerClearListener),this._l.trigger(Co,[new wr(Co,{index:e,layer:t})]),i.splice(e,0,t),this.updateGrid())},ko.prototype.removeLayer=function(t){var e=this._layers,i=e.indexOf(t);0<=i&&(this._display.removeLayer(t),t.removeEventListener("clear",this._layerClearListener),e.splice(i,1),this.updateGrid(),this._l.trigger(Io,[new wr(Io,{index:i,layer:t})]))},ko.prototype.refresh=function(t){for(var e=0,i=t=!(t instanceof Array)?[t]:t;e<i.length;e++){var n=i[e];n instanceof A.TileLayer&&this._display.clearLayer(n)}this.updateGrid()},ko.prototype.pixelToGeo=function(t,e){var i=this._wSize;1==arguments.length&&(e=t.y,t=t.x);var n=this._ox,r=this._oy,o=this._display.unproject(t,e),t=this._tlwx,e=this._tlwy,n=o[0]+t+n,r=o[1]+e+r;return(r%=i)<0&&(r+=i),new A.GeoPoint(To.x2lon(n%=i,i),To.y2lat(r,i))},ko.prototype.geoToPixel=function(t,e){e==wo&&(e=t.latitude,t=t.longitude),e<So?e=So:Ao<e&&(e=Ao);var i=this._wSize,n=this._tlwx,r=this._tlwy,n=To.lon2x(t,i)-n,r=To.lat2y(e,i)-r,r=this._display.project(n,r);return new A.PixelPoint(r[0],r[1])},ko.prototype.destroy=function(){var e=this,t=this._el;this.ui.destroy(),this._layers.forEach(function(t){return e.removeLayer(t)}),this._display.destroy(),t.parentNode.removeChild(t),this._mvcRecognizer.watch(!1),this._evDispatcher.destroy(),this._b.drag(!1),this._b.scroll(!1);var i=this;i.__proto__=null,Object.keys(i).forEach(function(t){return delete i[t]}),Po.splice(Po.indexOf(i),1)},ko.prototype.resize=function(t,e){var i=this._el;t!=wo&&e!=wo||(t=f(i.parentNode,"width"),e=f(i.parentNode,"height"));var n=this._w,r=this._h;n===t&&r===e||(i.style.width=t+"px",i.style.height=e+"px",this._display.setSize(t,e),this._w=t,this._h=e,this._cx=t/2,this._cy=e/2,this.updateGrid(),this._l.trigger("resize",[new wr("resize",{width:t,height:e})]))},ko.prototype.getWidth=function(){return this._w},ko.prototype.getHeight=function(){return this._h},ko.prototype.addObserver=function(t,e){return this._l.add(t="zoomLevel"==t?"zoomlevel":t,e)},ko.prototype.removeObserver=function(t,e){return this._l.remove(t="zoomLevel"==t?"zoomlevel":t,e)},ko.prototype.getContainer=function(){return this._el.parentNode},gt=ko;function ko(t,e){this._s=1,this._rz=0,this._rx=0,this._cw=new A.PixelPoint(0,0),this._c=new A.GeoPoint(0,0),this._pc=new A.GeoPoint(0,0),this._ox=0,this._oy=0,this._cfg=e=X.JSUtils.extend(!0,X.JSUtils.extend(!0,{},bo),e||{});var i=this;this._w=f(t,"width"),this._h=f(t,"height"),this._cx=this._w/2,this._cy=this._h/2;var n=e.zoomLevel||e.zoomlevel;e.maxLevel=Math.min(28,e.maxLevel),this._z=0^Math.min(20,n),this._wSize=256*Math.pow(2,this._z),this._l=new X.Listener(["center","rotation","zoomlevel","mapviewchangestart","mapviewchange","mapviewchangeend","resize",Co,Io]);var r=this._l,o=[],a=t;i._layers=o,i.id=1e6*Math.random()^0,(t=document.createElement("div")).className="_"+X.JSUtils.String.random(11),t.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)",t.style.position="relative",t.style.width=this._w+"px",t.style.height=this._h+"px",a.appendChild(t),this._el=t;a="canvas"==e.renderer?lr:An;"string"==typeof a.zoomBehavior&&(Lo=a.zoomBehavior);var s=new a(t,256,e.devicePixelRatio,e.renderOptions||{});i._mvcRecognizer=new Hr(i,function(t,e,i){r.trigger(t,[new wr(t,e)],i)},s),i._display=s,this._search=new Nr(i,s.dpr);var l=this._evDispatcher=new Pr(t,i,o,e);r.add("mapviewchangestart",function(t){return l.disable("pointerenter")}),r.add("mapviewchangeend",function(t){return l.enable("pointerenter")}),r.add("mapviewchangeend",function(t){return s.viewChangeDone()}),this.zoomAnimator=new yo(i);a=v(v({},e.behavior),e.behaviour);a[Eo]==wo&&(a[Eo]=Lo);o=this._b=new _r(t,i,new xo(i),a,e);o.drag(!0),o.scroll(!0),this._vplock={pan:!1,minLevel:e.minLevel,maxLevel:e.maxLevel};o=e.UI||e.ui||{};o.Compass==wo&&(o.Compass=a.rotate||a.pitch),this.ui=new fo(t,e,i),i.setCenter(e.center),i.pitch(e.pitch),i.rotate(e.rotate),i.setZoomlevel(n),i._layerClearListener=i._layerClearListener.bind(i);for(var h=0,u=e.layers||[];h<u.length;h++){var c=u[h];i.addLayer(c)}Po.push(this),e.debug&&this.debug(e.debug)}X.global.here.xyz.maps.Map=gt,t.Map=gt,t.MapEvent=wr,t.default=gt,Object.defineProperty(t,"__esModule",{value:!0})});
