/*
 * @here/xyz-maps-display
 * (c) 2019-2021 HERE
 */
import{global as t,TaskManager as e,LRU as i,Listener as n,JSUtils as r,Map as o}from"@here/xyz-maps-common";import{tileUtils as a,webMercator as s,GeoRect as l,GeoPoint as h,PixelPoint as u,utils as f,TileLayer as c}from"@here/xyz-maps-core";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var p=function(t,e){return(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};function d(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}p(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var v=function(){return(v=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function y(t,e,i,n){return new(i||(i=Promise))((function(r,o){function a(t){try{l(n.next(t))}catch(t){o(t)}}function s(t){try{l(n.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,s)}l((n=n.apply(t,e||[])).next())}))}function g(t,e){var i,n,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(r=2&o[0]?n.return:o[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,o[1])).done)return r;switch(n=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=a.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=e.call(t,a)}catch(t){o=[6,t],n=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var m=function(t,e,i,n){("string"==typeof e?[e]:e).forEach((function(e){t.addEventListener(e,i,n)}))},x=function(t,e,i,n){("string"==typeof e?[e]:e).forEach((function(e){t.removeEventListener(e,i,n)}))},_=function(t,e){return Math.round(parseFloat(function(t,e){var i,n;return(n=t.ownerDocument.defaultView.getComputedStyle(t,null))&&""===(i=n.getPropertyValue(e))&&(i=t.style[e]),i}(t,e)))||0},w=function(t,e,i,n){this.lrTs=!1,this.x=t,this.y=e,this.size=i,this.tile=n},b=function(){function t(t,e){this.ready=!1,this.cnt=0,this.z={},this.zLength=0,this.zd=!1,this._z3d=1/0,this.layer=t,this.tileSize=t.tileSize,this.layers=e,this.id=Math.floor(1e16*Math.random())}return t.prototype.getZ=function(t){var e=this.z;if(this.zd){var i=0;for(var n in e)e[n]=i++;this.zLength=i,this.zd=!1,this.z3d=e[this._z3d]}return e[t]||0},t.prototype.getAbsoluteZ=function(t){for(var e=this.index,i=this.layers,n=0,r=0;n<e;)r+=i[n++].zLength;return null!=t&&(r+=this.getZ(t)),r},t.prototype.addZ=function(t,e){var i=this.z;null==i[t]&&(i[t]=0,this.zd=!0,e&&t<this._z3d&&(this._z3d=t))},t.prototype.getZ3d=function(){for(var t,e=this.layers,i=0,n=0;t=e[i++];){if(t._z3d>=0)return n+t.z3d;n+=t.zLength}return n},t}(),T=function(t){function e(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];var r=t.apply(this,i)||this;return r._map={},Object.setPrototypeOf(r,e.prototype),r}return d(e,t),e.prototype.indexOf=function(e){var i=this._map[e.id];return t.prototype.indexOf.call(this,i)},e.prototype.fixZ=function(){for(var t=0;t<this.length;t++)this[t].index=t},e.prototype.add=function(e,i){var n,r=e.id,o=this._map[r];return o?(this.splice(t.prototype.indexOf.call(this,o),1),this.splice(i,0,o),n=!1):(o=this._map[r]=new b(e,this),this.splice(i,0,o),n=!0),this.fixZ(),n},e.prototype.remove=function(t){var e=this.indexOf(t);return-1!==e&&(this.splice(e,1),delete this._map[t.id],this.fixZ()),e},e.prototype.get=function(t){return"string"!=typeof t&&(t=t.id),this._map[t]},e.prototype.reset=function(t){for(var e,i=new Set,n=0;n<this.length;n++){var r=this[n];e=r.layer,r.error=!1,r.cnt=0,r.tiles=[],(r.visible=t>=e.min&&t<=e.max)?(r.ready=!1,i.add(e.tileSize)):r.ready=!0}return Array.from(i)},e}(Array),L=function(){function t(t,e){this.display=t,this.render=e}return t.prototype.forEachTile=function(t,e){t.getProvider().getCachedTilesOfBBox(t.getBBox()).forEach(e)},t.prototype.remove=function(t,e,i){for(var n=0,r=e;n<r.length;n++){var o=r[n];this.removeFromTile(t,o,i)}},t.prototype.modifyInTile=function(t,e,i,n){var r=this.isVertexDataInitialized(e);return!!r&&(this.display.updateTile(e,r,n,t),!0)},t.prototype.isVertexDataInitialized=function(t){return this.display.getBucket(t.quadkey)},t.prototype.addToTile=function(t,e,i){var n=this.isVertexDataInitialized(e);n&&this.display.updateTile(e,n,i,t)},t.prototype.removeFromTile=function(t,e,i){var n=this.isVertexDataInitialized(e);n&&this.display.updateTile(e,n,i,t)},t.prototype.add=function(t,e,i){for(var n=0,r=e;n<r.length;n++){var o=r[n];this.addToTile(t,o,i)}},t.prototype.updateGeometry=function(t,e,i,n){for(var r=n.getProvider(),o=r.getCachedTilesOfBBox(e),a=r.getCachedTilesOfBBox(t.getBBox()),s=0,l=a.length;s<l;s++){var h=o.indexOf(a[s]);-1===h?this.addToTile(t,a[s],n):(this.modifyInTile(t,a[s],i,n),o.splice(h,1))}for(s=0,l=o.length;s<l;s++)this.removeFromTile(t,o[s],n),this.removeFromTile(t,o[s],n)},t.prototype.repaint=function(t,e,i){var n=this;n.forEachTile(t,(function(e){var r=n.isVertexDataInitialized(e);r?n.display.updateTile(e,r,i,t):e.preview&&(e.preview=void 0)}))},t.prototype.clear=function(t,e){e=e||[];var i=this.display,n=i.layers.indexOf(t);i.buckets.forEach((function(i){e.length&&!function(t,e){for(var i,n,r=t.length,o=0;o<e.length;o++)if(n=t,i=e[o],r>e[o].length&&(i=n,n=e[o]),0===i.search(n))return!0}(i.quadkey,e)||(i.clear(n),i.ready(n,!1),i.cancelTasks(t),i.luTs=null)})),i.update()},t}(),A=[],S=function(){function t(t,e){this.display=t,"number"==typeof e?(this.down=e,this.up=e):(this.down=e[0],this.up=e[1])}return t.prototype.lookUp=function(t,e,i,n,r,o){var a,s,l,h=t.quadkey,u=i-n;if(a=Number(h[u]),o.x+=a%2*e/2,o.y+=Number(a>1)*e/2,l=h.substring(0,u),this.hasData(l,r)){var f=e/Math.pow(2,n);return s=[],this.add(s,l,o.x,o.y,f,0,0,e),s}o.x/=2,o.y/=2},t.prototype.add=function(t,e,i,n,r,o,a,s){t.push([e,i,n,r,r,0^o,0^a,s,s])},t.prototype.hasData=function(t,e){var i=this.display.buckets.get(t,!0);if(i)return i.ready(e)&&i.getData(e)},t.prototype.lookDown=function(t,e,i,n,r){var o,s,l,h,u,f,c=i+n;o=a.getTilesOfLevel(t.quadkey,c);for(var p=0;p<o.length;p++){s=l=0,h=e;for(var d=0;d<n;d++)h/=2,s+=(u=o[p][i+d])%2*h,l+=Number(u>1)*h,d==n-1&&this.hasData(o[p],r)&&(f=f||[],this.add(f,o[p],0,0,e,s,l,h))}return f},t.prototype.create=function(t,e,i,n){var r,o=t.quadkey.length,a=e.min,s=e.max,l=s-o,h=o-a,u={x:0,y:0},f=0,c=e.tileSize;i=i||this.down,(n=n||this.up)>h&&(n=h),i>l&&(i=l);for(var p=n>i?n:i,d=t.index(e);f++<p;){if(o-f>=a&&(r=this.lookUp(t,c,o,f,d,u)))return r;if(o+f<=s&&f<i&&(r=this.lookDown(t,c,o,f,d)))return r}return A},t}(),M=document.createElement("canvas").getContext("2d"),E="abcdefghijklmnopqrstuvwxyz",z=(E=E+E.toUpperCase()+" 0123456789").length,C={},I="normal 12px Arial",P=function(t,e,i,n){t.font=e.font||I,"number"==typeof e.strokeWidth?t.lineWidth=e.strokeWidth:t.lineWidth=1,t.strokeStyle=n,t.fillStyle=i,t.textAlign=e.textAlign||"start",t.lineCap="round",t.lineJoin="round"},k=function(t,e,i,n,r){var o=r.fill,a=r.stroke,s=r.strokeWidth;a&&0!=s&&t.strokeText(e,i,n),o&&t.fillText(e,i,n)},D=function(t,e,i,n,r){n=n||128,r=r||128,t.fillStyle="#000",t.fillRect(0,0,n,r),P(t,e,"#fff","#fff"),k(t,i,0,0,e);for(var o=t.getImageData(0,0,n,r).data,a=-1,s=-1,l=0;l<r;l++)for(var h=0;h<n;h++){if(0!=o[4*(l*n+h)]){-1==a&&(a=l);break}if(h==n-1&&-1!==a){s=l,l=r;break}}return t.clearRect(0,0,n,r),{height:s-a,min:a,max:s}},R=function(t){void 0===t&&(t={});var e=t.font,i=t.strokeWidth,n=(e=e||I)+(i=i||0);return C[n]||(M.font=e,M.textBaseline="top",C[n]={width:M.measureText(E).width/z,height:D(M,t,"gM").height}),C[n]},O=function(t,e){if(!1===e)return[t];null!=e&&!0!==e||(e=14);for(var i,n=[],r=0,o=-1,a=0,s=void 0,l=void 0,h=t.length;a<h;a++)l=a-r," "==(i=t.charAt(a))?o=a:"\n"==i&&(l=1/0,o=a),l>=e&&r<=o&&(s=t.substring(r,o),r=o+1,n.push(s)),a==h-1&&r<=a&&(s=t.substring(r,a+1),n.push(s));return n},N={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgrey:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",grey:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightslategrey:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"},U=function(t){return t.length<5?[parseInt(""+t[1]+t[1],16)/255,parseInt(""+t[2]+t[2],16)/255,parseInt(""+t[3]+t[3],16)/255,1]:[parseInt(t.slice(1,3),16)/255,parseInt(t.slice(3,5),16)/255,parseInt(t.slice(5,7),16)/255,1]};for(var F in N)N[F]=U("#"+N[F]);var B=function(t){var e;return t&&(Array.isArray(t)?3==(e=t).length&&(e[3]=1):e="#"==t[0]?U(t):(e=N[t])?e.slice():function(t){var e=t.match(/^rgba?\s*\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d*(?:\.\d+)?))?\)$/);return e&&e.length>3&&[e[1]/255,e[2]/255,e[3]/255,null==e[4]?1:Number(e[4])]}(t)),e},W=function(t,e){for(var i=0,n=[t,e];i<n.length;i++)for(var r=n[i],o=0;o<r.length;o++){for(var a=void 0,s=void 0,l=void 0,h=void 0,u=void 0,f=(o+1)%r.length,c=r[o],p=r[f],d=[p[1]-c[1],c[0]-p[0]],v=0,y=t;v<y.length;v++){var g=y[v];u=d[0]*g[0]+d[1]*g[1],(void 0===a||u<a)&&(a=u),(void 0===s||u>s)&&(s=u)}for(var m=0,x=e;m<x.length;m++){g=x[m];u=d[0]*g[0]+d[1]*g[1],(void 0===l||u<l)&&(l=u),(void 0===h||u>h)&&(h=u)}if(s<l||h<a)return!1}return!0},X=function(t,e,i,n,r){var o=Math.sin(r),a=Math.cos(r),s=t-i,l=e-n;return[a*s-o*l+i,o*s+a*l+n]},G=function(t,e,i,n,r){void 0===n&&(n=0),void 0===r&&(r=0);var o=n-(e*=.5),a=n+e,s=r-(i*=.5),l=r+i,h=X(o,s,n,r,t),u=X(a,l,n,r,t),f=X(o,l,n,r,t),c=X(a,s,n,r,t);return[Math.min(h[0],u[0],f[0],c[0]),Math.min(h[1],u[1],f[1],c[1]),Math.max(h[0],u[0],f[0],c[0]),Math.max(h[1],u[1],f[1],c[1])]},Z=function(t,e,i,n,r,o){return t>i&&t<r&&e>n&&e<o},H=function(t,e,i,n){var r=t-i,o=e-n;return Math.sqrt(r*r+o*o)},Y=function(t){return t>47&&t<58},j=function(){function t(){this.fonts={}}return t.getInstance=function(){return this.instance=this.instance||new t},t.prototype.getFontId=function(t,e){return""+(t.font||"normal 12px Arial")+(t.strokeWidth||1)+e},t.prototype.initFont=function(t,e){void 0===e&&(e=1);var i=this.fonts,n=this.getFontId(t,e);if(!i[n]){var r=96*e,o=function(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}(r,r),a=o.getContext("2d");a.textBaseline="bottom";var s=D(a,t,"gM").height;a.textBaseline="top";var l=D(a,t,"gM").height;P(a,t,"#fff","#000"),a.setTransform(e,0,0,e,0,0);var h=a.lineWidth,u=Math.floor(h),f=Math.floor(h),c=l+2*f;i[n]={name:n,size:0,glyphs:new Map,paddingX:u,paddingY:f,canvas:o,ctx:a,width:r,offsetX:2*h*e,scale:e,style:t,charWidthCache:new Map,rowHeight:c*e,letterHeightBottom:s,letterHeight:l,spaceWidth:a.measureText(" ").width*e,baselineOffset:e*((l-s)/2+f)}}return i[n]},t.prototype.hasGlyph=function(t,e){return e.glyphs.has(t)},t.prototype.getGlyph=function(t,e){var i,n=e.glyphs.get(t);if(!n){var r=e.canvas.width,o=e.offsetX,a=e.scale;e.ctx.clearRect(0,0,r,r),k(e.ctx,t,e.paddingX,e.paddingY,e.style);var s=e.charWidthCache.get(t);null==s?s=e.ctx.measureText(t).width:e.charWidthCache.delete(t);var l=Math.round((s||0)+2*e.paddingX)*a,h=e.ctx.getImageData(0,0,l,e.rowHeight);n={char:t,width:s,data:h,direction:(i=t.charCodeAt(0),function(t){return t>=32&&t<=47||t>=58&&t<=64||t>=91&&t<=96||t>=123&&t<=126}(i)||Y(i)?0:function(t){return t>=1424&&t<=1791||t>=1872&&t<=1919||t>=2208&&t<=2303||t>=64336&&t<=65023||t>=65136&&t<=65279}(i)?-1:1),advanceX:s?h.width-o:0},e.glyphs.set(t,n),e.size++}return n},t.prototype.getTextWidth=function(t,e){for(var i=e.ctx,n=0,r=0,o=t;r<o.length;r++){var a=o[r],s=e.glyphs.get(a);if(s)n+=s.width;else{var l=e.charWidthCache.get(a);null==l&&(l=i.measureText(a).width,e.charWidthCache.set(a,l)),n+=l}}return n},t}(),q=j.getInstance(),V=s.meterToPixel,K=s.pixelToMeter,Q=function(t){return 0^Math.min(t,20)},$={type:1,zIndex:1,fill:1,stroke:1,strokeWidth:1,radius:1,width:1,height:1,font:1,text:1,textRef:1,offsetX:1,offsetY:1,alignment:1,rotation:1,priority:1,repeat:1,collide:1,offset:1,from:1,to:1},J=new Map,tt=function(t,e,i){var n=et("text",t,e,i);if(!n&&t.textRef&&(null==(n=J.get(t.textRef))&&(n=new Function("f","return f."+t.textRef),J.set(t.textRef,n)),n=n(e,i)),""!=n)return void 0!==n&&"string"!=typeof n&&(n=String(n)),n},et=function(t,e,i,n){var r=e[t];return"function"==typeof r?r(i,n,e):r},it=function(t,e){void 0===e&&(e=!1);var i="px",n=t;return"string"==typeof t&&(n=parseFloat(t)||0,"m"==t.charAt(t.length-1))?(i="m",[n=Math.round(10*n)/10,i]):(e||(n^=0),[n,i])},nt=function(t,e,i,n){var r=et(t,e,i,n),o=it(r),a=o[0];if("m"==o[1]){var s=Q(n);a=Math.pow(2,n%s)*V(a,s)}return a},rt=function(t,e,i,n){var r=et("zIndex",t,e,i),o=et("zLayer",t,e,i);return"number"!=typeof o&&(o=n+1),1e6*o+r},ot=function(t,e,i,n){for(var r=0,o=Q(i),a=0,s=t;a<s.length;a++){var l=s[a],h=rt(l,e,o,n);h>r&&(r=h)}return r},at=function(t,e,i,n){for(var r,o=0,a=0,s=Q(i),l=0;l<t.length;l++){r=t[l];var h=rt(r,e,s,n);h>a&&(a=h);var u=et("strokeWidth",r,e,s);isNaN(u)&&(u=1);var f=it(u,!0),c=f[0];if("m"==f[1])c=Math.pow(2,i%s)*V(c,s);c>o&&(o=c)}return[o,a]},st=function(t,e,i,n,r,o){var a,s,l,h,u,f,c=Q(i),p=et("type",t,e,c);r=r||[1/0,1/0,-1/0,-1/0];var d=et("fill",t,e,c),v=!o&&et("stroke",t,e,c);if("Image"!=p&&!d&&!v)return null;if("Text"==p){var y=tt(t,e,c);if(!y)return null;var g=et("strokeWidth",t,e,c),m=et("font",t,e,c),x=q.initFont({font:m,strokeWidth:g,fill:d,stroke:v},n),_=void 0;if(u=0,"LineString"==e.geometry.type||"MultiLineString"==e.geometry.type)u=q.getTextWidth(y,x),f=x.letterHeight;else{for(var w=et("lineWrap",t,e,c),b=0,T=_=O(y,w);b<T.length;b++){var L=T[b],A=q.getTextWidth(L,x);A>u&&(u=A)}f=_.length*x.letterHeight}}else{g=et("strokeWidth",t,e,c);isNaN(g)&&(g=1),"Circle"==p?f=u=2*nt("radius",t,e,c)^0:(u=0^nt("width",t,e,c),f=0^((f=nt("height",t,e,c))||u)),f+=g,u+=g}var S=0^et("offsetX",t,e,c),M=0^et("offsetY",t,e,c),E="Circle"!=p&&0^et("rotation",t,e,c);if(E){var z=G(E,u,f,S,M);a=z[0],l=z[1],s=z[2],h=z[3]}else s=(a=S-.5*u)+u,h=(l=M-.5*f)+f;return a<r[0]&&(r[0]=a),s>r[2]&&(r[2]=s),l<r[1]&&(r[1]=l),h>r[3]&&(r[3]=h),r},lt=function(t,e,i,n,r){for(var o,a,s=Q(i),l=0,h=0,u=t;h<u.length;h++){var f=u[h];a=st(f,e,i,n,a,!0)||a,(o=rt(f,e,s,r))>l&&(l=o)}if(a)return a[4]=l,a},ht=function(t){return t.type&&null!=t.zIndex},ut=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=1),Math.min(i,Math.max(e,t))},ft=function(t,e,i,n,r){return function(t,e,i){return t*(1-i)+e*i}(i,n,function(t,e,i){return ut((i-t)/(e-t))}(t,e,r))},ct=function(t,e){var i,n,r,o,a,s=0;for(var l in t){var h=Number(l);n=t[h];var u=Array.isArray(n),f=void 0,c=void 0;if(u?f=n:(f=(i=it(n))[0],c=i[1]),"px"==c&&(n=f),e<=h){if(0==s)return"m"==c?t[h]:f;if(u){for(var p=[],d=0;d<f.length;d++)p[d]=ft(a,h,r[d],f[d],e);return p}if(h-a>1){var v=r,y=f,g=c!=o,m="m"==c;return g&&(m?v=K(v,a):y=K(y,h)),ft(a,h,v,y,e)+(g||m?"m":0)}return n}a=h,r=f,o=c,s++}return n},pt=function(t,e){for(var i=1;i<=20;i++)t[i]=ct(e,i);return t},dt=function(t){for(var e in t)t[e]=B(t[e])},vt=function(t){var e=function(e,i){return t[i]};return e.map=t,e},yt=function(t){if(!t.__p){t.__p=!0;for(var e=0,i=t;e<i.length;e++){var n=i[e];for(var r in n)if(r in $){var o=n[r];if("object"==typeof o&&!Array.isArray(o)){"stroke"!=r&&"fill"!=r||dt(o);var a=pt({},o);n[r]=vt(a)}}}}},gt=function(){return 1},mt=function(){function t(t,e){this.tm=t,this.ms=e}return t.prototype.exclusiveRuntime=function(t){this.ms=t},t.prototype.spawn=function(t,e,i,n,r,o,a,s){var l=this.createTask(t,e,i,n,r,o,a);return this.tm.start(l,s),l},t.prototype.createTask=function(t,e,i,n,r,o,a){var s=[],l=this.ms,h=this.tm.create({time:l,priority:t,init:function(){if(n){for(var t=n.length,o=Date.now();t--;)n[t];h.time=l-(Date.now()-o)}return[i,n,r,0,s,300,e,{}]},name:"cluster",onDone:function(){var t=e.getStyle(),n=t&&(t.strokeWidthZoomScale||t.LineStringZoomScale)||gt;s.swzs=n(i.z),a(s,this)},exec:function(t){var e,i,n,r,a,s,l,h,u,f,c,p,d,v,y,g,m,x,_,w=t[0],b=t[1],T=t[2],L=t[6],A=b.length,S=t[4],M=w.z;if(b&&!(t[3]>=A)){for(;t[5]--&&(a=b[t[3]++]);)if(!T[s=a.id]&&(T[s]=!0,n=L.getStyleGroup(a,M))){n.length||(n=[n]);for(var E=0,z=n.length;E<z;E++)r=n[E],ht(r)&&(e=et("zIndex",r,a,M),l=et("type",r,a,M),y=et("opacity",r,a,M),p=void 0,c=void 0,d=void 0,v=void 0,x=void 0,g=void 0,m=void 0,void 0,_=void 0,void 0,"Image"==l?i="I":(c=et("fill",r,a,M),d=et("stroke",r,a,M),v=et("strokeWidth",r,a,M),i="Line"==l?"L"+((g=et("strokeLinecap",r,a,M))||"*")+((m=et("strokeLinejoin",r,a,M))||"*")+((x=et("strokeDasharray",r,a,M))||"*"):"Text"==l?"T"+((p=et("font",r,a,M)||"normal 12px Arial")||"*"):"Circle"==l?"C"+et("radius",r,a,M)||"*":"R"+(_=et("width",r,a,M))+(et("height",r,a,M)||_),i+=(d||"*")+(v||"*")+(c||"*")),null!=y&&(i+=100*y^0),null==(f=(h=S[e]=S[e]||[])[i])?(f=h[i]=h.length,u=h[f]={shared:{font:p,fill:c,opacity:y,stroke:d,strokeWidth:v,strokeLinecap:g,strokeLinejoin:m,strokeDasharray:x},data:new o}):u=h[f],u.data.add(a,r))}return t[5]=300,t[3]<A}}});return h},t}(),xt=function(){function t(t){this.tiles={},this.size=t}return t.prototype.init=function(t,e,i,n,r){this.cwpx=t[0],this.cwpy=t[1],this.width=i,this.height=n,this.bounds=r;for(var o=1/0,a=-o,s=1/0,l=-s,h=0,u=r;h<u.length;h++){var f=u[h];f[0]<o&&(o=f[0]),f[0]>a&&(a=f[0]),f[1]<s&&(s=f[1]),f[1]>l&&(l=f[1])}this.minX=o,this.maxX=a,this.minY=s,this.maxY=l},t.prototype.getTiles=function(t,e){void 0===e&&(e=this.size);for(var i=this.width,n=this.height,r=Math.pow(2,t)*e,o=this.bounds,s=[],l=this.cwpx*r,h=this.cwpy*r,u=l-i/2+this.minX,f=h-n/2+this.minY,c=l+i/2+this.maxX-i,p=h+n/2+this.maxY-n,d=a.pixelToGrid(u/e,f/e,t),v=a.pixelToGrid(c/e,p/e,t),y=v[0]-d[0]+1,g=v[1]-d[1]+1,m=a.getTilesIds(d,v),x=d[0]*e-u+this.minX,_=d[1]*e-f+this.minY,w=0,b=0;w<g;w++)for(var T=0;T<y;T++){var L=x+T*e,A=_+w*e,S=L+e,M=A+e,E=m[b++];W(o,[[L,A],[S,A],[S,M],[L,M]])&&s.push({quadkey:E,x:L,y:A})}return this.tiles[e]=s,s},t}();function _t(t,e,i){if(e[t+="EventListener"])for(var n in i)e[t](n,i[n])}var wt=function(){function i(t,n,r,o,a,s){this.updating=!1,this.dirty=!1,this.globalBgc=!1;var l=this,h=_(t,"width"),u=_(t,"height"),f=function(t,e,i,n,r){var o,a=document.createElement("canvas"),s=a.style;return function(t,e,i){t.setAttribute("width",e),t.setAttribute("height",i)}(a,e,i),a.setAttribute("oncontextmenu","return false;"),function(t,e){["-webkit-user-select","-moz-user-select","-ms-user-select","user-select"].forEach((function(i){t.style[i]=e}))}(a,"none"),s.top=s.left="0px",s.position="absolute",1!=r&&(s.opacity=String(r)),t.querySelectorAll("canvas[type=layer]"),a.setAttribute("type","layer"),(o=t.querySelectorAll("canvas")[n])?t.insertBefore(a,o):t.appendChild(a),a}(t,h,u,0);l.previewer=new S(l,s),l.cluster=new mt(e.getInstance(),4),l.grid=new xt(n),l.tiles={256:[],512:[]},l.render=a,l.tileSize=n,l.buckets=o,l.layers=new T,l.w=h,l.h=u,l.canvas=f,f.className="tmc",l.dpr=i.getPixelRatio(r),l.setSize(h,u),l.setBGColor();var c=new L(l,a);l.listeners={clear:function(t){var e=t.detail,i=e.tiles,n=e.layer;c.clear(n,i)},featureAdd:function(t){var e=t.detail,i=e.feature,n=e.tiles,r=e.layer;n&&c.add(i,n,r)},featureRemove:function(t){var e=t.detail,i=e.feature,n=e.tiles,r=e.layer;n&&c.remove(i,n,r)},featureCoordinatesChange:function(t){var e=t.detail,i=e.feature,n=e.prevBBox,r=e.prevCoordinates,o=e.layer;c.updateGeometry(i,n,r,o)},styleGroupChange:function(t){var e=t.detail,i=e.feature,n=e.styleGroup,r=e.layer;c.repaint(i,n,r)},styleChange:function(t){var e=t.detail,i=e.layer,n=e.style,r=l.layers.indexOf(i);l.setLayerBgColor(n,l.layers[r]),l.buckets.tiles.forEach((function(t){return t.clear(r)}))}}}return i.getPixelRatio=function(e){return(e="auto"==e?Math.min(2,t.devicePixelRatio||1):e||1)<1?1:e},i.prototype.addLayer=function(t,e,i){var n=this,r=n.layers,o=!1;if(r.add(t,i)){var a=r.get(t);a.handleTile=function(e){n.isVisible(e,a)&&n.handleTile(e,t)},_t("add",t,n.listeners),0==i&&n.setLayerBgColor(t.getStyle(),a),n.buckets.forEach((function(t){t.addLayer(i)})),o=!0}return o},i.prototype.removeLayer=function(t){var e=this.layers,i=e.get(t),n=i.tiles,r=e.indexOf(t);if(-1!==r){this.buckets.forEach((function(e){e.cancelTasks(t),e.removeLayer(r)}));for(var o=0,a=n;o<a.length;o++){var s=a[o].tile.quadkey;this.releaseTile(s,i),this.cancel(s,t)}e.remove(t),_t("remove",t,this.listeners)}return r},i.prototype.getBucket=function(t,e){return e?this.buckets.create(t,this.layers):this.buckets.get(t)},i.prototype.handleTile=function(t,e,i,n){var r,o=this,a=!1;if(i?a=!0:i=o.getBucket(t.quadkey,!0),null==n&&(n=o.layers.indexOf(e)),t.error&&(o.layers[n].error=!0),!i.ready(n)&&!i.busy(e)&&(r=t.data)){var s=function(e,i){t.isLoaded()&&e.ready(e.index(i),!0),o.update(a)};i.ready(n,!1);var l=e.render;l?l(t,r,e,i,s):o.prepareTile(t,r,e,i,s)}},i.prototype.setLayerBgColor=function(t,e){var i=t.backgroundColor;i&&(e.bgColor=this.render.convertColor(i))},i.prototype.isVisible=function(t,e){for(var i=t.quadkey,n=0,r=e.tiles;n<r.length;n++){if(r[n].tile.quadkey==i)return!0}return!1},i.prototype.updateTile=function(t,e,i,n){if(e&&!e.busy(i)){var r=e.index(i);e.ready(r,!1),this.isVisible(t,this.layers[r])&&this.handleTile(t,i,e,r)}},i.prototype.setSize=function(t,e){var i=this.dpr,n=this.canvas;this.w=t,this.h=e,n.width=t*i,n.height=e*i,n.style.width=t+"px",n.style.height=e+"px"},i.prototype.cancel=function(t,e){var i=this.buckets.get(t,!0);i&&i.cancelTasks(e)},i.prototype.preview=function(t,e,i){var n=this.previewer.create(t,e);return t.preview(i,n),n},i.prototype.initVpTiles=function(t,e,i){for(var n=this,r=this.layers,o=n.tiles[i],a=n.tiles[i]=[],s=[],l=0,h=t;l<h.length;l++){var u=h[l],f=u.x,c=u.y,p=u.quadkey,d=n.getBucket(p,!0),v=new w(f,c,i,d);d.i=++this.ti,s.push(v),a.push(v);for(var y=0,g=r;y<g.length;y++){var m=g[y],x=m.layer;(x.tileSize||256)==i&&(m.tiles!=s&&(m.tiles=s),e>=x.min&&e<=x.max&&(n.initTile(d,m),x.getTile(p,m.handleTile)))}}o.forEach((function(t){for(var e=t.tile.quadkey,o=0,s=a;o<s.length;o++){if(s[o].tile.quadkey==e)return}for(var l=0,h=r;l<h.length;l++){var u=h[l];u.layer.tileSize==i&&n.releaseTile(e,u)}n.cancel(e)}))},i.prototype.updateGrid=function(t,e,i,n){this.viewChange=!0,this.sx=i,this.sy=n;var r=this.rz,o=this.w,a=this.h,s=o,l=a,h=this.grid,u=[this.unproject(0,0),this.unproject(s-1,0),this.unproject(s-1,l-1),this.unproject(0,l-1)];h.init(t,r,o,a,u);var f=this.layers.reset(e+Math.log(this.s)/Math.LN2);this.ti=0;for(var c=0,p=f;c<p.length;c++){var d=p[c],v=this.grid.getTiles(e-Number(512==d),d);this.initVpTiles(v,e,d)}-1==f.indexOf(512)&&this.grid.getTiles(e-1,512),this.dirty=!0,this.update()},i.prototype.releaseTile=function(t,e){var i=e.layer.getCachedTile(t);i&&i.loadStartTs&&(i.isLoaded()||e.layer.cancelTile(i,e.handleTile))},i.prototype.initTile=function(t,e){var i=e.index;e.visible?t.ready(i)||t.preview(i)||this.preview(t,e.layer,i):t.ready(i,!0)},i.prototype.update=function(t){var e=this;e.updating||(e.updating=!0,requestAnimationFrame((function(){e.viewport(t),e.updating=!1})))},i.prototype.setBGColor=function(e){var i=this.render,n=e||t.getComputedStyle(this.canvas.parentElement,null).getPropertyValue("background-color");n&&"rgba(0, 0, 0, 0)"!=n&&"transparent"!=n||(n="#ffffff"),n=i.convertColor(n),this.globalBgc=n,i.setBackgroundColor(n)},i.prototype.showGrid=function(t){this.render.grid(!!t)},i.prototype.setTransform=function(t,e,i){this.render.setScale(this.s=t,0,0),this.render.setRotation(this.rz=e,this.rx=i),this.render.applyTransform()},i.prototype.getLayers=function(){return this.layers},i.prototype.destroy=function(){this.render.destroy();var t=this.canvas;t.parentElement.removeChild(t),t.width=t.height=1},i.prototype.clearLayer=function(t){var e=this.getLayers().indexOf(t);this.buckets.forEach((function(t){t.preview(e,!1),t.ready(e,!1)}))},i.prototype.viewChangeDone=function(){this.viewChange=!1},i}(),bt=document.createElement("canvas");bt.width=1,bt.height=1;var Tt=bt.getContext("2d");function Lt(){var t=this._s;for(var e in Tt.drawImage(this,0,0),this.ready=!0,t)t[e][0](this,t[e][1])}var At,St=function(){function t(){this.src={}}return t.prototype.isRequested=function(t){return!!this.src[t]},t.prototype.isReady=function(t){return this.src[t]&&this.src[t].ready},t.prototype.get=function(t,e,i,n){var r=this.src;if(null==r[t]){var o=r[t]=new Image;o.ready=!1,o._s={},e&&(o._s[i]=[e,n]),o.crossOrigin="Anonymous",o.onload=Lt,o.src=t}else e&&(r[t].ready?e(r[t],n):r[t]._s[i]=[e,n]);return r[t]},t}(),Mt=function(){function t(t,e,i){this.gl=t,this.format=i||t.RGBA,e&&this.set(e)}return t.prototype.bind=function(){var t=this.gl,e=this.texture;e&&t.bindTexture(t.TEXTURE_2D,e)},t.prototype.set=function(t,e,i){var n=this.gl,r=this.texture,o=this.format,a=t.width,s=t.height,l=o,h="number"==typeof e;r||(this.texture=r=n.createTexture()),n.bindTexture(n.TEXTURE_2D,r),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),h||this.width==a&&!this.height&&!s?n.texSubImage2D(n.TEXTURE_2D,0,e||0,i||0,o,n.UNSIGNED_BYTE,t):(t instanceof HTMLCanvasElement||t instanceof HTMLImageElement?n.texImage2D(n.TEXTURE_2D,0,l,o,n.UNSIGNED_BYTE,t):n.texImage2D(n.TEXTURE_2D,0,l,a,s,0,o,n.UNSIGNED_BYTE,t.pixels),this.width=a,this.height=s),a==s&&function(t){return 0==(t&t-1)}(s)?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.generateMipmap(n.TEXTURE_2D)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR))},t.prototype.destroy=function(){var t=this.gl,e=this.texture;e&&(t.deleteTexture(e),this.texture=null)},t}(),Et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return d(e,t),e.prototype.destroy=function(e){e&&t.prototype.destroy.call(this)},e}(Mt),zt=function(t,e,i,n,r){this.i=t,this.u1=e,this.v1=n,this.u2=i,this.v2=r},Ct=function(){function t(t){var e=t.gl,n=t.maxImgSize||256,r=Math.pow(1024/n,2),o=Math.sqrt(r);this.c=new i(r),this.max=r,this.maxSize=n,this.gl=e,this.d=o}return t.prototype.get=function(t){return this.c.get(t)},t.prototype.init=function(){this.texture,this.gl;var t=this.maxSize,e=this.d;if(!this.texture){var i=e*t;this.texture=new Et(this.gl,{width:i,height:i})}},t.prototype.set=function(t,e){var i,n=this.c,r=this.d,o=this.maxSize,a=n.get(t),s=!1;a?i=a.i:((i=n.length)>=n.max&&(i=(a=n.tail.data).i),s=!0);var l=i%r^0,h=i/r^0,u=l*o,f=h*o,c=u+e.width,p=f+e.height;return a?(a.u1=u,a.u2=c,a.v1=f,a.v2=p):a=new zt(i,u,c,f,p),(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(this.init(),this.texture.set(e,l*o,h*o)),s&&n.set(t,a),a},t.prototype.destroy=function(){var t=this.texture;t&&t.destroy(!0)},t}(),It=function(){function t(t,e){this.images=new St,this.atlas=new Ct({gl:t,maxImgSize:64})}return t.prototype.getTexture=function(){return this.atlas.texture},t.prototype.get=function(t,e,i,n){var r=this.atlas,o=this.images,a=this.onLoad,s=r.get(t);if(!s&&!o.get(t,(function(e){s=r.set(t,e),n&&n(s),a&&a(s)})).ready)return!1;return s},t.prototype.destroy=function(){this.atlas.destroy()},t}(),Pt=window.console.error,kt=function(t,e,i,n){n=n||Pt;var r=t.createShader(i);return t.shaderSource(r,e),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(n("compileShader "+t.getShaderInfoLog(r)),t.deleteShader(r),null)},Dt=function(t,e,i){return function(t,e,i){i=i||Pt;for(var n=t.createProgram(),r=0,o=e;r<o.length;r++){var a=o[r];t.attachShader(n,a)}return t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)?n:(i("linkProgram "+t.getProgramInfoLog(n)),t.deleteProgram(n),null)}(t,[kt(t,e,t.VERTEX_SHADER),kt(t,i,t.FRAGMENT_SHADER)])},Rt=function(t){for(var e in t)this[e]=t[e]};!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.ALPHA=1]="ALPHA",t[t.POST_ALPHA=2]="POST_ALPHA"}(At||(At={}));var Ot,Nt=function(){function t(t,e,i,n,r){this.attributes={},this.uniforms={},this.uniformSetters={},this.macros=["#define M_PI 3.1415927410125732"];var o=this.macros.concat("#define DEVICE_PIXEL_RATIO "+r.toFixed(1)+"\n").join("\n"),a=Dt(t,o+"vec2 round(vec2 point){\n    vec2 fractPoint = fract(point);\n    point += step(0.5, fractPoint) - fractPoint;\n    return point;\n}\n\nvec4 snapToScreenPixel(vec4 position, vec2 resolution){\n    resolution *= DEVICE_PIXEL_RATIO;\n    vec2 screenPixel = ((position.xy / position.w + 1.0) / 2.0) * resolution;\n    position.xy = (round(screenPixel) / resolution * 2.0 - 1.0) * position.w;\n    return position;\n}\n"+i,o+n);this.mode=e,this.usage=t.STATIC_DRAW,this.gl=t,this.prog=a,this.glStates=new Rt({scissor:!0,blend:!1,depth:!0});for(var s=t.getProgramParameter(a,t.ACTIVE_ATTRIBUTES),l=0;l<s;++l){var h=t.getActiveAttrib(a,l).name;this.attributes[h]=t.getAttribLocation(a,h)}for(var u=t.getProgramParameter(a,t.ACTIVE_UNIFORMS),f=0;f<u;f++){var c=t.getActiveUniform(a,f),p=(h=c.name,t.getUniformLocation(a,h));this.uniforms[h]=p,this.uniformSetters[c.name]=this.createUniformSetter(c,p)}}return t.prototype.createUniformSetter=function(t,e){var i=this.gl;switch(t.type){case i.FLOAT:return function(t){return i.uniform1f(e,t)};case i.FLOAT_MAT4:return function(t){return i.uniformMatrix4fv(e,!1,t)};case i.FLOAT_VEC2:return function(t){return i.uniform2fv(e,t)};case i.FLOAT_VEC3:return function(t){return i.uniform3fv(e,t)};case i.FLOAT_VEC4:return function(t){return i.uniform4fv(e,t)};case i.BOOL:case i.SAMPLER_2D:return function(t){return i.uniform1i(e,t)}}return function(){}},t.prototype.getUniformLocation=function(t){return this.uniforms[t]},t.prototype.setUniform=function(t,e){var i;(i=this.uniformSetters[t])&&i(e)},t.prototype.initUniforms=function(t){for(var e in t){var i=this.uniformSetters[e];i&&i(t[e])}},t.prototype.initAttributes=function(t,e){var i,n,r=this.gl;for(var o in t)i=t[o],n=this.attributes[o],r.bindBuffer(r.ARRAY_BUFFER,e.get(i)),r.vertexAttribPointer(n,i.size,i.type,i.normalized,i.stride,i.offset),r.enableVertexAttribArray(n)},t.prototype.initIndex=function(t,e){var i=this.gl,n=e.get(t),r=!0;n||(n=i.createBuffer(),e.set(t,n),r=!1),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,n),r?delete t.data:i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.data,i.STATIC_DRAW)},t.prototype.pass=function(t){return t==At.OPAQUE},t.prototype.draw=function(t,e){var i=this.gl,n=t.index,r=t.texture,o=t.mode||this.mode;r&&(i.activeTexture(i.TEXTURE0),r.bind()),n?(this.initIndex(n,e),i.drawElements(o,n.length,n.type,0)):i.drawArrays(o,t.arrays.first,t.arrays.count)},t.prototype.setStates=function(t,e,i,n){var r=this.gl;t?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),n?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e?r.enable(r.BLEND):r.disable(r.BLEND),i?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST)},t.prototype.init=function(t,e,i){var n=this.gl,r=e==At.OPAQUE,o=this.glStates,a=o.blend,s=o.scissor,l=o.depth;null!=t.scissor&&(s=t.scissor),null!=t.blend&&(a=t.blend),null!=t.depth&&(l=t.depth),this.setStates(s,a,l,i&&!r&&a&&s),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.depthMask(r)},t}(),Ut=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,"precision lowp float;\n\nattribute highp vec2 a_position;\nuniform float u_scale;\n\nuniform vec4 u_size;\nuniform mat4 u_matrix;\nuniform float u_strokeWidth;\nuniform vec2 u_topLeft;\nuniform float u_rotation;\nuniform vec4 u_offset;\nuniform bool u_alignMap;\nuniform vec2 u_resolution;\n\nvarying vec2 vSize;\nvarying vec2 vDir;\n\nconst float EXTENT_SCALE = 1.0 / 32.0;// 8912->512\n\nfloat toPixel(vec2 size){\n    float pixel = size.x;\n    if (size.y > 0.0){\n        // value is defined in meters -> convert to pixels at current zoom\n        pixel *= u_scale * size.y;\n    }\n    return pixel;\n}\n\nvoid main(void){\n    // LSB defines visibility\n    if (mod(a_position.x, 2.0) == 1.0)\n    {\n        // bit1 is direction/normal vector [-1,+1]\n        vec2 dir = mod(floor(a_position / 2.0), 2.0) * 2.0 - 1.0;\n        vec2 pos = floor(a_position / 4.0) * EXTENT_SCALE;\n        vec2 size = vec2(toPixel(u_size.xy), toPixel(u_size.zw));\n\n        size = (size + u_strokeWidth) * .5;\n\n        float rotation = u_rotation;\n\n        if (!u_alignMap){\n            rotation *= -1.0;\n        }\n\n        float rotSin = sin(rotation);\n        float rotCos = cos(rotation);\n        mat2 mRotate = mat2(rotCos, -rotSin, rotSin, rotCos);\n\n        vec2 pixel_offset = vec2(toPixel(u_offset.xy), toPixel(u_offset.zw));\n\n        if (u_alignMap){\n\n            vec2 shift = (pixel_offset + dir * size * mRotate) / u_scale;\n            gl_Position = u_matrix * vec4(u_topLeft + pos + shift, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4(u_topLeft + pos, 0.0, 1.0);\n            vec2 shift = dir * size * mRotate;\n            vec2 offset = pixel_offset * vec2(1.0, -1.0);\n\n            gl_Position = vec4(cpos.xy / cpos.w + (offset + shift) / u_resolution * 2.0, 0.0, 1.0);\n        }\n\n        vSize = size;\n        vDir = dir;\n\n    }\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\nuniform vec4 u_stroke;\nuniform float u_strokeWidth;\n\nvarying vec2 vSize;\nvarying vec2 vDir;\n\n#define COLOR_UNDEF -1.0\n\nvoid main(void){\n    float dx = distance(vDir.x, 0.0) * vSize.x;\n    float dy = distance(vDir.y, 0.0) * vSize.y;\n\n    if (dx > vSize.x-u_strokeWidth || dy > vSize.y-u_strokeWidth){\n        gl_FragColor = u_stroke;\n    } else {\n        gl_FragColor = u_fill;\n        if(u_fill[0] == COLOR_UNDEF){\n//            discard;\n            gl_FragColor.a = 0.0;\n        };\n\n    }\n}\n",i)||this;return n.name="Rect",n.glStates=new Rt({scissor:!1,blend:!1,depth:!0}),n}return d(e,t),e}(Nt),Ft=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,"precision lowp float;\n\nattribute highp vec2 a_position;\nuniform vec2 u_radius;\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\nuniform vec4 u_offset;\nuniform float u_scale;\nuniform vec2 u_resolution;\nuniform bool u_alignMap;\nuniform float u_strokeWidth;\n\nvarying vec2 v_position;\nvarying float v_radius;\n\nconst float EXTENT_SCALE = 1.0 / 32.0;// 8912->512\n\nfloat toPixel(vec2 size){\n    float value = size.x;\n    if (size.y > 0.0){\n        // value is defined in meters -> convert to pixels at current zoom\n        value *= u_scale * size.y;\n    }\n    return value;\n}\n\nvoid main(void){\n\n    if (mod(a_position.x, 2.0) == 1.0)\n    {\n        // LSB is direction/normal vector [-1,+1]\n        vec2 dir = mod(floor(a_position / 2.0), 2.0) * 2.0 - 1.0;\n        vec2 pos = floor(a_position / 4.0) * EXTENT_SCALE;\n\n        float radius = toPixel(u_radius);\n\n        radius = radius + u_strokeWidth / 2.0;\n\n        v_position = dir * radius;\n        v_radius = radius;\n\n        vec2 pixel_offset = vec2(toPixel(u_offset.xy), toPixel(u_offset.zw));\n\n        if (u_alignMap){\n            vec2 shift = (pixel_offset + v_position) / u_scale;\n            gl_Position = u_matrix * vec4(u_topLeft + pos + shift, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4(u_topLeft + pos, 0.0, 1.0);\n            vec2 offset = pixel_offset * vec2(1.0, -1.0);\n            gl_Position = vec4(cpos.xy / cpos.w + (offset + v_position) / u_resolution * 2.0, 0.0, 1.0);\n        }\n    }\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\nuniform vec4 u_stroke;\nuniform float u_strokeWidth;\n\nvarying float v_radius;\nvarying vec2 v_position;\n\n#define COLOR_UNDEF -1.0\n\nvoid main(void){\n    float r = length(v_position);\n\n    if (r > v_radius) discard;\n\n    if (r < v_radius - u_strokeWidth){\n        if(u_fill[0] == COLOR_UNDEF) discard;\n        gl_FragColor = u_fill;\n    } else {\n        gl_FragColor = u_stroke;\n    }\n}\n",i)||this;return n.name="Circle",n.glStates=new Rt({scissor:!1,blend:!1,depth:!0}),n}return d(e,t),e}(Nt),Bt="precision lowp float;\n\nattribute vec2 a_position;\nattribute highp vec4 a_normal;\nattribute float a_lengthSoFar;\n\nuniform mat4 u_matrix;\nuniform highp vec2 u_strokeWidth;\nuniform highp float u_scale;\nuniform vec2 u_topLeft;\nuniform float u_texWidth;\nvarying vec2 v_normal;\nvarying float v_lengthSoFar;\nvarying vec2 v_width;\n\nuniform vec2 u_offset;\nuniform float u_tileScale;\n\nconst float N_SCALE = 1.0 / 8192.0;\n\n\nfloat toPixel(vec2 size){\n    float value = size.x;\n    if (size.y > 0.0){\n        // value is defined in meters -> convert to pixels at current zoom\n        value *= u_scale * size.y;\n    }\n    return value;\n}\n\nvoid main(void){\n\n    float strokeWidth = toPixel(u_strokeWidth);\n    float alias = strokeWidth<1. ? .65 : 1.;\n    float width = (strokeWidth+alias) / u_scale;\n    v_width = vec2(strokeWidth, alias * .5);\n    // LSB is direction/normal vector [-1,+1]\n    vec2 dir2 = mod(a_normal.zw, 2.0) * 2.0 - 1.0;\n    vec2 aliasNormal = floor(a_normal.zw * .5) * N_SCALE;\n    v_normal = dir2 * aliasNormal;\n    // LSB is direction/normal vector [-1,+1]\n    vec2 dir = mod(a_normal.xy, 2.0) * 2.0 - 1.0;\n    vec2 normal = floor(a_normal.xy * .5) * N_SCALE;\n\n    v_lengthSoFar = a_lengthSoFar / u_texWidth;\n\n    float lineOffset = toPixel(u_offset);\n\n    vec2 position = a_position + normal * -lineOffset / u_scale;\n\n    gl_Position = u_matrix * vec4(u_topLeft + position * u_tileScale + dir * normal * width, 0.0, 1.0);\n}\n\n",Wt=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,Bt,"precision lowp float;\n\nuniform sampler2D u_pattern;\nuniform vec4 u_fill;\nvarying vec2 v_normal;\nvarying float v_lengthSoFar;\nvarying vec2 texCoord;\nvarying vec2 v_width;\n\nvoid main(void){\n\n    float width = length(v_normal) * (v_width.s + v_width.t);\n    float alpha = 1.0 - clamp(.5 * (width - v_width.s + v_width.t) / v_width.t, .0, 1.);\n\n    gl_FragColor = u_fill;\n    gl_FragColor.a *= alpha;\n}\n",i)||this;return n.name="Line",n.glStates=new Rt({blend:!0,scissor:!0,depth:!0}),n}return d(e,t),e.prototype.pass=function(t){return t==At.ALPHA},e.prototype.init=function(e,i,n){t.prototype.init.call(this,e,i,n),this.gl.depthMask(!1)},e}(Nt),Xt=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,Bt,"precision lowp float;\n\nuniform vec4 u_fill;\nvarying vec2 v_normal;\nvarying vec2 v_width;\nvarying float v_lengthSoFar;\n\nuniform sampler2D u_pattern;\n\nvoid main(void){\n\n    float width = length(v_normal) * (v_width.s + v_width.t);\n    float alpha = 1.0 - clamp(.5 * (width - v_width.s + v_width.t) / v_width.t, .0, 1.);\n\n    gl_FragColor = u_fill;\n    gl_FragColor.a *= alpha * texture2D(u_pattern, vec2(fract(v_lengthSoFar))).r;\n}\n",i)||this;return n.name="Line",n.glStates=new Rt({blend:!0,scissor:!0,depth:!0}),n}return d(e,t),e.prototype.pass=function(t){return t==At.ALPHA},e.prototype.init=function(e,i,n){var r=this.gl;t.prototype.init.call(this,e,i,n),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA)},e}(Nt),Gt=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,"precision lowp float;\n\nattribute vec2 a_position;\n\nuniform float u_tileScale;\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\n\nvoid main(void){\n    gl_Position = u_matrix * vec4( u_topLeft + a_position * u_tileScale, 0.0, 1.0 );\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\n\nvoid main(void){\n    gl_FragColor = u_fill;\n}\n",i)||this;return n.name="Polygon",n}return d(e,t),e}(Nt),Zt=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,"precision lowp float;\n\nattribute vec2 a_position;\nattribute vec2 a_textureCoord;\n\nuniform highp mat4 u_matrix;\nuniform highp vec2 u_topLeft;\nuniform highp vec2 u_resolution;\n\nvarying vec2 v_textureCoord;\n\nvoid main(void){\n    v_textureCoord = a_textureCoord;\n\n    vec4 position = u_matrix * vec4( u_topLeft + a_position, 0.0, 1.0 );\n\n    gl_Position = snapToScreenPixel(position, u_resolution);\n}\n","precision lowp float;\n\nvarying vec2 v_textureCoord;\nuniform sampler2D u_sampler;\n\nvoid main(void){\n    gl_FragColor = texture2D(u_sampler, v_textureCoord);\n}\n",i)||this;return n.name="Image",n.glStates=new Rt({scissor:!0,blend:!1,depth:!0}),n}return d(e,t),e.prototype.draw=function(e,i){var n=this.gl,r=e.texture;r&&(n.activeTexture(n.TEXTURE0),r.bind()),t.prototype.draw.call(this,e,i)},e}(Nt),Ht=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,"precision highp float;\n\nattribute vec2 a_point;\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\n\nuniform vec2 u_resolution;\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\nuniform vec2 u_offset;\nuniform float u_scale;\nuniform float u_rotate;\nuniform bool u_alignMap;\nuniform bool u_fixedView;\nuniform float u_atlasScale;\n\nvarying vec2 v_texcoord;\nvarying vec4 vColor;\n\nconst float EXTENT_SCALE = 1.0 / 128.0;// 32768->512\nconst float OFFSET_SCALE = 1.0 / 32.0;\n\nconst float PI_05 = M_PI * 0.5;\nconst float PI_15 = M_PI * 1.5;\nconst float PI_20 = M_PI * 2.0;\n\nvec2 rotate(vec2 point, float rad){\n    float s = sin(rad);\n    float c = cos(rad);\n    return vec2(point.x * c + point.y * s, point.y * c - point.x * s);\n}\n\nvoid main(void){\n    if (mod(a_texcoord.x, 2.0) == 1.0)\n    {\n        vec2 rotLowHi = mod(a_texcoord, 32.0);\n        float rotation = rotLowHi.x - 1.0 + floor(rotLowHi.y * 32.0);\n        // texture coodrinates bit6->bit16\n        v_texcoord = floor(a_texcoord / 32.0) * u_atlasScale;\n\n        vec2 labelOffset = u_offset;\n\n        labelOffset *= DEVICE_PIXEL_RATIO;\n\n        rotation = rotation / 512.0 * PI_20;// 9bit -> 2PI;\n\n        if (u_alignMap){\n            float absRotation = mod(u_rotate + rotation, PI_20);\n\n            if (absRotation > PI_05 && absRotation < PI_15){\n                rotation += M_PI;\n                labelOffset *= -1.0;\n            }\n\n            vec2 posOffset = rotate(a_point.xy * OFFSET_SCALE + labelOffset, -rotation) / u_scale / DEVICE_PIXEL_RATIO;\n            gl_Position = u_matrix * vec4(u_topLeft + a_position * EXTENT_SCALE + posOffset, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4((u_topLeft + a_position * EXTENT_SCALE), 0.0, 1.0);\n            vec2 offset = rotate(a_point * OFFSET_SCALE + labelOffset, -rotation);\n            gl_Position = vec4(cpos.xy / cpos.w + vec2(1, -1) * offset / DEVICE_PIXEL_RATIO / u_resolution * 2.0, 0.0, 1.0);\n        }\n\n        if (u_fixedView){\n            // round/snap to pixelgrid if mapview is static -> crisp\n            gl_Position = snapToScreenPixel(gl_Position, u_resolution);\n        }\n    }\n}\n","precision mediump float;\n\nvarying vec2 v_texcoord;\nuniform sampler2D u_texture;\nuniform bool u_strokeOnly;\nuniform vec4 u_fillColor;\nuniform vec4 u_strokeColor;\n\nvoid main() {\n    vec4 glyph = texture2D(u_texture, v_texcoord);\n    vec4 color;\n    float glyphAlpha;\n\n    if (u_strokeOnly){\n        color = u_strokeColor;\n        glyphAlpha = glyph.a;\n    } else {\n        color = u_fillColor;\n        glyphAlpha = glyph.r;\n    }\n\n    gl_FragColor = glyphAlpha * vec4(color.rgb * color.a, color.a);\n}\n",i)||this;return n.name="Text",n.glStates=new Rt({blend:!0,scissor:!1,depth:!0}),n}return d(e,t),e.prototype.pass=function(t){return t==At.ALPHA},e.prototype.init=function(e,i,n){var r=this.gl;t.prototype.init.call(this,e,i,n),r.depthMask(!1),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)},e.prototype.draw=function(e,i){var n=this.gl,r=this.uniforms;n.uniform1f(r.u_strokeOnly,1),t.prototype.draw.call(this,e,i),n.uniform1f(r.u_strokeOnly,0),t.prototype.draw.call(this,e,i)},e}(Nt),Yt=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,"precision lowp float;\n\nattribute vec2 a_size;\nattribute highp vec2 a_position;\nattribute vec2 a_texcoord;\n\nuniform mat4 u_matrix;\nuniform vec2 u_topLeft;\nuniform float u_scale;\nuniform float u_atlasScale;\nuniform vec2 u_offset;\nuniform bool u_alignMap;\nuniform vec2 u_resolution;\nuniform bool u_fixedView;\n\nvarying float vOpacity;\nvarying vec2 v_texcoord;\n\nconst float EXTENT_SCALE = 1.0 / 32.0;// 8912->512\n\nvoid main(void){\n\n    // LSB defines visibility\n    if (mod(a_position.x, 2.0) == 1.0)\n    {\n        vec2 rotLowHi = mod(a_texcoord, 32.0);\n        float rotation = rotLowHi.x + floor(rotLowHi.y * 32.0);\n\n        rotation = rotation / 1024.0 * 2.0 * M_PI;// 10bit -> 2PI;\n\n        // bit1 is direction/normal vector [-1,+1]\n        vec2 dir = mod(floor(a_position / 2.0), 2.0) * 2.0 - 1.0;\n        vec2 pos = floor(a_position / 4.0) * EXTENT_SCALE;\n\n\n        if (!u_alignMap){\n            rotation *= -1.0;\n        }\n\n        float rotSin = sin(rotation);\n        float rotCos = cos(rotation);\n        mat2 mRotate = mat2(rotCos, -rotSin, rotSin, rotCos);\n\n        if (u_alignMap){\n            vec2 shift = ((u_offset + dir * vec2(a_size.x, -a_size.y) * 0.5) * mRotate) / u_scale;\n            gl_Position = u_matrix * vec4(u_topLeft + pos + shift, 0.0, 1.0);\n        } else {\n            vec4 cpos = u_matrix * vec4(u_topLeft + pos, 0.0, 1.0);\n            vec2 shift = dir * a_size * 0.5 * mRotate;\n            vec2 offset = vec2(u_offset.x, -u_offset.y);\n            gl_Position = vec4(cpos.xy / cpos.w + (offset + shift) / u_resolution * 2.0, 0.0, 1.0);\n        }\n\n        if (u_fixedView){\n            gl_Position = snapToScreenPixel(gl_Position, u_resolution);\n        }\n\n        // textcoords bit6->bit16\n        v_texcoord = floor(a_texcoord / 32.0) * u_atlasScale;\n    }\n}\n","precision mediump float;\n\nvarying vec2 v_texcoord;\nuniform float u_opacity;\n\nuniform sampler2D u_texture;\n\nvoid main() {\n\n   gl_FragColor = texture2D(u_texture, v_texcoord);\n\n   gl_FragColor.a *= u_opacity;\n}\n",i)||this;return n.name="icon",n.glStates=new Rt({blend:!0,scissor:!1,depth:!0}),n}return d(e,t),e.prototype.pass=function(t){return t==At.ALPHA},e.prototype.init=function(e,i,n){var r=this.gl;t.prototype.init.call(this,e,i,n),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)},e}(Nt),jt=function(t){function e(e,i){var n=t.call(this,e,e.TRIANGLES,"precision lowp float;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n\nuniform mat4 u_matrix;\n\nuniform vec2 u_topLeft;\nuniform float u_zoom;\n\nvarying vec4 v_fill;\nvarying vec3 v_normal;\n\n\nvoid main(void){\n    gl_Position = u_matrix * vec4(u_topLeft + a_position.xy, -a_position.z / u_zoom, 1.0);\n    v_normal = a_normal;\n}\n","precision lowp float;\n\nuniform vec4 u_fill;\nvarying vec3 v_normal;\n\n#define lightDir normalize(vec3(0.5, 0.0, -1.0))\n#define top vec2(0.0)\n\nvoid main(void){\n\n    if (v_normal.xy == top){\n        gl_FragColor.rgb = u_fill.rgb;\n    } else {\n        float diffuse = 0.3 + dot(v_normal, lightDir) * 0.7;\n        gl_FragColor.rgb = u_fill.rgb * diffuse;\n    }\n\n    gl_FragColor.a = u_fill.a;\n}\n",i)||this;return n.name="Extrude",n.glStates=new Rt({scissor:!1,blend:!1,depth:!0}),n}return d(e,t),e.prototype.init=function(e,i,n){var r=this.gl;this._pass=i,t.prototype.init.call(this,e,i,n),r.depthMask(!0),i==At.POST_ALPHA&&(r.enable(r.STENCIL_TEST),r.stencilFunc(r.GREATER,1,255),r.stencilOp(r.KEEP,r.KEEP,r.REPLACE))},e.prototype.draw=function(e,i){var n=this.gl;this._pass==At.ALPHA?(n.colorMask(!1,!1,!1,!1),t.prototype.draw.call(this,e,i),n.colorMask(!0,!0,!0,!1)):t.prototype.draw.call(this,e,i)},e}(Nt),qt=function(){function t(t,e,i){this.attributes={},this.uniforms={},this.flat=!0,t&&(t instanceof Array?this.setIndex(t,i):this.setArrays(t),this.type=e)}return t.prototype.setIndex=function(t,e){this.index=e?{data:new Uint32Array(t),type:5125,length:t.length}:{data:new Uint16Array(t),type:5123,length:t.length}},t.prototype.setArrays=function(t){this.arrays=t},t.prototype.addUniform=function(t,e){this.uniforms[t]=e},t.prototype.getUniform=function(t){return this.uniforms[t]},t.prototype.addAttribute=function(t,e){var i=e.data;e.type=function(t){return t instanceof Int8Array?5120:t instanceof Uint8Array?5121:t instanceof Int16Array?5122:t instanceof Uint16Array?5123:t instanceof Int32Array?5124:t instanceof Uint32Array?5125:t instanceof Float32Array?5126:void 0}(i),null==e.stride&&(e.stride=0),null==e.dirty&&(e.dirty=!0),this.attributes[t]=e,this.size=i.length},t.prototype.getAttributes=function(){return this.attributes},t.prototype.destroy=function(){},t}(),Vt=function(t,e,i,n,r,o){return void 0===o&&(o=1),Math.abs(e)<o&&Math.abs(n)<o||Math.abs(t-r)<o&&Math.abs(i-r)<o||Math.abs(e-r)<o&&Math.abs(n-r)<o||Math.abs(t)<o&&Math.abs(i)<o},Kt=function(t){var e=t[0],i=t[1],n=e*e+i*i;return n>0&&(n=1/Math.sqrt(n),t[0]=e*n,t[1]=i*n),t},Qt=function(t,e,i,n,r,o,a,s){if(void 0===s&&(s=1),"round"==t)o.push(e,i,e,i,e,i),n*=Math.SQRT2*s,r*=Math.SQRT2*s,a.push(n<<1|0,r<<1|1,n<<1|0,r<<1|1,n<<1|1,r<<1|0,n<<1|1,r<<1|0,r<<1|1,n<<1|1,r<<1|1,n<<1|1);else if("square"==t){o.push(e,i,e,i,e,i,e,i,e,i,e,i);var l=r-n,h=n+r;a.push(n<<1|0,r<<1|1,0,0,h<<1|1,l<<1|0,0,0,n<<1|1,r<<1|0,0,0,l<<1|1,h<<1|1,n<<1|1,r<<1|1,h<<1|1,l<<1|0,n<<1|1,r<<1|1,n<<1|0,r<<1|1,0,0)}},$t=function(t,e,i,n,r,o,a,s,l,h,u,f,c,p){void 0===c&&(c=0),void 0===p&&(p=0),h*=.5;var d,v,y,g,m,x,_,w,b,T=c*r,L=p*r,A=!0,S=0,M=null;if(T&&L&&p<c){var E=T;T=L,L=E}for(f&&(s="butt","none"!=l&&(l="miter")),u&&(s="butt",f||(l="none")),y=0;y<n;y+=2){var z=i[y],C=i[y+1],I=Z(z,C,0,0,o,o);if(I)A?null==M&&(M=y):M=y-2;else if(y)if(A)S=Jt(t,e,i,M,y+2,o,s,l,h,u,S,T,L,f),M=null;else{var P=z,k=d,D=C,R=v;d<z&&(P=d,k=z),v<C&&(D=v,R=C);var O=o+16;if(a&&!Vt(d,v,z,C,o)||!a&&(g=k,m=D,x=R,_=-16,w=-16,b=O,P<=O&&_<=g&&m<=b&&w<=x))S=Jt(t,e,i,y-2,y+2,o,s,l,h,u,S,T,L,f),M=null;else if(u||c||p){var N=d-z,U=v-C;S+=Math.sqrt(N*N+U*U)}}A=I,d=z,v=C}null!=M&&Jt(t,e,i,M,y,o,s,l,h,u,S,T,L,f)},Jt=function(t,e,i,n,r,o,a,s,l,h,u,f,c,p){void 0===u&&(u=0);var d,v,y,g,m,x,_,w,b,T,L,A,S,M,E,z,C,I,P,k,D,R,O=r,N=i[n],U=i[n+1],F=null,B=null,W=null,X=null,G=null,Z=null;if(c&&c<u)return u;for(var H=n+2;H<O;H+=2){g=i[H],m=i[H+1];var Y=H==O-2,j=void 0,q=null,V=!1,K=void 0;y=s,w=(R=Kt([x=N-g,_=U-m]))[1],b=R[0],X=null==X,length=Math.sqrt(x*x+_*_);var Q=length,$=u;if(u+=length,c&&c<u&&c>$){var J=(c-$)/Q;g=N-x*J,m=U-_*J,length*=J,Y=!0,O=0}if(f){if(!(f<u)){N=g,U=m;continue}if(f>$){var tt=(f-$)/Q;N-=x*tt,U-=_*tt,length*=1-tt,X=!0}}if(X&&Y&&(s="none"),!Y){F=i[H+2],j=x*(W=m-i[H+3])-_*(B=g-F)<0;var et=[T=(q=Kt([B,W]))[1]+w,L=-q[0]-b];if((K=1/(et[0]*w-et[1]*b))==1/0)V=!0,T=2,L=2;else{"miter"==s&&K>2&&(y="bevel"),T=et[0]*K,L=et[1]*K;var it=Math.sqrt(T*T+L*L)/2;(V=it>1)&&(T/=it,L/=it)}T*=-8192,L*=-8192}if(I=C=[1^(M=[-(w*=8192)<<1|1,(b*=8192)<<1|1])[0],1^M[1]],P=C,E=M,z=M,"none"!=s){if(!Y&&"miter"==y&&O>4&&(P=[T<<1|0,L<<1|0],z=[T<<1|1,L<<1|1]),X||k||(D?(E=[A<<1|1,S<<1|1],"miter"==s&&(I=[A<<1|0,S<<1|0])):(I=[A<<1|0,S<<1|0],"miter"==s&&(E=[A<<1|1,S<<1|1]))),!V&&!Y&&"miter"!=s){var nt=l*T/-8192,rt=l*L/-8192;j&&(nt*=-1,rt*=-1);var ot=R[0]*nt+R[1]*rt;length<ot?V=!0:j?z=[T<<1|1,L<<1|1]:P=[T<<1|0,L<<1|0]}if((!X||Y)&&u)if("round"==s&&(D?e.push(v[0],v[1],v[0],v[1],I[0],I[1],I[0],I[1],A<<1|0,S<<1|0,A<<1|0,S<<1|0):e.push(A<<1|1,S<<1|1,A<<1|1,S<<1|1,E[0],E[1],E[0],E[1],d[0],d[1],d[0],d[1]),t.push(G,Z,G,Z,G,Z)),!X)if(k){if(!p){var at,st=0,lt=0;if("round"!=s)st=8192*(at=Kt([T,L]))[0],lt=8192*at[1];st=st<<1|1,lt=lt<<1|1,D?e.push(0,0,0,0,C[0],C[1],st,lt,v[0],v[1],st,lt):e.push(0,0,0,0,M[0],M[1],st,lt,d[0],d[1],st,lt),t.push(G,Z,G,Z,G,Z)}}else if("miter"!=s)(at=Kt([A,S]))[0]*=8192,at[1]*=8192,D?"bevel"==s?e.push(A<<1|1,S<<1|1,at[0]<<1|1,at[1]<<1|1,I[0],I[1],at[0]<<1|0,at[1]<<1|0,v[0],v[1],at[0]<<1|0,at[1]<<1|0):e.push(A<<1|1,S<<1|1,at[0]<<1|1,at[1]<<1|1,I[0],I[1],I[0],I[1],v[0],v[1],v[0],v[1]):"bevel"==s?e.push(E[0],E[1],at[0]<<1|1,at[1]<<1|1,A<<1|0,S<<1|0,at[0]<<1|0,at[1]<<1|0,d[0],d[1],at[0]<<1|1,at[1]<<1|1):e.push(E[0],E[1],E[0],E[1],A<<1|0,S<<1|0,at[0]<<1|0,at[1]<<1|0,d[0],d[1],d[0],d[1]),t.push(G,Z,G,Z,G,Z)}if(e.push(E[0],E[1],M[0],M[1],P[0],P[1],C[0],C[1],I[0],I[1],C[0],C[1],E[0],E[1],M[0],M[1],z[0],z[1],M[0],M[1],P[0],P[1],C[0],C[1]),t.push(N,U,g,m,N,U,N,U,g,m,g,m),X&&Qt(a,N,U,w,b,t,e),Y&&Qt(a,g,m,-w,-b,t,e),h){var ht=u-length;h.push(ht,u,ht,ht,u,u)}d=M,v=C,A=T,S=L,G=g,Z=m,N=g,U=m,D=j,k=V}return u},te=function(){function t(t,e){void 0===e&&(e=128),this.length=0,this.data=new t(this.size=e)}return t.prototype.get=function(t){return this.data[t]},t.prototype.push=function(t){var e=arguments.length;this.reserve(e);for(var i=0;i<e;i++)this.data[this.length++]=arguments[i];return this.length},t.prototype.reserve=function(t){var e=this.data,i=t-(this.size-this.length);i>0&&(this.size+=Math.max(i,this.size),this.data=new e.constructor(this.size),this.length&&this.data.set(e))},t.prototype.trim=function(){return this.data=this.data.slice(0,this.length)},t}(),ee=function(t,e,i){for(var n;++e<t.length;){var r=t.charAt(e),o=null===(n=i.glyphInfos[r])||void 0===n?void 0:n.glyph;if(o){var a=o.direction;if(a)return a}}},ie=function(t,e,i,n,r,o){var a=o.offset,s=e.spaceWidth,l=e.glyphInfos[t],h=o.x,u=0,f=n.data,c=n.length,p=r.data,d=r.length,v=i>>5,y=31&i;if(l){var g=l.glyph,m=l.u1<<5|y,x=l.u2<<5|y,_=l.v1<<5|v,w=l.v2<<5|v,b=g.advanceX,T=g.data,L=T.width,A=T.height,S=32*h;A*=32,u=S+32*L,f[c++]=S,f[c++]=0,f[c++]=u,f[c++]=A,f[c++]=S,f[c++]=A,f[c++]=u,f[c++]=0,f[c++]=u,f[c++]=A,f[c++]=S,f[c++]=0,p[d++]=m,p[d++]=_,p[d++]=x,p[d++]=w,p[d++]=m,p[d++]=w,p[d++]=x,p[d++]=_,p[d++]=x,p[d++]=w,p[d++]=m,p[d++]=_,h+=b,a+=12}else" "==t&&(h+=s);n.length=c,r.length=d,o.x=h,o.offset=a,o.x2=u},ne=function(t,e,i,n,r,o,a,s,l){for(var h=e,u=i,f=void 0,c=void 0;h<u;h++){if(f=n?e+(u-1-h):h,c=t.charAt(f),n&&Y(t.charCodeAt(f))){for(var p=f,d=0;--p>=0;)if(!Y(t.charCodeAt(p))){for(;++p<=f;)ie(t.charAt(p),r,o,a,s,l),d++;break}if(d){h+=d-1;continue}}ie(c,r,o,a,s,l)}},re=function(t,e,i,n,r){var o;void 0===i&&(i=0);var a=t.length;n?n.reserve(18*a):n=new te(Int16Array,18*a),r?r.reserve(12*a):r=new te(Uint16Array,12*a);var s,l,h,u={x:0,x2:0,offset:0},f=0;i=Math.round(1|i);for(var c=0;c<a;c++){var p=t.charAt(c),d=e.glyphInfos[p],v=c==a-1,y=(null===(o=null==d?void 0:d.glyph)||void 0===o?void 0:o.direction)||0;if(!s){if(" "==p)continue;s=y=y||1}if(void 0!==l){var g=!0;if(!y){var m=ee(t,c,e);g=m&&m!=l}if(g&&y!=l){var x=c-1;" "==h&&1==y&&x--,x++,ne(t,f,x,-1==l,e,i,n,r,u),f=x}}if(v&&f<=c){x=c+Number(" "!=p);ne(t,f,x,y?-1==y:l!=s,e,i,n,r,u)}y&&(l=y),h=p}var _=u.x2;return{count:u.offset/2,position:n.data,texcoord:r.data,width:_/32/e.scale}},oe=j.getInstance(),ae=function(){function t(t,e,i,n){this.x=0,this.y=0,this.glyphInfos={},this.avgCharWidth=0,this.glyphs=0;var r=oe.initFont(t,e);if(this.style=t,this.letterHeight=r.letterHeight,this.lineHeight=r.letterHeight*e,this.baselineOffset=r.baselineOffset,this.rowHeight=r.rowHeight,this.spaceWidth=r.spaceWidth,this.fontScale=r.fontScale,!i)for(i=1;i<r.rowHeight;)i*=2;i*=e,this.width=i,this.height=i,this.maxWidth=i,this.maxHeight=i,this.style=t,this.scale=e,this.font=r,n&&this.addChars(n)}return t.prototype.getTextWidth=function(t){return oe.getTextWidth(t,this.font)},t.prototype.placeGlyph=function(t){var e=this.rowHeight;if(this.x+t>this.width){var i=this.y+2*e;i>this.maxHeight?i>this.height?(this.height*=2,this.width*=2,0==this.x?this.maxWidth=this.maxWidth=this.width:(this.x=this.maxWidth,this.y=0)):(this.x=0,this.y+=e,this.maxHeight=this.height,this.maxWidth=this.width):(this.y+=e,this.maxHeight<this.height?this.x=this.maxWidth:this.x=0)}},t.prototype.addChars=function(t){for(var e=this.glyphInfos,i=this.rowHeight,n=!1,r=0,o=t;r<o.length;r++){var a=o[r];if(" "!=a&&!e[a]){var s=oe.getGlyph(a,this.font),l=a.charCodeAt(0),h=s.data.width,u=s.width;if(l){this.avgCharWidth=(this.avgCharWidth*this.glyphs+u)/++this.glyphs,n=!0,this.placeGlyph(h);var f=this.x,c=this.y;e[a]={u1:f,v1:c,u2:f+h,v2:c+i,glyph:s},this.x+=h}}}return n},t}(),se=function(t){function e(e,i,n){var r=t.call(this,e)||this;r.dirty=!1;var o=e.dpr;return r.atlas=new ae(i,o,n),r.format=e.LUMINANCE_ALPHA,r}return d(e,t),e.prototype.addChars=function(t){this.dirty=this.atlas.addChars(t)||this.dirty},e.prototype.bufferLength=function(t){for(var e=0,i=0,n=t;i<n.length;i++){" "!=n[i]&&e++}return 6*e*2},e.prototype.getAtlas=function(){return this.atlas},e.prototype.sync=function(){if(this.dirty){var t=this.atlas,e=(this.gl,t.glyphInfos);for(var i in this.set({width:t.width,height:t.height}),e){var n=e[i];this.set(n.glyph.data,n.u1,n.v1)}}},e.prototype.destroy=function(){this.atlas=null,t.prototype.destroy.call(this)},e}(Mt),le=function(){function t(t){this.i32=!1,this._flat=!0,this.scissor=t}return t.prototype.count=function(){var t=this.attributes.a_position;return t.data.length/t.size-this.first},t.prototype.index=function(){return this._index=this._index||[]},t.prototype.hasIndex=function(){return!!this._index},t.prototype.isEmpty=function(){return 0==this.count()},t.prototype.trimAttribute=function(t){var e=t;return e.data=e.data.trim(),e},t.prototype.isFlat=function(){return this._flat},t.prototype.finalize=function(t){var e,i=this.attributes;if(this.hasIndex()){var n=this.index();if(!n.length)return null;e=new qt(n,t,this.i32)}else e=new qt({first:this.first,count:this.count()},t);for(var r in i){var o=i[r];o.data.length&&e.addAttribute(r,this.trimAttribute(o))}return e},t}(),he=function(t){function e(){var e=t.call(this,!0)||this;return e.attributes={a_position:{data:new te(Float32Array),size:2},a_normal:{data:new te(Int16Array),size:4},a_lengthSoFar:{data:new te(Uint16Array),size:1}},e.first=0,e}return d(e,t),e}(le),ue="undefined"!=typeof Float32Array?Float32Array:Array;function fe(t,e,i){var n=e[0],r=e[1],o=e[2],a=i[3]*n+i[7]*r+i[11]*o+i[15];return a=a||1,t[0]=(i[0]*n+i[4]*r+i[8]*o+i[12])/a,t[1]=(i[1]*n+i[5]*r+i[9]*o+i[13])/a,t[2]=(i[2]*n+i[6]*r+i[10]*o+i[14])/a,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var ce,pe;ce=new ue(3),ue!=Float32Array&&(ce[0]=0,ce[1]=0,ce[2]=0),pe=ce;function de(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ve(t,e){var i=e[0],n=e[1],r=e[2],o=e[3],a=e[4],s=e[5],l=e[6],h=e[7],u=e[8],f=e[9],c=e[10],p=e[11],d=e[12],v=e[13],y=e[14],g=e[15],m=i*s-n*a,x=i*l-r*a,_=i*h-o*a,w=n*l-r*s,b=n*h-o*s,T=r*h-o*l,L=u*v-f*d,A=u*y-c*d,S=u*g-p*d,M=f*y-c*v,E=f*g-p*v,z=c*g-p*y,C=m*z-x*E+_*M+w*S-b*A+T*L;return C?(C=1/C,t[0]=(s*z-l*E+h*M)*C,t[1]=(r*E-n*z-o*M)*C,t[2]=(v*T-y*b+g*w)*C,t[3]=(c*b-f*T-p*w)*C,t[4]=(l*S-a*z-h*A)*C,t[5]=(i*z-r*S+o*A)*C,t[6]=(y*_-d*T-g*x)*C,t[7]=(u*T-c*_+p*x)*C,t[8]=(a*E-s*S+h*L)*C,t[9]=(n*S-i*E-o*L)*C,t[10]=(d*b-v*_+g*m)*C,t[11]=(f*_-u*b-p*m)*C,t[12]=(s*A-a*M-l*L)*C,t[13]=(i*M-n*A+r*L)*C,t[14]=(v*x-d*w-y*m)*C,t[15]=(u*w-f*x+c*m)*C,t):null}var ye={create:function(){var t=new ue(16);return ue!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},lookAt:function(t,e,i,n){var r,o,a,s,l,h,u,f,c,p,d=e[0],v=e[1],y=e[2],g=n[0],m=n[1],x=n[2],_=i[0],w=i[1],b=i[2];return Math.abs(d-_)<1e-6&&Math.abs(v-w)<1e-6&&Math.abs(y-b)<1e-6?de(t):(u=d-_,f=v-w,c=y-b,r=m*(c*=p=1/Math.hypot(u,f,c))-x*(f*=p),o=x*(u*=p)-g*c,a=g*f-m*u,(p=Math.hypot(r,o,a))?(r*=p=1/p,o*=p,a*=p):(r=0,o=0,a=0),s=f*a-c*o,l=c*r-u*a,h=u*o-f*r,(p=Math.hypot(s,l,h))?(s*=p=1/p,l*=p,h*=p):(s=0,l=0,h=0),t[0]=r,t[1]=s,t[2]=u,t[3]=0,t[4]=o,t[5]=l,t[6]=f,t[7]=0,t[8]=a,t[9]=h,t[10]=c,t[11]=0,t[12]=-(r*d+o*v+a*y),t[13]=-(s*d+l*v+h*y),t[14]=-(u*d+f*v+c*y),t[15]=1,t)},multiply:function(t,e,i){var n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],f=e[8],c=e[9],p=e[10],d=e[11],v=e[12],y=e[13],g=e[14],m=e[15],x=i[0],_=i[1],w=i[2],b=i[3];return t[0]=x*n+_*s+w*f+b*v,t[1]=x*r+_*l+w*c+b*y,t[2]=x*o+_*h+w*p+b*g,t[3]=x*a+_*u+w*d+b*m,x=i[4],_=i[5],w=i[6],b=i[7],t[4]=x*n+_*s+w*f+b*v,t[5]=x*r+_*l+w*c+b*y,t[6]=x*o+_*h+w*p+b*g,t[7]=x*a+_*u+w*d+b*m,x=i[8],_=i[9],w=i[10],b=i[11],t[8]=x*n+_*s+w*f+b*v,t[9]=x*r+_*l+w*c+b*y,t[10]=x*o+_*h+w*p+b*g,t[11]=x*a+_*u+w*d+b*m,x=i[12],_=i[13],w=i[14],b=i[15],t[12]=x*n+_*s+w*f+b*v,t[13]=x*r+_*l+w*c+b*y,t[14]=x*o+_*h+w*p+b*g,t[15]=x*a+_*u+w*d+b*m,t},perspective:function(t,e,i,n,r){var o,a=1/Math.tan(e/2);return t[0]=a/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(o=1/(n-r),t[10]=(r+n)*o,t[14]=2*r*n*o):(t[10]=-1,t[14]=-2*n),t},rotateX:function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[4],a=e[5],s=e[6],l=e[7],h=e[8],u=e[9],f=e[10],c=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*r+h*n,t[5]=a*r+u*n,t[6]=s*r+f*n,t[7]=l*r+c*n,t[8]=h*r-o*n,t[9]=u*r-a*n,t[10]=f*r-s*n,t[11]=c*r-l*n,t},rotateZ:function(t,e,i){var n=Math.sin(i),r=Math.cos(i),o=e[0],a=e[1],s=e[2],l=e[3],h=e[4],u=e[5],f=e[6],c=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*r+h*n,t[1]=a*r+u*n,t[2]=s*r+f*n,t[3]=l*r+c*n,t[4]=h*r-o*n,t[5]=u*r-a*n,t[6]=f*r-s*n,t[7]=c*r-l*n,t},translate:function(t,e,i){var n,r,o,a,s,l,h,u,f,c,p,d,v=i[0],y=i[1],g=i[2];return e===t?(t[12]=e[0]*v+e[4]*y+e[8]*g+e[12],t[13]=e[1]*v+e[5]*y+e[9]*g+e[13],t[14]=e[2]*v+e[6]*y+e[10]*g+e[14],t[15]=e[3]*v+e[7]*y+e[11]*g+e[15]):(n=e[0],r=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],f=e[8],c=e[9],p=e[10],d=e[11],t[0]=n,t[1]=r,t[2]=o,t[3]=a,t[4]=s,t[5]=l,t[6]=h,t[7]=u,t[8]=f,t[9]=c,t[10]=p,t[11]=d,t[12]=n*v+s*y+f*g+e[12],t[13]=r*v+l*y+c*g+e[13],t[14]=o*v+h*y+p*g+e[14],t[15]=a*v+u*y+d*g+e[15]),t},scale:function(t,e,i){var n=i[0],r=i[1],o=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},clone:function(t){var e=new ue(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},invert:ve,identity:de},ge=45*Math.PI/180,me=function(t,e){return Math.round((t+1)/2*e)},xe={font:"bold 14px Arial",stroke:"red",fill:"white",strokeWidth:3},_e=function(){function t(t){this.gridTextBuf=new WeakMap,this.tileGrid=!1,this.tileSize=256,this.dbgTile=function(t,e){void 0===t&&(t=[1,0,0,1]),void 0===e&&(e=2);var i=new he,n=i.attributes;$t(n.a_position.data,n.a_normal.data,new Float32Array([0,0,1,0,1,1,0,1,0,0]),10,4,1,!1,"butt","none",e);var r=i.finalize("Line");return r.addUniform("u_zIndex",0),r.addUniform("u_fill",t),r.addUniform("u_strokeWidth",[e,0]),r.addUniform("u_offset",[0,0]),r.scissor=!1,r.depth=!1,r}(),this.buffers=new WeakMap,this.ctxAttr=v({alpha:!0,antialias:!1,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1},t),this.pMat=ye.create(),this.vMat=ye.create(),this.invPMat=ye.create(),this.screenMat=ye.create(),this.invScreenMat=ye.create(),this.tilePreviewTransform={m:ye.create(),tx:0,ty:0,s:0};var e,i,n,r=(e=1,i=new qt([0,1,3,3,1,2],"Polygon"),n=e>256?Int16Array:Int8Array,i.addAttribute("a_position",{data:new n([0,0,e,0,e,e,0,e]),size:2}),i.addUniform("u_zIndex",0),i.addUniform("u_fill",[1,1,1,1]),i.scissor=!0,i.depth=!1,i.alpha=0,i);r.alpha=At.ALPHA,r.blend=!0,this.stencilTile=r}return t.prototype.setPass=function(t){var e=this.gl;this.pass=t,this.depthFnc=t!=At.OPAQUE?e.LEQUAL:e.LESS,t==At.POST_ALPHA&&e.clear(e.STENCIL_BUFFER_BIT)},t.prototype.convertColor=function(t){return B(t)},t.prototype.setBackgroundColor=function(t){this.gl&&this.gl.clearColor(t[0],t[1],t[2],1)},t.prototype.setScale=function(t,e,i){},t.prototype.setRotation=function(t,e){},t.prototype.clear=function(t){var e=this.gl;t&&this.setBackgroundColor(t),e.colorMask(!0,!0,!0,!0),e.disable(e.SCISSOR_TEST),e.depthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.colorMask(!0,!0,!0,!1)},t.prototype.init=function(t,e){this.dpr=e;var i=t.getContext("webgl",this.ctxAttr);i.dpr=e,i.getExtension("OES_element_index_uint"),i.enable(i.CULL_FACE),i.cullFace(i.FRONT),i.enable(i.DEPTH_TEST),i.enable(i.SCISSOR_TEST),i.clearStencil(0);var n=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.icons=new It(i,n-2),this.programs={Rect:new Ut(i,e),Line:new Wt(i,e),DashedLine:new Xt(i,e),Text:new Ht(i,e),Image:new Zt(i,e),Circle:new Ft(i,e),Polygon:new Gt(i,e),Extrude:new jt(i,e),Icon:new Yt(i,e)},i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.gl=i},t.prototype.grid=function(t){this.tileGrid=t},t.prototype.applyTransform=function(){},t.prototype.initView=function(t,e,i,n,r){var o=this.pMat,a=this.vMat,s=.5*ge,l=.5*t,h=.5*e,u=h/Math.tan(s),f=Math.cos(s),c=Math.sin(s)*u,p=.5*Math.PI-s+n,d=.25*u,v=f*(f*u+c/Math.tan(p));v*=1.005,this.tilePreviewTransform.tx=null,this.tilePreviewTransform.ty=null,this.tilePreviewTransform.s=null,this.w=t,this.h=e,this.rz=r,this.rx=n,this.scale=i,this.gl.viewport(0,0,t*this.dpr,e*this.dpr),ye.perspective(o,ge,t/e,d,v),ye.lookAt(a,[l,h,-u],[l,h,0],[0,-1,0]),ye.translate(a,a,[l,h,0]),ye.rotateX(a,a,n),ye.rotateZ(a,a,r),ye.scale(a,a,[i,i,i]),ye.translate(a,a,[-l,-h,0]),ye.multiply(o,o,a),ve(this.invPMat,this.pMat);var y=ye.identity(this.screenMat);ye.scale(y,y,[l,-h,1]),ye.translate(y,y,[1,-1,0]),ye.multiply(y,y,this.pMat),ve(this.invScreenMat,y)},t.prototype.initBuffers=function(t){var e,i,n=this.gl;for(var r in t)e=t[r],(i=this.buffers.get(e))||(i=n.createBuffer(),this.buffers.set(e,i)),e.dirty&&(e.dirty=!1,n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,e.data,n.STATIC_DRAW))},t.prototype.useProgram=function(t){var e=this.prog;if(e!=t){var i=this.gl;if(e){var n=e.attributes;for(var r in n)i.disableVertexAttribArray(n[r])}return i.useProgram(t.prog),this.prog=t,!0}return!1},t.prototype.drawGrid=function(t,e,i,n){var r=this.pass;this.pass=At.ALPHA,this.drawBuffer(this.dbgTile,t,e,null,null,n);var o=this.gridTextBuf.get(i);o||(o=function(t,e,i){Ot||((Ot=new se(e,i)).addChars("L0123456789"),Ot.sync());var n=re(t+" L"+t.length,Ot.atlas),r=n.position,o=new qt({first:0,count:n.count},"Text");return o.addAttribute("a_point",{data:r,size:2,stride:0}),o.addAttribute("a_texcoord",{data:n.texcoord,size:2,stride:0}),o.depth=!1,o.scissor=!1,o.texture=Ot,o.addUniform("u_texture",0),o.addUniform("u_atlasScale",1/Ot.width),o.addUniform("u_opacity",1),o.addUniform("u_alignMap",!0),o.addUniform("u_fillColor",B(i.fill)),o.addUniform("u_strokeColor",B(i.stroke)),o}(i.quadkey,this.gl,xe),this.gridTextBuf.set(i,o)),this.drawBuffer(o,t+4,e+4),this.pass=r},t.prototype.deleteBuffer=function(t){var e=this.buffers,i=this.gl,n=t.attributes,r=t.texture,o=t.index;for(var a in r&&r.destroy(),n){var s=n[a],l=e.get(s);i.deleteBuffer(l)}o&&i.deleteBuffer(e.get(o))},t.prototype.drawBuffer=function(t,e,i,n,r,o){var a,s,l,h=this.gl,u=this.buffers,f=this.pass;if(s=this.programs[t.type]){var c=s.pass(f);r=r||1;var p=this.zIndex,d=p>this.min3dZIndex,v=t.alpha==At.POST_ALPHA&&f==At.POST_ALPHA;if((t.alpha||d)&&(c=f==At.ALPHA||v),c){if(this.stencilVal&&t.alpha){var y=this.stencilVal;this.stencilVal=null,this.drawStencil(y)}a=t.getAttributes(),this.initBuffers(a),this.useProgram(s),h.depthFunc(this.depthFnc);var g=1-(1+p)/65536;h.depthRange(t.flat?g:0,g),s.init(t,f,Boolean(this.rx||this.rz)),d&&h.disable(this.gl.DEPTH_TEST),s.initAttributes(a,u),s.initUniforms(t.uniforms),l=s.uniforms,h.uniform1i(l.u_fixedView,this.fixedView),h.uniform1f(l.u_rotate,this.rz),h.uniform2f(l.u_resolution,this.w,this.h),h.uniform1f(l.u_scale,this.scale*r),h.uniform2f(l.u_topLeft,e,i),h.uniform1f(l.u_tileScale,o||1),h.uniformMatrix4fv(l.u_matrix,!1,n||this.pMat),s.draw(t,u)}}},t.prototype.initStencil=function(t,e,i,n){this.stencilVal=t,this.stencilSize=n,this.stencilX=e,this.stencilY=i},t.prototype.drawStencil=function(t){if(this.rx||this.rz){var e=this.gl,i=this.stencilTile,n=this.stencilX,r=this.stencilY;e.stencilFunc(e.ALWAYS,t,255),e.stencilOp(e.REPLACE,e.REPLACE,e.REPLACE),e.colorMask(!1,!1,!1,!1),this.drawBuffer(i,n,r,null,1/0,this.stencilSize),e.stencilFunc(e.EQUAL,t,255),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.colorMask(!0,!0,!0,!1)}},t.prototype.initScissor=function(t,e,i,n,r){if(t.scissor){var o=this.gl,a=o.canvas.width,s=o.canvas.height;if(this.scale>4)return o.scissor(0,0,a,s),this.scissorX=null,!0;if(this.scissorX!=e||this.scissorY!=i||this.scissorSize!=n){this.scissorX=e,this.scissorY=i,this.scissorSize=n;for(var l=e+n,h=i+r,u=1/0,f=-u,c=u,p=f,d=0,v=[[e,h,0],[l,h,0],[e,i,0],[l,i,0]];d<v.length;d++){var y=v[d];y=fe([],y,this.pMat);var g=me(y[0],a),m=me(y[1],s);g<u&&(u=g),g>f&&(f=g),m<c&&(c=m),m>p&&(p=m)}o.scissor(u,c,f-u,p-c)}return!0}},t.prototype.draw=function(t,e){var i,n,r,o,a,s,l,h,u,f,c,p=!1,d=!1,v=t,y=v.tile,g=y.tile,m=y.size,x=y.x,_=y.y,w=v.b,b=v.preview;if(this.zIndex=v.z,this.min3dZIndex=e,b){var T=v.previewTile;i=b[0],n=b[1],r=b[2],o=b[3],a=b[5],s=b[6],h=(l=b[7])/o,u=Math.pow(2,g.quadkey.length-i.length),f=a/h-n,c=s/h-r,this.initScissor(w,x+a,_+s,l,l),u<1?this.initStencil(T.i,x+a,_+s,m*u):d||(d=!0,this.initStencil(g.i,x,_,m));var L=this.initPreviewMatrix(x,_,h);this.drawBuffer(w,f,c,L,u)}else p||(p=this.initScissor(w,x,_,m,m)),d||(this.initStencil(g.i,x,_,m),d=!0),this.drawBuffer(w,x,_)},t.prototype.initPreviewMatrix=function(t,e,i){var n=this.tilePreviewTransform,r=n.m;return n.tx==t&&n.ty==e&&n.s==i||(ye.copy(r,this.pMat),ye.translate(r,r,[t,e,0]),ye.scale(r,r,[i,i,i]),n.tx=t,n.ty=e,n.s=i),r},t.prototype.destroy=function(){this.icons.destroy()},t.prototype.prepare=function(t,e,i,n,r,o){},t}(),we=function(){function t(){this.r=[],this.p=[]}return t.prototype.init=function(t,e){this.luTs=null,this.quadkey=t,this.layers=e,this.tasks={},this.r.length=0,this.p.length=0},t.prototype.busy=function(t){var e=t.id;for(var i in this.tasks)if(e==this.tasks[i]._lid)return!0},t.prototype.addTask=function(t,e){t._lid=e.id,this.tasks[t.id]=t},t.prototype.cancelTasks=function(t){var e,i=this.tasks;for(var n in i)e=i[n],t&&t.id!=e._lid||(e.cancel(),delete i[n])},t.prototype.removeTask=function(t,e){delete this.tasks[t.id]},t.prototype.index=function(t){return this.layers.indexOf(t)},t.prototype.ready=function(t,e){return 2==arguments.length&&(this.r[t]=e,e&&(this.luTs=Date.now())),this.r[t]},t.prototype.addLayer=function(t){this.r.splice(t,0,!1),this.p.splice(t,0,void 0)},t.prototype.removeLayer=function(t){this.r.splice(t,1),this.p.splice(t,1)},t.prototype.preview=function(t,e){return 2==arguments.length&&(this.p[t]=e),this.p[t]},t}(),be=function(t){function e(e,i,n){var r=t.call(this)||this;return r.data=[],r.onDrop=n,r.init(e,i),r}return d(e,t),e.prototype.clear=function(t){this.setData(t,void 0),this.ready(t,!1),this.preview(t,!1)},e.prototype.init=function(e,i){t.prototype.init.call(this,e,i),this.data.length=0},e.prototype.setData=function(t,e){var i="number"==typeof t?t:this.layers.indexOf(t),n=this.data[i];return n&&n.length&&this.onDrop&&this.onDrop(n,i),this.data[i]=e,i},e.prototype.getData=function(t){return this.data[t]},e.prototype.addLayer=function(e){t.prototype.addLayer.call(this,e),this.data.splice(e,0,void 0)},e.prototype.removeLayer=function(e){t.prototype.removeLayer.call(this,e),this.setData(e,void 0),this.preview(e,void 0),this.data.splice(e,1)},e}(we),Te=function(){function t(t){this.tiles=new i(t)}return t.prototype.setSize=function(t){this.tiles.setSize(t)},t.prototype.get=function(t,e){if(e){var i=this.tiles._[t];return i&&i.data}return this.tiles.get(t)},t.prototype.forEach=function(t){return this.tiles.forEach(t)},t}(),Le=function(t){function e(e){return t.call(this,e)||this}return d(e,t),e.prototype.create=function(t,e){var i,n,r=this.tiles,o=this.onDrop,a=r.get(t);if(!a&&(a=new be(t,e,o),(i=r.set(t,a))&&(n=i.data))){for(var s=0;s<n.length;s++)i.setData(s,null),i.preview(s,null);i.data=null}return a},e}(Te),Ae=e.getInstance(),Se=Math.PI/180,Me=new Float32Array([-1,-1,-1,-1]),Ee=function(t,e,i,n,r,o,a){void 0===a&&(a=0);for(var s=t.z,l=!0,h=0,u=n;h<u.length;h++){var f=u[h],c=f.type,p=et("type",f,e,s);if("Polygon"==p||"Line"==p){if(et("stroke",f,e,s)){f.type="Line";for(var d=0,v=i;d<v.length;d++){var y=v[d];l=l&&t.create(e,"LineString",y,[f],r,o.clipped)}f.type=c}}else if(0==a){var g=o.bounds,m=e.bbox,x=[m[0]+(m[2]-m[0])/2,m[1]+(m[3]-m[1])/2],_=x[0],w=x[1];_>=g[0]&&w>=g[1]&&_<g[2]&&w<g[3]&&(l=l&&t.create(e,"Point",x,[f],r))}}return l},ze=[0,0,1,0,1,1,0,0,1,1,0,1],Ce=function(t,e,i){var n=i.length,r=t=32*t<<2|1,o=e=32*e<<2|1,a=2|t,s=o,l=r,h=2|e,u=a,f=h;return i.push(r,o,l,h,u,f,r,o,u,f,a,s),n+12},Ie=function(t,e,i,n,r){for(var o=t.length,a=[],s=0,l=0;l<e.length;l++){for(var h=0,u=void 0,f=void 0;h<e[l].length;h++)u=i.lon2x(e[l][h][0],n),f=i.lat2y(e[l][h][1],n),r?t.push(u,f,r):t.push(u,f);l>0&&(s+=e[l-1].length,a[a.length]=s)}return{dimensions:r?3:2,vertices:t,holes:a,start:o,stop:t.length}},Pe=function(t,e,i,n,r){var o;if("number"!=typeof e[0][0][0]){o=[];for(var a=0,s=e;a<s.length;a++){var l=s[a];o.push(Ie(t,l,i,n,r))}}else o=[Ie(t,e,i,n,r)];return o},ke=function(t,e,i){for(var n=0,r=e,o=i-1;r<o;r+=3){var a=t[r],s=t[r+1];n+=(t[r+3]-a)*(s+t[r+4])}return n},De=function(t,e,i,n,r,o){for(var a=t.holes,s=t.vertices,l=t.stop-3,h=t.start,u=0,f=h+3*a[u]-6,c=ke(e.data,h,f?f+3:l)>=0;h<l;){var p=void 0,d=void 0,v=void 0,y=void 0;if(c){var g=t.start+l-h;p=s.get(g),v=s.get(g+1),d=s.get(g-3),y=s.get(g-2)}else p=s.get(h),v=s.get(h+1),d=s.get(h+3),y=s.get(h+4);var m=Math.round(p)-Math.round(d),x=Math.round(v)-Math.round(y);if((m||x)&&(Z(p,v,0,0,r,r)||Z(d,y,0,0,r,r))){var _=e.length/3;n[n.length]=_+2,n[n.length]=_,n[n.length]=_+1,n[n.length]=_+3,n[n.length]=_+2,n[n.length]=_+1,e.push(p,v,o,p,v,0,d,y,o,d,y,0);var w=m*m+x*x,b=x,T=-m;b*=w=127/Math.sqrt(w),T*=w,i.push(b,T,b,T,b,T,b,T)}h==f?(h+=6,f=t.start+3*a[++u]-6,c=ke(e.data,h,f?f+3:l)<0):h+=3}},Re=function(t,e,i,n,r,o,a){for(var s=t.length,l=Pe(t,n,r,o,a);s<t.length;)e.push(0,0),s+=3;for(var h=0,u=l;h<u.length;h++){var f=u[h];De(f,t,e,i,o,a)}return l},Oe=Ue,Ne=Ue;function Ue(t,e,i){i=i||2;var n,r,o,a,s,l,h,u=e&&e.length,f=u?e[0]*i:t.length,c=Fe(t,0,f,i,!0),p=[];if(!c||c.next===c.prev)return p;if(u&&(c=function(t,e,i,n){var r,o,a,s,l,h=[];for(r=0,o=e.length;r<o;r++)a=e[r]*n,s=r<o-1?e[r+1]*n:t.length,(l=Fe(t,a,s,n,!1))===l.next&&(l.steiner=!0),h.push(Ke(l));for(h.sort(Ye),r=0;r<h.length;r++)je(h[r],i),i=Be(i,i.next);return i}(t,e,c,i)),t.length>80*i){n=o=t[0],r=a=t[1];for(var d=i;d<f;d+=i)(s=t[d])<n&&(n=s),(l=t[d+1])<r&&(r=l),s>o&&(o=s),l>a&&(a=l);h=0!==(h=Math.max(o-n,a-r))?1/h:0}return We(c,p,i,n,r,h),p}function Fe(t,e,i,n,r){var o,a;if(r===hi(t,e,i,n)>0)for(o=e;o<i;o+=n)a=ai(o,t[o],t[o+1],a);else for(o=i-n;o>=e;o-=n)a=ai(o,t[o],t[o+1],a);return a&&ti(a,a.next)&&(si(a),a=a.next),a}function Be(t,e){if(!t)return t;e||(e=t);var i,n=t;do{if(i=!1,n.steiner||!ti(n,n.next)&&0!==Je(n.prev,n,n.next))n=n.next;else{if(si(n),(n=e=n.prev)===n.next)break;i=!0}}while(i||n!==e);return e}function We(t,e,i,n,r,o,a){if(t){!a&&o&&function(t,e,i,n){var r=t;do{null===r.z&&(r.z=Ve(r.x,r.y,e,i,n)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e,i,n,r,o,a,s,l,h=1;do{for(i=t,t=null,o=null,a=0;i;){for(a++,n=i,s=0,e=0;e<h&&(s++,n=n.nextZ);e++);for(l=h;s>0||l>0&&n;)0!==s&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,s--):(r=n,n=n.nextZ,l--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;i=n}o.nextZ=null,h*=2}while(a>1)}(r)}(t,n,r,o);for(var s,l,h=t;t.prev!==t.next;)if(s=t.prev,l=t.next,o?Ge(t,n,r,o):Xe(t))e.push(s.i/i),e.push(t.i/i),e.push(l.i/i),si(t),t=l.next,h=l.next;else if((t=l)===h){a?1===a?We(t=Ze(Be(t),e,i),e,i,n,r,o,2):2===a&&He(t,e,i,n,r,o):We(Be(t),e,i,n,r,o,1);break}}}function Xe(t){var e=t.prev,i=t,n=t.next;if(Je(e,i,n)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(Qe(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)&&Je(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Ge(t,e,i,n){var r=t.prev,o=t,a=t.next;if(Je(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,l=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,h=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,f=Ve(s,l,e,i,n),c=Ve(h,u,e,i,n),p=t.prevZ,d=t.nextZ;p&&p.z>=f&&d&&d.z<=c;){if(p!==t.prev&&p!==t.next&&Qe(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&Je(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,d!==t.prev&&d!==t.next&&Qe(r.x,r.y,o.x,o.y,a.x,a.y,d.x,d.y)&&Je(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;p&&p.z>=f;){if(p!==t.prev&&p!==t.next&&Qe(r.x,r.y,o.x,o.y,a.x,a.y,p.x,p.y)&&Je(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;d&&d.z<=c;){if(d!==t.prev&&d!==t.next&&Qe(r.x,r.y,o.x,o.y,a.x,a.y,d.x,d.y)&&Je(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function Ze(t,e,i){var n=t;do{var r=n.prev,o=n.next.next;!ti(r,o)&&ei(r,n,n.next,o)&&ri(r,o)&&ri(o,r)&&(e.push(r.i/i),e.push(n.i/i),e.push(o.i/i),si(n),si(n.next),n=t=o),n=n.next}while(n!==t);return Be(n)}function He(t,e,i,n,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&$e(a,s)){var l=oi(a,s);return a=Be(a,a.next),l=Be(l,l.next),We(a,e,i,n,r,o),void We(l,e,i,n,r,o)}s=s.next}a=a.next}while(a!==t)}function Ye(t,e){return t.x-e.x}function je(t,e){if(e=function(t,e){var i,n=e,r=t.x,o=t.y,a=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var s=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=r&&s>a){if(a=s,s===r){if(o===n.y)return n;if(o===n.next.y)return n.next}i=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!i)return null;if(r===a)return i;var l,h=i,u=i.x,f=i.y,c=1/0;n=i;do{r>=n.x&&n.x>=u&&r!==n.x&&Qe(o<f?r:a,o,u,f,o<f?a:r,o,n.x,n.y)&&(l=Math.abs(o-n.y)/(r-n.x),ri(n,t)&&(l<c||l===c&&(n.x>i.x||n.x===i.x&&qe(i,n)))&&(i=n,c=l)),n=n.next}while(n!==h);return i}(t,e)){var i=oi(e,t);Be(e,e.next),Be(i,i.next)}}function qe(t,e){return Je(t.prev,t,e.prev)<0&&Je(e.next,t,t.next)<0}function Ve(t,e,i,n,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Ke(t){var e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function Qe(t,e,i,n,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(n-s)-(i-a)*(e-s)>=0&&(i-a)*(o-s)-(r-a)*(n-s)>=0}function $e(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&ei(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(ri(t,e)&&ri(e,t)&&function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)&&(Je(t.prev,t,e.prev)||Je(t,e.prev,e))||ti(t,e)&&Je(t.prev,t,t.next)>0&&Je(e.prev,e,e.next)>0)}function Je(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function ti(t,e){return t.x===e.x&&t.y===e.y}function ei(t,e,i,n){var r=ni(Je(t,e,i)),o=ni(Je(t,e,n)),a=ni(Je(i,n,t)),s=ni(Je(i,n,e));return r!==o&&a!==s||(!(0!==r||!ii(t,i,e))||(!(0!==o||!ii(t,n,e))||(!(0!==a||!ii(i,t,n))||!(0!==s||!ii(i,e,n)))))}function ii(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function ni(t){return t>0?1:t<0?-1:0}function ri(t,e){return Je(t.prev,t,t.next)<0?Je(t,e,t.next)>=0&&Je(t,t.prev,e)>=0:Je(t,e,t.prev)<0||Je(t,t.next,e)<0}function oi(t,e){var i=new li(t.i,t.x,t.y),n=new li(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,o.next=n,n.prev=o,n}function ai(t,e,i,n){var r=new li(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r}function si(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function li(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function hi(t,e,i,n){for(var r=0,o=e,a=i-n;o<i;o+=n)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}Ue.deviation=function(t,e,i,n){var r=e&&e.length,o=r?e[0]*i:t.length,a=Math.abs(hi(t,0,o,i));if(r)for(var s=0,l=e.length;s<l;s++){var h=e[s]*i,u=s<l-1?e[s+1]*i:t.length;a-=Math.abs(hi(t,h,u,i))}var f=0;for(s=0;s<n.length;s+=3){var c=n[s]*i,p=n[s+1]*i,d=n[s+2]*i;f+=Math.abs((t[c]-t[d])*(t[p+1]-t[c+1])-(t[c]-t[p])*(t[d+1]-t[c+1]))}return 0===a&&0===f?0:Math.abs((f-a)/a)},Ue.flatten=function(t){for(var e=t[0][0].length,i={vertices:[],holes:[],dimensions:e},n=0,r=0;r<t.length;r++){for(var o=0;o<t[r].length;o++)for(var a=0;a<e;a++)i.vertices.push(t[r][o][a]);r>0&&(n+=t[r-1].length,i.holes.push(n))}return i},Oe.default=Ne;var ui,fi=function(){function t(t){this.data={},this.gl=t}return t.prototype.create=function(t){var e=t.reduce((function(t,e){return t+e}))*(t.length%2+1);e*=Math.ceil(512/e);for(var i=new Uint8Array(e),n=!0,r=0;r<e;)for(var o=0,a=t;o<a.length;o++){var s=a[o];n&&i.fill(255,r,r+s),r+=s,n=!n}return new Et(this.gl,{width:i.length,height:1,pixels:i},this.gl.LUMINANCE)},t.prototype.get=function(t){var e=String(t),i=this.data[e];return i||(i=this.data[e]=this.create(t)),i},t}(),ci=function(){function t(t){void 0===t&&(t=256),this.length=0,this.points=[],this.sqDistance=this.setMinDistance(t)}return t.prototype.setMinDistance=function(t){return this.sqDistance=t*t},t.prototype.add=function(t,e){var i=this.points;i[this.length++]=t,i[this.length++]=e},t.prototype.clear=function(){this.length=0,this.points.length=0},t.prototype.hasSpace=function(t,e){var i=this.length,n=this.points,r=this.sqDistance,o=0;if(r)for(;o<i;){var a=t-n[o++],s=e-n[o++];if(a*a+s*s<r)return!1}return!0},t}(),pi=180/Math.PI,di=function(){function t(t){this.length=0,this.dashes=new fi(t),this.gl=t,this.pixels=new Float32Array(262144),this.alpha=new Float32Array(131072),this.repeat={}}return t.prototype.getDistanceGrp=function(){return this.repeat[this.dId]},t.prototype.projectLine=function(t,e,i){var n=this.pixels,r=this.decimals;if(!this.length){for(var o=0,a=0,s=0,l=t.length,h=void 0,u=void 0,f=void 0,c=void 0;s<l;s++){if(h=e.lon2x(t[s][0],i),u=e.lat2y(t[s][1],i),(!s||Math.round(f*r)-Math.round(h*r)||Math.round(c*r)-Math.round(u*r))&&(n[o++]=h,n[o++]=u,o>2)){var p=f-h,d=c-u;a+=Math.sqrt(p*p+d*d)}f=h,c=u}this.length=o,this.lineLength=a}return this.length},t.prototype.initTile=function(){var t=this.repeat;for(var e in t)t[e].clear()},t.prototype.initFeature=function(t,e,i){this.decimals=t>=20-Number(512==e)?100:1,this.length=0,this.collisions=null;var n=this.repeat;this.dId=i,i&&!n[i]&&(n[i]=new ci)},t.prototype.createLine=function(t,e,i,n,r,o,a,s,l,h,u,f){o&&(e.texture=this.dashes.get(o)),e.buffer||(e.buffer=new he);var c=e.buffer;this.projectLine(t,i,n),$t(c.attributes.a_position.data,c.attributes.a_normal.data,this.pixels,this.length,this.lineLength,n,r,a,s,l,o&&c.attributes.a_lengthSoFar.data,h,u,f)},t.prototype.placeAtSegments=function(t,e,i,n,r,o,a,s,l,h,u,f,c){var p;this.projectLine(t,e,i),null===(p=this.getDistanceGrp())||void 0===p||p.setMinDistance(null==o?256:o),this.placeAlongLine(e,i,n,r,a,s,l,h,u,f,c)},t.prototype.placeAtPoints=function(t,e,i,n,r,o,a,s,l,h){if(this.projectLine(t,e,i),this.collisions)for(var u=0,f=this.collisions;u<f.length;u++){var c=f[u];h(c.cx,c.cy,0,c)}else{for(var p=n&&[],d=0,v=this.pixels,y=this.length;d<y;d++){var g=v[d],m=v[++d],x=void 0;if(g>=0&&m>=0&&g<i&&m<i){var _=void 0;p&&((_=this.getDistanceGrp())&&!_.hasSpace(g,m)||(x=n.insert(g,m,s,l,o,a,e,i,r))&&p.push(x)),p&&!x||(h(g,m,0,x),null==_||_.add(g,m))}}(null==p?void 0:p.length)&&(this.collisions=p)}},t.prototype.placeAlongLine=function(t,e,i,n,r,o,a,s,l,h,u){if(this.collisions)for(var f=0,c=void 0;f<this.collisions.length;f++)u((c=this.collisions[f]).cx,c.cy,l?this.alpha[f]:0,c);else{var p,d,v,y,g,m,x=i&&[],_=this.length/2,w=this.pixels,b=Math.pow(2*r+a,2),T=Math.floor(_/2)-1,L=1,A=w[2*T],S=w[2*T+1],M=A,E=S;for(f=1;f<_;f++){var z=T+L*f;if(z>=_&&(L=-1,z=T-1,T=_-1,A=M,S=E),p=w[2*z],m=.5*(y=(d=w[2*z+1])-S)+S,(g=.5*(v=p-A)+A)>=0&&m>=0&&g<e&&m<e)if((h?v*v+y*y:1/0)>b){var C=Math.atan2(y,v);-1==L&&(C+=Math.PI);var I=void 0,P=void 0;if(x&&(!(P=this.getDistanceGrp())||P.hasSpace(g,m))){var k=a,D=s,R=r,O=o;if(l&&C){var N=G(C,a,s,g,m);if(k=N[2]-N[0],D=N[3]-N[1],r&&(R=(O=Math.sin(C)*r)*v/y),o){var U=Math.PI-C;R+=Math.sin(U)*-o,O+=Math.cos(U)*-o}}(I=i.insert(g,m,R,O,k/2,D/2,t,e,n))&&(this.alpha[x.length]=C*pi,x.push(I))}x&&!I||(u(g,m,l?C*pi:0,I),null==P||P.add(g,m))}A=p,S=d}(null==x?void 0:x.length)&&(this.collisions=x)}},t}(),vi=function(t){function e(){var e=t.call(this,!1)||this;return e.attributes={a_position:{data:new te(Uint16Array),size:2},a_point:{data:new te(Int16Array),size:2},a_texcoord:{data:new te(Uint16Array),size:2}},e.first=0,e}return d(e,t),e}(le),yi=function(t){function e(){var e=t.call(this,!1)||this;return e.attributes={a_position:{data:new te(Uint16Array),size:2},a_size:{data:new te(Uint8Array),size:2},a_texcoord:{data:new te(Uint16Array),size:2}},e.first=0,e}return d(e,t),e}(le),gi=function(t){function e(){var e=t.call(this,!1)||this;return e.attributes={a_position:{data:new te(Uint16Array),size:2}},e.first=0,e}return d(e,t),e}(le),mi=function(t){function e(){var e=t.call(this,!0)||this;return e.attributes={a_position:{data:new te(Float32Array),size:2}},e.first=0,e}return d(e,t),e}(le),xi=function(t){function e(){var e=t.call(this,!0)||this;return e._flat=!1,e.attributes={a_position:{data:new te(Float32Array),size:3},a_normal:{data:new te(Int8Array),size:2,normalized:!0}},e.first=0,e}return d(e,t),e}(le),_i=new Map;[[ui,ui,ui],[ui,ui,65154],[ui,ui,65156],[ui,ui,65158],[ui,ui,65160],[65163,65164,65162],[ui,ui,65166],[65169,65170,65168],[ui,ui,65172],[65175,65176,65174],[65179,65180,65178],[65183,65184,65182],[65187,65188,65186],[65191,65192,65190],[ui,ui,65194],[ui,ui,65196],[ui,ui,65198],[ui,ui,65200],[65203,65204,65202],[65207,65208,65206],[65211,65212,65210],[65215,65216,65214],[65219,65220,65218],[65223,65224,65222],[65227,65228,65226],[65231,65232,65230],ui,ui,ui,ui,ui,[1600,1600,1600],[65235,65236,65234],[65239,65240,65238],[65243,65244,65242],[65247,65248,65246],[65251,65252,65250],[65255,65256,65254],[65259,65260,65258],[ui,ui,65262],[ui,ui,65264],[65267,65268,65266]].forEach((function(t,e){_i.set(1569+e,t&&{initial:t[0],medial:t[1],final:t[2]})})),_i.set(1662,{initial:64344,medial:64345,final:64343}),_i.set(1740,{initial:64510,medial:64511,final:64509}),_i.set(1670,{initial:64380,medial:64381,final:64379}),_i.set(1705,{initial:64400,medial:64401,final:64399}),_i.set(1711,{initial:64404,medial:64405,final:64403}),_i.set(1688,{final:64395});var wi=new Set([1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773]),bi={1570:{isolated:65269,final:65270},1571:{isolated:65271,final:65272},1573:{isolated:65273,final:65274},1575:{isolated:65275,final:65276}},Ti=function(t,e,i){for(var n=i>0?t.length-e:e+1,r=1,o=void 0;r<n;r++)if(o=t.charCodeAt(e+i*r),!wi.has(o))return{cp:o,map:_i.get(o)}},Li=function(t){var e;if(!function(t){return/[\u0600-\u06FF]/.test(t)}(t))return t;for(var i="",n=0;n<t.length;++n){var r=t.charCodeAt(n);if(_i.has(r)){var o=null===(e=Ti(t,n,-1))||void 0===e?void 0:e.map;!o||o.initial||o.medial||(o=ui);var a=Ti(t,n,1),s=null==a?void 0:a.map;!s||s.medial||s.final||(s=ui);var l;if(l=1604==r&&bi[null==a?void 0:a.cp])r=o?l.final:l.isolated,n++;else{var h=_i.get(r);o&&s&&h.medial?r=h.medial:o&&h.final?r=h.final:s&&h.initial&&(r=h.initial)}}i+=String.fromCharCode(r)}return i},Ai=function(){function t(t,e,i,n){this.pendingCollisions=[],this.gl=t,this.icons=e,this.dpr=n,this.dashes=new fi(t),this.collisions=i,this.lineFactory=new di(t)}return t.prototype.init=function(t,e,i,n){this.tile=t,this.groups=e,this.tileSize=i,this.z=n,this.lineFactory.initTile(),this.pendingCollisions.length=0},t.prototype.createPoint=function(t,e,i,n,r,o,a,s,l,h){void 0===s&&(s=0);var u,f,c,p=this.z;if(s=(s+360)%360,"Text"==t){e.texture||(e.texture=new se(this.gl,e.shared),e.buffer=new vi);var d=e.texture,v=e.buffer.attributes;d.addChars(l);var y=d.getAtlas(),g=et("lineWrap",r,o,p);null==g&&(g=h);var m=O(l,g);u=v.a_texcoord,c=(f=v.a_texcoord.data.length)+d.bufferLength(l),function(t,e,i,n,r,o,a,s){void 0===s&&(s=0);var l=i.length,h=a.lineHeight,u=32*(a.baselineOffset+(l-1)*h*.5);t*=128,e*=128,s=Math.round(512*s/360);for(var f=0,c=i;f<c.length;f++){var p=c[f],d=r.length,v=re(p,a,s,n,o),y=v.width*a.scale/2*32,g=2*v.count;r.reserve(g);for(var m=n.data,x=r.data,_=d+g;d<_;d+=2)m[d]-=y,m[d+1]-=u,x[d]=t,x[d+1]=e;r.length+=g,u-=32*h}}(i,n,m,v.a_point.data,v.a_position.data,v.a_texcoord.data,y,s)}else{if("Icon"==t){e.buffer||(e.buffer=new yi),u=e.buffer.attributes.a_position;var x=et("src",r,o,p),_=et("width",r,o,p),w=et("height",r,o,p)||_,b=(v=e.buffer.attributes,this.icons.get(x,_,w));if(!b)return void(this.iconsLoaded=!1);!function(t,e,i,n,r,o,a,s,l){void 0===l&&(l=0);var h=i.u1,u=i.u2,f=i.v1,c=i.v2;Ce(t,e,a);var p=(l=Math.round(1024*l/360))>>5,d=31&l;h=h<<5|d,u=u<<5|d,f=f<<5|p,c=c<<5|p,o.push(n,r,n,r,n,r,n,r,n,r,n,r),s.push(h,c,h,f,u,f,h,c,u,f,u,c)}(i,n,b,_,w,v.a_size.data,u.data,v.a_texcoord.data,s),e.texture=this.icons.getTexture()}else{if("Circle"!=t&&"Rect"!=t)return;e.buffer||(e.buffer=new gi),u=e.buffer.attributes.a_position,Ce(i,n,u.data)}f=(c=u.data.length)-12}a&&u&&a.attrs.push({buffer:u,start:f,stop:c})},t.prototype.create=function(t,e,i,n,r,o,a,s){var l,h,u,f,c,p,d,v,y,g,m,x,_,w,b,T,L,A,S,M,E,z,C,P,k,D,R,O,N,U,F,W,X,G,Z,H,Y,j,q=this,V=this.tile,K=this.groups,Q=this.tileSize,$=this.z,J=Number.MAX_SAFE_INTEGER,nt=-Number.MAX_SAFE_INTEGER,rt="";if(this.iconsLoaded=!0,this.lineFactory.initFeature($,Q,null==s?void 0:s.id),void 0===a&&"Point"===e&&!V.isInside(i))return this.iconsLoaded;for(var ot=0,at=n.length;ot<at;ot++)if(y=n[ot],(m=et("type",y,t,$))&&0!==(x=et("opacity",y,t,$))){var lt="Polygon"==e||et("collide",y,t,$);if(null!=a||("Text"!=m||lt)&&!1!==lt){if((null==x||x>=.98)&&(x=1),"Image"==m&&(m="Icon"),_=void 0,w=void 0,L=void 0,b=void 0,A=void 0,S=void 0,M=void 0,E=void 0,z=void 0,P=void 0,k=void 0,U=0,F=0,W=void 0,G=void 0,X=r,Z="px",H=void 0,T=0^et("rotation",y,t,$),"Icon"==m)U=0^et("offsetX",y,t,$),F=0^et("offsetY",y,t,$),G=et("alignment",y,t,$)||"viewport",R="I"+U+F;else{if(L=et("stroke",y,t,$),S=et("strokeWidth",y,t,$),"Line"==m){if(!L||!S)continue;var ht=it(S);S=ht[0],Z=ht[1],E=et("strokeLinecap",y,t,$)||"round",z=et("strokeLinejoin",y,t,$)||"round",(M=et("strokeDasharray",y,t,$))instanceof Array&&M.length&&M[0]||(M=void 0);var ut=et("offset",y,t,$);R="L"+Z+(U=(l=it(ut))[0])+(H=l[1])+E+z+(M||"*")}else if(w=et("fill",y,t,$),"Polygon"==m){if(!w||"Polygon"!=e)continue;(C=et("extrude",y,t,$))?(R="E",m="Extrude"):R="P"}else{if("Polygon"==e)continue;if(G=et("alignment",y,t,$),"Text"==m){if(!(W=tt(y,t,$)))continue;W=Li(W),null==G&&(G="Point"==e?"viewport":"map"),R="T"+((_=et("font",y,t,$)||I)||"*")}else if("Circle"==m)P=k=et("radius",y,t,$),P=(h=it(P))[0],R="C"+(Z=h[1])+P||"*";else{if("Rect"!=m)continue;P=et("width",y,t,$),P=(u=it(P))[0],Z=u[1],k=(k=et("height",y,t,$))?it(k)[0]:P,R="R"+T+Z+P+k}U=et("offsetX",y,t,$),F=et("offsetY",y,t,$),H=new Array(2),U=(f=it(U))[0],H[0]=f[1],F=(c=it(F))[0],H[1]=c[1],R+=U+H[0]+F+H[1]}w&&((b=B(w))?b[3]*=x:w=null),L&&((A=B(L))?A[3]*=x:L=null,"Text"==m&&(X=1),("number"!=typeof S||(S*=X)<0)&&(S=1)),R+=(L||"*")+(S||"*")+(w||"*")}R+=100*x^0,g=et("zIndex",y,t,$);var ft=et("zLayer",y,t,$);if(null!=ft&&(R=ft+":"+R),null==(N=(D=K[g]=K[g]||[])[R])?(N=D[R]=D.length,O=D[N]={type:m,zLayer:ft,shared:{unit:Z,font:_,fill:b,opacity:x,stroke:A,strokeWidth:S,strokeLinecap:E,strokeLinejoin:z,strokeDasharray:M,width:P,height:k,rotation:T,offsetX:U,offsetY:F,offsetUnit:H,alignment:G}}):O=D[N],"Point"==e){var ct=V.lon2x(i[0],Q),pt=V.lat2y(i[1],Q),dt=void 0;if(s){if(!(dt=this.collisions.insert(ct,pt,s.offsetX,s.offsetY,s.width,s.height,V,Q,s.priority)))return this.iconsLoaded;s=null}this.createPoint(m,O,ct,pt,y,t,dt,T,W)}else if("LineString"==e)if("Line"==m)this.lineFactory.createLine(i,O,V,Q,o,M,E,z,S,U,et("from",y,t,$),et("to",y,t,$));else{var vt=et("anchor",y,t,$);null==vt&&(vt="Text"==m?"Line":"Coordinate");var yt="Text"==m?!lt:!1===lt,gt=void 0,mt=void 0;if("Line"==vt){var xt="map"==G;if(s)gt=2*s.width,mt=2*s.height;else if("Icon"==m)gt=et("width",y,t,$),mt=et("height",y,t,$)||P;else if("Text"==m){var _t=O.texture;_t||(_t=O.texture=new se(this.gl,y),O.buffer=new vi);var wt=_t.getAtlas();gt=wt.getTextWidth(W),mt=wt.letterHeight}else gt=P,mt=k,"Circle"==m&&(gt*=2,mt*=2);var bt=et("checkLineSpace",y,t,$);null==bt&&(bt=!0),this.lineFactory.placeAtSegments(i,V,Q,yt&&this.collisions,a,et("repeat",y,t,$),U,F,gt,mt,xt,bt,(function(e,i,n,r){q.createPoint(m,O,e,i,y,t,r,n+T,W,!1)}))}else s?(gt=s.width,mt=s.height):(gt=P/2,mt=k/2),this.lineFactory.placeAtPoints(i,V,Q,yt&&this.collisions,a,gt,mt,U,F,(function(e,i,n,r){q.createPoint(m,O,e,i,y,t,r,n+T,W)}))}else if("Polygon"==m||"Extrude"==m){O.buffer||(O.buffer="Polygon"==m?new mi:new xi);var Tt=O.buffer,Lt=Tt.index(),At=Tt.attributes,St=At.a_position.data;if(p=St.length,"Extrude"==m?d=Re(St,At.a_normal.data,Lt,i,V,Q,C):"Polygon"==m&&(d=Pe(St,i,V,Q)),!v){var Mt=t.geometry;if(Mt._xyz)v=Mt._xyz;else{v=[];for(var Et=0,zt=d;Et<zt.length;Et++)for(var Ct=zt[Et],It=Ct.dimensions,Pt=St.data.subarray(Ct.start,Ct.stop),kt=Oe(Pt,Ct.holes,It),Dt=(Ct.start-p)/It,Rt=0,Ot=kt;Rt<Ot.length;Rt++){var Nt=Ot[Rt];v.push(Dt+Nt)}V.clipped||(Mt._xyz=v)}}Nt=0;for(var Ut,Ft=p/d[0].dimensions;Nt<v.length;Nt++)Ut=Ft+v[Nt],Tt.i32=Tt.i32||Ut>65535,Lt.push(Ut)}}else{var Bt=st(y,t,$,this.dpr,j);if(Bt){j=Bt||j,(Y=Y||[]).push(y);var Wt=et("priority",y,t,$);Wt<J&&(J=Wt);var Xt=et("repeat",y,t,$);Xt>nt&&(nt=Xt),rt+=m+(Wt||"?")+(Xt||"?")}}}if(Y){var Gt={id:rt,priority:J,repeat:nt,styleGrp:Y,feature:t,geomType:e,coordinates:i},Zt=j[0],Ht=j[1],Yt=.5*(j[2]-Zt),jt=.5*(j[3]-Ht);Gt.offsetX=Zt+Yt,Gt.offsetY=Ht+jt,Gt.width=Yt,Gt.height=jt,this.pendingCollisions.push(Gt)}return this.iconsLoaded},t}(),Si=function(){function t(t){this.tiles=new Map,this.display=t}return t.prototype.getTileCacheKey=function(t,e){return 256==e.tileSize?t.slice(0,-1):t},t.prototype.getDataKey=function(t,e){return e.id+"-"+t},t.prototype.intersects=function(t,e,i){void 0===i&&(i=0);for(var n=e.length,r=void 0;i<n;i++)if(r=e[i],t.minX<=r.maxX&&r.minX<=t.maxX&&t.minY<=r.maxY&&r.minY<=t.maxY)return!0},t.prototype.initTile=function(t,e){var i=[],n=t.quadkey,r=t.x,o=t.y,s=t.z;this.clearTile(n,e),256==e.tileSize&&(s--,o=.5*o^0,r=.5*r^0);for(var l=-1;l<2;l++)for(var h=-1;h<2;h++)if(0!=h||0!=l){var u=a.tileXYToQuadKey(s,o+l,r+h),f=this.tiles.get(u);if(f)for(var c in f)for(var p=0,d=f[c];p<d.length;p++){var y=d[p];i[i.length]=y}}var g=this.getTileCacheKey(n,e);this.curLayerTileCollision={tileKey:g,data:[],dataKey:this.getDataKey(n,e),existing:v({neighbours:i},this.tiles.get(g)||{})},this.updated=!1},t.prototype.insert=function(t,e,i,n,r,o,a,s,l){void 0===l&&(l=Number.MAX_SAFE_INTEGER);var h=a.x*s,u=a.y*s,f=h+t-r,c=h+t+r,p=u+e-o,d=u+e+o;256==s&&(t-=512*(.5*a.x^0)-h,e-=512*(.5*a.y^0)-u);var v={cx:t+i,cy:e+n,offsetX:i,offsetY:n,minX:f-3,maxX:c+3,minY:p-3,maxY:d+3,priority:l,attrs:[]},y=this.curLayerTileCollision,g=y.data,m=y.existing;if(this.intersects(v,g))return!1;for(var x in m)if(this.intersects(v,m[x]))return!1;return v.cx-=i,v.cy-=n,this.updated=!0,g.push(v),v},t.prototype.completeTile=function(){this.updated&&(this.rx=this.rz=this.s=null);var t=this.curLayerTileCollision,e=t.tileKey,i=t.dataKey,n=t.data,r=this.tiles.get(e)||{};r[i]=n,this.tiles.set(e,r),this.curLayerTileCollision=null},t.prototype.clearTile=function(t,e){var i,n=this.getTileCacheKey(t,e),r=this.getDataKey(t,e);if((null===(i=this.curLayerTileCollision)||void 0===i?void 0:i.dataKey)!=r){var o=this.tiles.get(n);if(o){for(var a in delete o[r],o)return;this.tiles.delete(n)}}},t.prototype.update=function(t,e,i,n){if(this.rx!=e||this.rz!=i||this.s!=n){this.rx=e,this.rz=i,this.s=n;for(var r=this.display,o=[],a=0,s=t;a<s.length;a++){var l=s[a],h=l.quadkey,u=this.tiles.get(h);if(u)for(var f in u)for(var c=u[f],p=0;p<c.length;p++){var d=(S=c[p]).attrs,v=S.minX,y=S.maxX,g=S.minY,m=.5*(y-v),x=.5*(S.maxY-g),_=l.x+S.cx,w=l.y+S.cy,b=r.project(_+S.offsetX/n,w+S.offsetY/n,0,0);o.push({minX:b[0]-m,maxX:b[0]+m,minY:b[1]-x,maxY:b[1]+x,attrs:d,priority:S.priority})}}o.sort((function(t,e){return t.priority-e.priority}));for(var T=[],L=0,A=o;L<A.length;L++){var S=A[L],M=this.intersects(S,T);M||T.push(S);for(var E=0,z=S.attrs;E<z.length;E++){var C=z[E],I=C.buffer,P=C.start,k=C.stop,D=I.data,R=I.size,O=1==(1&D[P]);if(M&&O||!M&&!O){for(;P<k;)D[P]^=1,P+=R;I.dirty=!0}}}}},t.prototype.removeTiles=function(t){var e=t.id;this.tiles.forEach((function(t){for(var i in t)Number(i.split("-")[0])==e&&delete t[i]}))},t}(),Mi=[3,9],Ei=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n||"auto",new Le(512),new _e(r),Mi)||this;o.name="gl-test",o.dpr<2&&o.buckets.setSize(1024);var a=o;return o.collision=new Si(a),o.buckets.onDrop=function(t,e){var i=this.quadkey,n=this.layers;a.collision.clearTile(i,n[e]),a.releaseBuffers(t)},o.render.init(o.canvas,o.dpr),o.factory=new Ai(o.render.gl,o.render.icons,o.collision,o.dpr),o.tilesNotReady=[],o.render.icons.onLoad=function(t){for(var e=0,i=o.tilesNotReady;e<i.length;e++){var n=i[e],r=n.quadkey,a=n.layerId,s=o.layers.get(a);if(s){var l=o.buckets.get(r,!0);if(l){var h=s.layer,u=s.index;l.preview(u,!1),l.ready(u,!1),l.cancelTasks(h);var f=h.getCachedTile(l.quadkey);f&&o.handleTile(f,h,l,u)}}}o.tilesNotReady=[]},o}return d(e,t),e.prototype.releaseBuffers=function(t){var e=this.render;if(t)for(var i=0,n=t;i<n.length;i++){var r=n[i];e.deleteBuffer(r)}},e.prototype.removeLayer=function(e){return this.collision.removeTiles(this.layers.get(e)),t.prototype.removeLayer.call(this,e)},e.prototype.unproject=function(t,e){var i=this.render.invScreenMat,n=[t,e,0],r=[t,e,1];fe(n,n,i),fe(r,r,i);var o=n[2],a=r[2],s=o===a?0:(0-o)/(a-o);return[n[0]*(1-s)+r[0]*s,n[1]*(1-s)+r[1]*s]},e.prototype.project=function(t,e,i,n){void 0===i&&(i=this.sx),void 0===n&&(n=this.sy);var r=[t-i,e-n,0];return fe(r,r,this.render.screenMat)},e.prototype.setSize=function(e,i){t.prototype.setSize.call(this,e,i),this.render.gl&&this.render.initView(this.w,this.h,this.s,this.rx,this.rz)},e.prototype.setTransform=function(t,e,i){if(this.s!=t||this.rz!=e||this.rx!=i){this.s=t,this.rz=e,this.rx=i;var n=2*Math.PI;e=(e+n)%n,this.render.initView(this.w,this.h,t,i,e)}},e.prototype.prepareTile=function(t,e,i,n,r){var o=this,a=this,l=a.render.gl,h=i.tileSize,u=this.layers.get(i.id);if("image"==t.type){var f=function(t,e,i){var n=new qt({first:0,count:6},"Image"),r=new Int16Array(12);return r[0]=0,r[1]=0,r[2]=i,r[3]=0,r[4]=i,r[5]=i,r[6]=0,r[7]=0,r[8]=i,r[9]=i,r[10]=0,r[11]=i,n.addAttribute("a_position",{data:r,size:2,stride:0}),n.addAttribute("a_textureCoord",{data:new Int8Array(ze),size:2,stride:0}),n.texture=new Mt(e,t),n.addUniform("u_sampler",0),n.zIndex=0,n.scissor=!0,n}(e,l,h);u.addZ(f.zIndex),n.preview(n.setData(i,[f]),null),r(n,i)}else if(e.length){var c=function(t,e,i,n,r,o,a){var l=e.layer,h={},u=!0,f=Ae.create({time:4,priority:4,init:function(){var e=n.z+l.levelOffset,a=l.getStyle(),s=1;if(a){var u=a.strokeWidthZoomScale||a.LineStringZoomScale;u&&(s=u(e))}return o&&o(),r.init(n,h,i,e),[n,t,s,0,16,l,e,!1]},name:"createBuffer",onDone:function(t){var i,r,o,f,c,p,d,v,y,g,m=t[6],x=Math.pow(2,17-m),_=1/s.getGroundResolution(m),w=[];for(g in h)if(o=h[g])for(var b=0;b<o.length;b++)if(c=(f=o[b]).type,d=(p=f.shared).stroke,v=p.strokeWidth,y=c,r=f.buffer,("Text"!=y||f.texture)&&r&&!r.isEmpty()&&null!=(i=r.finalize(c))){if(w.push(i),"Line"==c)p.strokeDasharray&&(i.type="DashedLine",i.texture=f.texture,i.addUniform("u_texWidth",f.texture.width),i.addUniform("u_pattern",0)),i.addUniform("u_fill",d),i.addUniform("u_strokeWidth",[.5*v,"m"==p.unit?_:0]),i.addUniform("u_offset",[p.offsetX,"m"==p.offsetUnit?_:0]),i.alpha=1;else if("Polygon"==c||"Extrude"==c)i.addUniform("u_fill",p.fill),"Extrude"==c&&(i.addUniform("u_zoom",x),i.scissor=!1);else if("Text"==c||"Icon"==c)i.scissor=r.scissor,i.texture=f.texture,"Text"==c?(i.texture.sync(),i.addUniform("u_fillColor",p.fill||Me),i.addUniform("u_strokeColor",p.stroke||Me)):i.addUniform("u_opacity",p.opacity),i.addUniform("u_texture",0),i.addUniform("u_atlasScale",1/i.texture.width),i.addUniform("u_alignMap","map"==p.alignment),i.addUniform("u_offset",[p.offsetX,p.offsetY]);else if("Rect"==c||"Circle"==c){i.scissor=r.scissor;var T=p.fill||Me;i.addUniform("u_fill",T),d&&(i.addUniform("u_stroke",d),null==v&&(v=1)),i.addUniform("u_strokeWidth",0^v);var L="m"==p.unit?_:0;"Circle"==c?i.addUniform("u_radius",[p.width,L]):(T==Me&&(i.alpha=1,i.blend=!0),i.addUniform("u_size",[p.width,L,p.height,L]),i.addUniform("u_rotation",p.rotation*Se)),i.addUniform("u_alignMap","map"==p.alignment),i.addUniform("u_offset",[p.offsetX,"m"==p.offsetUnit[0]?_:0,p.offsetY,"m"==p.offsetUnit[1]?_:0])}var A=p.fill&&p.fill[3],S=p.stroke&&p.stroke[3],M=A<1,E=M||S<1;E&&(i.alpha=M&&"Extrude"==c?2:1,i.blend=!0,i.depth=!0);var z=f.zLayer;"top"==g&&(z=1/0,g=0),g=Number(g),i.flat=r.isFlat(),e.addZ(g,!i.flat),i.zIndex=g,i.zLayer="number"==typeof z?Math.ceil(z):null,null==i.scissor&&(i.scissor=!n.clipped||l.getMargin()>0||E)}a(w.reverse(),u)},exec:function(t){var e,i,n,o=t[0],a=t[1],s=t[2],l=t[5],h=a.length,f=t[6],c=!1;if(!t[7]){for(;t[4]--&&(i=a[t[3]++]);)if(e=l.getStyleGroup(i,f)){n=i.geometry.type,e.length||(e=[e]),yt(e);var p=i.getProvider().decCoord(i),d=!0;if("MultiLineString"==n||"MultiPoint"==n)for(var v="MultiPoint"==n?"Point":"LineString",y=0,g=p;y<g.length;y++){var m=g[y];d=d&&r.create(i,v,m,e,s)}else if("MultiPolygon"==n){d=r.create(i,"Polygon",p,e,s);for(var x=0;x<p.length;x++){var _=p[x];d=d&&Ee(r,i,_,e,s,o,x)}}else d=r.create(i,n,p,e,s),"Polygon"==n&&(d=d&&Ee(r,i,p,e,s,o));u=u&&d}c=t[3]<h}if(!c&&r.pendingCollisions.length){t[7]||(t[7]=r.pendingCollisions.sort((function(t,e){return t.priority-e.priority})),t[3]=0);var w=t[7],b=void 0;if(t[4]>=0)for(;t[4]--&&(b=w[t[3]++]);){p=b.coordinates;var T=b.priority,L=b.geomType;if("Point"==L||"LineString"==L){var A=r.create(b.feature,L,p,b.styleGrp,s,!1,T,b);u=u&&A}}c=t[3]<w.length}return t[4]=16,c}});return Ae.start(f),f}(e,u,h,t,this.factory,(function(){a.collision.initTile(t,u)}),(function(t,e){n.removeTask(c,i),n.preview(n.setData(i,t),null),e||a.tilesNotReady.push({quadkey:n.quadkey,layerId:i.id}),o.dirty=!0,a.collision.completeTile(),r(n,i)}));n.addTask(c,i)}else n.preview(n.setData(i,[]),null),r(n,i)},e.prototype.orderBuffers=function(t,e,i,n,r,o,a){for(var s=0,l=e;s<l.length;s++){var h=l[s],u=h.zLayer,f=h.zIndex;null==u&&(u=i.index+1);var c=1e6*u+f;n[c]=0,r[r.length]={b:h,z:c,tile:t,preview:o,previewTile:a}}},e.prototype.viewport=function(t){var e,i=this.buckets,n=this.layers,r=this.render,o=n.length;(this.dirty||t)&&(this.dirty=!1,this.collision.update(this.grid.tiles[512],this.rx,this.rz,this.s)),r.clear(o&&n[0].bgColor||this.globalBgc),r.fixedView=Number(!this.viewChange);for(var a=[],s={},l=0,h=n;l<h.length;l++){var u=h[l],f=u.tiles;if(u.cnt=0,f)for(var c=u.index,p=f.length,d=0;d<p;){var v=(R=f[d++]).tile,y=v.data[u.index];if(!u.ready&&v.ready(c)&&++u.cnt==p&&(u.ready=!0),y)y.length&&this.orderBuffers(R,y,u,s,a);else{var g;if((g=v.preview(c))&&g.length)for(var m=0,x=g;m<x.length;m++){var _,w=x[m],b=w[0],T=i.get(b,!0);(null==(_=null==T?void 0:T.getData(c))?void 0:_.length)&&this.orderBuffers(R,_,u,s,a,w,T)}}}}var L=-1;for(var d in s)s[d]=++L;for(var A=1/0,S=(d=0,void 0),M=void 0;d<a.length;d++)S=(M=a[d]).z=s[M.z],!M.b.flat&&S<A&&(A=S);r.setPass(At.OPAQUE);for(var E=a.length;E--;){(I=a[E])&&r.draw(I,A)}r.setPass(At.ALPHA),a=a.sort((function(t,e){return t.z-e.z}));var z=0;do{var C=!1;for(E=0,e=a.length;E<e;E++){var I;2==(I=a[E]).b.alpha&&(C=!0),I&&I.z==z&&r.draw(I,A)}r.pass==At.POST_ALPHA?r.setPass(At.ALPHA):C&&(r.setPass(At.POST_ALPHA),z--)}while(++z<=L);if(r.tileGrid)for(var P in this.tiles){if((f=this.tiles[P]).length){for(var k=0,D=f;k<D.length;k++){var R=D[k];r.drawGrid(R.x,R.y,R.tile,P)}break}}},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e.prototype.viewChangeDone=function(){this.viewChange=!1,this.update()},e.zoomBehavior="float",e}(wt),zi=new St,Ci=2*Math.PI,Ii=Math.PI/180,Pi=Math.log(2048)/Math.log(2),ki=Pi+9,Di=function(t,e,i,n,r,o,a,s,l,h,u,f){var c=a.z;e+=0^et("offsetX",n,r,c),i+=0^et("offsetY",n,r,c);var p,d,v,y,g,m,x=et("rotation",n,r,c),_=e+512<<Pi|i+512^0|(x+360)%360<<ki;u[_]||(u[_]=1,x&&(x*=Ii,l.translate(e,i),l.rotate(x),g=e,m=i,e=0,i=0),"Text"==t?(n.stroke&&0!=n.strokeWidth&&l.strokeText(o,e,i),n.fill&&l.fillText(o,e,i)):"Circle"==t?(d=et("radius",n,r,c),l.moveTo(e+d,i),l.arc(e,i,d,0,Ci,!1)):(e-=(v=et("width",n,r,c))/2,i-=(y=et("height",n,r,c)||v)/2,"Image"==t?(p=et("src",n,r,c),zi.isReady(p)?l.drawImage(zi.get(p),e,i,v,y):zi.get(p,(function(){return f.updateTile(a,s,h)}),a.quadkey)):"Rect"==t&&l.rect(e,i,v,y)),x&&(l.rotate(-x),l.translate(-g,-m)))},Ri=Math,Oi=function(){function t(){this.o=.5}return t.prototype.init=function(t){return this.o=t,!0},t.prototype.createSymbol=function(t,e){return t-("Circle"==e.type?e.radius:e.width)>0},t.prototype.drawSymbol=function(t,e,i,n,r,o,a,s,l,h,u){Di(r.type,e,i,r,a,!1,o,s,n,l,h,u)},t.prototype.angle=function(t,e){return Math.atan2(t,e)},t.prototype.place=function(t,e,i,n,r,o,a,s,l,h){for(var u,f,c,p,d,v,y,g,m,x,_=this.o,w=0;w<t.length;w++)c=Math.round(e.lon2x(t[w][0])),p=Math.round(e.lat2y(t[w][1])),w&&(m=c-u,x=p-f,d=Ri.sqrt(Ri.pow(m,2)+Ri.pow(x,2))-16,(v=this.createSymbol(d,r))&&(y=(m*_+u)*h,g=(x*_+f)*h,i.setTransform(h,0,0,h,y,g),i.rotate(this.angle(x,m)),i.translate(-y,-g),this.drawSymbol(v,y,g,i,r,e,n,o,a,s,l),i.setTransform(h,0,0,h,0,0))),u=c,f=p},t}(),Ni=function(t){function e(e){var i=t.call(this)||this;return t.prototype.init.call(i,.5),i.setCharWidth(e),i}return d(e,t),e.prototype.setCharWidth=function(t){this.cw=t},e.prototype.init=function(t){return"string"!=typeof t&&(t=String(t)),this.lw=t.length*this.cw,this.label=t,!0},e.prototype.angle=function(t,e){return Math.atan(t/e)},e.prototype.createSymbol=function(t){var e,i,n=this.label,r=this.cw,o=this.lw,a=Math.floor(t/o);return a>0&&(e=n,a>1&&(a=1+Math.floor((a-1)/8),i=new Array(Math.floor(1.5*(t-o)/r/a)).join(" "),e=n+new Array(a).join(i+n))),e},e.prototype.drawSymbol=function(t,e,i,n,r){r.stroke&&n.strokeText(t,e,i),r.fill&&n.fillText(t,e,i)},e}(Oi),Ui=function(t,e,i){var n,r,o,a,s=t.length-1;for(e.moveTo(o=Math.round(i.lon2x(t[s][0])),a=Math.round(i.lat2y(t[s][1])));s--;)n=Math.round(i.lon2x(t[s][0])),r=Math.round(i.lat2y(t[s][1])),(o-n||a-r)&&e.lineTo(o=n,a=r)},Fi=[],Bi=new Ni(R({font:I}).width),Wi=new Oi,Xi=function(t,e,i){t.globalAlpha=null==e.opacity?1:e.opacity;var n,r,o=e.font,a=e.stroke;if(a&&(t.strokeStyle=a,o&&(i=1),(n=e.strokeWidth)&&"number"==typeof n||(n=1),t.lineWidth=n*i),e.fill&&(t.fillStyle=e.fill),o){var s=e.font||I;Bi.setCharWidth(R(e).width),t.font=s,t.textAlign=e.textAlign||"center",t.textBaseline=e.textBaseline||"middle"}else t.lineCap=e.strokeLinecap||"round",t.lineJoin=e.strokeLinejoin||"round",(r=e.strokeDasharray)instanceof Array?t.setLineDash(r):t.setLineDash(Fi),(e.fill||e.stroke)&&t.beginPath();return!0},Gi=function(t,e,i,n,r,o,a,s,l,h){var u=i.getProvider().decCoord(i),f=i.geometry.type,c=t.z,p=et("type",r,i,c);if("LineString"==f){if("Circle"==p||"Rect"==p||"Image"==p){var d=et("offset",r,i,c);if(null!=d)return Wi.init(d),void Wi.place(u,t,e,i,r,o,a,s,l,h);f="MultiPoint"}}else if(("Polygon"==f||"MultiPolygon"==f)&&"Polygon"!=p&&"Line"!=p){var v=i.bbox;return Di(p,Math.round(t.lon2x(v[0]+(v[2]-v[0])/2)),Math.round(t.lat2y(v[1]+(v[3]-v[1])/2)),r,i,n,t,o,e,a,s,l)}if("Point"==f)Di(p,Math.round(t.lon2x(u[0])),Math.round(t.lat2y(u[1])),r,i,n,t,o,e,a,s,l);else if("Text"==p){if(!Bi.init(n))return;if("MultiLineString"==f)for(var y=0;y<u.length;y++)Bi.place(u[y],t,e,i,r,o,a,s,l,h);else"LineString"==f&&Bi.place(u,t,e,i,r,o,a,s,l,h)}else if("LineString"==f)Ui(u,e,t);else if("Polygon"==f||"MultiLineString"==f)for(var g=0;g<u.length;g++)Ui(u[g],e,t);else if("MultiPolygon"==f)for(y=0;y<u.length;y++)for(g=0;g<u[y].length;g++)Ui(u[y][g],e,t);else if("MultiPoint"==f)for(var m=u.length;m--;)Di(p,Math.round(t.lon2x(u[m][0])),Math.round(t.lat2y(u[m][1])),r,i,n,t,o,e,a,s,l)},Zi=function(){function t(t,e,i){this.tm=t,this.exclusiveTimeMS=i,this.dpr=e}return t.prototype.spawn=function(t,e,i,n,r,o,a,s,l){var h=this.createTask(t,e,i,n,r,i.bounds,o,a,s,l);return this.tm.start(h),h},t.prototype.createTask=function(t,e,i,n,r,o,a,s,l,h){var u=this.dpr,f=r.index(n),c=r.getContext(f);return this.tm.create({priority:t,delay:h,time:this.exclusiveTimeMS,init:function(){if(!l){c.setTransform(u,0,0,u,0,0);var t=n.getStyle().backgroundColor;t?(c.fillStyle=t,c.globalAlpha=1,c.fillRect(0,0,256,256)):c.clearRect(0,0,256,256)}return{tile:i,ctx:c,data:a,lI:0,gI:0,fI:0,style:void 0,dTile:r,layer:n,bI:100}},onDone:function(){r.dirty(f),s(c,this)},exec:function(t){var i,n=t.tile,r=t.data,o=r.length;if(o){for(;!(i=r[t.lI])&&t.lI<o;)++t.lI;if(i){var a=i[t.gI];if(a){var s=t.ctx,l=a.shared,h=null!=l.font;if(t.style!=l){t.style=l;var f=Xi(s,l,r.swzs);if(t.pmap={},!f)return t.fI=0,t.gI++,t.bI=100,this.CONTINUE}for(;t.bI--;){var c=t.fI++,p=a.data,d=p.features[c];if(!d){h?s.setTransform(u,0,0,u,0,0):(l.fill&&s.fill(),l.stroke&&(l.strokeWidth||null==l.strokeWidth)&&s.stroke()),t.fI=0,t.gI++;break}var v=p.styles[c],y=void 0;h&&!(y=tt(v,d,n.z))||Gi(n,s,d,y,v,t.dTile,t.layer,t.pmap,e,u)}}else t.fI=0,t.gI=0,t.lI++;return t.bI=100,this.CONTINUE}}}})},t}(),Hi=function(){function t(t,i){this.dpr=1,this.debug=!1,this.rz=0,this.sx=0,this.sy=0,this.s=1;var n=e.getInstance();this.ts=t,this.dpr=i,this.painter=new Zi(n,i,4)}return t.prototype.drawGrid=function(t,e,i){var n=i+"  L"+i.length,r=this.ctx;r.strokeRect(t,e,256,256),r.strokeText(n,t+8,e+16),r.fillText(n,t+8,e+16)},t.prototype.applyTransform=function(){var t=this.s,e=this.rz;if(this._s!=t||this._rz!=e){this._s=t,this._rz=e;var i=this.ctx,n=this.canvas,r=n.width,o=n.height,a=r/2-this.sx,s=o/2-this.sy,l=this.dpr;i.setTransform(1,0,0,1,r/2,o/2),i.rotate(e),i.translate(-r/2+a,-o/2+s),i.scale(t,t),i.translate(-a,-s),i.scale(l,l)}},t.prototype.init=function(t){var e=t.getContext("2d",{alpha:!1});e.font="bold 14px Arial",e.lineWidth=3,e.strokeStyle="red",e.fillStyle="white",e.textAlign="start",e.textBaseline="alphabetic",this.ctx=e,this.canvas=t},t.prototype.setBuckets=function(t){this.buckets=t},t.prototype.clear=function(){},t.prototype.convertColor=function(t){return t},t.prototype.setBackgroundColor=function(t){this.buckets.bgColor(t)},t.prototype.grid=function(t){this.debug=t},t.prototype.setScale=function(t,e,i){this.s=t,this.sx=e,this.sy=i},t.prototype.setRotation=function(t,e){this.rz=t},t.prototype.prepare=function(t,e,i,n,r,o){return this.painter.spawn(3,n,e,i,r,t,o)},t.prototype.tile=function(t,e,i){e=Math.round(e),i=Math.round(i),this.ctx.drawImage(t.combine(),e,i,256,256),this.debug&&this.drawGrid(e,i,t.quadkey)},t.prototype.preview=function(t,e,i,n){var r=t.getContext(n);r.clearRect(0,0,t.size,t.size);for(var o=0,a=e.length;o<a;o++){var s=e[o],l=this.buckets.get(s[0],!0),h=void 0;l&&(h=l.getData(n))&&(r.setTransform(1,0,0,1,0,0),r.drawImage(h,s[1],s[2],s[3],s[4],0+s[5],0+s[6],s[7],s[8]),t.dirty(n))}},t.prototype.destroy=function(){},t}(),Yi=function(t){function e(e,i,n,r,o){var a=t.call(this)||this,s=n.length;return a.c=new Array(s),a.init(i,n),a.size=r,a.bPool=e,a.ctx=e.claimCtx(r),a.canvas=a.ctx.canvas,a.ctx.fillStyle=o,a}return d(e,t),e.prototype.destroy=function(t){if(null!=t)(e=this.c[t])&&(e.canvas&&this.bPool.releaseCtx(e),this.c[t]=void 0);else for(var e,i=this.c.length;i--;)(e=this.c[i])&&e.canvas&&(this.bPool.releaseCtx(e),this.c[i]=void 0)},e.prototype.init=function(e,i){t.prototype.init.call(this,e,i);var n=i.length;for(this.c.length=n;n--;)this.c[n]=void 0;this._c=!1,this._ready=!1},e.prototype.dirty=function(t,e){var i=this.c[t],n=e!=i;e&&i&&n&&this.destroy(t),e||(n=!0,e=this.c[t]),n&&(this.c[t]=e,this._c=!1)},e.prototype.clear=function(t){var e;(e=this.c[t])&&(e.setTransform&&this.bPool.releaseCtx(e),this.c[t]=void 0,this.preview(t,void 0),this.ready(t,!1),this._c=!1,this.combine())},e.prototype.getContext=function(t){return this.c[t]||(this.c[t]=this.bPool.claimCtx(this.size)),this.c[t]},e.prototype.getData=function(t){return this.c[t]&&(this.c[t].canvas||this.c[t])},e.prototype.combine=function(){var t,e=this,i=e.size;if(!e._c){e._c=!0,e.ctx.fillRect(0,0,i,i);for(var n=0;n<e.c.length;n++)(t=this.getData(n))&&e.ctx.drawImage(t,0,0,i,i)}return e.canvas},e.prototype.addLayer=function(e){t.prototype.addLayer.call(this,e);this.c.splice(e,0,void 0),this._c=!1,this._ready=!1},e.prototype.removeLayer=function(e){t.prototype.removeLayer.call(this,e);this.destroy(e),this.c.splice(e,1),this._c=!1},e}(we),ji=[],qi={length:0,max:128,clear:function(){this.length=0},create:function(t){var e=document.createElement("canvas");return e.width=e.height=t,this.length++,e.getContext("2d")},get:function(t){return ji.length?(this.length++,ji.shift()):this.create(t)},release:function(t){t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.lineWidth=1,t.globalAlpha=1,ji.push(t),this.length--}},Vi=function(t){function e(e,i){var n=t.call(this,e||256)||this;return n.ctxCache=qi,n._bgc=null,n.tSize=i,n}return d(e,t),e.prototype.bgColor=function(t){this._bgc=t,this.forEach((function(e){e.ctx.fillStyle=t}))},e.prototype.clear=function(){this.tiles.clear(),qi.clear()},e.prototype.setSize=function(t){this.tiles.setSize(t)},e.prototype.releaseCtx=function(t){return qi.release(t)},e.prototype.claimCtx=function(t){if(qi.length<qi.max)return qi.get(t);var e=this.tiles.tail.data;return e.destroy(),qi.release(e.ctx),e.ctx=null,e.canvas=null,this.tiles.remove(e.quadkey),e.cancelTasks(),this.claimCtx(t)},e.prototype.create=function(t,e){var i=this.tiles.get(t);return i||(this.tiles.length>=this.tiles.max?((i=this.tiles.tail.data).destroy(),i.init(t,e),i.size=this.tSize):i=new Yi(this,t,e,this.tSize,this._bgc),this.tiles.set(t,i)),i},e}(Te),Ki={1:[512,3,512],2:[128,2,128],3:[64,1,128]},Qi=function(t,e,i,n,r){var o=Math.sin(r),a=Math.cos(r),s=t-i,l=e-n;return[a*s-o*l+i,o*s+a*l+n]},$i=function(){function t(){this.features=[],this.styles=[]}return t.prototype.add=function(t,e){this.features.push(t),this.styles.push(e)},t}(),Ji=function(t){function e(e,i,n,r){var o;i=i||256,n=0^wt.getPixelRatio(n);var a=Ki[n][1],s=new Hi(i*n,n),l=Ki[n][0],h=new Vi(l,i*n);return s.setBuckets(h),o=t.call(this,e,i,n,h,s,a)||this,s.init(o.canvas),o}return d(e,t),e.prototype.preview=function(e,i,n){var r=t.prototype.preview.call(this,e,i,n);return r&&this.render.preview(e,r,i,n),r},e.prototype.prepareTile=function(t,e,i,n,r){var o=this,a=o.render;if("image"==t.type){var s=n.index(i);n.dirty(s,e),r(n,i)}else if(e.length)n.addTask(o.cluster.spawn(4,i,t,e,{},$i,(function(e,s){n.removeTask(s,i),null==n&&(n=void 0),n.addTask(a.prepare(e,t,i,o,n,(function(t,e){n.removeTask(e,i),r(n,i)})),i)})),i);else{s=n.index(i);n.destroy(s),n.dirty(s),r(n,i)}},e.prototype.viewport=function(t){var e,i,n=this.tiles,r=this.render,o=this.layers,a=o.length;this.buckets;for(var s in(this.dirty||t)&&(this.render.clear(),this.dirty=!1),n)if("512"!=s)for(var l=n[s],h=l.length,u=0,f=l;u<f.length;u++){var c=f[u];if(i=(e=c.tile).luTs,c.lrTs!=i||t){c.lrTs=i,r.tile(e,c.x,c.y);for(var p,d=0;d<a;d++)!(p=o[d]).ready&&e.ready(d)&&++p.cnt==h&&(p.ready=!0)}}},e.prototype.addLayer=function(e,i,n){e.tileSize=256;var r=t.prototype.addLayer.call(this,e,i,n);return r&&this.setupTilePool(),r},e.prototype.removeLayer=function(e){var i=t.prototype.removeLayer.call(this,e);return-1!==i&&this.setupTilePool(),i},e.prototype.setSize=function(e,i){t.prototype.setSize.call(this,e,i),this.setupTilePool(),this.render._s=void 0,this.setTransform(this.s,this.rz,this.rx)},e.prototype.destroy=function(){t.prototype.destroy.call(this),this.buckets.clear()},e.prototype.setupTilePool=function(){var t=(Math.ceil(this.w/256)+1)*(Math.ceil(this.h/256)+1),e=t,i=Ki[this.dpr],n=t*this.getLayers().length;e<i[0]&&(e=i[0]),this.buckets.setSize(e),n<i[2]&&(n=i[2]),this.buckets.ctxCache.max=n},e.prototype.update=function(e){t.prototype.update.call(this)},e.prototype.project=function(t,e){var i=this.s;return Qi(t*=i,e*=i,this.w/2,this.h/2,this.rz)},e.prototype.unproject=function(t,e){var i=this.s,n=this.w/2,r=this.h/2,o=Qi(t,e,n,r,-this.rz);return o[0]=(o[0]-n)/i+n,o[1]=(o[1]-r)/i+r,o},e.zoomBehavior="fixed",e}(wt),tn=0===navigator.platform.indexOf("Win")?.0025:.0015,en=function(){function e(t,e,i,n){var r=this;this.passive=!1;try{var o=Object.defineProperty({},"passive",{get:function(){r.passive=!0}});window.addEventListener("testPassive",null,o),window.removeEventListener("testPassive",null,o)}catch(t){}this.el=t,this.settings=i,this.map=e,this.ams=0^n,this.onSpin=this.onSpin.bind(this)}return e.prototype.onSpin=function(e){var i=this.settings,n=this.el,r=this.map,o=i.zoom;if(o){var a=-(e=e||t.event).deltaY;if(e.deltaMode===e.DOM_DELTA_LINE&&(a*=32.001953125),a){var s=r.getZoomlevel(),l=void 0,h=void 0;"fixed"==o?e.shiftKey?l=s+(a>0?.1:-.1):(l=Math.round(s+(a<0?-1:1)),h=!0):l=s+a*tn;var u=n.getBoundingClientRect();this.zoom(l,e.pageX-u.left,e.pageY-u.top,h)}}e.preventDefault&&e.preventDefault(),e.returnValue=!1},e.prototype.enable=function(){m(this.el,["wheel","DOMMouseScroll"],this.onSpin)},e.prototype.disable=function(){x(this.el,["wheel","DOMMouseScroll"],this.onSpin)},e.prototype.zoom=function(t,e,i,n){var r=this.map,o=this.ams;r.setZoomlevel(t,e,i,n&&o)},e}(),nn=function(t){return t},rn=function(t){return Math.sin(Math.PI*t*.5)},on=Object.freeze({__proto__:null,linear:nn,easeOutSine:rn,easeOutCubic:function(t){return 1-(t=1-t)*t*t}}),an=function(){function t(t,e,i,n,r){this.ts=0,this.af=null,this.from="number"==typeof t?[t]:t,this.to="number"==typeof e?[e]:e,this.duration=i,"function"==typeof n&&(r=n,n="linear"),this.easing=on[n]||nn,this.animator=r,this.animate=this.animate.bind(this)}return t.prototype.animate=function(){var t=this,e=this.duration,i=Math.min(Date.now()-this.ts,e),n=this.from.map((function(n,r){var o=t.to[r];return n+t.easing(i/e)*(o-n)}));this.animator(1==n.length?n[0]:n),i<e?this.af=requestAnimationFrame(this.animate):(this.af=null,this.done())},t.prototype.start=function(){return y(this,void 0,void 0,(function(){var t=this;return g(this,(function(e){return[2,new Promise((function(e){t.done=e,t.ts?e():(t.ts=Date.now(),t.animate())}))]}))}))},t.prototype.stop=function(){null!=this.af&&(cancelAnimationFrame(this.af),this.af=null)},t}(),sn=function(t,e){var i,n,r=t.targetTouches;if(r){var o=r.length,a=r[o-1],s=void 0;if(o){var l=e.getBoundingClientRect(),h=a.pageX-l.left,u=a.pageY-l.top;o>1?(i=(h+(s=r[o-2]).pageX-l.left)/2,n=(u+s.pageY-l.top)/2):(i=h,n=u)}}else i=t.clientX,n=t.clientY;return[0^i,0^n]},ln=function(t){var e=t.targetTouches,i=e.length,n=e[i-2];if(n){var r=e[i-1],o=n.clientX-r.clientX,a=n.clientY-r.clientY;return 180*Math.atan2(a,o)/Math.PI}},hn=function(e,i,n,r,o){var a=this;this.scrollHandler=new en(e,i,r,o.zoomAnimationMs);var s,l,h,u,f,c,p,d,v,y,g,_,w,b,T,L=this,A=null,S=Date.now(),M=[],E=[],z=function(){p=0,M.length=0,E.length=0};function C(t){var e=1;if(null!=t.scale)return t.scale;var i=t.targetTouches,n=i.length,r=i[n-1],o=i[n-2];if(o){var a=H(r.clientX,r.clientY,o.clientX,o.clientY);null==A&&(A=a),e=a/A}return e}function I(t,e){if(!f){var a=o.minPanMapThreshold;if(Math.abs(t-s)<a&&Math.abs(e-l)<a)return!0;n.cancel()}if(c=Date.now(),r.drag&&!i.lockViewport().pan){var d=t-h,v=e-u;p<8?(M[p]=d,E[p]=v,p++):p=0,i.pan(d,v),f=!0}h=t,u=e}function P(t){if(f){var e=Date.now();e-c<25&&n.pan(e,3*M.reduce((function(t,e){return t+e}),0),3*E.reduce((function(t,e){return t+e}),0))}}var k,D=null;function R(t){z();var n=t.targetTouches,r=n.length,o=sn(t,e);if(h=o[0],u=o[1],s=h,l=u,C(t),f=!1,2==r){k=0;var a=n[r-1],c=n[r-2];_=a.clientX,w=a.clientY,b=c.clientX,T=c.clientY,A=H(_,w,b,T),g=i.getZoomlevel(),d=i.rotate(),v=i.pitch(),y=ln(t)}}function O(t){var n=t.targetTouches,o=n.length,a=sn(t,e),s=C(t);if(o>1){if(r.pitch){if(++k<5)return void t.preventDefault();var l=n[o-1],f=n[o-2],c=w-l.clientY,p=T-f.clientY;if(D||0!=D&&Math.abs(f.clientY-l.clientY)<110&&Math.sign(c)==Math.sign(p))return D=!0,i.pitch(v+.2*c),void t.preventDefault();D=!1}r.zoom&&L.scrollHandler.zoom(g+Math.log2(s),a[0],a[1],!1),r.rotate&&i.rotate(d+ln(t)-y)}I(a[0],a[1]),h=a[0],u=a[1],t.preventDefault()}function N(t){var i=sn(t,e),n=t.targetTouches.length;D=null,i&&(h=i[0],u=i[1],s=h,l=u),n<2&&(A=null);var r=Date.now(),o=r-S;n&&(S=r),C(t),0==n&&1==t.changedTouches.length&&o>350&&P()}var U=null;function F(t){U=t.button,z(),f=!1,m(e,"mousemove",B),d=i.rotate(),v=i.pitch(),h=t.clientX,u=t.clientY,s=h,l=u}function B(t){var e;null===(e=L.resetAnimation)||void 0===e||e.stop(),0==U?I(t.clientX,t.clientY):2==U&&(r.rotate&&i.rotate(d+.25*(h-t.clientX)),r.pitch&&i.pitch(v+.1*(u-t.clientY)))}function W(t){if(U=null,x(e,"mousemove",B),f)P();else if(r.rotate){var n=i.rotate();d!=n&&Math.abs(n)<=5&&(L.resetAnimation=new an(n,0,500,"easeOutSine",(function(t){return i.rotate(t)})),L.resetAnimation.start())}}L.scroll=function(t){var e=a.scrollHandler;t?e.enable():e.disable()},L.drag=function(i){var n=i?m:x;setTimeout((function(){n(e,"touchstart",R),n(t,"touchend",N),n(e,"touchmove",O),n(e,"mousedown",F),n(t,"mouseup",W)}),0)},L.getOptions=function(){return r}},un=function(){function t(t,e,i,n,r){this.type=t,this.timeStamp=Date.now(),null!=e&&(this.data=this.detail=e),i&&(this.mapX=n,this.mapY=r,this.nativeEvent=i,this.button=i.button)}return t.prototype.stopPropagation=function(){var t=this.nativeEvent;if("mousemove"==t.type||"touchmove"==t.type)return t.stopImmediatePropagation(),t.preventDefault()},t.prototype.toString=function(){return"MapEvent "+this.type},t}(),fn=["pointerup","pointerenter","pointerleave","pointerdown","pointermove","pressmove","tap","dbltap"];function cn(t){return-1!==fn.indexOf(t)}function pn(t,e){var i=e.type;"touchstart"!=i&&"touchmove"!=i&&"touchend"!=i||(e=e.changedTouches[e.changedTouches.length-1]);var n=t.getBoundingClientRect();return[e.pageX-n.left,e.pageY-n.top]}var dn,vn=function(){function t(t,i,r,o){this.disabled={},this.hActive=!1,this.cnt=0,this.el=t,this.cbs=new n(["click"]);var a,s,l,h,u,f,c=this.disabled,p=!1,d=!1,v=0,y=!1,g=this.cbs;g.sync(!0),fn.forEach((function(t){g.addEvent(t),c[t]=!1}));var m=e.getInstance().create({delay:40,priority:5,exec:function(){!function(e){var i=pn(t,e),n=w(i);_("pointermove",e,i,n),n?u?u.feature.id!==n.feature.id&&(_("pointerleave",e,i,u),_("pointerenter",e,i,n)):_("pointerenter",e,i,n):u&&_("pointerleave",e,i,u);u=n}(f),y=!1}});function x(t,e,n,r,o){var a=new un(t,o,e,n,r);return o&&(a.target=o.feature,a.detail.display=i),a}function _(t,e,i,n){g.trigger(t,[x(t,e,i[0],i[1],n)],!1)}function w(t){return i.getFeatureAt({x:t[0],y:t[1]},{layers:i._layers.filter((function(t){return t.pointerEvents()}))})}this.onPointerDown=function(e){l=i.getCenter(),d=!0,p=!1,a=pn(t,e),s=w(a),_("pointerdown",e,a,s),"touchstart"==e.type&&e.target.parentNode==t&&e.preventDefault()},this.onPointerMove=function(e){var i,n,r;if(d){var l=o.minPanMapThreshold;if(!p&&(n=(i=pn(t,e))[0]-a[0],r=i[1]-a[1],Math.abs(n)<l&&Math.abs(r)<l))return}p=!0,d?s&&g.isListened("pressmove")&&(n=(i=pn(t,e))[0]-a[0],r=i[1]-a[1],g.trigger("pressmove",[x("pressmove",e,i[0],i[1],s),n,r],!1)):"touchmove"!=e.type&&(g.isListened("pointerenter")||g.isListened("pointerleave")||g.isListened("pointermove"))&&(f=e,c.pointerenter||c.pointerleave||y||(y=!0,m.start()))},this.onPointerUp=function(e){if(d){var n=i.getCenter();if(!(l.longitude!=n.longitude||l.latitude!=n.latitude)&&e.target.parentNode==t&&(s||!p)){var r=pn(t,e);_("tap",e,r,s),_("pointerup",e,r,s),function(t){var e=Date.now(),i=s&&s.feature;e-v<250&&!p&&h==i&&_("dbltap",t,a,s),h=i,v=e}(e)}d=p=!1}}}return t.prototype.getGlobalHandlers=function(){var t=this.onPointerDown,e=this.onPointerMove,i=this.onPointerUp;return{touchstart:t,touchmove:e,touchend:i,mousedown:t,mouseup:i,mousemove:e}},t.prototype.enable=function(t){cn(t)&&delete this.disabled[t]},t.prototype.disable=function(t){cn(t)&&(this.disabled[t]=!0)},t.prototype.destroy=function(){var t=this.getGlobalHandlers();if(this.hActive){for(var e in t)x(this.el,e,t[e]);this.hActive=!1}},t.prototype.addEventListener=function(t,e,i){if(cn(t)&&this.cbs.add(t,e,i)){this.cnt++;var n=this.getGlobalHandlers(),r=void 0;if(!this.hActive)for(var o in n){r=n[o];var a=this.el;if("mouseup"==o)for(;a.parentNode;)a=a.parentNode;m(a,o,r),this.hActive=!0}}},t.prototype.removeEventListener=function(t,e,i){var n=this.cbs,r=this.el;if(cn(t)&&n.remove(t,e,i)&&!--this.cnt&&this.hActive){var o=this.getGlobalHandlers();for(var a in o)n.isListened(a)||x(r,a,o[a]);this.hActive=!1}},t}(),yn=function(t,e,i,n,r,o){var a,s,l,h,u=r-i,f=o-n,c=u*u+f*f,p=-1;return 0!=c&&(p=((t-i)*u+(e-n)*f)/c),p<0?(a=i,s=n):p>1?(a=r,s=o):(a=i+p*u,s=n+p*f),l=t-a,h=e-s,Math.sqrt(l*l+h*h)},gn=function(t,e,i){for(var n,r,o,a,s=!1,l=0,h=i.length-1;l<i.length;h=l++)n=i[l][0],o=i[l][1],r=i[h][0],o>e!=(a=i[h][1])>e&&t<(r-n)*(e-o)/(a-o)+n&&(s=!s);return s},mn=function(){function t(t,e){this.map=t,this.dpr=e}return t.prototype.feature=function(t,e,i,n,r,o){return this.geometry(t,e,i.geometry.coordinates,i.geometry.type,n,r,i,o)},t.prototype.geometry=function(t,e,i,n,r,o,a,s,l){var h,u,f,c,p,d=!1,v=this.dpr,y=this.map;if("Point"==n){if(l=l||lt(r,a,s,v,o)){var g=y.geoToPixel(i[0],i[1]),m=Math.round(g.x+l[0]),x=Math.round(g.y+l[1]),_=Math.round(g.x+l[2]),w=Math.round(g.y+l[3]);u=e,f=_,c=x,p=w,d=(h=t)>=m&&h<=f&&u>=c&&u<=p}}else if("LineString"==n){for(var b=(l=l||at(r,a,s,o))[0],T=i.length,L=1/0,A=y.geoToPixel(i[0][0],i[0][1]),S=void 0,M=void 0,E=1;E<T;E++)S=y.geoToPixel(i[E][0],i[E][1]),(M=yn(t,e,A.x,A.y,S.x,S.y))<L&&(L=M),A=S;d=L<=b/2}else if("Polygon"==n){for(var z=y.pixelToGeo(t,e),C=z.longitude,I=z.latitude,P=0;P<i.length;P++)if(gn(C,I,i[P])!=!P)return!1;d=!0,l=l||[ot(r,a,s,o)]}else{var k=void 0;if("MultiPolygon"==n?(k="Polygon",l=[ot(r,a,s,o)]):"MultiPoint"==n?(k="Point",l=lt(r,a,s,v,o)):"MultiLineString"==n&&(k="LineString",l=at(r,a,s,o)),k){P=0;for(var D=i.length;P<D;P++)if(this.geometry(t,e,i[P],k,r,o,a,s,l)){d=!0;break}}}return d&&l},t}(),xn=Array.from({length:33},(function(t,e){return 32*Math.pow(2,Math.max(0,e-20+2))})),_n=function(t){return"number"==typeof t},wn=function(){function t(t,e){this.map=t,this.hit=new mn(t,e)}return t.prototype.getFeaturesInRect=function(t,e,i,n,r,o,a){for(var s,l,h,u,f,c,p,d,v=this.map,y=this.hit,g=0^Math.min(20,o),m={},x=t+(i-t)/2,_=e+(n-e)/2,w=180,b=-180,T=180,L=-180,A=[v.pixelToGeo(t,e),v.pixelToGeo(i,e),v.pixelToGeo(i,n),v.pixelToGeo(t,n)],S=4,M=[];S--;){var E=A[S].longitude,z=A[S].latitude;E<w&&(w=E),E>b&&(b=E),z<T&&(T=z),z>L&&(L=z)}s=[w,T,b,L],r&&!Array.isArray(r)&&(r=[]);for(var C=r.length;C--;)if(l=(h=r[C]).getProvider(o),o<=h.max&&o>=h.min&&l.search)for(c=(f=l.search(s)).length;c--;)if(u=f[c],(p=h.getStyleGroup(u,g))&&(d=y.feature(x,_,u,p,C,o))){var I=d[d.length-1],P=m[I]=m[I]||[];(P[C]=P[C]||[]).push(u)}var k={layer:null,features:null};for(var D in m)for(var R=m[D],O=0,N=void 0;O<R.length;O++)if(N=R[O]){var U=r[O];k.layer==U?k.features=k.features.concat(N):M.push({layer:U,features:N})}return M},t.prototype.search=function(t,e,i,n,r,o){var a=this.map,s=a._layers;if(r=r?r instanceof Array?r.slice().sort((function(t,e){return Number(s.indexOf(t)>s.indexOf(e))})):[r]:s,_n(t)&&_n(e)&&_n(i)&&_n(n)){var l=a.getZoomlevel(),h=xn[Math.ceil(l)];return this.getFeaturesInRect(t-h,e-h,i+h,n+h,r,l,o)}},t}(),bn=t.setTimeout,Tn=t.setInterval,Ln=100,An=function(t,e,i){var n;return"function"==typeof Event?n=new Event(t):(n=document.createEvent("Event")).initEvent(t,!0,!0),n.detail=n.data={map:e,layer:i},n},Sn=function(){function e(e,i,n){this.watchTimer=null,this.map=e,this.trigger=i,this.renderInfo=n,Ln=t.__XYZTST_MVCEDelayMs||Ln,this.changeWatcher=this.changeWatcher.bind(this),this.readyWatcher=this.readyWatcher.bind(this)}return e.prototype.centerChanged=function(t){return this.center.longitude!=t.longitude||this.center.latitude!=t.latitude},e.prototype.vpChanged=function(t,e,i){var n=this.viewport,r=this.rz,o=this.rx;return!(n.minLon!=t.minLon||n.maxLon!=t.maxLon||n.minLat!=t.minLat||n.maxLat!=t.maxLat||r!=e||o!=i)},e.prototype.changeWatcher=function(){var t=this,e=t.map,i=t.readyTimer,n=t.watchTimer,r=t.viewport,o=(t.center,e.getViewBounds()),a=e.getCenter(),s=e.rotate(),l=e.pitch(),h="mapviewchange",u={changed:{center:!0}};if(r){if(u.changed.center=this.centerChanged(a),this.vpChanged(o,s,l))return clearInterval(n),this.watchTimer=this.viewport=this.rz=this.rx=null,i&&clearTimeout(i),this.readyTimer=bn(this.readyWatcher,Ln);this.viewport=o,this.rz=s,this.rx=l,this.center=a}else this.triggeredLayers={},h="mapviewchangestart",this.viewport=o,this.rz=s,this.center=a,this.endTriggered=!0;this.trigger(h,u,!0)},e.prototype.readyWatcher=function(){var t,e,i,n=this.map,r=this.triggeredLayers,o=this.renderInfo.getLayers(),a=!0;if(this.endTriggered){this.endTriggered=!1;var s=n.getCenter();this.trigger("mapviewchangeend",{changed:{center:this.centerChanged(s)}},!0)}for(var l=0;l<o.length;l++)if(i=(t=(e=o[l]).layer).id,e.ready){if(!r[i]&&(r[i]=!0,!e.error)){var h=An("viewportReady",n,t);t._l.trigger("viewportReady",h,!0)}}else a=!1;a||(this.readyTimer=bn(this.readyWatcher,Ln))},e.prototype.watch=function(t){var e=this.readyTimer,i=this.watchTimer;e&&(clearTimeout(e),this.readyTimer=null),t?i||(this.watchTimer=Tn(this.changeWatcher,1e3/30)):i&&(clearInterval(i),this.watchTimer=null)},e}(),Mn=function(){function t(t,e,i,n){this._v=!0;this.map=i,this.cPrefix=t.className+"-ui-",this.parent=t,this.opt=e,e.visible&&(this.create(t,e),this.enable())}return t.prototype.show=function(){this.html||this.create(this.parent,this.opt),this.html.style.display="inline"},t.prototype.hide=function(){var t=this.html;t&&(t.style.display="none")},t.prototype.enable=function(){this.active=!0,this.toggleListeners(!0)},t.prototype.disable=function(){this.active=!1,this.toggleListeners(!1)},t.prototype.destroy=function(){this.disable(),this.parent.removeChild(this.html)},t.prototype.toggleListeners=function(t){var e=this,i=e.listeners,n=function(n){var r=e.querySelectorAll(n),o=function(o){r.forEach((function(r){var a=i[n][o];t?r.addEventListener(o,i[n][o]._=a.bind(e)):r.removeEventListener(o,a._)}))};for(var a in i[n])o(a)};for(var r in i)n(r)},t.prototype.insertRule=function(t,e){var i,n=(dn=dn||(i=document.createElement("style"),document.head.appendChild(i),i)).sheet;n.insertRule?n.insertRule(t+" {"+e+"}",n.cssRules.length):n.addRule&&n.addRule(t,e)},t.prototype.create=function(t,e){var i=this.templ.replace(/class\=\"/g,'class="'+this.cPrefix);i=i.replace(/\>[\s]+\</g,"><");var n,r=(n=i,(new DOMParser).parseFromString(n,"text/html").body.childNodes[0]),o=r.style,a=e.position,s="."+t.className+" ";for(var l in a)o[l]=a[l];if(this.style)for(var h in this.style)this.insertRule(s+this.prefixClass(h),this.style[h]);this.html=t.appendChild(r)},t.prototype.prefixClass=function(t){return t=t.replace(/\./g,"."+this.cPrefix)},t.prototype.querySelector=function(t){return this.html.querySelector(this.prefixClass(t))},t.prototype.querySelectorAll=function(t){return this.html.querySelectorAll(this.prefixClass(t))},t}(),En=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n)||this;return o.maxPitch=r.maxPitch,o}return d(e,t),e.prototype.enable=function(){t.prototype.enable.call(this);var e=this.querySelector(".needle"),i=this.map;i.addEventListener("mapviewchange",this._rl=function(t){e.style.transform="rotate("+i.rotate()+"deg) rotateX("+i.pitch()+"deg) scale(0.7,1.1)"}),this._rl()},e.prototype.disable=function(){t.prototype.disable.call(this),this.map.removeEventListener("mapviewchange",this._rl),this.a&&(this.a.stop(),this.a=null)},e}(Mn);En.prototype.listeners={".needle":{click:function(t){return y(this,void 0,void 0,(function(){var t,e,i,n;return g(this,(function(r){switch(r.label){case 0:return this.aip?[3,2]:(t=this.map,e=t.rotate(),i=t.pitch(),n=[0,0],e||i||(n=[0,this.maxPitch]),this.a=new an([e,i],n,500,"easeOutCubic",(function(e){t.rotate(e[0]),t.pitch(e[1])})),[4,this.a.start()]);case 1:r.sent(),this.a=null,r.label=2;case 2:return[2]}}))}))}}},En.prototype.style={".compass":"        position: absolute;        right:  10px;        bottom: 96px;        text-align: center;        font-family: sans-serif;        color: white;        height: 28px;        background-color: #0f1621;        user-select: none;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;        overflow: hidden;",".compass .needle":"        padding: 4px 0px;        line-height: 10px;",".compass:hover":"        background-color: #383c45;        cursor: pointer;"},En.prototype.templ='<div class="compass">        <div class="needle">&#9650;<br>&#9661;</div>    </div>';var zn=function(t){function e(e,i,n,r){var o=t.call(this,e,i,n)||this;o.ams=250;var a=o;return r&&r.zoomAnimationMs&&(a.ams=r.zoomAnimationMs),o}return d(e,t),e.prototype.enable=function(){t.prototype.enable.call(this);var e=this.querySelector(".info"),i=this.map;e.innerText=i.getZoomlevel(),i.addEventListener("mapviewchangeend",this._zll=function(t){e.innerText=Math.round(10*i.getZoomlevel())/10})},e.prototype.disable=function(){t.prototype.disable.call(this),this.map.removeEventListener("mapviewchangeend",this._zll)},e}(Mn);zn.prototype.listeners={".zoomBtn":{click:function(t){var e=0^t.srcElement.getAttribute("dir");this.map.setZoomlevel(this.map.getZoomlevel()+e,this.ams)}}},zn.prototype.style={".zoomctrl":"        position: absolute;        right:  10px;        bottom: 20px;        text-align: center;        font-family: sans-serif;        color: white;        user-select: none;",".zoomctrl div":"        background-color: #0f1621;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;",".zoomctrl .zoomBtn":"        height: 28px;        font-size: 32px;        /* border: 1px solid white; */        line-height: 22px;        font-weight: 200;",".zoomctrl .zoomBtn:hover":"        background-color: #383c45;        cursor: pointer;"},zn.prototype.templ='<div class="zoomctrl">         <div class="zoomBtn" dir="1">+</div>         <div class="info">L</div>        <div class="zoomBtn" dir="-1">-</div>     </div>';var Cn=function(t){function e(e,i,n){return t.call(this,e,i,n)||this}return d(e,t),e.prototype.add=function(t){!function(t,e,i,n){var r=document.createElement(t);e&&(r.className=e),i&&(r.innerText=i),n&&n.appendChild(r)}("div",this.prefixClass(".src").substr(1)," "+t.label,this.html)},e.prototype.setData=function(t){if(this.data=t,this.html){this.html.innerText="";for(var e=0,i=t;e<i.length;e++){var n=i[e];this.add(n)}}},e}(Mn);Cn.prototype.style={".copyright-popup":"        user-select: none;        background-color: rgba(0,0,0,0.1);        position: absolute;        bottom: 15px;        padding: 2px;        right: 120px;        z-index: 1;        width:  auto;        color: #fff;        font-family: arial;        font-size: 11px;        opacity: 0.8;        height: auto;",".src":"        opacity: 0.8;        margin: 4px;    "},Cn.prototype.templ='<div class="copyright-popup"></div>';var In=t.document,Pn=function(t,e){var i,n,r,o=t.scopes,a=o.length;if(!a)return!0;for(;i=o[--a];){var s=i.layer.getProvider(e),l=s&&s.level||e;if(n=i.minLevel||-1/0,r=i.maxLevel||1/0,l>=n&&l<=r)return!0}return!1},kn=function(t,e){t.style.display=e?"inline":"none"},Dn={defaultOwner:"XYZ",termsAndConditions:{label:"Terms and Conditions",url:!1}},Rn=function(t){function e(e,i,n){var a=t.call(this,e,r.extend(!0,r.clone(Dn),i),n)||this;a.sources=new o,a.sLen=0,a.srcWidth=0;var s=a,l=s.opt,h=l.termsAndConditions,u=l.defaultOwner;return s.$src=s.querySelector(".sources"),s.$cDefault=s.querySelector(".cDefault"),s.$btn=s.querySelector(".btn"),a.details=new Cn(e,{visible:!1},n),a.setDefaultOwner(u),a.setTermsAndConditions(h),a}return d(e,t),e.prototype.setTermsAndConditions=function(t){var e=t.url,i=t.label,n=this.querySelector(".terms");e?(n.lastChild.href=e,i&&(n.lastChild.innerText=i)):kn(n,!1)},e.prototype.setDefaultOwner=function(t){"string"==typeof t&&this.setOwnerLabel(this.$cDefault,t)},e.prototype.enable=function(){var e=this;t.prototype.enable.call(this),e.map.addObserver("zoomlevel",e.onZoomChange=function(t,i,n){Math.abs((0^i)-(0^n))&&(e.sources.forEach((function(t){kn(t.el,Pn(t,i))})),e.showDetails(!1),e.handleOverflow())}),e.map.addEventListener("addLayer removeLayer",e.onLayerChange=function(t){var i=t.detail.layer;i.getCopyright((function(n){e.active&&("addLayer"==t.type?n.forEach((function(t){return e.addSource(t,i)})):n.forEach((function(t){return e.removeSource(t,i)})))}))}),e.map.addEventListener("resize",e.onResize=function(){return e.handleOverflow()})},e.prototype.disable=function(){var e=this;t.prototype.disable.call(this),e.map.removeObserver("zoomlevel",e.onZoomChange),e.map.removeEventListener("addLayer removeLayer",e.onLayerChange),e.map.removeEventListener("resize",e.onResize)},e.prototype.calcWidth=function(){var t=0^this.map.getZoomlevel(),e=this.sources,i=0;return e.forEach((function(e){i+=Pn(e,t)&&e.width})),i},e.prototype.handleOverflow=function(){var t=this,e=t.$btn,i=t.map.getWidth(),n=t.calcWidth(),r=i-132^0;t.$src.style.width=(r<n?r-10:n)+"px",n>Math.min(r,384)?kn(e,!0):(kn(e,!1),t.showDetails(!1))},e.prototype.showDetails=function(t){var e=this.details,i=this.map.getZoomlevel();this.$btn.innerText=t?"-":"+",t?(e.show(),e.setData(this.sources.values().filter((function(t){return Pn(t,i)})))):e.hide()},e.prototype.setOwnerLabel=function(t,e){t.innerText=" "+e},e.prototype.addSource=function(t,e){var i,n=this,r=n.sources,o=t.label,a=t.scopes,s=0^n.map.getZoomlevel(),l=r.get(o);l?(i=l.el,l.cnt++):((i=In.createElement("span")).className=this.prefixClass(".source").substr(1),n.setOwnerLabel(i,o),n.$src.appendChild(i),l={label:o,scopes:[],el:i,cnt:1,width:i.getBoundingClientRect().width},r.set(o,l),n.sLen++,n.srcWidth+=l.width),null!=a&&a.forEach((function(t){return l.scopes.push({minLevel:t.minLevel,maxLevel:t.maxLevel,layer:e})})),kn(n.$cDefault,!1),kn(i,Pn(l,s)),n.handleOverflow()},e.prototype.removeSource=function(t,e){var i,n,r=this,o=t.label,a=r.sources.get(o);if(a){if(n=a.scopes,i=t.scopes)for(var s=0,l=void 0;s<i.length;s++){l=i[s];for(var h=0,u=void 0;s<n.length;h++)if((u=n[h]).layer==e&&u.minLevel==l.minLevel&&u.maxLevel==l.maxLevel){n.splice(h,1);break}}--a.cnt||(r.$src.removeChild(a.el),r.sources.delete(o),r.handleOverflow(),--r.sLen||kn(r.$cDefault,!0))}},e}(Mn);Rn.prototype.listeners={".btn":{click:function(t){var e="+"==this.$btn.innerText;this.showDetails(e)}}},Rn.prototype.style={".copyright *":"        color: #fff;        font-family: arial;        opacity: 0.8;        text-decoration: none;",".copyright":"        right: 0px;        bottom: 0px;        padding: 1px 4px;        margin: 0px;        background-color: rgba(0,0,0,.1);        position: absolute;        font-size: 11px;        line-height: 13px;        overflow: hidden;        white-space: nowrap;        user-select: none;",".sources":"        width:auto;        max-width: 384px;        float: left;        white-space: nowrap;        overflow: hidden;        text-overflow: ellipsis;        border-right: 2px;",".btn":"        display: none;        font-family: sans-serif;        font-weight: bold;        text-align: center;        height: 12px;        width: 12px;        float: left;        padding: 0px;        line-height: 9px;        margin: 1px 2px 0px;        background-color: inherit;        box-sizing: border-box;        border-radius: 3px;        border: 1px solid;",".terms, .cDefault, .source":"        white-space: nowrap;        padding-right: 4px;"},Rn.prototype.templ='<div class="copyright">        <span style="float: left; white-space: nowrap;">            <span class="sources"></span>            <span class="cDefault"></span>         </span>        <span class="tac" style="float: right; white-space: nowrap;">            <span class="btn">+</span>            <span class="terms" style="white-space: nowrap;">|            <a target="_blank" style="white-space: nowrap;" href="">Terms and Conditions</a></span>        </span>    </div>';var On=function(t){function e(e,i,n){var r=t.call(this,e,i,n)||this,o=i.url;return o&&r.setSrc(o),r}return d(e,t),e.prototype.setSrc=function(t){this.html.style.backgroundImage="url("+t+")"},e}(Mn);On.prototype.style={".logo":"        position: absolute;        bottom: 6px;        left: 6px;        z-index: 1;        margin:  0px;        background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjdweCIgaGVpZ2h0PSIzMnB4IiB2aWV3Qm94PSIwIDAgMjcgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUyLjYgKDY3NDkxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5Hcm91cCAzPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9Ikdyb3VwLTMiPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzA0QjZDOCIgcG9pbnRzPSItNy44NjQyMTYxOWUtMTQgOSAxMyAxNS45Njg4NjgxIDEzIDMyIDAgMjQuNDc4MDIyNiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzBBNTdENCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAuNTAwMDAwLCAyMC41MDAwMDApIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTIwLjUwMDAwMCwgLTIwLjUwMDAwMCkgIiBwb2ludHM9IjE0IDkgMjcgMTUuOTY4ODY4MSAyNyAzMiAxNCAyNC40NzgwMjI2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTIiIGZpbGw9IiMwQTk0REUiIHBvaW50cz0iMCA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMCAyNyA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMTUiPjwvcG9seWdvbj4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==);        background-repeat: no-repeat;        background-size: contain;        width:  32px;        height: 32px;        cursor: pointer;"},On.prototype.templ='<div class="logo"></div>';var Nn={Compass:En,ZoomControl:zn,Copyright:Rn,Logo:On},Un=function(){function t(t,e,i){var n=v({},e.UI||e.ui||{}),r=this.components={};for(var o in this.el=t,null!=n.HERE&&(n.Logo=n.HERE),Nn){var a=n[o];!1!==a&&("object"!=typeof a&&(a={}),null==a.visible&&(a.visible=!0),a.visible&&(r[o]=new Nn[o](t,a,i,e)))}}return t.initComponentOptions=function(){},t.prototype.get=function(t){return this.components[t]},t.prototype.destroy=function(){var t=this.components;for(var e in t)t[e].destroy(),delete t[e]},t}(),Fn=r.isFunction,Bn=function(){function t(t,e){void 0===e&&(e={});this.map=t,Fn(e.onStart)&&(this.onStart=e.onStart),Fn(e.onStop)&&(this.onStop=e.onStop)}return t.prototype.onStart=function(){},t.prototype.onStop=function(){},t.prototype.animate=function(t,e,i,n){return y(this,void 0,void 0,(function(){var r,o;return g(this,(function(a){switch(a.label){case 0:return o=(r=this).map,r.active?[3,2]:(r.active=!0,r.onStart(),[4,new an(o.getZoomlevel(),t,n,"easeOutCubic",(function(t){o.setZoomlevel(t,e,i)})).start()]);case 1:a.sent(),r.onStop(),r.active=!1,a.label=2;case 2:return[2]}}))}))},t}(),Wn=r.isFunction,Xn=function(){function t(t,e){e=e||{};var i=this;i.map=t,i.duration=e.duration||500,Wn(e.onStart)&&(i.onStart=e.onStart),Wn(e.onStop)&&(i.onStop=e.onStop),i.raf=function(){i._pan()&&(i.rafId=requestAnimationFrame(i.raf))}}return t.prototype._pan=function(){var t=this.deltaX,e=this.deltaY,i=this.duration,n=this.startTs,r=Math.min(Date.now()-n,i)/i,o=rn(r)*t,a=rn(r)*e;if(this.map.pan(o-this.lastDx||0,a-this.lastDy||0),o!=t||a!=e)return this.lastDx=o,this.lastDy=a,!0;this.onStop()},t.prototype.pan=function(t,e,i){this.startTs=t,this.deltaX=e,this.deltaY=i,this.onStart(),this.raf()},t.prototype.cancel=function(){var t=this.rafId;t&&(cancelAnimationFrame(t),this.rafId=null),this.onStop(),this.startTs=0,this.lastDx=0,this.lastDy=0},t.prototype.onStart=function(){},t.prototype.onStop=function(){},t}(),Gn={ui:{},behavior:{drag:!0,pitch:!1,rotate:!1},rotate:0,pitch:0,zoomlevel:18,center:{longitude:8.534,latitude:50.162},layers:null,maxLevel:20,minLevel:2,debug:!1,minPanMapThreshold:4,zoomAnimationMs:100,maxPitch:50},Zn=s,Hn="fixed",Yn="longitude",jn="latitude",qn=[];function Vn(t,e,i,n,r,o){for(var a,s,l,h=256*Math.pow(2,20),u=20;u>=0;--u)if(l=20-u,a=(Zn.lon2x(i,h)>>l)-(Zn.lon2x(t,h)>>l),s=(Zn.lat2y(e,h)>>l)-(Zn.lat2y(n,h)>>l),a<=r&&s<=o)return u;return 0}var Kn=function(){function t(t,e){this._s=1,this._rz=0,this._rx=0,this._cw=new u(0,0),this._c=new h(0,0),this._pc=new h(0,0),this._ox=0,this._oy=0,this._cfg=e=r.extend(!0,r.extend(!0,{},Gn),e||{});this._w=_(t,"width"),this._h=_(t,"height"),this._cx=this._w/2,this._cy=this._h/2;var i=e.zoomLevel||e.zoomlevel;e.maxLevel=Math.min(28,e.maxLevel),this._z=0^Math.min(20,i),this._wSize=256*Math.pow(2,this._z),this._l=new n(["center","rotation","zoomlevel","mapviewchangestart","mapviewchange","mapviewchangeend","resize","addLayer","removeLayer"]);var o=this._l,a=[],s=t;this._layers=a,this.id=1e6*Math.random()^0,(t=document.createElement("div")).className="_"+r.String.random(11),t.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)",t.style.position="relative",t.style.width=this._w+"px",t.style.height=this._h+"px",s.appendChild(t),this._el=t;var l="canvas"==e.renderer?Ji:Ei;"string"==typeof l.zoomBehavior&&(Hn=l.zoomBehavior);var f=new l(t,256,e.devicePixelRatio,e.renderOptions||{});this._mvcRecognizer=new Sn(this,(function(t,e,i){o.trigger(t,[new un(t,e)],i)}),f),this._display=f,this._search=new wn(this,f.dpr);var c=this._evDispatcher=new vn(t,this,a,e);o.add("mapviewchangestart",(function(t){return c.disable("pointerenter")})),o.add("mapviewchangeend",(function(t){return c.enable("pointerenter")})),o.add("mapviewchangeend",(function(t){return f.viewChangeDone()})),this.zoomAnimator=new Bn(this);var p=v(v({},e.behavior),e.behaviour);null==p.zoom&&(p.zoom=Hn);var d=this._b=new hn(t,this,new Xn(this),p,e);d.drag(!0),d.scroll(!0),this._vplock={pan:!1,minLevel:e.minLevel,maxLevel:e.maxLevel};var y=e.UI||e.ui||{};null==y.Compass&&(y.Compass=p.rotate||p.pitch),this.ui=new Un(t,e,this),this.setCenter(e.center),this.pitch(e.pitch),this.rotate(e.rotate),this.setZoomlevel(i),this._layerClearListener=this._layerClearListener.bind(this);for(var g=0,m=e.layers||[];g<m.length;g++){var x=m[g];this.addLayer(x)}qn.push(this),e.debug&&this.debug(e.debug)}return t.getInstances=function(){return qn.slice()},t.prototype._layerClearListener=function(t){this.refresh(t.detail.layer)},t.prototype.initViewPort=function(){var t=this._s,e=this._w/2,i=this._h/2,n=this._cw.x,r=this._cw.y,o=n-e/t,a=r-i/t;this._tlwx=o,this._tlwy=a,this._ox=n-e-o,this._oy=r-i-a;var s=this._wSize,h=Zn.x2lon(o,s),u=Zn.y2lat(a,s),f=n+e/t,c=r+i/t,p=Zn.x2lon(f,s),d=Zn.y2lat(c,s);return this._vp=new l(h,d,p,u),[n/s,r/s]},t.prototype.updateGrid=function(){var t=this._display,e=this._c,i=this._pc;this._mvcRecognizer.watch(!0),t.setTransform(this._s,this._rz,this._rx),t.updateGrid(this.initViewPort(),this._z,this._ox,this._oy),i[Yn]==e[Yn]&&i[jn]==e[jn]||(this._l.trigger("center",["center",e,i],!0),this._pc=e)},t.prototype._setCenter=function(t,e){var i=this._wSize;return 2!=arguments.length&&(t instanceof Array?(e=t[1],t=t[0]):(e=(t=t||this._c)[jn],t=t[Yn])),!isNaN(t)&&!isNaN(e)&&"number"==typeof t&&"number"==typeof e&&(t>180?t-=360:t<-180&&(t+=360),e<-85.05112878?e=-85.05112878:e>85.05112878&&(e=85.05112878),this._c=new h(t,e),this._cw=new u(Zn.lon2x(t,i),Zn.lat2y(e,i)),!0)},t.prototype.repaint=function(){this.updateGrid()},t.prototype.debug=function(t){this._display.showGrid(t),this.updateGrid()},t.prototype.pitch=function(t){if(void 0!==t){var e=this._cfg.maxPitch,i=Math.max(0,Math.min(e,Math.round(t%360*10)/10));this._rx=-i*Math.PI/180,this.updateGrid()}return 180*-this._rx/Math.PI},t.prototype.rotate=function(t){if(void 0!==t){var e=Math.round(10*t||0)*Math.PI/1800,i=this._rz;if(e!==i){var n=this._cx,r=this._cy,o=this._display.unproject(n,r),a=this._cw;a.x+=o[0]-n,a.y+=o[1]-r,this._rz=e,this.updateGrid(),this._l.trigger("rotation",["rotation",this._rz,i],!0)}}return this._rz/Math.PI*180},t.prototype.setBackgroundColor=function(t){this._display.setBGColor(t),this.refresh()},t.prototype.addEventListener=function(t,e){var i=this,n=this._l;t.split(" ").forEach((function(t){if(n.isDefined(t))return n.add(t,e);i._evDispatcher.addEventListener(t,e)}))},t.prototype.removeEventListener=function(t,e){var i=this,n=this._l;t.split(" ").forEach((function(t){if(n.isDefined(t))return n.remove(t,e);i._evDispatcher.removeEventListener(t,e)}))},t.prototype.getViewBounds=function(){var t=this._vp,e=t.minLon,i=t.maxLon,n=t.minLat,r=t.maxLat;return n<=-85.05112878&&(n=-90),r>=85.05112878&&(r=90),e<-180&&(e=-180),i>180&&(i=180),new l(e,n,i,r)},t.prototype.setViewBounds=function(t){var e,i,n,r,o=arguments;if("number"==typeof t?t=[o[0],o[1],o[2],o[3]]:"FeatureCollection"==t.type?t=t.features:"Feature"==t.type&&(t=[t]),Array.isArray(t)){if("object"==typeof t[0]){for(var a=[1/0,1/0,-1/0,-1/0],s=0,l=t;s<l.length;s++){var h=l[s];f.calcBBox(h,a)}t=a}e=t[0],i=t[1],n=t[2],r=t[3]}else{var u=t;e=u.minLon,i=u.minLat,n=u.maxLon,r=u.maxLat}this.setZoomlevel(Vn(e,i,n,r,this.getWidth(),this.getHeight())),this.setCenter(e+(n-e)/2,i+(r-i)/2)},t.prototype.getFeatureAt=function(t,e){(e=e||{}).topOnly=!0;var i=this.getFeaturesAt(t,e);if(i.length){var n=i[i.length-1];return n.feature=n.features[0],n}},t.prototype.getFeaturesAt=function(t,e){var i,n,r,o;if(e=e||{},null!=t.x&&null!=t.y){var a=t.x,s=t.y,l=0^e.width,h=e.height||l;i=a-l/2,n=a+l/2,r=s-h/2,o=s+h/2}else null!=t.minX&&null!=t.maxX&&(i=t.minX,r=t.minY,n=t.maxX,o=t.maxY);return null!=i&&this._search.search(i,r,n,o,e.layers,e.topOnly)},t.prototype.getBehavior=function(){var t={},e=this._b.getOptions();for(var i in e)t[i]=!!e[i];return t},t.prototype.setBehavior=function(t,e){var i=typeof t,n="object"==i?t:{},r=this._b.getOptions();"string"==i&&(n[t]=e);var o=n.zoom;null!=o&&(r.zoom="fixed"==o||"float"==o?o:!!o&&Hn);for(var a=0,s=["drag","pitch","rotate"];a<s.length;a++){var l=s[a],h=n[l];null!=h&&(r[l]=!!h)}},t.prototype.getZoomlevel=function(){return this._z+Math.log(this._s)/Math.LN2},t.prototype.setZoomlevel=function(t,e,i,n){var r=this._vplock,o=this._z,a=this._s;if(t=Math.round(1e3*t)/1e3,t=Math.max(Math.min(t,r.maxLevel),r.minLevel),2==arguments.length&&(n=e,e=void 0),null!=e&&null!=i||(e=this._cx,i=this._cy),o!=t||1!=a)if(n)this.zoomAnimator.animate(t,e,i,"number"==typeof n?n:250);else{var s=this.getZoomlevel(),l=this._display.unproject(e,i),h=0^Math.min(20,t),u=o-h,f=this._wSize,c=Math.pow(2,t-h);u&&(this._z=0^Math.min(20,t),this._wSize=256*Math.pow(2,this._z)),this._display.setTransform(c*Math.pow(.5,u),this._rz,this._rx);var p=this._display.unproject(e,i);this._setCenter(Zn.x2lon(this._cw.x+l[0]-p[0],f),Zn.y2lat(this._cw.y+l[1]-p[1],f)),this._s=c,this.updateGrid(),this._l.trigger("zoomlevel",["zoomlevel",this.getZoomlevel(),s],!0)}},t.prototype.setCenter=function(t,e){this._setCenter.apply(this,arguments)&&this.updateGrid()},t.prototype.getCenter=function(){return new h(this._c.longitude,this._c.latitude)},t.prototype.lockViewport=function(t){var e=this._vplock;if(t){var i=t.pan,n=t.minLevel,r=t.maxLevel;n=!1===n?this._cfg.minLevel:n,r=!1===r?this._cfg.maxLevel:r,null!=i&&(e.pan=i),"number"==typeof n&&(e.minLevel=n),"number"==typeof r&&(e.maxLevel=r)}return e},t.prototype.pan=function(t,e){if(0!=t||0!=e){var i=this._wSize,n=this._cx,r=this._cy,o=this._cw,a=this._display.unproject(n+t,r+e),s=o.x-a[0]+n,l=o.y-a[1]+r;this.setCenter(Zn.x2lon(s,i),Zn.y2lat(l,i))}},t.prototype.getLayers=function(t){var e=this._layers;return null!=t?e[t]:e.slice()},t.prototype.addLayer=function(t,e){var i=this._layers;-1==i.indexOf(t)&&(null==e&&(e=i.length),this._display.addLayer(t,t.getStyle(),e),t.addEventListener("clear",this._layerClearListener),this._l.trigger("addLayer",[new un("addLayer",{index:e,layer:t})]),i.splice(e,0,t),this.updateGrid())},t.prototype.removeLayer=function(t){var e=this._layers,i=e.indexOf(t);i>=0&&(this._display.removeLayer(t),t.removeEventListener("clear",this._layerClearListener),e.splice(i,1),this.updateGrid(),this._l.trigger("removeLayer",[new un("removeLayer",{index:i,layer:t})]))},t.prototype.refresh=function(t){t instanceof Array||(t=[t]);for(var e=0,i=t;e<i.length;e++){var n=i[e];n instanceof c&&this._display.clearLayer(n)}this.updateGrid()},t.prototype.pixelToGeo=function(t,e){var i=this._wSize;1==arguments.length&&(e=t.y,t=t.x);var n=this._ox,r=this._oy,o=this._display.unproject(t,e),a=this._tlwx,s=this._tlwy,l=o[0]+a+n,u=o[1]+s+r;return l%=i,(u%=i)<0&&(u+=i),new h(Zn.x2lon(l,i),Zn.y2lat(u,i))},t.prototype.geoToPixel=function(t,e){null==e&&(e=t.latitude,t=t.longitude),e<-85.05112878?e=-85.05112878:e>85.05112878&&(e=85.05112878);var i=this._wSize,n=this._tlwx,r=this._tlwy,o=Zn.lon2x(t,i)-n,a=Zn.lat2y(e,i)-r,s=this._display.project(o,a);return new u(s[0],s[1])},t.prototype.destroy=function(){var t=this,e=this._el;this.ui.destroy(),this._layers.forEach((function(e){return t.removeLayer(e)})),this._display.destroy(),e.parentNode.removeChild(e),this._mvcRecognizer.watch(!1),this._evDispatcher.destroy(),this._b.drag(!1),this._b.scroll(!1);var i=this;i.__proto__=null,Object.keys(i).forEach((function(t){return delete i[t]})),qn.splice(qn.indexOf(i),1)},t.prototype.resize=function(t,e){var i=this._el;null!=t&&null!=e||(t=_(i.parentNode,"width"),e=_(i.parentNode,"height"));var n=this._w,r=this._h;n===t&&r===e||(i.style.width=t+"px",i.style.height=e+"px",this._display.setSize(t,e),this._w=t,this._h=e,this._cx=t/2,this._cy=e/2,this.updateGrid(),this._l.trigger("resize",[new un("resize",{width:t,height:e})]))},t.prototype.getWidth=function(){return this._w},t.prototype.getHeight=function(){return this._h},t.prototype.addObserver=function(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.add(t,e)},t.prototype.removeObserver=function(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.remove(t,e)},t.prototype.getContainer=function(){return this._el.parentNode},t}();t.here.xyz.maps.Map=Kn;export default Kn;export{Kn as Map,un as MapEvent};
