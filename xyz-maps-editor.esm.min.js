/*
 * @here/xyz-maps-editor
 * (c) 2019-2021 HERE
 */
import{geotools as e,JSUtils as t,global as r,Listener as i,Map as n,Set as o}from"@here/xyz-maps-common";import{Feature as s,webMercator as a,LocalProvider as c,TileLayer as d,EditableFeatureProvider as l,GeoPoint as u,PixelPoint as p}from"@here/xyz-maps-core";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var h=function(e,t){return(h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}h(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var v=function(){return(v=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function g(e,t,r){e._e().listeners.trigger(t,e,r)}function A(e,t){var r=e.__;return r||(r=e.__={isEditable:!0}),t?r[t]:r}var y,m={private:A,_evl:{pointerdown:function(){var e=A(this);e.moved=!1,e.pdm=[0,0]},pointerup:function(e){var t=A(this),r=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?m._select(this):r&&m.markAsModified(this),g(this,e,r?"dragStop":"pointerup")},pointerenter:function(e){this._e().listeners.trigger(e,this)},pointerleave:function(e){this._e().listeners.trigger(e,this)}},deHighlight:function(e){var t=A(e);t.selector&&(e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=void 0,t.pressmove=void 0)},_editable:function(e,t){var r=A(e);return null!=t&&(r.isEditable=!!t),m.deHighlight(e),r.isEditable},_select:function(e){var t=e._e();if(t.objects.selection.select(e)){var r=A(e);r.pressmove=function(i,n,o,s,a){r.isEditable&&r.isSelected&&!t._config.editRestrictions(e,1)&&(t.map.pixelMove(e,n-r.pdm[0],o-r.pdm[1]),r.pdm[0]=n,r.pdm[1]=o,g(e,i,r.moved?"dragMove":"dragStart"),r.moved=!0)},r.selector||(r.selector=t.objects.overlay.addCircle(e.coord(),void 0,{type:"MARKER_SELECTOR"}))}},_setCoords:function(e,t){e._e().objects.history.origin(e);var r=A(e,"selector");r&&r._provider.setFeatureCoordinates(r,t),e._provider.setFeatureCoordinates(e,t.slice())},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),m.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(null==t||t)&&e._e().objects.history.saveChanges(),e}},_=Math,S=_.PI,k=_.pow,C=_.sqrt,x=function(e,t,r){var i,n,o=(t[1]-e[1])/(t[0]-e[0]),s=e[1]-o*e[0];return i=_.abs(r[1]-o*r[0]-s)/C(k(o,2)+1),(n=F(r,e))<i&&(i=n),(n=F(r,t)<i)&&(i=n),i},L=function(e,t,r,i,n){void 0===r&&(r=0),void 0===i&&(i=e.length),void 0===n&&(n=[]);var o=0,s=0;i--;for(var a=r+1;a<i;a++){var c=x(e[r],e[i],e[a]);c>o&&(s=a,o=c)}return o>t?(L(e,t,r,s,n),L(e,t,s,i+1,n)):(n.push(e[r]),i-r>0&&n.push(e[i])),n},b=function(e,t,r){var i=(function(e,t){var r=t[0]-e[0],i=t[1]-e[1];return r||i?(180+180*_.atan2(i,r)/S)%360:0}(e,t)-180)*S/180;return[e[0]+(r||0)*_.cos(i),e[1]+(r||0)*_.sin(i)]},E=function(e,t){for(var r=999999,i=!1,n=0;n<e.length-1;n++){var o=n+1,s=I(e[n],e[o],t);if(s){var a=F(s,t);a<r&&(r=a,i=n)}}return i},P=function(e,t,r,i,n){var o=(i[1]-r[1])*(t[0]-e[0])-(i[0]-r[0])*(t[1]-e[1]);if(0!=o){var s=((i[0]-r[0])*(e[1]-r[1])-(i[1]-r[1])*(e[0]-r[0]))/o,a=((t[0]-e[0])*(e[1]-r[1])-(t[1]-e[1])*(e[0]-r[0]))/o;if(0<=s&&s<=1&&0<=a&&a<=1)return!n||[e[0]+s*(t[0]-e[0]),e[1]+s*(t[1]-e[1])]}return!1},I=function(e,t,r){if(e[0]==t[0]){var i=[e[0],r[1]];return!!N(e,t,i)&&i}if(e[1]==t[1]){var n=[r[0],e[1]];return!!N(e,t,n)&&n}var o=(t[1]-e[1])/(t[0]-e[0]),s=e[1]-o*e[0],a=-1/o,c=(r[1]-a*r[0]-s)/(o-a),d=[c,o*c+s];return!!N(e,t,d)&&d},w=function(e,t,r){return[(t[0]-e[0])*r+e[0],(t[1]-e[1])*r+e[1]]},R=function(e,t,r){var i=e[0],n=e[1],o=t[0],s=t[1],a=r[0],c=r[1],d=a-o,l=c-s,u=((i-o)*d+(n-s)*l)/(d*d+l*l);return F([i,n],u<0?[o,s]:u>1?[a,c]:[o+u*d,s+u*l])},O=function(e,t){for(var r=1/0,i=t.length-1,n=0;n<i;n++){var o=R(e,t[n],t[n+1]);o<r&&(r=o)}return r},F=function(e,t){return C(k(e[0]-t[0],2)+k(e[1]-t[1],2))},N=function(e,t,r,i){i=i||1e-7;var n=r[0]-e[0],o=r[1]-e[1],s=t[0]-e[0],a=t[1]-e[1],c=(n*s+o*a)/(s*s+a*a);return(c=(s=n-(c=c<0?0:c>1?1:c)*s)*s+(a=o-c*a)*a)<i*i},D=function(e){for(var t=0,r=0;r<e.length-1;r++)t+=F(e[r],e[r+1]);return t},B=function(e,t){for(var r,i,n,o,s=0,a=0;a<e.length-1;a++)if(i=e[a],n=e[a+1],(s+=r=F(i,n))>=t)return o=(t-(s-r))/r,[(n[0]-i[0])*o+i[0],(n[1]-i[1])*o+i[1]];return n};function T(e,t,r){for(var i=0,n=r.length-1;i<n;i++)if(P(e,t,r[i],r[i+1]))return 1}function j(e,t){for(var r=0,i=e.length-1;r<i;r++)if(T(e[r],e[r+1],t))return 1}function M(e,t){for(var r=e[0],i=e[1],n=!1,o=0,s=t.length-1;o<t.length;s=o++){var a=t[o][0],c=t[o][1],d=t[s][0],l=t[s][1];c>i!=l>i&&r<(d-a)*(i-c)/(l-c)+a&&(n=!n)}return n}function G(e,t,r){for(var i=0^r,n=e.length;i<n;i++)for(var o=0;o<e[i].length;o++)if(!M(e[i][o],t))return 0;return 1}var H=function(e,t,r,i,n){void 0===i&&(i=0),void 0===n&&(n=0);var o=y.getCoords(e),s=o[n],a=s[i],c=a[r];if(!y.willSelfIntersect(a,t,r)){if(a[r]=t,r||(a[a.length-1]=t),!function(e,t,r){for(var i=0,n=t.length;i<n;i++)if(i!=r&&j(e,t[i]))return 1}(a,s,i)&&G(s,s[0],1)){var d=y.private(e,"shapePnts"),l=y.getConnectedAreas(e,c);if(e.behavior("snapCoordinates"))for(var u=0;u<l.length;u++){var p=l[u],h=p.coordinates,f=p.polyIndex,v=p.lineIndex,g=p.coordIndex,A=h[f],m=A[v];if(p.area.behavior("snapCoordinates")){if(m[g][0]=t[0],m[g][1]=t[1],g||(m[m.length-1]=t),!(!y.willSelfIntersect(m,t,g)&&G(A,A[0],1)))return!1}else h.splice(u,1)}for(var _=0,S=l;_<S.length;_++){var k=S[_],C=k.area,x=k.coordinates;y._setCoords(C,x,!1)}y._setCoords(e,o,!1);for(var L=0,b=d;L<b.length;L++){var E=b[L],P=E.geometry.coordinates;P[0]==c[0]&&P[1]==c[1]&&E.getProvider().setFeatureCoordinates(E,t.slice())}}return!0}},z=function(t){function r(r,i,n,o,s){var a=this;y=s;var c=r._e(),d={type:"Feature",geometry:{type:"Point",coordinates:[i,n]},properties:{type:"AREA_SHAPE",poly:o[0],index:o[1],hole:o[2],AREA:{style:c.getStyle(r)}}},l=a=t.call(this,d,c.objects.overlay.layer.getProvider())||this,u=c.objects.overlay;function p(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,c.setStyle(this)}function h(e,t){c.listeners.trigger(e,l,t)}var f=!1,v=0,g=0;return a.__={area:r,pointerdown:function(){f=!1,v=0,g=0},pressmove:function(e,t,i,n,o){f||(f=!0,y.hideShape(y.private(r,"midShapePnts"),u),h(e,"dragStart"));var s=l.getIndex(),a=l.properties.poly,d=l.properties.hole,p=c.map.translateGeo(this.geometry.coordinates,t-v,i-g);H(r,p,s,d,a)&&(v=t,g=i)},pointerup:function(t){if(f){if(r.behavior("snapCoordinates")){for(var i=c.cfg("autoConnectShapeDistance"),n=e.extendBBox(this.bbox,i),o=void 0,s=0,a=c.getLayer(r).search({rect:n});s<a.length;s++){var d=a[s];if("AREA"==d.class&&d!=r)for(var u=0,p=y.getCoords(d);u<p.length;u++)for(var v=0,g=p[u][0];v<g.length;v++){var A=g[v],m=e.distance(this.geometry.coordinates,A);m<i&&(o=A,i=m)}}if(o){var _=l.getIndex(),S=l.properties.poly,k=l.properties.hole;H(r,o.slice(),_,k,S)}}y.markAsModified(r)}y.addVShapes(r),h(t,f?"dragStop":void 0)},pointerenter:p,pointerleave:p},l}return f(r,t),r.prototype.getArea=function(){return this.__.area},r.prototype.remove=function(){return y.deleteShape(this.getArea(),this)},r.prototype.getIndex=function(){return this.properties.index},r.prototype.removeGeometry=function(){var e=this.getArea(),t=this.properties.poly,r=this.properties.hole,i=e.coord();i[t].splice(r,1),y._setCoords(e,i,!1),y.deHighlight(e),y._select(e),y.markAsModified(e)},r}(s);z.prototype.class="AREA_SHAPE";var K=function(e){function t(t,r,i,n,o){var s,a,c=t._e(),d=c.objects.overlay,l={type:"Feature",geometry:{type:"Point",coordinates:[r,i]},properties:{type:"AREA_VIRTUAL_SHAPE",poly:n[0],index:n[1],hole:n[2],AREA:{style:c.getStyle(t)}}},u=s=e.call(this,l,d.layer.getProvider())||this;function p(e){var t,r=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete r.hovered,t="default"):(r.hovered=!0,t="move"),document.body.style.cursor=t,c.setStyle(this)}return u.__={pointerdown:function(){a=!1},pressmove:function(e,r,i,n,s){var c=u.properties,d=c.index+1,l=c.poly,p=u.geometry.coordinates;if(!a){a=!0;for(var h=o.private(t,"midShapePnts"),f=0,v=void 0,g=void 0,A=void 0;f<h.length;f++)(g=(v=h[f]).geometry.coordinates)[0]==p[0]&&g[1]==p[1]&&(A=v.properties,o.addShp(t,p.slice(),A.poly,A.hole,A.index+1));a=o.getShp(t,l,c.hole,d)}a.__.pressmove.apply(a,arguments)},pointerup:function(e){if(a){var r=u.properties,i=r.poly,n=r.hole,s=r.index,c=o.getShp(t,i,n,s+1);c.__.pointerup.call(c,e)}},pointerenter:p,pointerleave:p},s}return f(t,e),t}(s);function V(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]}),t?r[t]:r}function U(e){var t=V(e),r=e._e().objects.overlay;q.hideShape(t.shapePnts,r),q.hideShape(t.midShapePnts,r)}function Y(e,t,r,i){for(var n=e._e().objects.overlay,o=0;o<r.length;o++)for(var s=r[o],a=0;a<s.length-1;a++){var c=i(s[a],s[a+1],a,o);n.addFeature(c),t.push(c)}}function Q(e){for(var t=V(e,"midShapePnts"),r=q.getCoords(e),i=function(i){Y(e,t,r[i],(function(t,r,n,o){return new K(e,(t[0]+r[0])/2,(t[1]+r[1])/2,[i,n,o],q)}))},n=0;n<r.length;n++)i(n)}function W(e){V(e,"isSelected")&&(U(e),function(e){for(var t=V(e,"shapePnts"),r=q.getCoords(e),i=function(i){Y(e,t,r[i],(function(t,r,n,o){return new z(e,t[0],t[1],[i,n,o],q)}))},n=0;n<r.length;n++)i(n)}(e),Q(e))}function J(e){var t=V(this);t.allowEdit&&!t.isSelected&&(this._e().listeners.trigger(e,this),this.editState("hovered","pointerenter"==e.type),this._e().setStyle(this))}function Z(e){var t=V(this);t.isSelected||this._e()._config.featureSelectionByDefault&&t.allowEdit&&q._select(this),this._e().listeners.trigger(e,this)}var X,q={private:V,_evl:{pointerenter:J,pointerleave:J,dbltap:Z,pointerup:Z},deHighlight:function(e){var t=V(e);t.isSelected&&(U(e),e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),t.isSelected=!1)},_editable:function(e,t){var r=V(e);t&&t!=r.allowEdit?document.body.style.cursor="pointer":t||t==r.allowEdit||(q.deHighlight(e),document.body.style.cursor="default"),r.allowEdit=t},_select:function(e){var t=V(e);t.isSelected||(e._e().objects.selection.select(e),e._e().dump(e,"info"),t.isSelected=!0,e.editState("selected",!0),e._e().setStyle(e),W(e))},_setCoords:function(e,t,r){"number"==typeof t[0][0][0]&&(t=[t]);for(var i=t.length;i--;)for(var n=t[i],o=n.length;o--;){var s=n[o];s[s.length-1]=s[0]}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),e._provider.setFeatureCoordinates(e,t),r&&W(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),q.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(t||void 0===t)&&e._e().objects.history.saveChanges(),e},deleteShape:function(e,t){var r=t.properties,i=q.getCoords(e),n=i[r.poly][r.hole];return!(n.length<=4)&&(n.splice(t.getIndex(),1),q._setCoords(e,i),q.deHighlight(e),q._select(e),q.markAsModified(e),!0)},getCoords:function(e){var t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:function(e){for(var t=0,r=0,i=void 0,n=e.length-1;r<n;r++)i=(r+1)%n,t+=e[r][0]*e[i][1],t-=e[i][0]*e[r][1];return t<0},getMaxSpace:function(e,t,r){var i=e._e(),n=t[0],o=t[1],s=1e5,a=[[n+s,o-s],[n-s,o+s],[n+s,o+s],[n-s,o-s]];s=1/0;for(var c=0,d=r.length-1;c<d;c++)for(var l=(c+1)%d,u=i.map.getPixelCoord(r[c]),p=i.map.getPixelCoord(r[l]),h=0;h<4;){var f=P(a[h++],a[h++],u,p,!0);if(f){var v=F(t,f);v<s&&(s=0^v)}}return s},getPoly:function(e,t){for(var r=q.getCoords(e),i=1/0,n=null,o=0,s=void 0;o<r.length;o++)(s=O(t,r[o][0]))<i&&(i=s,n=o);return n},addVShapes:Q,getShp:function(e,t,r,i){for(var n=V(e,"shapePnts"),o=0,s=void 0;o<n.length;o++)if((s=n[o].properties).poly==t&&s.index==i&&s.hole==r)return n[o]},addShp:function(e,t,r,i,n){for(var o=q.getCoords(e),s=o[r][i],a="number"==typeof n?n:E(s,t)+1,c=0;c<s.length;c++)if(s[c][0]==t[0]&&s[c][1]==t[1])return!1;return s.splice(a,0,t),q._setCoords(e,o),W(e),a},hideShape:function(e,t){e instanceof Array||(e=[e]);for(var r=0;r<e.length;r++)t.remove(e[r]);e.length=0},willSelfIntersect:function(e,t,r){for(var i=0==r?e.length-2:r-1,n=r+1,o=0,s=void 0,a=e.length-1;o<a;o++){if(s=o+1,n==a){if(o&&o<i&&P(t,e[n],e[o],e[o+1]))return!0}else if(o!=n&&r!=(s%=a)&&o!=r&&P(t,e[n],e[o],e[s]))return!0;if(o>r){if((s%=a)!=i&&o!=i&&P(e[i],t,e[o],e[s]))return!0}else if(s<i&&o!=r&&P(e[i],t,e[o],e[s]))return!0}return!1},validateGeometry:function(e){for(var t=1;t<e.length-1;t+=1)if(q.willSelfIntersect(e,e[t],t))return!1;return!0},getConnectedAreas:function(e,t){for(var r=[],i=e._e(),n=i.getLayer(e),o=function(e){return Math.round(1e9*e)},s=o(t[0]),a=o(t[1]),c=i.objects.getInBBox([t[0],t[1],t[0],t[1]],n),d=c.length;d--;)for(var l=c[d],u=q.getCoords(l),p=u.length;p--;)for(var h=u[p].length;h--;)for(var f=u[p][h],v=f.length-1;v--;)o(f[v][0])==s&&o(f[v][1])==a&&l!=e&&r.push({area:l,polyIndex:p,lineIndex:h,coordIndex:v,coordinates:u});return r}},$=function(e){function t(t,r,i,n){var o=this;X=n;var s=t._e().getStyle(t);return(o=e.call(this,{type:"Feature",properties:{index:i,LINE:{properties:t.prop(),style:s}},geometry:{type:"Point",coordinates:r}})||this)._l=t,o}return f(t,e),t.prototype.getLine=function(){return this._l},t.prototype.getLength=function(){return this._l.geometry.coordinates.length},t.prototype.getIndex=function(){return this.properties.index},t.prototype.remove=function(){X.removeCoord(this.getLine(),this.properties.index)},t.prototype.pointerdown=function(e){var t=this.properties,r=this.geometry.coordinates,i=e.detail.display;t.moved=!1;var n=i.geoToPixel.apply(i,r);t.x=n.x,t.y=n.y,X.removeShapes(this.getLine(),"vShps","LINE_VIRTUAL_SHAPE"==this.class&&this)},t.prototype.pressmove=function(e,t,r){var i=e.detail.display,n=this.properties,o=i.pixelToGeo(n.x+t,n.y+r),s=o.longitude,a=o.latitude,c=this.getLine(),d=c.coord();n.moved||(n.moved=!0,c._e().listeners.trigger(e,this,"dragStart")),this.getProvider().setFeatureCoordinates(this,[s,a]),d[n.index][0]=s,d[n.index][1]=a,X._setCoords(c,d)},t.prototype.pointerup=function(e){var t=this.getLine(),r=this.properties.moved;r&&X.markAsModified(t),X.displayShapes(t),t._e().listeners.trigger(e,this,r?"dragStop":void 0)},t}(s);$.prototype.class="LINE_SHAPE";var ee,te=function(e){function t(t,r,i,n){return ee=n,e.call(this,t,r,i,n)||this}return f(t,e),t.prototype.pointerdown=function(t){e.prototype.pointerdown.call(this,t)},t.prototype.pressmove=function(t,r,i){var n=this.properties,o=this.getLine();n.moved||(n.index++,ee.addCoord(o,this.geometry.coordinates.slice(),n.index,!0),ee.removeShapes(o,"vShps",this)),e.prototype.pressmove.call(this,t,r,i)},t.prototype.pointerup=function(t){this.getProvider().removeFeature(this),e.prototype.pointerup.call(this,t)},t}($);function re(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[]}),t?r[t]:r}te.prototype.class="LINE_VIRTUAL_SHAPE";var ie=function(e,t,r){void 0===r&&(r=!1),t&&e.editState(t,r),e._e().setStyle(e,void 0)};function ne(e){re(this,"isEditable")&&this._e().listeners.trigger(e,this)}var oe,se,ae={private:re,_evl:{pointerenter:ne,pointerleave:ne,pointerup:function(e){var t=re(this);t.isEditable&&(!t.isSelected&&this._e()._config.featureSelectionByDefault&&ae._select(this),this._e().listeners.trigger(e,this))}},addCoord:function(e,t,r,i){var n=e.coord();if(null==r){if(!1===(r=E(n,t)))return!1;r++}return n.splice(r,0,t),ae._setCoords(e,n),i||ae.displayShapes(e),r},removeCoord:function(e,t){var r,i=e.coord(),n=i.length;return n>2&&t>=0&&t<n&&(r=i.splice(t,1),ae._setCoords(e,i),ae.displayShapes(e)),r},createShapes:function(e,t,r,i){var n=re(e,r),o=t.length;n.length&&ae.removeShapes(e,r);for(var s=0;s<o;s++)n[s]=new i(e,[t[s][0],t[s][1]],s,ae),e._e().objects.overlay.addFeature(n[s])},createVShapes:function(e){for(var t=e.geometry.coordinates,r=[],i=1;i<t.length;i++)r.push(w(t[i-1],t[i],.5));ae.createShapes(e,r,"vShps",te)},displayShapes:function(e){if(re(e,"isSelected")){var t=e.geometry.coordinates;ae.createShapes(e,t,"shps",$),ae.createVShapes(e)}},removeShapes:function(e,t,r){var i=re(e,t);i.forEach((function(t){t!=r&&e._e().objects.overlay.remove(t)})),i.length=0},deHighlight:function(e){re(e,"isSelected")&&(ie(e,"selected",!1),ae.removeShapes(e,"shps"),ae.removeShapes(e,"vShps"))},_editable:function(e,t){var r=re(e);return null!=t&&(r.isEditable=!!t),ae.deHighlight(e),r.isEditable},_select:function(e){e._e().objects.selection.select(e)&&(ie(e,"selected",!0),ae.displayShapes(e))},_setCoords:function(e,t){e._e().objects.history.origin(e),e.getProvider().setFeatureCoordinates(e,t)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),ae.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),(null==t||t)&&e._e().objects.history.saveChanges(),e}},ce=function(e,t){this.offset=e,this.distance=t},de=function(e,t){for(var r=0,i=0,n=0;n<t.length-1;n++){var o=t[n],s=t[n+1];0!=N(t[n],t[n+1],e)&&(i=r+F(o,e)),r+=F(o,s)}return i/r},le=function(e,t){for(var r=0,i={lenPntToLine:1/0,lenTotal:0,shp:0},n=0;n<e.length-1;n++){var o=e[n],s=e[n+1],a=I(e[n],e[n+1],t);if(0!=a){var c=F(a,t);c<i.lenPntToLine&&(i.shp=n,i.lenPntToLine=c,i.lenTotal=r+F(o,a))}r+=F(o,s)}var d=0,l={shp:-1,distancePoi:1/0,length:-1};for(n=0;n<e.length;n++){var u=F(e[n],t);n>0&&(d+=F(e[n],e[n-1])),u<l.distancePoi&&(l.shp=n,l.distancePoi=u,l.length=d)}return i.lenPntToLine<l.distancePoi?new ce(i.lenTotal/r,i.lenPntToLine):new ce(l.length/r,l.distancePoi)},ue=function(e,t,r,i){e.target=r||"display",e._e().listeners.trigger(t,e,i)};function pe(e,t){var r=null,i=e.getLink();if(i){var n=i.coord(),o=E(n,e.coord());if(!1!==o)var s=n[o],a=n[o+1];void 0!==s&&void 0!==a&&(r=function(e,t,r){if(t[0]==r[0]&&t[1]==r[1])return!1;var i=e[0]-t[0],n=e[1]-t[1],o=r[0]-t[0];return i*(r[1]-t[1])-n*o>0?"L":"R"}(t.coord(),s,a))}return r}function he(e,t,r){var i=this;oe=r;var n,o,s,a,c=this,d=e._e();function l(){this.prevDMove=null,n.moved=!1}function u(t,r,i,o,a){var l=this.prevDMove||[0,0],u=r-l[0],p=i-l[1];if(s&&!d._config.editRestrictions(e,1)){var f=d.map.getEventsMapXY(t),v=d.map.getGeoCoord(f[0]+u,f[1]+p);v.pop();var g=d.objects.getNearestLine(v,[s]),A=-1!=[0,e.geometry.coordinates.length-1].indexOf(g.shpIndex);if(n.moved||(n.moved=!0,ue(e,t,"routing","dragStart")),A||c.setRoutingPoint(s,g.point),g.distance>1||A){var y=d.objects.getNearestLine(v,s.getProvider(),{ignore:[s],maxDistance:10});if(y&&(y.distance<g.distance||A))return oe.defaults(s),c.setRoutingPoint(y.line,y.point),void oe.displayAsSelected(y.line,e.id,!0)}A||h()}l[0]=r,l[1]=i,this.prevDMove=l}function p(r){n.moved&&(t.setRoutingData(e),h(pe(c,e)),t.markAsModified(e)),ue(e,r,"routing",n.moved?"dragStop":void 0)}function h(e){if(s){var t=s.coord(),r=D(t),i=0^le(t,a).offset,o=B(t,r*i),l=B(t,r*i+(i<1?1:-1));o[0]==l[0]&&l[1]==o[1]||n&&(c.updateStreetLine(),d.objects.overlay.setFeatureCoordinates(n,a.slice()))}}c.getLink=function(){return s},c.coord=function(){return a},c.show=function(){if(s&&!n){var t=e.class,r=d.display.getLayers().indexOf(d.getLayer(i.getLink()));r=-1==r?void 0:r+1,o=d.objects.overlay.addPath([e.coord().slice(),a.slice()],void 0,{type:t+"_LINE",zLayer:r}),(n=d.objects.overlay.addPoint(a.slice(),{type:t+"_ROUTING_POINT",zLayer:r})).pointerdown=l,n.pressmove=u,n.pointerup=p}return s&&(h(pe(c,e)),oe.displayAsSelected(s,e.id)),s},c.hide=function(){n&&(n.pointerdown=n.pressmove=n.pointerup=void 0,d.objects.overlay.remove(n),d.objects.overlay.remove(o),n=o=null)},c.updateRoutingPoint=function(){var r,i,n=t.getRoutingData(e),o=n.link,c=t.getRoutingProvider(e),l=n.position;if(s=a=null,o&&c&&(s=c.search(o)),s){if(l){i=s.coord();for(var u=0;u<i.length-1;u++)if(N(i[u],i[u+1],l,1e-6))return a=l,s;r=l}else r=e.coord();var p=d.objects.getNearestLine(r,[s]);p&&(s=p.line,a=p.point)}return s},c.searchLink=function(){var r=t.getRoutingProvider(e);return r&&d.objects.getNearestLine(e.coord(),r,{maxDistance:d._config.maxRoutingPointDistance})},c.setRoutingPoint=function(e,t){if(a=s=null,e)s=e,a=t;else{var r=c.searchLink();r&&(s=r.line,a=r.point)}return s},c.clearRoutingPoint=function(){s=a=null,c.hide()},c.updateStreetLine=function(){if(o){var r=e.coord(),i=t.private(e);if(i.isSelected){var n=(d.getStyle(i.selector)[0]||[])[1]||{};r=d.map.getGeoCoord(b(d.map.getPixelCoord(r),d.map.getPixelCoord(a),n.radius||n.width/2))}d.objects.overlay.setFeatureCoordinates(o,[a].concat([r]))}}}var fe=function(e,t){var r=e.__;return r||(r=e.__={isEditable:!0,allowEdit:!0,isHovered:!1,cLink:null,moved:!1,prevDMove:null}),t?r[t]:r};var ve=function(e){return Math.round(1e5*e)/1e5},ge=function(e){return"PLACE"==e.class},Ae=function(e){var t=fe(e);return null==t._rp&&(t._rp=new he(e,ke,se)),t._rp};function ye(e,t){var r=!ge(e),i=ke.getRoutingData(e).link,n=fe(e);n.isHovered=t;var o=i||r;if(i||r){var s=Ae(e);(s.updateRoutingPoint()||s.setRoutingPoint())&&(n.cLink=s.show(),o&&ke.setRoutingData(e))}t&&ue(e,t)}function me(e,t){var r=fe(e,"cLink");fe(e).isHovered=!t,r&&se.defaults(r,e.id)&&se.private(r,"isSelected")&&se.displayAsSelected(r),t&&ue(e,t),Ae(e).hide()}function _e(e){var t=fe(this),r="pointerenter"==e.type;t.allowEdit&&(this.editState("hovered",r),t.isSelected||(r?ye(this,e):me(this,e)))}function Se(e,t,r,i,n){var o=fe(this),s=this._e();if(o.isSelected&&!s._config.editRestrictions(this,1)){o.moved||(o.moved=!0,null!=ke.getRoutingData(this).link&&ke.connect(this,null),ue(this,e,"display","dragStart"));var a=o.prevDMove||[0,0],c=t-a[0],d=r-a[1];s.map.pixelMove(this,c,d),a[0]=t,a[1]=r,o.prevDMove=a,Ae(this).updateStreetLine()}}var ke={private:fe,setLinkTools:function(e){se=e},_evl:{pointerenter:_e,pointerleave:_e,dbltap:function(e){ue(this,e)},pointerup:function(e){var t=fe(this),r=t.moved,i=this._e();t.allowEdit&&(t.isSelected||(i.dump(this),i._config.featureSelectionByDefault&&ke._select(this)),r&&(Ae(this).show(),ke.markAsModified(this)),ue(this,e,"display",r?"dragStop":void 0),t.moved=!1,t.prevDMove=null)},pointerdown:function(){var e=fe(this);e.allowEdit&&e.isSelected&&(e.moved=!1,e.prevDMove=null)}},deHighlight:function(e){var t=fe(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(me(e),t.pressmove=null,t.isSelected=!1,e.editState("selected",!1),t.cLink&&se.defaults(t.cLink,e.id)),e},_editable:function(e,t){var r=fe(e);t!=r.allowEdit&&(t||(ke.deHighlight(e),r.isHovered&&(r.isHovered.type="mouseout",me(e,r.isHovered))),r.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(e.editState("selected",!0),fe(e).pressmove=Se,ke.highlight(e),ye(e))},_setCoords:m._setCoords,markAsRemoved:m.markAsRemoved,markAsModified:m.markAsModified,_props:function(e,r){var i=arguments.length,n=e.getProvider().getFeatureProperties(e);if(i>1){if(2==i&&"string"==typeof r)return n[r];if(3==i){var o=r;(r={})[o]=arguments[2]}e._e().objects.history.origin(e),t.extend(n,r)}return n},highlight:function(e){var t=fe(e);t.selector||(t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,void 0,{type:e.class+"_SELECTOR"}))},getRoutingProvider:function(e){var t=e._e(),r=e.getProvider().readRoutingProvider(e,t.layers.map((function(e){return e.getProvider()})));return t.getProviderById(r)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){var t=Ae(e),r=t.getLink(),i=t.coord(),n=fe(e);n.cLink=r;var o=i?[ve(i[0]),ve(i[1]),0|i[2]]:[],s=ke.getRoutingData(e),a=s.position||[],c=r?r.id:null;s.link==c&&o[0]==ve(a[0])&&o[1]==ve(a[1])||(e._e().objects.history.ignore((function(){n.writeProp=!0,e.getProvider().writeRoutingPoint(e,r,i?o:i),delete n.writeProp})),ke._setCoords(e,e.geometry.coordinates))},connect:function(e,t,r){var i=fe(e);if(!i.writeProp){var n=Ae(e),o=n.getLink(),s=(ke.getRoutingData(e).position||[]).slice();o&&se.defaults(o),t?i.cLink=n.setRoutingPoint(t,r):(i.cLink=n.updateRoutingPoint())||!1===t||(i.cLink=n.setRoutingPoint()),(ge(e)||i.cLink)&&ke.setRoutingData(e),i.isSelected&&(i.cLink?ye(e):me(e));var a=ke.getRoutingData(e).position||[];o==i.cLink&&s[0]==a[0]&&s[1]==a[1]||ke.markAsModified(e,!1)}},disconnect:function(e){var t=fe(e);t.writeProp||(me(e),Ae(e).clearRoutingPoint(),t.cLink=null,ge(e)||Ae(e).setRoutingPoint(),ke.setRoutingData(e),ke.markAsModified(e,!1))},getRoutingPosition:function(e){var t=Ae(e),r=t.coord();return r||(t.updateRoutingPoint(),r=t.coord()),r&&[r[0],r[1],r[2]||0]||void 0}};function Ce(e,t,r){this.isPntInFence=function(){return!0},this.isHidden=function(){return!0},this.remove=function(){}}var xe,Le,be=function(e){return e.__||(e.__={})};function Ee(e,t){be(this).line._e().listeners.trigger(e,this,t)}function Pe(){var e=(r=be(this)).line,t=e._e();r._cls=r.cLinks.map((function(e){return e.link})),r.drg=!1;var r,i=this.geometry.coordinates,n=t.display.geoToPixel.apply(t.display,i);(r=be(this)).x=n.x,r.y=n.y,t.dump(this),xe.removeShapePnts(e,!0),t.listeners.trigger("_clearOverlay"),xe.hideDirection(e),Le=new Ce(t,i[0],i[1])}function Ie(e,t,r){var i=be(this),n=i.line,o=n._e(),s=o._config,a=o.map.getGeoCoord(i.x+t,i.y+r);if(!s.editRestrictions(n,1))if(Le.isPntInFence(a)){if(!Le.isHidden()&&Le.hide(),s.autoSnapShape)for(var c=2*(21-o.display.getZoomlevel()),d=n.getProvider().search({point:a,radius:c}),l=d.length,u=void 0;u=d[--l];)if(u.id!=n.id&&-1==i._cls.indexOf(u)){var p=o.map.calcCrossingAt(u.geometry.coordinates,a,s.minShapeDistance,void 0,c);if(p&&null!=p.index){a=p;break}}xe.moveShapeAtIndexTo(n,i.index,a[0],a[1]),i.drg||(i.drg=!0,Ee.call(this,e,"dragStart"))}else Le.isHidden()&&Le.show()}function we(e){var t,r,i=be(this),n=i.index,o=i.drg,s=!1,a=i.line,c=!1,d=!1,l=i.cLinks;i._cls=null,o&&("boolean"==typeof(r=xe.fixGeo(a,n))?c=!r:(c=r>=0,(d=n!=r)&&(n=r))),xe.showDirection(a),Le.isHidden()&&!c&&o&&(t=function(e,t){var r,i,n=e.coord()[t],o=e.getConnectedLinks(t),s=e._e();return o.push(e),null!=(r=s.objects.getNearestLine(n,e.getProvider(),{maxDistance:s._config.autoConnectShapeDistance,ignore:o.map((function(e){return e.id}))}))&&((i=r.point)[2]=e.getZLevels(t)||0,null===xe.connectShpToLink(e,t,r=r.line,i)&&(r=null)),r}(a,n)),t||(o&&((!1===r?l:a.getConnectedLinks(n,!0)).forEach((function(e){var t=xe.fixGeo(e.link,e.index);d="number"==typeof t||!t||d,xe.markAsModified(e.link,!1,!1)})),s=!0),xe.createAddShapePnts(a)),Le&&Le.remove(),i.drg=!1,(d||o)&&xe.refreshGeometry(a),a._e().listeners.trigger(e,a.editState("removed")?this:xe.private(a,"shps")[n],o?"dragStop":void 0),s&&xe.markAsModified(a,!0,!1)}function Re(){var e=be(this);document.body.style.cursor="default",e.cLinks.forEach((function(e){xe.defaults(e.link)})),delete this.properties["@ns:com:here:editor"].hovered,e.line._e().setStyle(this)}function Oe(){var e=be(this),t=e.line._e();document.body.style.cursor="move",e.cLinks.forEach((function(e){for(var r=t.getStyle(e.link),i=0;i<r.length;i++)r[i].opacity=.5;t.setStyle(e.link,r)})),this.properties["@ns:com:here:editor"].hovered=!0,t.setStyle(this)}var Fe=function(r){function i(e,i,n,o){var s;xe=o;var a=e._e(),c=e.getConnectedLinks(n,!0),d=0==n||n==e.geometry.coordinates.length-1,l={type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{isNode:d,isConnected:!!c.length,"@ns:com:here:editor":{},NAVLINK:{properties:t.extend(!0,{},e.properties),style:a.getStyle(e)},parent:e}};s=r.call(this,l,a.objects.overlay.layer.getProvider())||this;var u=be(s);return u.index=n,u.line=e,u.drg=!1,u.cLinks=c,u.dblclick=Ee,u.pressmove=Ie,u.pointerdown=Pe,u.pointerup=we,a._config.editRestrictions(e,1)||(u.pointerenter=Oe,u.pointerleave=Re),s}return f(i,r),i.prototype.getLink=function(){return this.properties.parent},i.prototype.isNode=function(){return this.properties.isNode},i.prototype.isOverlapping=function(){return xe.checkOverlapping(this.properties.parent,this.getIndex())},i.prototype.getIndex=function(){return be(this).index},i.prototype.editTurnRestrictions=function(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]},i.prototype.getConnectedLinks=function(){return this.getLink().getConnectedLinks(this.getIndex())},i.prototype.remove=function(){var e=this.getLink();e._e()._config.editRestrictions(e||this,2)||xe.deleteShape(e,this)},i.prototype.disconnect=function(){var t=be(this),r=t.line._e();if(this.isNode()&&t.cLinks.length){var i=t.line,n=t.index,o=i.coord(),s=o[n],a=o[n+(n?-1:1)],c=90-e.calcBearing(s,a),d=r.map.movePoint(s,r._config.disconnectShapeDistance,c);r.hooks.trigger("Navlink.disconnect",{link:i,index:n},i.getProvider()),o[n][0]=d[0],o[n][1]=d[1],xe._setCoords(i,o),xe.fixGeo(i),xe.refreshGeometry(i),xe.markAsModified(i)}},i.prototype.splitLink=function(){var e,t=this.getLink(),r=t._e();return this.isNode()||(e=r.objects.splitLinkAt({link:t,index:this.getIndex()})).length&&r.objects.history.saveChanges(),e},i}(s);Fe.prototype.class="NAVLINK_SHAPE";var Ne=function(e){function r(r,i,n,o){var s,a,c=r._e(),d=c.display;var l=s=e.call(this,{type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:t.extend(!0,{},r.properties),style:c.getStyle(r)},parent:r}},c.objects.overlay.layer.getProvider())||this;return l.pointerdown=function(){var e=l.properties.parent;l.moved=!1,o.hideDirection(e);var t=d.geoToPixel.apply(d,this.geometry.coordinates);a=new Ce(c,l.x=t.x,l.y=t.y)},l.pressmove=function(e,t,r,i,s){var d=l.properties.parent,u=c.map.getGeoCoord(l.x+t,l.y+r);if(a.isPntInFence(u)){a.isHidden()||a.hide();var p=o.private(d,"shps");if(!l.moved){o.addShp(d,u,n,!1,!0),o.removeShapePnts(d,!0,l.id),l.pointerenter=l.pointerleave=void 0,l.moved=!0;var h=p[n];h.x=l.x,h.y=l.y,h.__.pointerdown.call(h)}var f=p[n];f.__.pressmove.apply(f,arguments)}else a.isHidden()&&a.show()},l.pointerup=function(e){var t=l.properties.parent,r=o.private(t);if(l.moved){var i=r.shps[n];i.__.pointerup.call(i,e),this.getProvider().removeFeature(this)}else r.isSelected&&o.showDirection(t)},c._config.editRestrictions(r,1)||(l.pointerenter=l.pointerleave=function(e){var t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",this.properties["@ns:com:here:editor"].hovered=t,c.setStyle(this)}),s}return f(r,e),r}(s),De=function(){},Be=function(e,t){var r=e.__;return r||(r=e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null}),t?r[t]:r};function Te(e,r){var i=arguments.length,n=e.getProvider().getFeatureProperties(e);if(i>1){if(2==i&&"string"==typeof r)return n[r];if(3==i){var o=r;(r={})[o]=arguments[2]}e._e().objects.history.origin(e),t.extend(n,r)}return n}function je(e){var t=e.type;Be(this,"allowEdit")&&this._e()._config.featureSelectionByDefault&&("dbltap"==t||"pointerup"==t)&&Ye._select(this),this._e().listeners.trigger(e,this)}function Me(e,t){if(t)for(var r in t)e.editState(r,t[r]);e._e().setStyle(e,void 0)}function Ge(t){var r=Be(t);return Ye.getConnectedObjects(t,e.mergeBBoxes(r.prevBBox=r.prevBBox||t.bbox.slice(),t.bbox))}function He(e,t){Be(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function ze(e,t){if(e._e().objects.overlay.remove(t),t.class){for(var r in t)"id"!=r&&"type"!=r&&"class"!=r&&"properties"!=r&&"geometry"!=r&&(t[r]=void 0);t.isDeleted=!0}}function Ke(e,t){var r=e.__.ol;e.properties.isOverlapping=t,r!=(e.__.ol=t)&&e.getLink()._e().setStyle(e,void 0)}function Ve(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function Ue(e){var t=Be(this);t.allowEdit&&(document.body.style.cursor="default",je.call(this,e),t.isSelected||function(e){for(var t=Ye.getConnectedObjects(e),r=0;r<t.length;r++)if(ke.private(t[r],"isSelected"))return!0}(this)||Me(this,{hovered:!1}),t.isHovered=null)}var Ye={private:Be,_evl:{pointerenter:function(e){var t=Be(this);t.allowEdit&&(document.body.style.cursor="Pointer",t.isHovered=e,je.call(this,e),Me(this,{hovered:!0}))},pointerleave:Ue,dbltap:je,pointerup:je},deHighlight:function(e){return Be(e,"isSelected")&&(Me(e,{selected:!1,hovered:!1}),Ye.removeShapePnts(e),Ye.hideDirection(e)),e},_editable:function(e,t){var r=Be(e);if(t!=r.allowEdit){if(!t){var i=r.isHovered;i&&(i.type="mouseout",Ue.call(i.target,i)),Ye.deHighlight(e)}r.allowEdit=t}},_select:function(e){Be(e,"isSelected")||(e._e().objects.selection.select(e),e._e().dump(e,"info"),Ye.refreshGeometry(e))},_setCoords:function(e,t){for(var r=t.length;r--;)t[r][2]=t[r][2]||0;Ge(e),He(e,t),Ye.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),Ye.hideDirection(e),Ge(e).forEach((function(e){ke.disconnect(e)})),Ye._editable(e,!1);var t=e.coord(),r=t[0],i=t[t.length-1];r[0]==i[0]&&r[1]==i[1]&&(t[0][0]+=1e-5,t[0][1]+=1e-5,He(e,t))},markAsModified:function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=!0);var i=e.editState("modified"),n=Be(e);if(e.editState("modified",Date.now()),n.isGeoMod){var o=e.coord();Ge(e).forEach((function(t){var r=B(o,D(o)*le(o,ke.getRoutingPosition(t)).offset);ke.connect(t,e,r)})),n.isGeoMod=!1}return i||(Me(e),!n.isSelected&&r&&Ye.defaults(e)),t&&e._e().objects.history.saveChanges(),e},_props:Te,getConnectedObjects:function(t,r){var i=t._e();return i.objects.getInBBox(e.extendBBox(r||t.bbox,i._config.maxRoutingPointDistance)).filter((function(e){var r=e.class;if("PLACE"==r||"ADDRESS"==r)return e.getLink()==t}))},refreshGeometry:function(e){Ye.removeShapePnts(e),Be(e,"isSelected")&&(Ye.displayAsSelected(e),Ye.showDirection(e),Ye.createShapes(e),Ye.createAddShapePnts(e))},checkOverlapping:function(e,t){var r=e.coord(),i=null==t,n=i?1:t,o=i?r.length-1:n+1,s=[];o==r.length&&o--;for(var a,c=e._e().objects.getInBBox(e.bbox,e.getProvider()),d=c.length;d--;)if((a=c[d]).id!=e.id&&"NAVLINK"==a.class)for(var l=n;l<o;l++)for(var u=0,p=a.coord();u<p.length;u++)if(r[l][0]==p[u][0]&&r[l][1]==p[u][1]){s.push(l);break}return i?s:!!s.pop()},createLinkShape:function(e,t,r){return e._e().objects.overlay.addFeature(new Fe(e,t,r,Ye))},createShapes:function(e){var t=Be(e,"shps"),r=e.geometry.coordinates,i=r.length;if(!e.editState("removed")){var n=Ye.checkOverlapping(e);if(t.length)t.forEach((function(t,r){t.__.cLinks=e.getConnectedLinks(r,!0)}));else for(var o=0;o<i;o++){var s=Ye.createLinkShape(e,[r[o][0],r[o][1]],o);Ke(s,n.indexOf(o)>=0),t[o]=s}}},createAddShapePnts:function(e){var t=Be(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,1))for(var r=e.geometry.coordinates,i=1,n=void 0,o=void 0;i<r.length;i++)n=r[i-1],o=r[i],t.push(e._e().objects.overlay.addFeature(new Ne(e,w(n,o,.5),i,Ye)))},removeShapePnts:function(e,t,r){function i(t){for(var i=0;i<t.length;i++)t[i].id!=r&&ze(e,t[i]);t.length=0}var n=Be(e),o=n.vShps;return t||i(n.shps),(o.length||t)&&i(o),e},moveShapeAtIndexTo:function(e,t,r,i,n){var o=e.coord(),s=Be(e,"shps");o[t][0]=r,o[t][1]=i,Ge(e),He(e,o),Ye.hideDirection(e);var a=s[t];return!n&&a&&(e._e().objects.overlay.setFeatureCoordinates(a,[r,i]),a.__.cLinks.forEach((function(t){var n=t.link;!e._e()._config.editRestrictions(n,1)&&Ye.moveShapeAtIndexTo(n,t.index,r,i)})),Ke(a,Ye.checkOverlapping(e,t))),o},deleteShape:function(e,t,r){var i="number"==typeof t?t:t.getIndex(),n=e.coord();if(n.length>2){n.splice(i,1);var o=Be(e),s=o.shps;s.length&&(ze(e,s[i]),s.splice(i,1),s.forEach((function(e){e.__.index-=Number(e.getIndex()>=i)}))),Ge(e),He(e,n);var a=e.getZLevels();a.splice(i,1),e._e().objects.history.ignore((function(){e.getProvider().writeZLevels(e,a)})),r||Ye.markAsModified(e),o.isSelected&&Ye.refreshGeometry(e)}},showDirection:function(t){if(!t.editState("removed")){var r=(""+t.getProvider().readDirection(t)).toUpperCase(),i=void 0,n=void 0,o=void 0,s=void 0,a=void 0;if(Ye.hideDirection(t),"START_TO_END"==r?s=90:"END_TO_START"==r&&(s=-90),null!=s){var c=Be(t).arrows=[];i=t.geometry.coordinates;for(var d=0;d<i.length-1;d++)n=i[d],o=i[d+1],a=e.calcBearing(n,o)-s,c.push(t._e().objects.overlay.addPoint(w(n,o,.5),{type:"NAVLINK_DIRECTION",bearing:a}))}}return t},displayAsSelected:function(e,t,r){var i=Be(e);i.isSelected||(i._cPnt=t),Me(e,{selected:!0})},addShp:function(e,t,r,i,n,o){var s=e.coord(),a=e._e(),c=a.map.calcCrossingAt(s,t,a._config.minShapeDistance,o);if(r="number"==typeof r?r:c.index,!c.existingShape||n){var d=e.getZLevels();c.existingShape&&(r=E(s,t)+1),a.map.clipGeoCoord(t),s.splice(r,0,t),function(e,t){for(var r=Te(e,"bn")||[],i=0;i<r.length;i++)r[i]+=r[i]>=t}(e,r),Ge(e),He(e,s),d.splice(r,0,t[2]||0),a.objects.history.ignore((function(){e.getProvider().writeZLevels(e,d)}));var l=Be(e,"shps");l.length&&(l.splice(r,0,Ye.createLinkShape(e,t,r)),l.forEach((function(e){e.__.index+=Number(e.getIndex()>r)})),l.forEach((function(t){Ke(t,Ye.checkOverlapping(e,t.getIndex()))}))),Ye.refreshGeometry(e)}else i||(r=!1);return r},defaults:function(e,t){var r=Be(e);return(!t||t==r._cPnt)&&(r._cPnt=null,Me(e,{selected:!1,hovered:!1}),e)},hideDirection:function(e){var t=Be(e,"arrows");if(t){for(var r=0;r<t.length;r++)e._e().objects.overlay.remove(t[r]);t.length=0}return e},fixGeo:function(e,t,r,i){return We(e,t,r,i)},connectShpToLink:function(e,t,r,i,n,o){var s,a=new De,c=e._e().objects;if(r.id!=e.id){var d=function(e,t,r,i,n,o){var s=e._e(),a=e.coord(),c=e.getConnectedLinks(t,!0),d=n[0],l=n[1],u=s._config.minShapeDistance,p=s.map.calcCrossingAt(r.coord(),n,u,i),h=s.map.clipGeoCoord(p.point),f=null,v=p.existingShape;v&&function(e,t){(Te(e,"bn")||[]).indexOf(t==e.geometry.coordinates.length-1?"N":t)}(r,p.index);a[t][0]=d,a[t][1]=l,Ye._setCoords(e,a),null!==p.index&&(f=s.objects.splitLinkAt(v?{link:r,index:p.index,avoidSnapping:!0}:{link:r,point:h,preferSegment:i,avoidSnapping:!0}),Qe(e,t,h[0],h[1]),c.forEach((function(e){var t=e.link;Qe(t,e.index,h[0],h[1]),We(t,e.index,!0),Ye.markAsModified(t,!1,!1),Ye.defaults(t)})));return f}(e,t,r,n,i);if(null===d)return null;t>0&&t<e.geometry.coordinates.length-1&&(Be(e,"isSelected")&&Ve(e._e()),Ye.deHighlight(e),s=c.splitLinkAt({link:e,index:t}));var l=e.geometry.coordinates;2==l.length&&l[0][0]==l[1][0]&&l[0][1]==l[1][1]&&c.remove(e),Ye.markAsModified(e),Be(e,"isSelected")&&Ye.refreshGeometry(e),d&&(a.targetSplittedInto=d),s&&(a.splittedInto=s)}return a},isIntersection:function(e,t,r){var i=Math.pow(10,e._config.intersectionScale),n=function(e){return Math.round(e*i)};return n(t[0])==n(r[0])&&n(t[1])==n(r[1])}},Qe=Ye.moveShapeAtIndexTo;function We(e,t,r,i){var n=e._e(),o=n.objects,s=!0===r,a=t||0,c=e.getZLevels(),d=c.length,l=void 0===t?d:a+1,u=!0,p=n._config.minShapeDistance||2;function h(a){if(i==a)return!0;function d(e){return 0==e||e==g-1}function l(t){var r=e.getConnectedLinks(t,!0);return r.forEach((function(e){var t=e.link;Ye.markAsModified(t,!1),Qe(t,e.index,h[0],h[1],!0)})),r}for(var u,h,f=e.coord(),v=Be(e),g=f.length,A=!1,y=!1,m=function(i){if(a!=i&&function(e,t,r,i,o){return void 0===o&&(o=1),Number(r)==Number(i)&&n.map.distance(e,t)<=o}(f[i],f[a],c[i],c[a],p)){if(u=Math.abs(a-i)-1,d(i)&&d(a)?1==u?A=a:y=i:d(a)?u<=1?A=a:y=i:d(i)?(1==u&&a>i&&(A=i),0==u?A=a:u>0?y=a:A=i):0==u?A=a:y=i,!1!==y){var m,_,S=void 0;if(h=f[y],2==g){var k=l(t);Qe(e,a==y?i:a,h[0],h[1]),Ve(e._e()),o.remove(Ye.deHighlight(e)),k.forEach((function(e){s||We(e.link,e.index,!0)}))}else l(a),Qe(e,a,h[0],h[1]),(_=o.splitLinkAt({link:e,index:y===g-1||0===y?~~(g/2):y})).forEach((function(t,i){We(t,void 0,r.concat(e,_[Number(0==i)]))})),!(S=_[Number(a>=y)]).editState("removed")&&Math.abs(a-y)>=2&&(S.coord().forEach((function(e,t){e[0]==h[0]&&e[1]==h[1]&&(m=t)})),m&&o.splitLinkAt({link:S,index:m}));return{value:!1}}if(!1!==A){var C=f[i][0],x=f[i][1],L=!1;e.getConnectedLinks(A,!0).forEach((function(e){var t,i=e.link;Ye.markAsModified(i,!1),Ye.moveShapeAtIndexTo(i,e.index,C,x,!0),t=i,L=!(s||-1!=r.indexOf(t))})),Qe(e,a==i?i:a,C,x,!0),Ye.deleteShape(e,A,!0),d(A)&&(!d(a)&&a-1>0&&Qe(e,a-1,C,x,!0),v.isSelected&&Ye.refreshGeometry(e),L&&f.length>2&&o.splitLinkAt({link:e,index:i-Number(0===A)}));var b=a-i,E=void 0;return b>0?E=a-1-u:b<0&&(E=a+u),{value:E}}}},_=0;_<g;_++){var S=m(_);if("object"==typeof S)return S.value}return!0}if(!e.editState("removed")&&a<d)for(r=s||!r?[]:r;a<l&&!0===(u=h(a));a++);return u}var Je={};Je.MARKER=m,Je.AREA=q,Je.LINE=ae;var Ze=Je.NAVLINK=Ye;function Xe(e){return Je[e.class]}function qe(e){return function(t){var r=t.class,i=Je[r][e];if(i)return i.apply(i,arguments)}}(Je.PLACE=Je.ADDRESS=ke).setLinkTools(Ze);var $e={getTool:function(e,t){var r=Xe(e);return r&&t?r[t]:r},private:qe("private"),getEventListener:function(e,t){var r=Xe(e);return r?r._evl[t]||r.private(e,t):e.__&&e.__[t]||e[t]}};for(var et in Je)for(var tt in Je[et])$e[tt]||($e[tt]=qe(tt));var rt=function(){},it=rt.prototype;it.created=!1,it.modified=!1,it.removed=!1,it.split=!1,it.selected=!1,it.hovered=!1;var nt=function(e){return 3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]]},ot=function(e){function r(t,r){var i=e.call(this,t,r)||this;return i.properties=i.properties||{},i.properties["@ns:com:here:editor"]=new rt,i}return f(r,e),r.prototype.toString=function(){return this.class+" ðŸŒŽ "+this.id},r.prototype.getProvider=function(){return this._provider},r.prototype._e=function(){return this._provider._e},r.prototype.editState=function(e,t){var r=arguments.length,i=this,n=i.properties["@ns:com:here:editor"];if(!r)return n;if(2==r){if(this._esu)return;t?n[e]=t:delete n[e],"hovered"!=e&&"selected"!=e&&i._e().objects.history.ignore((function(){i._esu=!0,i.getProvider().writeEditState(i,e),i._esu=void 0}))}return n[e]},r.prototype.style=function(e){var t=this;if("string"==typeof e||0==arguments.length)return this._e().getStyle(t,void 0);this._e().setStyle(t,e,!0)},r.prototype.prop=function(e,r){var i=this,n=!1,o=arguments.length,s=i.getProvider().getFeatureProperties(i);if(!o||1==o&&"string"==typeof e)return"object"==typeof(e=e?s[e]:s)?t.extend(!0,new e.constructor,e):e;if(2==o){var a={};a[e]=arguments[1],e=a}for(var c in e){var d=e[c],l="object"==typeof d,u=s[c];(l&&JSON.stringify(d)!=JSON.stringify(u)||!l&&u!==d)&&(n||(this._e().objects.history.origin(i),n=!0),s[c]=d)}n&&(this._e().setStyle(i),$e.markAsModified(i))},r.prototype.getCoordinates=function(){return this.coord()},r.prototype.coord=function(e){var t,r=this.geometry.type;if(e instanceof Array)$e.deHighlight(this),$e._setCoords(this,e),$e.markAsModified(this);else if(e=this.getProvider().decCoord(this),"Point"==r)t=nt(e);else{t=[];for(var i=e.length,n=0;n<i;n++)t[n]=nt(e[n])}return t},r.prototype.editable=function(e){return $e._editable(this,e),this.unselect(),this},r.prototype.select=function(){$e._select(this)},r.prototype.unselect=function(){$e.private(this,"isSelected")&&this._e().objects.selection.clearSelected()},r.prototype.transform=function(){this._e().transformer.show(this)},r.prototype.remove=function(){this._e().objects.remove(this,{save:!0})},r}(s);ot.prototype.id=null;var st=function(e,t,r,i,n,o,s){this.type=e,this.timeStamp=Date.now(),this.mapX=t,this.mapY=r,this.nativeEvent=i,this.button=n,this.target=o,this.detail=s},at=st.prototype;at.nativeEvent=null,at.detail=null,at.target=null,at.mapX=null,at.mapY=null,at.type=null,at.button=null,at.timeStamp=null,at.toString=function(){return"EditorEvent "+this.type};var ct=function(e){function r(r,i,n,o,s){var a=e.call(this,{type:"Feature",geometry:{type:"Point",coordinates:o},properties:{"@ns:com:here:editor":{},index:n,isMoved:!1}},r.overlay.getProvider())||this,c=r.getFeature().geojson,d=a,l=s.toUpperCase();return d.properties[l]={properties:t.extend(!0,{},c.properties),style:i.getStyle(c)},d._b=r,d.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=i.display.geoToPixel.apply(i.display,this.geometry.coordinates)},pressmove:function(e,t,n,o,s){var a=this.properties.p,c=i.map.getGeoCoord(a.x+t,a.y+n);r.getFeature().update(this.properties.index,c),this._provider.setFeatureCoordinates(this,c.slice()),this.isMoved=!0},pointerup:function(e){this.properties.isMoved||i.listeners.trigger(e,this)}},a.class=l+"_SHAPE",a}return f(r,e),r.prototype.remove=function(){this.__=null,this._b.removeShape(this.properties.index)},r.prototype.getLength=function(){return this._b.getLength()},r.prototype.getIndex=function(){return this.properties.index},r}(s),dt=function(){function e(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),r.length>1&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.createGeo=function(e){if(e.length>1)return e.slice()},e.prototype.isValid=function(e){return!!e||this.path.length>1},e}(),lt=function(){function e(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}return e.prototype.update=function(e,t){var r=this.path;if(t&&(r[e]=t),r.length>2){var i=this.createGeo(r);i&&this.overlay.setFeatureCoordinates(this.geojson,i)}},e.prototype.createGeo=function(e){if(e.length>2)return[[e.concat([e[0]])]]},e.prototype.removeAt=function(e){this.path.splice(e,1)},e.prototype.isValid=function(e){return e?(e.push(e[0].slice()),e.length<4||q.validateGeometry(e)):this.path.length>2},e}(),ut=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],pt=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function ht(e,r){var i=t.clone(e||ut);return i.forEach((function(e){return e.zIndex=(0^e.zIndex)+r})),i}var ft=function(){function e(e,t,r){this.shapes=[],this.originLink=null,this.originPos=null;this.overlay=e,this.iEdit=t,this.display=r,this.onBoardUp=this.onBoardUp.bind(this),this.updateCursor=this.updateCursor.bind(this)}return e.prototype.onBoardUp=function(){this.mousedown=!1},e.prototype.updateCursor=function(e){var t=this,r=t.iEdit,i=t.feature,n=t.shapes,o=t.display,s=t.cursor,a=t.mousedown,c=t.overlay;if(a){var d=r.map.getEventsMapXY(e),l=s.properties.prevPos;o.lockViewport().pan||o.pan(d[0]-l[0],d[1]-l[1],0,0),l[0]=d[0],l[1]=d[1]}else{var u=r.map.getGeoCoord(r.map.getEventsMapXY(e)),p=n.map((function(e){return e.geometry.coordinates}));p.push(u);var h=i.isValid(p);if(h!=!this.inValid){var f=this.style.feature;h?(f=this.inValid,this.inValid=!1):(this.inValid=f,f=[v(v({},f[0]),{fill:"rgba(0,0,0,0)"})]),r.setStyle(i.geojson,f)}i.update(n.length,u),c.setFeatureCoordinates(s,u)}},e.prototype.init=function(){var e=this,t=e.iEdit,i=e.display,n=e.overlay,o=e.updateCursor,s=i.getViewBounds(),a=[s.minLon,s.maxLat];this.feature=new this.FeatureClass(n,a);var c=n.addCircle(a,ht(ut,1));c.pointerdown=function(r){var i=c.properties;i.prevPos=t.map.getEventsMapXY(r),e.mousedown=!0,i.panned=!1},c.pressmove=function(e){o(e),c.properties.panned=!0},c.pointerup=function(r){c.properties.panned||e.addShape(t.map.getGeoCoord(r.mapX,r.mapY),void 0,r),e.onBoardUp()},this.cursor=c,this.inValid=!1,r.addEventListener("mousemove",this.updateCursor),r.addEventListener("mouseup",this.onBoardUp)},e.prototype.addShape=function(e,t,r){var i,n=this.iEdit,o=this.settings,s=this.shapes,a=this.feature;if(t){if(this.originLink=t,i=t.geometry.coordinates,"number"==typeof e)e=i[e].slice(0);else{var c=n.map.calcCrossingAt(i,e,n._config.minShapeDistance);!c.existingShape||0!=c.index&&c.index!=i.length-1||(this.originLink=null),e=c.point}this.originPos=e}var d=this.overlay.addFeature(new ct(this,n,s.length,e,o.mode),ht(this.style.shape,9));return a.update(s.length,e),s.push(d),o.onShapeAdd&&o.onShapeAdd(new st("onShapeAdd",e[0],e[1],r,r&&r.button,d,{index:d.properties.index})),d},e.prototype.setGeom=function(e,t){var r=this.settings;if(e==this.feature.type){this.hide(),this.show(r);var i="LineString"==e?t:t[0][0].slice(0,-1),n=r.onShapeAdd;r.onShapeAdd=null;for(var o=0,s=i;o<s.length;o++){var a=s[o];this.addShape(a)}r.onShapeAdd=n}},e.prototype.removeShape=function(e){var t=this,r=t.shapes,i=t.iEdit,n=t.overlay,o=t.feature,s=t.settings;null==e&&(e=r.length-1);var a=r[e],c=i.map.getGeoCoord(a.geometry.coordinates);n.remove(a),r.splice(e,1),o.removeAt(e);for(var d=e;d<r.length;d++)r[d].properties.index--;o.update(),s.onShapeRemove&&s.onShapeRemove(new st("onShapeRemove",c[0],c[1],void 0,void 0,void 0,{index:e}))},e.prototype.getFeature=function(){return this.feature},e.prototype.getLength=function(){return this.shapes.length},e.prototype.setAttributes=function(e){var r=this,i=r.feature,n=r.iEdit,o=r.cursor,s=r.settings,a=r.shapes;if(e){t.extend(i.properties,e);var c=function(e,r){var i,n,o,s,a=e.mode;if(e.styleGroup)i=e.styleGroup;else if("Navlink"!=a&&"Area"!=a||(r.editState=function(){return{}},r.class=a),i=e.layer.getStyleGroup(r),"Area"!=a)return(s=t.clone(ut))[0].fill=i[0].stroke,(o=t.clone(pt))[0].stroke=(i[1]||i[0]).stroke,{feature:o,shape:s};var c=function(e){return-1!=["Circle","Image","Rect","Text"].indexOf(e.type)};if(o=i.filter((function(e){return!c(e)})),s=i.filter(c),o.length||(o=e.layer.getStyleGroup(r)),!e.styleGroup||!s.length){s=t.clone(ut);var d=o[0];n=d.stroke;var l=void 0;"Area"==a?(l=d.fill,n&&(s[0].stroke=n)):l=n,l&&(s[0].fill=l)}return{feature:o,shape:s}}(s,i.geojson);this.style=c,i.geojson.class=void 0,n.setStyle(i.geojson,c.feature),a.concat(o).forEach((function(e){n.setStyle(e,ht(c.shape,n.getStyle(e)[0].zIndex))}))}},e.prototype.createGeom=function(){var e=this.feature,t=this.shapes,r=this.settings,i=t.map((function(e){return e.geometry.coordinates}));"Area"!=r.mode&&(i=L(i,r.generalization||1e-5));var n=e.createGeo(i);if(n)return{type:e.type,coordinates:n}},e.prototype.create=function(e){var t=this,r=t.iEdit,i=t.FeatureClass,n=t.shapes,o=t.feature,s=t.originLink,a=t.originPos,c=t.settings;if(this.setAttributes(e),i==dt){var d=n[0].geometry.coordinates;s&&a[0]==d[0]&&a[1]==d[1]&&r.objects.splitLinkAt({link:r.objects.get(s),point:d})}var l=n.map((function(e){return e.geometry.coordinates}));if(o.isValid(l)){var u=this.createGeom(),p=void 0;return u&&(p=r.objects.create({feature:{type:"Feature",geometry:u,properties:o.properties},provider:c.layer.getProvider()}),r.objects.history.saveChanges(),this.hide()),p}throw new Error("Invalid Geometry")},e.prototype.isActive=function(){return this.active},e.prototype.show=function(e){if(!this.active){var t=this.overlay.layer,r=this.iEdit,i=this.display;r.objects.listenDisplay(!1),i.removeLayer(t),i.addLayer(t),r.objects.listenDisplay(!0),this.settings=e,"Area"==e.mode?this.FeatureClass=lt:this.FeatureClass=dt,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes)}},e.prototype.hide=function(){var e=this.display,t=this.overlay,i=this.shapes,n=this.feature;if(this.active){this.active=!1;var o=t.layer;e.removeLayer(o),e.addLayer(o),t.remove(n.geojson),this.feature=null,i.forEach((function(e){return t.remove(e)})),i.length=0,t.remove(this.cursor),this.cursor=null,r.removeEventListener("mousemove",this.updateCursor),r.removeEventListener("mouseup",this.onBoardUp)}},e}(),vt=r.here.xyz.maps.editor,gt=function(){function e(e){this._e=e,this._b=new ft(e.objects.overlay,e,e.display),this._a=!1}return e.prototype.addShape=function(e,t){if(this._a)return this._b.addShape(this._e.map.getGeoCoord(e),t)},e.prototype.removeShape=function(e){this._a&&this._b.removeShape(e)},e.prototype.getLength=function(){return this._b.getLength()},e.prototype.cancel=function(){this._b.hide(),this._a=!1},e.prototype.setProperties=function(e){this._a&&this._b.setAttributes(e)},e.prototype.setAttributes=function(e){return this.setProperties(e)},e.prototype.create=function(e){if(this._a){var t=this._b.create(e);return t&&(this._a=!1),t}},e.prototype.start=function(e){var t=(e=e||{}).connectTo,r=e.mode||"Navlink";return r="string"!=typeof r?r===vt.features.Area?"Area":"Navlink":r.charAt(0).toUpperCase()+r.slice(1).toLowerCase(),e.mode=r,e.attributes=e.properties||e.attributes||{},this._a||(e.layer=e.layer||this._e.getLayerForClass(r.toUpperCase()),("Area"!=r||e.layer)&&(this._e.listeners.trigger("_clearOverlay"),this._b.show(e),this._a=this._b.isActive(),e.position&&this.addShape(e.position,t))),this._a},e.prototype.isActive=function(){return this._a},e.prototype.getGeometry=function(){return this._b.createGeom()},e.prototype.setGeometry=function(e){this._b.setGeom(e.type,e.coordinates)},e}();function At(e,t){var r,i=e.coord().map((function(e){var t=a.geoToPixel(e[0],e[1],1);return[t.x,t.y]}));if("number"==typeof t)r=t;else{var n=a.geoToPixel(t.longitude,t.latitude,1);r=le(i,[n.x,n.y]).offset}var o=B(i,D(i)*r),s=a.pixelToGeo(o[0],o[1],1);return{coordinate:[s.longitude,s.latitude],offset:r}}var yt=function(e){function r(r,i,n,o,s,a,c,d,l){for(var u=this,p=0,h=s=t.clone(s);p<h.length;p++){var f=h[p];f._offsetX=f.offsetX||0,f._offsetY=f.offsetY||0}var v=At(i,o).coordinate;return(u=e.call(this,{type:"Feature",properties:{relPos:o,side:n.toUpperCase(),dragged:!1,style:s},geometry:{type:"Point",coordinates:v}})||this).isLocked=a,u.ml=i,u.dragStart=c,u.dragMove=d,u.dragEnd=l,r.addFeature(u,u.properties.style),u.updatePosition(v),u}return f(r,e),r.prototype.updatePosition=function(e){var t=this.properties.style,r=this.ml.coord(),i=E(r,e),n=this.properties.side,o=r[i],s=r[i+1],a=s[0]-o[0],c=s[1]-o[1],d=180*-Math.atan2(c,a)/Math.PI,l=Math.sqrt(a*a+c*c),u=c,p=a;l&&(u/=l,p/=l);for(var h=0,f=t;h<f.length;h++){var v=f[h];if(v.rotation=d,"B"!=n){var g=v._offsetX,A=v._offsetY;A+=v.lineOffset,v.offsetX=u*A+p*g,v.offsetY=p*A+-u*g}}return e.slice()},r.prototype.pressmove=function(e){if(!this.isLocked()){var t=e.detail.display,r=At(this.ml,t.pixelToGeo(e.mapX,e.mapY));this.properties.relPos=r.offset;var i=this.updatePosition(r.coordinate);this.getProvider().setFeatureCoordinates(this,i),this.dragMove(e),this.properties.dragged=!0}},r.prototype.pointerdown=function(e){this.dragStart(e),this.properties.dragged=!1},r.prototype.pointerup=function(e){this.properties.dragged&&this.dragEnd(e)},r.prototype.remove=function(){this.getProvider().removeFeature(this)},r.prototype.getRelPos=function(){return this.properties.relPos},r.prototype.getRelPosOfSubLink=function(e){var t=this.geometry.coordinates,r=e.link._e(),i=r.map.getPixelCoord(t),n=E(this.ml.coord().map((function(e){return r.map.getPixelCoord(e)})),i);if(n>=e.from&&n<e.to){var o=e.link.coord().map((function(e){return r.map.getPixelCoord(e)})),s=de(i,e.reversed?o.reverse():o);return s>.995?1:Math.round(1e6*s)/1e6}return n<e.from?0:1},r}(s),mt={L:"#ff4040",R:"#4cdd4c",B:"#35b2ee"},_t=function(){function e(e,t,r){var i=this;this.options=v({dragStart:function(e,t){},dragMove:function(e,t){},dragStop:function(e,t){}},r);var n=r.id;null!=n&&(this.id=n);var o=JSON.parse(JSON.stringify(r.style||{}));this.ml=e;var s=r.side,a=o.opacity,c=o.fill,d=o.stroke;c&&!d&&(d=c,c=!1),c||(c=d,d="#fff"),c=c||mt[s];var l=r.lineStyle||function(e,t,r){return void 0===t&&(t=.75),[{zIndex:4,type:"Line",strokeWidth:9,opacity:t,stroke:e}]}(c,a);this.line=t.addPath(e.coord(),this.style=l);for(var u=0,p=0,h=l;p<h.length;p++){u=h[p].offset||u}for(var f=r.markerStyle||function(e,t,r,i){var n="R"==i?8:"L"==i?-8:0;return[{zIndex:110,type:"Rect",fill:t,width:2,height:20,alignment:"map",offsetY:n},{zIndex:111,type:"Circle",fill:e,radius:7,alignment:"map",stroke:t,strokeWidth:1,offsetY:2.5*n},{zIndex:110,type:"Circle",stroke:t,radius:5,alignment:"map"}]}(c,d,0,s),g=0,A=f;g<A.length;g++){var y=A[g];null==y.lineOffset&&(y.lineOffset=u)}this.markers=["from","to"].map((function(n){return new yt(t,e,s,r[n],f,(function(e){i.locked()}),(function(e){i.options.dragStart(e,i)}),(function(e){i.draw(),i.updateSegments(),i.options.dragMove(e,i)}),(function(e){i.options.dragStop(e,i)}))})),this.overlay=t,this.updateSegments()}return e.prototype.updateSegments=function(){this.segments=this.ml.getZoneSegments(this)},e.prototype.remove=function(){this.overlay.remove(this.line),this.markers[0].remove(),this.markers[1].remove()},e.prototype.locked=function(){return!!this.options.locked},e.prototype.draw=function(){var e=this.markers[0].getRelPos(),t=this.markers[1].getRelPos();if(e>t){var r=e;e=t,t=r}for(var i=0,n=this.style;i<n.length;i++){var o=n[i];o.from=e,o.to=t}this.overlay.layer.setStyleGroup(this.line,this.style)},e}();function St(e,t){return e.concat(t.slice(1))}function kt(e,t,r,i){return{zIndex:e,type:"Line",stroke:t,strokeWidth:r,strokeDasharray:i||"none",strokeLinejoin:"round",strokeLinecap:i?"butt":"round"}}var Ct=function(){return[kt(0,"white",23),kt(1,"grey",20),kt(2,"white",3,[5,4])]},xt=function(){function e(e,t,r){this.zones=[],this.links=[];var i,n=e.objects.overlay;if(this.iEdit=e,void 0===t)return null;i=this.completePath=t.coord();var o=this.style=r||Ct();this.overlay=n,this.feature=n.addPath(i,o),this.hide(),this.links.push({from:0,to:i.length-1,link:t,reversed:!1}),n.setFeatureCoordinates(this.feature,this.completePath)}return e.prototype.updateStyle=function(e){e=e||Ct(),this.style=e,this.overlay.layer.setStyleGroup(this.feature,e)},e.prototype.removeZones=function(){this.zones.forEach((function(e){e.remove()})),this.zones.length=0},e.prototype.coord=function(){return this.completePath.map((function(e){return e.slice()}))},e.prototype.hide=function(){this.overlay.remove(this.feature)},e.prototype.show=function(e){var t=this,r=this.overlay;this.removeZones(),r.addFeature(this.feature,this.style),e.forEach((function(e){if(-1!=["L","R","B"].indexOf(e.side)){var i=new _t(t,r,e);t.zones.push(i),i.draw()}}))},e.prototype.addLink=function(e){var t=this,r=e.coord(),i=this.links;function n(e,t){return e[0]===t[0]&&e[1]===t[1]}Ye.defaults(e);var o=function(n,o,a){if(a&&r.reverse(),0===n){for(var c=0;c<i.length;c++)i[c].from+=o,i[c].to+=o;t.completePath=St(r,s)}else t.completePath=St(s,r);i.unshift({from:n,to:o,link:e,reversed:!!a})},s=this.completePath;n(r[r.length-1],s[0])?o(0,r.length-1):n(r[0],s[0])?o(0,r.length-1,!0):n(r[0],s[s.length-1])?o(s.length-1,s.length+r.length-2):n(r[r.length-1],s[s.length-1])&&o(s.length-1,s.length+r.length-2,!0),this.overlay.setFeatureCoordinates(this.feature,this.completePath)},e.prototype.destroy=function(){this.hide(),this.removeZones()},e.prototype.getZones=function(){return this.zones},e.prototype.getZoneSegments=function(e){var t=e.markers[0],r=e.markers[1],i=[];function n(e){var t=e[0];e[0]=e[1],e[1]=t}return this.links.forEach((function(e){var o=[t.getRelPosOfSubLink(e),r.getRelPosOfSubLink(e)];o[0]>o[1]&&n(o),e.reversed&&(n(o),o[0]=1-o[0],o[1]=1-o[1]),o[0]!==o[1]&&i.push({navlink:e.link,from:o[0],to:o[1],reversed:e.reversed})})),i},e}(),Lt=function(){function e(e){this.multiLink=null,this.candidates={ref:null,nref:null},this.parents=[],this.display=e.display}return e.prototype.isCandidate=function(e){var t=this.candidates;for(var r in t)for(var i in t[r])if(e.id===t[r][i].link.id)return r;return null},e.prototype.getCollection=function(){return this.multiLink},e.prototype.show=function(e){this.multiLink&&this.multiLink.show(e)},e.prototype.hide=function(){for(var e=this.multiLink,t=this.parents,r=0;r<t.length;r++)Ye.defaults(t[r]);this.parents=[],this.candidates={ref:null,nref:null},e&&(e.destroy(),this.multiLink=null)},e.prototype.addLink=function(e){var t,r,i,n=this.multiLink,o=this.parents,s=this.candidates;if(null!=e&&(i=e.coord().length-1,(r=!o.length)&&(s.ref=e.getConnectedLinks(0,!0),s.nref=e.getConnectedLinks(i,!0),o.push(Ye.deHighlight(e)),this.multiLink=n=new xt(e._e(),e,this.mlStyle)),t=this.isCandidate(e))){var a=o[o.length-1],c=s[t];for(var d in Ye.deHighlight(a),c)Ye.defaults(c[d].link),c[d].link.id==e.id&&(s[t]=e.getConnectedLinks(0==c[d].index?i:0,!0),o.push(e),n.addLink(e))}return!(!t&&!r)},e.prototype.setMLStyle=function(e){this.mlStyle=e,this.multiLink&&this.multiLink.updateStyle(e)},e}();var bt=function(){function e(){this.listeners=new i(["tap","dbltap","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay"]).sync(!0)}return e.createEditorEvent=function(e,t,r,i){return new st(r||e.type,e.mapX,e.mapY,e.nativeEvent,e.button,t,i||e.detail)},e.prototype.trigger=function(t,r,i){var n,o,s,a,c=i||t.type||t;return(a=r)&&a.class?(o=t.detail,s=r):o=r,"touchend"==t.type&&(t=t.changedTouches[0]),n=this.listeners.trigger(c,e.createEditorEvent(t,s,c,o),function(e){return"_"==e[0]}(c)),"pointerup"==c&&(n=this.listeners.trigger("tap",[new st("tap",t.mapX,t.mapY,t.nativeEvent,t.button,s,o)],!1)||n),n},e.prototype.bind=function(e,t,r){return this.listeners.add(e,t,r)},e.prototype.remove=function(e,t,r){return this.listeners.remove(e,t,r)},e.prototype.supported=function(){return this.listeners.getEvents()},e.prototype.destroy=function(){this.listeners=null},e}(),Et=function(e){var t=e.options;return{id:t.id,from:t.from,to:t.to,side:t.side,style:t.style,segments:e.segments}},Pt=function(){function e(e){this.links=new Lt(e)}return e.prototype.add=function(e){for(var t=e instanceof Array?e:[].slice.call(arguments),r=0;r<t.length;r++)t[r]instanceof ot&&this.links.addLink(t[r])},e.prototype.show=function(e){var t=this.zones=e instanceof Array?e:[].slice.call(arguments);t.forEach((function(e){e.from=e.from||0,e.to=(null==e.to?1:e.to)||0;for(var t=0,r=["markerStyle","lineStyle"];t<r.length;t++){var i=r[t],n=e[i];n&&!Array.isArray(n)&&(e[i]=[n])}for(var o=function(t){var r=e[t];r&&(e[t]=function(e,i){e.detail.zone=Et(i),r(bt.createEditorEvent(e,e.target,t))})},s=0,a=["dragStart","dragMove","dragStop"];s<a.length;s++){o(a[s])}})),this.links.show(t)},e.prototype.hide=function(){return this.links.hide()},e.prototype.info=function(){var e=[],t=this.links.getCollection();t&&t.getZones().forEach((function(t){e.push(Et(t))}));return e},e.prototype.setStyleGroup=function(e){this.links.setMLStyle(e)},e}();function It(t,r,i,n,o,s){var a,c,d,l,u,p,h=i.addImage(r,o);h.pressmove=function(r,i,o,s,h){a||n.visible(!(a=!0));for(var f=e.calcBearing(d,t.map.getGeoCoord(r.mapX,r.mapY))-l,v=0;v<c.length;v++)p=c[v],$e._setCoords(p,t.map.rotateGeometry(p.geometry,d,f-u));u=f},h.pointerdown=function(r){a=!1,d=n.getCenter(),l=e.calcBearing(d,t.map.getGeoCoord(r.mapX,r.mapY)),c=n.getObjects(),u=0},h.pointerup=function(){a&&(c.length>1||"Point"!=c[0].geometry.type)&&(n.markObjsAsMod(),n.objBBoxChanged()),c=null,d=null,n.visible(!0)},h.pointerenter=h.pointerleave=function(e){var r="pointerenter"==e.type;document.body.style.cursor=r?"move":"default",t.setStyle(h,r?s:o)},this.setPosition=function(e,t){i.setFeatureCoordinates(h,[e,t])},this.hide=function(){i.hideFeature(h)},this.show=function(){i.showFeature(h)},this.remove=function(){i.remove(h)}}function wt(e,t,r,i,n,o){var s,a,c,d=r.addCircle(t,n),l=null;d.pointerdown=function(){s=!1,a=0,c=0,l=i.getObjects()},d.pressmove=function(t,r,n,o,d){s=!0;for(var u=0;u<l.length;u++)e.map.pixelMove(l[u],r-a,n-c);a=r,c=n,i.objBBoxChanged()},d.pointerup=function(){s&&i.markObjsAsMod(),l=null},this.setPosition=function(e,t){r.setFeatureCoordinates(d,[e,t])},this.getCenter=function(){return d.geometry.coordinates.slice()},this.hide=function(){r.hideFeature(d)},this.show=function(){r.showFeature(d)},this.remove=function(){r.remove(d)}}function Rt(e,t,r,i,n,o,s,a,c){for(var d,l,u,p,h,f=[o.addRect(t,r,i,n,a)],v=[[[t,n],[i,n]],[[i,n],[i,r]],[[i,r],[t,r]],[[t,r],[t,n]]],g=0;g<v.length;g++){var A=g%2;f.push(o.addPath(v[g],[{zIndex:0,zLayer:1/0,type:"Line",opacity:.02,strokeWidth:4}],{orientation:A?"V":"H",index:g,cursor:(A?"ew":"ns")+"-resize"}))}function y(t,r,i){var n=this.properties.index,o=this.properties.orientation,a=null,c=null,f=h,v=[],g=e.map.getGeoCoord(t.mapX,t.mapY),A=s.getGap();if((1!=f.length||"Point"!=f[0].geometry.type)&&(p=!0,"V"==o&&l>0?(v[1]=d[3],c=1,v[0]=d[0]+(1==n?0:l),g[0]+=1==n?-A:A,a=(l+g[0]-(d[0]+l))/l,a=3==n?1-a:a):u>0&&(v[0]=d[0],a=1,v[1]=d[3]-(2==n?0:u),g[1]+=2==n?A:-A,c=(u+(d[1]-g[1]))/u,c=0==n?1-c:c),a&&c)){for(var y=0;y<f.length;y++){var m=f[y],_=e.map.scaleGeometry(m.geometry,[a/this.properties.fx,c/this.properties.fy],v);$e._setCoords(m,_)}s.objBBoxChanged(),this.properties.fx=a,this.properties.fy=c}}function m(){h=s.getObjects(),p=!1,d=h.getBBox(),l=d[2]-d[0],u=d[3]-d[1],this.properties.fx=1,this.properties.fy=1}function _(){p&&s.markObjsAsMod()}function S(){document.body.style.cursor=this.properties.cursor}function k(){document.body.style.cursor="default"}for(var C=0;C<f.length;C++){var x=f[C];x.pointerdown=m,x.pressmove=y,x.pointerup=_,x.pointerenter=S,x.pointerleave=k}this.update=function(e,t,r,i){var n=[[[e,i],[r,i]],[[r,i],[r,t]],[[r,t],[e,t]],[[e,t],[e,i]]];o.modifyRect(f[0],e,t,r,i);for(var s=1;s<f.length;s++)o.setFeatureCoordinates(f[s],n[s-1])},this.hide=function(){o.hideFeature(f)},this.show=function(){o.showFeature(f)},this.remove=function(){o.remove(f)}}function Ot(e){var t=e.objects.overlay,r=this,i=null,n=null,o=null,s=null,a=4e-5,c=[];function d(e){for(var t=e.length;t--;){var r=e[t];c.indexOf(r.id)>=0&&$e._editable(r,!0)}}r.markObjsAsMod=function(){for(var t=s.length,r=0;r<t;r++)$e.markAsModified(s[r],!1);t&&e.objects.history.saveChanges()},r.getObjects=function(){return s},r.visible=function(e){o&&(e?(i.show(),o.show(),n.show()):(i.hide(),o.hide(),n.hide()))},this.isActive=function(){return null!==i},this.hide=function(){i&&(i.remove(),o.remove(),n.remove()),i=n=o=null,null!=s&&(d(s),s=null)},this.objBBoxChanged=function(){var c=s.getBBox(),d=c[0]-=a,l=c[1]-=a,u=c[2]+=a,p=c[3]+=a,h=c[0]+(c[2]-c[0])/2,f=c[1]+(c[3]-c[1])/2;null!=i?i.update(d,l,u,p):(i=new Rt(e,d,l,u,p,t,r,{type:"Line",zIndex:0,zLayer:1/0,strokeDasharray:[4,4],strokeWidth:2,stroke:"#010B1E"}),n=new wt(e,[h,f],t,r,{type:"Circle",zIndex:0,zLayer:1/0,stroke:"#FFFFFF",fill:"#010B1E",strokeWidth:3,opacity:.3,radius:9}),o=new It(e,[u,l],t,r,[{type:"Image",zIndex:4,zLayer:1/0,src:"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs=",width:18,height:18}],[{type:"Image",zIndex:4,zLayer:1/0,src:"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=",width:18,height:18}])),o.setPosition(u,l),n.setPosition(h,f)},this.getGap=function(){return a},this.getCenter=function(){return n.getCenter()},this.show=function(t){var i;e.listeners.trigger("_clearOverlay"),null!=s&&d(s),(s=t instanceof Array?t:[t]).getBBox=function(){return function(e){for(var t=[1/0,1/0,-1/0,-1/0],r=0,i=e;r<i.length;r++){var n=i[r],o=n.getBBox?n.getBBox():n.bbox;o[0]<t[0]&&(t[0]=o[0]),o[1]<t[1]&&(t[1]=o[1]),o[2]>t[2]&&(t[2]=o[2]),o[3]>t[3]&&(t[3]=o[3])}return t}(s)},c=[];for(var n=0,o=void 0;n<s.length;n++)i=s[n],o=$e.private(i),$e.deHighlight(i),o.isSelected=!1,o.allowEdit&&(c.push(i.id),$e._editable(i,!1));r.objBBoxChanged()}}var Ft=["ready","active","history.current","history.length","changes.length"],Nt={ready:void 0,active:null},Dt=function(){function e(){this.listeners=new i(Ft).sync(!0),this.val={};for(var e,t,r=this.val,n=Ft.length;e=Ft[--n];)t=Nt[e],r[e]=void 0!==t&&t}return e.prototype.addObserver=function(e,t,r){var i=this.val;if("*"==e)for(var n in i)this.addObserver(n,t,r);else this.listeners.add(e,t,r)},e.prototype.removeObserver=function(e,t,r){var i=this.val;if("*"==e)for(var n in i)this.removeObserver(n,t,r);else this.listeners.remove(e,t,r)},e.prototype.get=function(e){return this.val[e]},e.prototype.change=function(e,t,r){var i=this.val[e];(r||i!=t&&this.get("active"))&&(this.val[e]=t,this.listeners.trigger(e,[e,t,i]))},e}(),Bt=function(){function e(e,t){this.s=[],this.zClearFeat=null,this.ie=e,this.display=t;var r=this;if(e._config.keepFeatureSelection){var i=t.getZoomlevel();t.addEventListener("mapviewchangeend",(function(){var e=t.getZoomlevel();if(e!=i){var n=r.getCurSelObj()||r.zClearFeat,o=void 0;n&&(o=n.getProvider().minLevel,i>=o?e<o&&(r.clearSelected(),r.zClearFeat=n):e>=o&&$e._select(n))}i=e}))}}return e.prototype.add=function(e){$e.private(e).isSelected=!0,this.s.push(e)},e.prototype.remove=function(e){var t=this.s;$e.private(e).isSelected=!1,t.splice(t.indexOf(e),1)},e.prototype.select=function(e){var t=this.display.getZoomlevel(),r=e.getProvider();if(t>=r.minLevel&&t<=r.maxLevel)return this.clearSelected(),this.add(e),!0;this.zClearFeat=e},e.prototype.getCurSelObj=function(){return this.s[0]},e.prototype.unselectFeature=function(e){var t,r=this.ie;if(e||!r._config.keepFeatureSelection){if(t=this.getCurSelObj()){var i=$e.private(t,"xt");i&&i.clear(),r.listeners.trigger("featureUnselected",{featureUnselected:!0})}this.clearSelected()}},e.prototype.clearSelected=function(){var e,t=this,r=this.s,i=this.ie;return i.listeners.trigger("_clearOverlay"),r.forEach((function(r){var i=$e.getTool(r,"deHighlight");i&&(e=r,i(r,!0),t.remove(r)),$e.private(r).isSelected=!1})),r.length=0,this.zClearFeat=null,i.transformer.hide(),e},e}(),Tt="@ns:com:here:editor",jt=function(){function e(){this.steps={}}return e.prototype.clone=function(e){return e?JSON.parse(JSON.stringify(e)):e},e.prototype.add=function(e,t,r){var i=this.steps[e]||{},n=i[t]=i[t]||{},o=r.id;if(!n[o])return n[o]=r,this.set(e,i),!0},e.prototype.remove=function(e,t,r){try{var i=this.steps[e][t],n=r.id;if(i[n])return delete i[n],this.set(e,this.steps[e]),!0}catch(e){}return!1},e.prototype.get=function(e){return this.clone(this.steps[e])},e.prototype.set=function(e,t){this.steps[e]=this.clone(t)},e.prototype.clear=function(){var e=this.steps;for(var t in e)delete e[t]},e}(),Mt=function(e){return e.properties[Tt]},Gt=function(e){var t=e.toJSON(),r=Mt(t);return t.class=e.class,r&&(delete r.hovered,delete r.selected),t},Ht=function(e){var t=Mt(e);return t.modified||t.removed||t.split||t.created},zt=function(){function e(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new jt}return e.prototype.updateObservers=function(e){var t=this.iEdit.observers;t.change("changes.length",this.getLength()),t.change("history.length",this.total),t.change("history.current",this.current,e)},e.prototype.getTotal=function(){return this.total},e.prototype.getLength=function(){var e=this.getChanges(),t=0;for(var r in e)for(var i in e[r])Mt(e[r][i]).origin||t++;return t},e.prototype.remove=function(e){var t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)},e.prototype.origin=function(e,t){var r=e.id,i=e.getProvider().id,n=this.storage,o=this.changes,s=this.current,a=n[s],c=o[i];if(c||(c=o[i]={}),c[r]=e,!a||!a[i]||!a[i][r]){var d=Gt(e),l=Mt(d);t&&(l.removed=!0),l.origin=!0,n.add(s,i,d)}},e.prototype.saveChanges=function(){var e=0;if(this.active()){this.cached=null;var t=function(e){var t={},r=0;for(var i in e)for(var n in t[i]={},e[i])t[i][n]=Gt(e[i][n]),r++;return{data:t,length:r}}(this.changes);if(e=t.length){var r=++this.current;this.storage.set(r,t.data),r>this.total?this.total++:this.total=r,this.iEdit.dump("History step saved...",r,"warn"),this.changes={},this.updateObservers()}}return e},e.prototype.getChanges=function(){if(!this.cached){for(var e=this.storage,t=this.current,r={},i=1,n=void 0;i<=t;i++)for(var o in n=e.get(i))for(var s in n[o]){var a=n[o][s];c=void 0,(c=Mt(a)).created&&c.removed?r[o]&&r[o][s]&&delete r[o][s]:Ht(a)&&((r[o]=r[o]||{})[s]=a)}this.cached=r}var c;return this.cached},e.prototype.clear=function(){this.storage.clear(),this.current=0,this.total=0,this.changes={},this.cached=null,this.updateObservers(!0)},e.prototype.import=function(e){var r=this.storage;for(var i in e)for(var n in e[i]){var o=this.iEdit.objects.get(n,i);if(o)this.origin(o);else{var s=t.extend(!0,{},e[i][n]),a=s.properties[Tt]=s.properties[Tt]||{};a.removed=!0,a.origin=!0,r.add(this.current,i,s)}}this.total=++this.current,r.set(this.current,e),this.recoverViewport(0)},e.prototype.recoverViewport=function(e,t){var r=+new Date,i=this.current+e,n=this.storage.get(i),o=this.iEdit;if(this.cached=null,i>=0&&i<=this.total){o.objects.selection.unselectFeature(),o.dump(arguments,i,"REBUILDED VIEW IN",+new Date-r,"ms"),o.objects.selection.getCurSelObj()&&o.listeners.trigger("featureUnselected",{featureUnselected:!0}),o.objects.selection.clearSelected();var s=[];for(var a in n){var c=n[a];for(var d in c){s["NAVLINk"==(h=c[d]).class?"unshift":"push"]({provider:o.getProviderById(a),feature:h})}}for(var l=0,u=s;l<u.length;l++){var p=u[l],h=p.feature,f=p.provider,v=f.search(h.id);v&&f.removeFeature(v);var g=Mt(h);if(!g.removed){for(var A in h=o.objects.create({feature:h,provider:f,history:!0}),g)h.properties[Tt][A]=g[A];o.setStyle(h)}}this.current=i,t||this.updateObservers()}},e.prototype.active=function(e){return arguments.length&&(this._a=!!e),this._a},e.prototype.ignore=function(e){var t=this.active();this.active(!1),e(),this.active(t)},e}(),Kt=function(){function e(e){this.type="CONTAINER",this.length=0,this._e=e}return e.prototype.push=function(e,t){var r,i,n=this,o={};t&&"Feature"==t.type&&(e=arguments,t=void 0),null==e.length&&(e=[e]);for(var s=n._e,a=0,c=e;a<c.length;a++){var d=c[a];(i=s.objects.add(d,t,o))&&(d=i,r=!0),n[n.length++]=d}return r&&s.objects.history.saveChanges(),n.length},e.prototype.forEach=function(e,t){for(var r=0;r<this.length;r++)e.call(t,this[r],r)},e.prototype.toArray=function(){for(var e=[],t=0;t<this.length;t++)e[e.length]=this[t];return e},e.prototype.highlight=function(){for(var e,t=this.length;e=this[--t];)$e.highlight(e)},e.prototype.remove=function(){for(var e=this._e.objects,t=!1,r=this.length;r--;)t=e.remove(this[r],{animation:!1,save:!1})||t,delete this[r];t&&(this.length=0,e.history.saveChanges())},e.prototype.transform=function(){this.length&&this._e.transformer.show(this.toArray())},e.prototype.unHighlight=function(){for(var e,t=this.length;e=this[--t];)$e.deHighlight(e)},e.prototype.unhighlight=function(){return this.unHighlight()},e.prototype.pop=function(){if(this.length){var e=this[--this.length];return delete this[this.length],e}},e.prototype.getBBox=function(){for(var e,t=[1/0,1/0,-1/0,-1/0],r=0;r<this.length;r++)(e=this[r].getBBox?this[r].getBBox():this[r].bbox)[0]<t[0]&&(t[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[2]>t[2]&&(t[2]=e[2]),e[3]>t[3]&&(t[3]=e[3]);return this.length?t:[0,0,0,0]},e}(),Vt=function(e,t,r){return{geometry:{coordinates:t,type:e},type:"Feature",properties:r||{}}},Ut=function(e,t){for(var r=0;r<e.length;r++)null!=e[r].opacity&&(e[r]._opacity=e[r]._opacity||e[r].opacity),e[r].opacity=t;return e},Yt=function(e){for(var t=0;t<e.length;t++)e[t].opacity=null==e[t]._opacity?1:e[t]._opacity,delete e[t]._opacity;return e},Qt=function(e){return e=e?e instanceof Array?e:[e]:void 0},Wt=function(e,t,r,i){return[[[e,t],[e,i],[r,i],[r,t],[e,t]]]},Jt=function(){function t(e){this.layer=e}return t.prototype.getProvider=function(){return this.layer.getProvider()},t.prototype.hideFeature=function(){for(var e,t=this,r=t.layer,i=0;i<arguments.length;i++)(e=arguments[i])instanceof Kt&&(e=e.toArray()),e instanceof Array?t.hideFeature.apply(t,e):r.setStyleGroup(e,Ut(r.getStyleGroup(e),0))},t.prototype.showFeature=function(){for(var e,t=this,r=t.layer,i=0;i<arguments.length;i++)(e=arguments[i])instanceof Kt&&(e=e.toArray()),e instanceof Array?t.showFeature.apply(t,e):r.setStyleGroup(e,Yt(r.getStyleGroup(e)))},t.prototype.addFeature=function(e,t){var r=this.layer.addFeature(e,Qt(t));return r.properties["@ns:com:here:editor"]=r.properties["@ns:com:here:editor"]||new rt,r},t.prototype.addCircle=function(e,t,r){return this.addFeature(Vt("Point",e,r),t)},t.prototype.remove=function(e){var t=this.layer;if(e instanceof Kt)for(var r=0;r<e.length;r++)t.removeFeature(e[r]);else e&&t.removeFeature(e)},t.prototype.setFeatureCoordinates=function(e,t){e._provider.setFeatureCoordinates(e,t)},t.prototype.getStyles=function(e){return this.layer.getStyleGroup(e)},t.prototype.modifyRect=function(e,t,r,i,n){this.setFeatureCoordinates(e,Wt(t,r,i,n))},t.prototype.addRect=function(e,t,r,i,n){return this.addFeature(Vt("Polygon",Wt(e,t,r,i)),n)},t.prototype.addPolygon=function(e,t,r){return this.addFeature(Vt("Polygon",[e],r),t)},t.prototype.addSquare=function(t,r,i,n,o){var s=e.movePoint;return i^=0,this.addPolygon([s(t,r,-45+i),s(t,r,45+i),s(t,r,135+i),s(t,r,225+i),s(t,r,-45+i)],n,o)},t.prototype.addPath=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:r||{}},Qt(t))},t.prototype.addPoint=function(e,t,r){t instanceof Array||(r=t,t=void 0);var i={geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}};return this.addFeature(i,Qt(t))},t.prototype.addImage=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}},Qt(t))},t}(),Zt="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==",Xt="#111111",qt=function(e){return e.properties["@ns:com:here:editor"].hovered},$t=function(e,t,r){return"function"==typeof e?e(t,r):e},er=function(e){return[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:Xt,strokeWidth:1.5},{zIndex:1,type:"Text",fill:Xt,font:"normal 16px Arial",text:e}]},tr=function(e){return[{zIndex:1,type:"Image",src:e,width:24,height:24,alignment:"map",rotation:function(e){return e.properties.rotation}}]},rr=function(){function e(){this.styleGroups={ADDRESS_LINE:[{zLayer:function(e){return e.properties.zLayer},zIndex:999990,type:"Line",strokeWidth:2,stroke:"#FF0000"}],ADDRESS_ROUTING_POINT:[{zLayer:function(e){return e.properties.zLayer},zIndex:999991,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zLayer:function(e){return e.properties.zLayer},zIndex:999992,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],ADDRESS_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],PLACE_LINE:[{zLayer:function(e){return e.properties.zLayer},zIndex:999990,type:"Line",strokeWidth:2,stroke:"#FF0000"}],PLACE_ROUTING_POINT:[{zLayer:function(e){return e.properties.zLayer},zIndex:999991,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zLayer:function(e){return e.properties.zLayer},zIndex:999992,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],AREA_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:Xt,radius:function(e){return qt(e)?6:4},fill:function(e,t){return qt(e)?Xt:$t(e.properties.AREA.style[0].fill,e,t)}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:1,fill:Xt,stroke:Xt,radius:function(e){return qt(e)?5:3}}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style[0].strokeWidth;return $t(r,e,t)/2+4^0},stroke:function(e,t){var r=e.properties.LINE.style.filter((function(e){return"Line"==e.type})),i=r.length-1;return i>0?$t(r[i].stroke,e,t):Xt},fill:function(e,t){var r=e.properties.LINE.style;return r.length>1?$t(r[0].stroke,e,t):"#151515"},strokeWidth:2}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style[0].strokeWidth;return $t(r,e,t)/2^0},fill:"#151515"}],MARKER_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],PLACE_SELECTOR:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}],NAVLINK_SHAPE:[{zIndex:0,type:function(e){return e.properties.isConnected?"Rect":"Circle"},width:function(e){return qt(e)?18:12},rotation:45,radius:function(e){return qt(e)?9:6},strokeWidth:2,fill:function(e,t){return e.isOverlapping()?"#FFFFFF":$t(e.properties.NAVLINK.style[0].stroke,e,t)},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"}}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:function(e){return e.properties.NAVLINK.style[0].strokeWidth/5},opacity:.7,fill:Xt,stroke:Xt,strokeWidth:2}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:Zt,rotation:90,width:24,height:24,alignment:"map"}],NAVLINK_DIRECTION_HINT_A:er("A"),NAVLINK_DIRECTION_HINT_B:er("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:function(e){return-e.properties.bearing},opacity:.7,alignment:"map"}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:Zt,width:24,height:24,rotation:90,alignment:"map"}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAMQAAAAAAAAA/wBAvwBA/wBNzBRO2ABV/wtV2gxVzgdW0wpX1ApY1Qpa3BJbyABd0Qtd4wtf6Ath6wBmzABm/wBt2wCAgACA/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABgALAAAAAAkABQAAAW/ICZiC6Ocijmu43KaqMq+aMwwT6Tv0fPANZlIAQGmaidSjeRCniKK4aPWvNFYypeveZpijqjH4quYpm5oXGna5Lq+XCHZGUtKa2Z8dKXgBvcjZVRODGOBeUheKwuIdIaHdIIzjUhvfJRdgHeRfZpfmJKXnCePm06KkKOFi6CoIoyjoYF+dZODnVeBqnafeoJhY5lnaWo4t529KFUwqzMxW3pDRX9UTAvXcJERpS5GLzc5PDo+3kdYX0ZyWHUxpSEAOw==",width:36,height:20,rotation:function(e){return e.properties.rotation},alignment:"map"}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:function(e){return"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}}],TURN_RESTRICTION_ONEWAY:tr(Zt),TURN_RESTRICTION_FORBIDDEN:tr("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:tr("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:tr("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]}}return e.prototype.assign=function(e){var t=e.class||e.properties.type;return void 0!==this.styleGroups[t]?t:"UNKNOWN"},e}(),ir=function(e){function t(t){void 0===t&&(t={});var r=this;return t.name="EOP",(r=e.call(this,t)||this).id="EOP-"+r.id,r}return f(t,e),t}(c),nr="pointerenter pointerleave pointerup pressmove pointerdown dbltap",or=function(e){return e.class},sr=function(){function r(e,t){this.listen=!1;this.iEdit=e,this.display=t,this.history=new zt(e),this.selection=new Bt(e,t);var r,i,o=(r=e,(i=new ir)._e=function(){return r},new d({name:"EditorOverlay",min:1,max:28,style:new rr,provider:i}));this.overlay=new Jt(o);var s=new n([[o.id,o]]);this.layers=s,t.addLayer(o,function(e){for(var t,r=e.length;r--;){if((t=e[r].getProvider())&&"NAVLINK"==t.class)return r+1}return e.length}(t.getLayers())),this.arrangeOverlay=this.arrangeOverlay.bind(this),this.pointerListener=this.pointerListener.bind(this),e.listeners.bind("_layerAdd",(function(e){var t=e.detail.layer;s.set(t.id,t)})),e.listeners.bind("_layerRemove",(function(t){var r=t.detail.layer;s.delete(r.id);var i=e.objects.selection.getCurSelObj();i&&e.getLayer(i)==r&&e.objects.selection.clearSelected()})),this.onMVCStart=this.onMVCStart.bind(this)}return r.prototype.onMVCStart=function(){this.selection.unselectFeature()},r.prototype.splitLinkAt=function(e){return function(e,r){var i,n,o=r.link,s=r.index,a=r.preferSegment,c=r.avoidSnapping,d=o.coord(),l=d.length-1,u=Ye._props(o),p=o.getProvider().readZLevels(o),h=e._config.minShapeDistance;if(r.point&&(i=r.point[0],n=r.point[1]),0===s||s===l||i==d[0][0]&&n==d[0][1]||i==d[l][0]&&n==d[l][1])return!1;if(e.objects.history.origin(o),void 0===s){var f=e.map.calcCrossingAt(d,r.point,h,a);if(s=f.index,f.existingShape&&(0===s||s===l))return!1;s=Ye.addShp(o,[i,n],null,!0,null,a),d=o.coord()}Ye.deHighlight(o);var v=o.getProvider(),g=function(r,i,n){var o=t.extend(!0,{},u),s={type:"Feature",geometry:{type:"LineString",coordinates:r},properties:o};return delete o["@ns:com:here:editor"],e.objects.create({feature:s,provider:v,zLevels:i,preferIndex:n})},A=g(d.slice(0,s+1),p.slice(0,s+1),c&&s),y=g(d.slice(s),p.slice(s),c&&0),m=de(d[s],d);m>.995&&(m=1);var _=le(d,d[s]).offset,S=Ye.getConnectedObjects(o);for(var k in S){var C=S[k],x=ke.getRoutingPosition(C),L=_>le(d,x).offset?A:y;ke.connect(C,L,x),ke.markAsModified(C,!1)}return e.hooks.trigger("Navlink.split",{link:o,index:s,children:[A,y],relativePosition:m},v),o.editState("split",Date.now()),e.objects.remove(o,{animation:!1,split:!0}),[A,y]}(this.iEdit,e)},r.prototype.destroy=function(){this.display.removeLayer(this.overlay.layer)},r.prototype.arrangeOverlay=function(e){var t=e&&e.detail.layer,r=this.display,i=this.overlay.layer;if(r.getLayers){var n=r.getLayers();if(!(t.getProvider()instanceof ir)){var o=n.map((function(e){var t=e.getProvider();return t&&t.class})).indexOf("NAVLINK");r.removeLayer(i),o>=0?r.addLayer(i,o+1):r.addLayer(i)}}},r.prototype.pointerListener=function(e){var t=this.iEdit,r=e.target,i=e.type;if(r){var n=e.detail.layer;if(!this.layers.has(n.id))return;var o=$e.getEventListener(r,i);if(o)return e.stopPropagation(),o.apply(r,arguments)}"pointerup"!=i&&"dbltap"!=i||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)},r.prototype.listenDisplay=function(e){var t=this.display,r=this.listen,i=this.pointerListener,n=this.arrangeOverlay;e?r||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(nr,i),t.addEventListener("addLayer removeLayer",n)):r&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(nr,i),t.removeEventListener("addLayer removeLayer",n))},r.prototype.clear=function(){},r.prototype.get=function(e,t){var r=this.iEdit;return t?"object"!=typeof t&&(t=r.getLayer(t)):t=r.getLayer(e),"object"!=typeof e&&t&&(e=t.search(e)),e&&t?e:null},r.prototype.getInBBox=function(e,t){e||(e=[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat]);var r=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-r,e[1]-r,e[2]+r,e[3]+r];for(var i,n=[],o=0,s=(t=t||this.layers.values())instanceof Array?t:[t];o<s.length;o++){if(i=s[o].search(e))for(var a=0;a<i.length;a++)n.push(i[a])}return n},r.prototype.remove=function(e,t){var r=!1;if((t=t||{}).split||!this.iEdit._config.editRestrictions(e,2)){var i=null==t.animation||t.animation;i&&$e.private(e,"isSelected")&&this.selection.clearSelected(),or(e)&&(this.history.origin(e),$e.markAsRemoved(e,i),t.save&&this.history.saveChanges(),r=!0);var n=e.getProvider();return e.editState&&!e.editState("created")&&n.blockFeature(e,!0),n.removeFeature(e),r}},r.prototype.add=function(e,t,r){var i=this.iEdit;if(!e.getProvider()&&("string"==typeof t?t=this.layers.get(t):t||(t=i.getLayerForClass(or(e))),t)){var n=e.id,o=null!=n&&t.search(n);return null!=n&&o?o:this.create({feature:e,provider:t.getProvider(),idMap:r})}},r.prototype.create=function(e){var t=this.iEdit,r=t.objects.history,i=[],n=e.feature;Array.isArray(n)||(n=[n]);for(var o=e.idMap||{},s=e.provider,a=e.preferIndex,c=e.history,d=e.zLevels,l=function(e){var l,u=n[e],p=u.id;if(c||(u.id=void 0),u=s.prepareFeature(u),l=s.detectFeatureClass(u),null==p&&(p=u.id),o[p]=u.id,u=function(e){return c&&s.blockFeature(e,!1),e=s.addFeature(e),e=s.search(e.id),c||(e.editState("created",Date.now()),$e.markAsModified(e,!1),r.origin(e,!0),d&&r.ignore((function(){s.writeZLevels(e,d)}))),i.push(e),e}(u),"NAVLINK"===l)u.geometry.coordinates.forEach((function(e){e[2]=0^e[2]})),c||$e.fixGeo(u,void 0,void 0,a);else if("PLACE"===l||"ADDRESS"===l){var h=$e.getRoutingData(u),f=h.link;if(o[f]){var v=$e.getRoutingProvider(u),g=v&&v.search(o[f]);r.ignore((function(){u.getProvider().writeRoutingPoint(u,g,h.position)}))}"ADDRESS"===l&&($e.connect(u),u.getLink()||(r.remove(u),s.removeFeature(i.pop()),t.dump("No Link found within "+t._config.maxRoutingPointDistance+" meters","warn")))}},u=0;u<n.length;u++)l(u);return i.length>1?i:i[0]},r.prototype.getNearestLine=function(r,i,n){var o=this.iEdit;n=t.extend({ignore:[],maxDistance:1/0,shapeThreshold:0,onlyExsitingShape:!1},n||{});var s,a,c,d,u,p,h,f,v,g={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},A=r,y=n.maxDistance,m=y<1/0?e.getPointBBox(A,y):null;function _(t){return void 0===t[2]||void 0===A[2]||t[2]===A[2]?e.distance(t,A):1/0}i instanceof l&&(i=this.getInBBox(m,i)),r=o.map.getPixelCoord(r);for(var S=0,k=i;S<k.length;S++){var C=k[S];if(-1==n.ignore.indexOf(C.id)&&(s=C.bbox,y==1/0||(a=m[0],c=m[2],d=m[1],u=m[3],p=s[0],h=s[2],f=s[1],v=s[3],a<=h&&p<=c&&d<=v&&f<=u))){for(var x,L=C.geometry.coordinates,b=void 0,E=n.maxDistance,P=void 0,w=[],R=void 0,O=void 0,F=0;F<L.length;F++)w[F]=o.map.getPixelCoord(x=L[F]),(O=_(x))<E&&(E=O,P=F,b=0^(F>0&&F-1),R=x);if(!n.onlyExsitingShape&&(null==R||E>n.shapeThreshold))for(F=0;F<w.length-1;F++)(x=I(w[F],w[F+1],r))&&(O=_([(x=o.map.getGeoCoord(x))[0],x[1]]))<E&&(E=O,P=null,b=F,R=x);R&&E<g.distance&&(g.point=R,g.distance=E,g.shpIndex=P,g.segmentNumber=b,g.line=C,y=e.distance(R,A),m=e.getPointBBox(A,y))}}return g.line?g:null},r}(),ar=function(){function e(e,t){var r=this;this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.bind("_layerAdd",(function(e){r.observers.change("ready",!1),r.display.setCenter(r.display.getCenter()),e.detail.layer.addEventListener("viewportReady",r.onStop)})),e.listeners.bind("_layerRemove",(function(e){e.detail.layer.removeEventListener("viewportReady",r.onStop)}))}return e.prototype.onStart=function(){if(!this.busy){var e=this.iEdit.layers;this.busy=new o(e),e.length&&this.observers.change("ready",!1)}},e.prototype.onStop=function(e){var t=e.detail.layer,r=this.busy;r&&(r.delete(t),r.size||(this.observers.change("ready",!0),this.busy=null))},e.prototype.start=function(){this.display.addEventListener("mapviewchangestart",this.onStart)},e.prototype.stop=function(){this.display.removeEventListener("mapviewchangestart",this.onStart)},e}(),cr=["Navlink.split","Navlink.disconnect","Feature.remove"],dr=function(e,t){var r=e.__=e.__||String(1e9*Math.random()^0);return t&&(r+=";"+t.id),r},lr=function(){function e(e){this.h=new i(cr),this.h.sync(!0),this.history=e,this.w=new Map}return e.prototype.add=function(e,t,r){var i=dr(t,r),n=this.w.get(i);return n||this.w.set(i,n=function(e,t){var r=function(r,i){t&&i!=t||e(r)};return r.h=e,r}(t,r)),this.h.add(e,n)},e.prototype.remove=function(e,t,r){return this.h.remove(e,this.w.get(dr(t,r)))},e.prototype.get=function(e){return this.h.get(e).map((function(e){return e[0].h}))},e.prototype.trigger=function(e,t,r){var i=this.history,n=i.active();i.active(!1),this.h.trigger(e,[t,r]),i.active(n)},e}(),ur=Math.PI/180,pr=function(e,t,r,i){this.point=[e,t],this.index=r,this.existingShape=i};function hr(e,t){if("number"==typeof e[0])return t(e);for(var r=[],i=e.length;i--;)r[i]=hr(e[i],t);return r}var fr=function(){function t(e){this.display=e}return t.prototype.distance=function(t,r){return e.distance(t,r)},t.prototype.rotatePoint=function(e,t,r){return this.clipGeoCoord(function(e,t,r){var i=e[0]-t[0],n=e[1]-t[1],o=r*ur;return[t[0]+(Math.cos(o)*i-Math.sin(o)*n/Math.abs(Math.cos(t[1]*ur))),t[1]+(Math.sin(o)*i*Math.abs(Math.cos(t[1]*ur))+Math.cos(o)*n),0^e[2]]}(e,t,r))},t.prototype.movePoint=function(t,r,i,n){return this.clipGeoCoord(e.movePoint(t,r,i,n))},t.prototype.scaleGeometry=function(e,t,r){var i=this;return hr(e.coordinates,(function(e){return i.clipGeoCoord([r[0]+(e[0]-r[0])*t[0],r[1]+(e[1]-r[1])*t[1],0^e[2]])}))},t.prototype.rotateGeometry=function(e,t,r){var i=this;return hr(e.coordinates,(function(e){return i.rotatePoint(e,t,r)}))},t.prototype.getClosestPoint=function(e,t,r){var i=e[0]-t[0],n=e[1]-t[1],o=e[1]*t[0]-e[0]*t[1],s=i*r[0]+n*r[1],a=1/(i*i+n*n);return[(s*i+o*n)*a,(s*n-o*i)*a]},t.prototype.calcCrossingAt=function(e,t,r,i,n){var o,s,a,c=null,d=n||1/0,l=!1,u=null,p=null;if(null!=i){var h=this.calcCrossingAt(e.slice(i,i+2),t,r,void 0,n);return h.index+=i,h}for(var f=0;f<e.length;f++)o=e[f],(a=this.distance(o,t))<=d&&(d=a,u=o[0],p=o[1],c=f,l=!0);if(d>r||!l)for(f=0;f<e.length;f++)f<e.length-1&&(s=I(e[f],e[f+1],t))&&(a=this.distance(s,t))<d&&(d=a,c=f+1,u=s[0],p=s[1],l=!1);return new pr(u,p,c,l)},t.prototype.translateGeo=function(e,t,r){var i=this,n=i.display;return hr(e,(function(e){var o=n.geoToPixel(e[0],e[1]);return i.getGeoCoord(o.x+t,o.y+r,e[2])}))},t.prototype.pixelMove=function(e,t,r){var i=e.getProvider(),n=this.translateGeo(i.decCoord(e),t,r),o=$e.getTool(e,"_setCoords");o?o(e,n):i.setFeatureCoordinates(e,n)},t.prototype.clipGeoCoord=function(e){return e[0]=Math.round(1e9*e[0])/1e9,e[1]=Math.round(1e9*e[1])/1e9,e},t.prototype.getGeoCoord=function(e,t,r){var i,n=this,o=n.display;return arguments.length>1?i=o.pixelToGeo(e,t):null!=(i=e).x&&null!=i.y?(r=i.z,i=o.pixelToGeo(i.x,i.y)):null!=e[0]&&null!=e[1]&&(r=i[2],i=o.pixelToGeo(i[0],i[1])),n.clipGeoCoord([i.longitude,i.latitude,0|r])},t.prototype.getPixelCoord=function(e,t,r){var i=this.display;return 2==arguments.length?e=i.geoToPixel(e,t):null!=e.longitude&&null!=e.latitude?e=i.geoToPixel(e.longitude,e.latitude):null!=e[0]&&null!=e[1]&&(e=i.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]},t.prototype.getEventsMapXY=function(e){var t,r,i=this.display;if(null!=e.mapX)t=e.mapX,r=e.mapY;else{var n=i.getContainer().getBoundingClientRect();t=e.pageX-n.left,r=e.pageY-n.top}return[t,r]},t}(),vr=function(){function e(e,r){this.isCommitInProcess=!1,this._config=e;var i=this;i.layers=[],i.layerMap={},i.observers=new Dt,i.listeners=new bt,i.objects=new sr(i,r),i.hooks=new lr(i.objects.history);var n=new ar(i,r);n.start();var o=i.objects.overlay.layer,s={};function a(e){i.listeners.trigger("error",e)}s[o.getProvider().id]=o,i.listeners.bind("_layerAdd",(function(e){for(var t=e.detail.layer,r=t.getProvider(),i=0,n=["src","base","delta","id"];i<n.length;i++){var o=r[n[i]];o&&(s[o]=t)}t.removeEventListener("error",a),t.addEventListener("error",a)})),i.getLayerForClass=function(e){for(var t,r,n,o,s=0,a=i.layers;s<a.length;s++){var c=a[s];c.getProvider&&(o=c.getProvider()),(r=o.class)?e==r&&(n=c):t||(t=c)}return n||t},i.getProviderById=function(e){var t=s[e];if(t)return t.getProvider()},i.getLayerById=function(e){for(var t=0,r=i.layers;t<r.length;t++){var n=r[t];if(n.id==e)return n}},i.getLayer=function(e){var t;if("object"==typeof e){var r=e.getProvider();e=r.src||r.delta||r.base||r.id}return e&&(t=s[e]),t},i.getStyle=function(e,r){var i=this.getLayer(e).getStyleGroup(e,void 0,r);return t.extend(!0,[],i)},i.setStyle=function(e,t,r){this.getLayer(e).setStyleGroup(e,t,r)},i.map=new fr(r),i.transformer=new Ot(i),i.display=r,i.destroy=function(){n.stop(),i.objects.destroy(),i.listeners.destroy()},i.dump=t.dump}return e.prototype.cfg=function(e,t){switch(arguments.length){case 2:this._config[e]=t;break;case 1:return this._config[e];case 0:return this._config}},e}(),gr={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},geoFence:!1,minShapeDistance:2,autoConnectShapeDistance:2,intersectionScale:5,XTestMaxDistance:2,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,maxRoutingPointDistance:1e3,autoSnapShape:!1},Ar=function(e,t,r,i){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:i})},yr=function(e,t,r,i,n){t.getProvider().writeTurnRestriction(e,{link:t,index:r},{link:i,index:n})},mr={"Navlink.split":[function(e){for(var t=e.link,r=e.children,i=r[0],n=r[1],o=t.coord().length-1,s=i.coord().length-1,a=n.coord().length-1,c=0,d=t.getConnectedLinks(0,!0);c<d.length;c++){var l=d[c],u=l.link,p=l.index;Ar(t,0,u,p)&&(yr(!0,i,0,u,p),yr(!1,n,0,u,p)),Ar(u,p,t,0)&&(yr(!0,u,p,i,0),yr(!1,u,p,n,0))}for(var h=0,f=t.getConnectedLinks(o,!0);h<f.length;h++){var v=f[h];u=v.link,p=v.index;Ar(t,o,u,p)&&(yr(!0,n,a,u,p),yr(!1,i,s,u,p)),Ar(u,p,t,o)&&(yr(!0,u,p,n,a),yr(!1,u,p,i,s))}}],"Feature.remove":function(e){var t=e.feature;if("NAVLINK"==t.class){for(var r=t.coord().length-1,i=0,n=t.getConnectedLinks(0,!0);i<n.length;i++){var o=n[i],s=o.link,a=o.index;yr(!1,t,0,s,a)}for(var c=0,d=t.getConnectedLinks(r,!0);c<d.length;c++){var l=d[c];s=l.link,a=l.index;yr(!1,t,r,s,a)}}},"Navlink.disconnect":function(e){var t=e.link,r=e.index;t.getConnectedLinks(r,!0).forEach((function(e){var i=e.link,n=e.index;yr(!1,t,r,i,n),yr(!1,i,n,t,r)}))}},_r=function(e){[mr].forEach((function(t){return function(t){var r;for(var i in t){"function"==typeof(r=t[i])&&(r=[r]);for(var n=0,o=r;n<o.length;n++){var s=o[n];e.hooks.add(i,s)}}}(t)}))},Sr=function(e){return e.properties["@ns:com:here:editor"]},kr=function(e){return!!Sr(e).created},Cr=function(e){return!!Sr(e).removed},xr=function(){function e(e){this.pIds={},this.iEdit=e}return e.prototype.reserveIds=function(e,t,i,n){var o=this.pIds,s=e.id,a=[];for(var c in t)kr(t[c])&&(o[s][c]||a.push(t[c]));a.length>0?e.reserveId(a,(function(e){for(var r in t){var n=t[r];kr(n)&&!o[s][r]&&(o[s][r]=e.shift())}i(o[s],s)}),n):r.setTimeout((function(){i(o[s],s)}),0)},e.prototype.replaceIds=function(e,r,i){var n,o,s,a=this.pIds,c=this.iEdit,d=0;for(var l in s=JSON.stringify(e),e){for(var u in d++,o=!1,e[l])if(kr(e[l][u])){o=!0;break}a[l]||(a[l]={}),o?(c.dump("REQUESTING PERMANENT IDs..","info"),this.reserveIds(c.getProviderById(l),e[l],(function(i,o){var a,l,u="#"+t.String.random()+"#";for(var p in i)(n=e[o][p])&&(a="number"==typeof i[p]?i[p]:'"'+i[p]+'"',"string"==typeof(l=n.id)&&(l='"'+n.id.replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\")+'"'),a!=l&&(s=s.replace(l+":{",u).replace(new RegExp('"link":'+l,"g"),'"link":"'+a+'"').replace(new RegExp(l,"g"),a).replace(u,a+":{")),c.dump(n.id+" -> "+a,"info"));--d||r(JSON.parse(s))}),i)):d--}!d&&r(e)},e.prototype.send=function(e,r,i,n){var o=this.pIds,s=this.iEdit,a=0;function c(){--a||r(t.clone(o))}for(var d in e){a++;var l=s.getProviderById(d),u=e[d],p=[],h=[],f=void 0;for(var v in u)f=u[v],(Cr(f)?h:p).push(f);var g=o[d],A={};for(var y in g)A[g[y]]=y;p.length|h.length?l.commit({put:p,remove:h},c,(function(e){i&&i(e)}),n):c()}},e.prototype.submit=function(e,r,i,n){var o=this;void 0===n&&(n=t.String.random());var s=this.iEdit,a=s._config.services.reverseGeocoder.getISOCC,c=0;s.dump("COMMIT",n,"info");var d=function(){o.replaceIds(e,(function(e){o.send(e,r,i,n)}),i)};function l(e){if(e)return"number"==typeof e[0]?e:l(e[0])}for(var u in e){var p=function(t){var r=e[u][t],i=s.getProviderById(u);Cr(r)?kr(r)&&delete e[u][t]:a&&(i.isoCC(r)||(c++,s.dump(r.id,"["+i.detectFeatureClass(r)+"] MISSING ISOCC -> REVERSE GEOCODING..","info"),function(e,t){a(t[0],t[1],(function(t){t&&i.isoCC(e,t),--c||d()}))}(r,l(r.geometry.coordinates))))};for(var h in e[u])p(h)}c||d()},e}(),Lr=function(e){var t=e.class;return"NAVLINK"==t?"NAVLINK":String(t)+(e.src||e.base+e.delta||e.id)},br=function(e,t,r){var i=t.hooks;if(i)for(var n in i){var o=i[n];o instanceof Array||(o=[o]);for(var s=0,a=o;s<a.length;s++){var c=a[s];r.hooks[e](n,c,t)}}},Er=function(e){!function(e){var t,r,i=e.objects.history.getChanges(),n=[];for(var o in i)for(var s in r=e.getProviderById(o),i[o])t=r.search(s),r._clearOnCommit?(t&&delete t.properties["@ns:com:here:editor"],n.push(r,i[o][s].bbox)):t&&(t.properties["@ns:com:here:editor"]={});for(var a=0;a<n.length;a+=2)(r=n[a]).clear.apply(r,n[a+1])}(e),e.objects.history.clear(),e.display.refresh()},Pr=function(){function e(e,r){var i=this,n=(r=function(e){var r=t.extend(!0,{},gr);for(var i in e)switch(i){case"services":t.extend(!0,r[i],e[i]);break;case"editRestrictions":if("function"!=typeof e[i])break;default:r[i]=e[i]}return r}(r||{})).layers;delete r.layers,t.loglevel=r.debug&&"debug";var o=new vr(r,e);this._i=function(){return o},this.addHook=function(e,t,r){return o.hooks.add(e,t,r)},this.removeHook=function(e,t,r){return o.hooks.remove(e,t,r)},this.getHooks=function(e){return o.hooks.get(e)},_r(o),this.container=e.getContainer(),n instanceof Array&&n.forEach((function(e){return i.addLayer(e)})),this.active(!0),setTimeout((function(){var e=o.observers,t=e.get("active"),r=t;e.change("active",t,r),o.layers.length||e.change("ready",!0)}),0)}return e.prototype.active=function(e){var t=this._i(),r=t.observers.get("active");return null!=e&&(e=!!e)!=r&&(r=e,t.objects.listenDisplay(e),t.observers.change("active",e,!0)),r},e.prototype.addEventListener=function(e,r,i){var n=this._i().listeners,o=n.supported().filter((function(e){return"_"!=e[0]}));String(e).split(" ").forEach((function(e){o.indexOf(e)>-1?n.bind.call(n,e,r,i):t.dump(e+" is not a valid event. Use: "+o.join(", "),"warn")}))},e.prototype.removeEventListener=function(e,t){var r=this._i().listeners;r.remove.apply(r,arguments)},e.prototype.addFeature=function(e,t,r){var i,n,o=this._i(),s=arguments,a=[],c={},d={},l=function(e){return null!=e.x&&null!=e.y||null!=e.longitude&&null!=e.latitude},u=function(e,t){if(l(e)&&(e=o.map.getGeoCoord(e)),"number"==typeof e[0])return e[0]+=t[0],e[1]+=t[1],o.map.clipGeoCoord(e);for(var r=[],i=0;i<e.length;i++)r[i]=u(e[i],t);return r},p=function(e,t){var r=t&&t.id;(d[r]=d[r]||[]).push(e)};if("Feature"==e.type)p(e,t);else if(e instanceof Array)e.forEach((function(e){return p(e,t)}));else for(var h in d=e)"Feature"==(e=d[h]).type&&(d[h]=[e]);if(r=s[s.length-1],l(r)){r=o.map.getGeoCoord(r);var f=o.display.getViewBounds();n=[r[0]-f.minLon,r[1]-f.maxLat]}else n=[0,0];var v=function(e){d[e].forEach((function(t){var r=t.geometry;r.coordinates=u(r.coordinates,n),"Feature"!=t.type||t instanceof ot||(t=new ot(t)),(t=o.objects.add(t,"undefined"==e?void 0:e,c))&&(i=!0,a.push(t))}))};for(var g in d)v(g);return i&&o.objects.history.saveChanges(),a.length>1?this.createFeatureContainer.apply(this,a):a[0]},e.prototype.getFeature=function(e,t){return this._i().objects.get(e,t)||null},e.prototype.createFeatureContainer=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=new Kt(this._i());return r.push(e),r},e.prototype.clearFeatureSelection=function(){return this._i().objects.selection.clearSelected()||null},e.prototype.search=function(e){var t,r=this._i(),i=[];if("object"==typeof e)for(var n=e.filter,o=e.layers||r.layers,s=o.length;s--;){var a=o[s].search(e);a instanceof Array||(a=[a]);for(var c=a.length;t=a[--c];)n&&!n(t)||i.push(t)}return i},e.prototype.addLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=e.getProvider();if(i&&"FeatureProvider"==i.__type&&i.editable&&(!r[Lr(i)]||"NAVLINK"==i.class)){if(i._e instanceof vr){if(i._e===t)return!1;throw new Error("Provider already in use by another editor")}return i._e=t,e.class=i.class,t.listeners.trigger("_layerAdd",{layer:e}),r[Lr(i)]=e,t.layers.push(e),br("add",i,t),!0}}return!1},e.prototype.getLayers=function(e){var t=this._i().layers;return e?t[e]:t.slice()},e.prototype.removeLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=t.layers,n=e.getProvider(),o=Lr(n);if("FeatureProvider"==n.__type&&n.editable&&r[o])return t.listeners.trigger("_layerRemove",{layer:e}),delete r[o],i.splice(i.indexOf(e),1),br("remove",n,t),delete n._e,!0}return!1},e.prototype.addObserver=function(e,t){this._i().observers.addObserver(e,t,arguments[2])},e.prototype.get=function(e){return this._i().observers.get(e)},e.prototype.removeObserver=function(e,t){this._i().observers.removeObserver(e,t,arguments[2])},e.prototype.destroy=function(){var e=this,t=e._i();for(var r in e.getLayers().forEach((function(t){return e.removeLayer(t)})),e.active(!1),t.destroy(),e)delete e[r];return e.__proto__={},null},e.prototype.setZoomLevel=function(e){this._i().display.setZoomlevel(e)},e.prototype.getZoomLevel=function(){return this._i().display.getZoomlevel()},e.prototype.pixelToGeo=function(e){var t=this._i().map.getGeoCoord(e);return t?new u(t[0],t[1]):null},e.prototype.geoToPixel=function(e){var t=this._i().map.getPixelCoord(e);return t?new p(t[0],t[1]):null},e.prototype.revert=function(){for(var e=this._i(),t=e.observers.get("history.current");t--;)e.objects.history.recoverViewport(-1,!0);Er(e)},e.prototype.getDrawingBoard=function(){var e=this._i();return e._db=e._db||new gt(e)},e.prototype.getZoneSelector=function(){var e=this._i();return e._zs=e._zs||new Pt(e)},e.prototype.getOverlay=function(){return this._i().objects.overlay.layer},e.prototype.undo=function(e){for(e=Math.min(this.get("history.current"),e||1);e--;)this._i().objects.history.recoverViewport(-1,!!e)},e.prototype.redo=function(e){for(e=Math.min(this.get("history.length"),e||1);e--;)this._i().objects.history.recoverViewport(1,!!e)},e.prototype.submit=function(e){var t,r=!1,i=[],n=(e=e||{}).ignoreEventBlock,o=e.layer,s=e.onError,a=e.onSuccess,c=e.transactionId,l=this._i();if("function"==typeof n)throw new Error("Invalid parameter!");if(n||!l.isCommitInProcess){for(var u in o=o instanceof Array?o:[o]){var p=o[u];p&&p instanceof d&&"MARKER"==p.type&&(p.base&&i.push(p.base),p.delta&&i.push(p.delta),p.src&&i.push(p.src))}for(var h in t=l.objects.history.getChanges())i.length>0&&i.indexOf(h)<0?delete t[h]:r=!0;if(r)return l.objects.clear(),function(e,t,r,i,n){e.isCommitInProcess||(e.objects.selection.clearSelected(),e.observers.change("ready",e.isCommitInProcess),e.isCommitInProcess=!0,new xr(e).submit(t,(function(t){e.isCommitInProcess=!1,r.call(null,t)}),(function(t){e.isCommitInProcess=!1,i.call(null,t)}),n))}(l,t,(function(e){Er(l),a&&a({permanentIDMap:e})}),(function(e){s&&s(e)}),c),!0}return!1},e.prototype.info=function(){var e=[],r=this._i().objects.history.getChanges();for(var i in r)for(var n in r[i])e[e.length]=t.clone(r[i][n]);return e},e.prototype.export=function(){var e=this._i();return JSON.stringify(e.objects.history.getChanges())},e.prototype.import=function(e){var t=this._i();return"string"==typeof e&&(e=JSON.parse(e)),t.objects.history.import(e)},e.prototype.toGeoJSONCoordinates=function(e){if(Array.isArray(e)&&"number"!=typeof e[0]){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];t.push(this.toGeoJSONCoordinates(n))}return t}return this._i().map.getGeoCoord(e)},e}();Pr.prototype.clearObjectSelection=Pr.prototype.clearFeatureSelection;var Ir=function(e){function t(t,r){return e.call(this,t,r)||this}return f(t,e),t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t.prototype.getBBox=function(){var e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]},t.prototype.getLink=function(){var e=ke.getRoutingData(this),t=e.link;if(t){var r=ke.getRoutingProvider(this);t=r&&r.search(e.link)}return t||null},t}(ot),wr=function(e){function r(t,r){return e.call(this,t,r)||this}return f(r,e),r.prototype.createRoutingPoint=function(){ke.getRoutingData(this).link||(ke.connect(this),ke.getRoutingData(this).link&&ke.markAsModified(this))},r.prototype.removeRoutingPoint=function(){ke.getRoutingData(this).link&&(ke.disconnect(this),ke.markAsModified(this))},r.prototype.prop=function(e,r){var i=this,n=arguments.length,o=i.getProvider().getFeatureProperties(i),s=!1;if(!n||1==n&&"string"==typeof e)return null!=(e=e?o[e]:o)&&"object"==typeof e?t.extend(!0,new e.constructor,e):e;if(2==n){var a={};a[e]=arguments[1],e=a}for(var c in e){var d=e[c],l="object"==typeof d,u=o[c];(l&&JSON.stringify(d)!=JSON.stringify(u)||!l&&u!==d)&&(s||(i._e().objects.history.origin(i),s=!0),o[c]=d)}ke.getRoutingData(i).link?ke.connect(i,null):ke.disconnect(i),s&&(i._e().setStyle(i),ke.markAsModified(i))},r}(Ir);wr.prototype.class="PLACE";var Rr,Or=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return f(r,e),r.prototype.prop=function(e,r){var i=this,n=!1,o=arguments.length,s=i.getProvider().getFeatureProperties(i);if(!o||1==o&&"string"==typeof e)return null!=(e=e?s[e]:s)&&"object"==typeof e?t.extend(!0,new e.constructor,e):e;if(2==o){var a={};a[e]=arguments[1],e=a}for(var c in e){var d=e[c],l="object"==typeof d,u=s[c];(l&&JSON.stringify(d)!=JSON.stringify(u)||!l&&u!==d)&&(n||(i._e().objects.history.origin(i),n=!0),s[c]=d)}ke.connect(i,null),n&&(i._e().setStyle(i),ke.markAsModified(i))},r}(Ir);Or.prototype.class="ADDRESS",function(e){e.CROSSING="CROSSING",e.CROSSING_CANDIDATE="CROSSING_CANDIDATE"}(Rr||(Rr={}));var Fr="#FFFFFF",Nr="#FF0000",Dr={zIndex:0,type:"Line",stroke:Nr,strokeWidth:22,strokeLinecap:"round",opacity:.5},Br={zIndex:1,type:"Line",stroke:Fr,strokeWidth:18,strokeLinecap:"round",opacity:.8},Tr={zIndex:2,type:"Line",stroke:"#000000",strokeWidth:14,strokeLinecap:"round",opacity:.8},jr={zIndex:3,type:"Circle",stroke:Nr,strokeWidth:1,opacity:.5,radius:12,fill:Nr},Mr={zIndex:4,type:"Circle",stroke:Fr,strokeWidth:2,opacity:1,radius:10,fill:Fr},Gr={zIndex:5,type:"Circle",stroke:Fr,radius:3,fill:Fr};function Hr(e,t){for(var r=e.coord(),i=0;i<r.length;i++)if(t.x==r[i][0]&&t.y==r[i][1])return i;return E(r,[t.x,t.y])}var zr=function(){function e(e,t,r){this._={iEdit:e,xTest:t,x:r};var i=e.map.getPixelCoord(r.cx,r.cy);this.x=i[0],this.y=i[1];var n=r.searchPnt,o=r.foundPnt||n,s=!!r.foundPnt,a=e.display.geoToPixel(n.x,n.y),c=e.display.geoToPixel(o.x,o.y);this.distance=F([a.x,a.y],[c.x,c.y]),this.class=s?Rr.CROSSING_CANDIDATE:Rr.CROSSING,this.type="Feature",this.geometry=s?{type:"LineString",coordinates:[[n.x,n.y],[o.x,o.y]]}:{type:"Point",coordinates:[r.cx,r.cy]}}return e.prototype.getLinkIndex=function(){var e=this._.x;return Hr(e.link,e.searchPnt)},e.prototype.getCandidateIndex=function(){var e=this._.x;return Hr(e.candidate,e.foundPnt||e.searchPnt)},e.prototype.getRelatedLink=function(){return this._.x.candidate},e.prototype.connect=function(){var e=this.getRelatedLink(),t=this._,r=t.iEdit,i=t.xTest,n=this.getLink();if(!e.id||!n.id||e.editState("removed")||e.editState("modified")>i.createTS||n.editState("removed")||n.editState("modified")>i.createTS)return!1;var o,s,a=this.class==Rr.CROSSING_CANDIDATE,c=this.getCandidateIndex(),d=t.x.foundPnt||t.x.searchPnt,l=[];(a||(s=$e.addShp(n,r.map.clipGeoCoord([d.x,d.y]),null,!0)),o=a?this.getLinkIndex():s,!1!==this.getLinkIndex())&&(a&&n.getConnectedLinks(o).forEach((function(e){$e.markAsModified(e,!1,!1)})),($e.connectShpToLink(n,o,e,r.map.clipGeoCoord([d.x,d.y]),c,!0).splittedInto||[]).forEach((function(e){null!=e&&l.push(e)})));for(var u in this.hide(),this)"type"!==u&&(this[u]=void 0);return i.getCrossings({links:l,croLink:n})},e.prototype.show=function(){var e=this,t=this,r=t._,i=r.iEdit,n=r.xTest,o=i.objects.overlay,s=r.x.foundPnt||r.x.searchPnt,a=r.set=r.set||function(r,s,a,c){var d=n.cStyles,l=e._.iEdit.getStyle(a)[0].stroke,u=e._.iEdit.getStyle(c)[0].stroke,p=function(e){return o.addPath([[r.x,r.y],[s.x,s.y]],e)},h=function(e,t){return o.addCircle([e.x,e.y],t)},f=function(e){return i.listeners.trigger(e,t)};if(l&&u){var g=[p(v(v({},Dr),d.connector1)),p(v(v({},Br),d.connector2)),p(v(v({},Tr),d.connector3)),h(r,v(v({},jr),d.search1)),h(r,v(v(v({},Mr),{fill:l}),d.search2)),h(s,v(v(v({},Gr),{fill:u,stroke:u}),d.found))];return g.forEach((function(e){return e.pointerup=f})),g}}(r.x.searchPnt,s,this.getLink(),this.getRelatedLink());i.objects.overlay.showFeature(a)},e.prototype.hide=function(){var e=this._,t=e.set;t&&t.forEach((function(e){e._provider.removeFeature(e)})),e.set=null},e.prototype.getLink=function(){return this._.x.link},e.prototype.getConnectedLinks=function(){return this.class==Rr.CROSSING_CANDIDATE?this.getLink().getConnectedLinks(this.getLinkIndex()):[]},e}();function Kr(t,r){var i,n,o,s,a=this,c=[],d=[];function l(e,r,i,n){var o=this,s=null,c=n||i;o.candidate=r,o.link=e,o.foundPnt=n,o.searchPnt=i,o.distance=n?F([i.x,i.y],[n.x,n.y]):0,o.cx=(c.x-i.x)/2+i.x,o.cy=(c.y-i.y)/2+i.y,o.getSimplified=function(){return s||(s=new zr(t,a,o))}}function u(e,r,i){var n=[],o=e.coord();function s(r){for(var i=!1,n=[],s=function(e,t){for(var r,i=[],n=0;n<e.length-1;n++)for(var o=0;o<t.length-1;o++)(r=P(e[n],e[n+1],t[o],t[o+1],!0))&&(r.s1=n+1,r.s2=o+1,i.push(r));return i}(o,r.coord()),c=0,d=0,u=s.length;c<u-1;d=++c)for(var p=s[c],h=void 0;++d<u;)h=s[d],p[0]==h[0]&&p[1]==h[1]&&Math.abs(h.s1-p.s1)<=1&&Math.abs(h.s2-p.s2)<=1&&(s.splice(d--,1),u--);for(c=0;c<s.length;c++){i=!1;for(var f=0,v=void 0;f<a.length;f++)if((v=a[f]).link.id==r.id&&Ye.isIntersection(t,s[c],v.link.coord()[v.index])){i=!0;break}i||n.push(new l(e,r,{x:s[c][0],y:s[c][1]}))}return n}if(!e.editState("removed")){var a=e.getConnectedLinks(0,!0).concat(e.getConnectedLinks(o.length-1,!0));i.forEach((function(e){n=n.concat(s(e))}))}return n}function p(r){var s,c=[];a.createTS=+new Date,(null==r.length?[r]:r).forEach((function(r){if(!(r.editState("removed")||o&&"CROSSING"!=o&&"CROSSING_CANDIDATE"!=o)){var a=e.extendBBox(r.getBBox(),i),d=t.objects.getInBBox(a,r.getProvider()),p=d.indexOf(r);-1!=p&&d.splice(p,1),"CROSSING_CANDIDATE"!=o&&(c=c.concat(u(r,0,d))),"CROSSING"!=o&&r.coord().forEach((function(e,o){(s=function e(r,o,s,a){var c,d,l;if(void 0===s)for(var u in c=r.getConnectedLinks(o,!0),s=[r.id],c)s.push(c[u].link.id);return d=r.coord(),null!=(l=t.objects.getNearestLine(d[o],a,{ignore:s,maxDistance:i,shapeThreshold:n,onlyExsitingShape:!1}))&&function(e,t){for(var r in e)if(-1!=t.indexOf(e[r].link.id))return!0;return!1}(l.line.getConnectedLinks(l.shpIndex,!0),s)?(s.push(l.line.id),e(r,o,s,a)):l}(r,o,void 0,d))&&c.push(new l(r,s.line,{x:e[0],y:e[1],index:o},{x:s.point[0],y:s.point[1],index:s.shpIndex}))}))}}));for(var d=0,p=void 0;d<(p=c.length);d++)for(;d<--p;)c[d].cx==c[p].cx&&c[d].cy==c[p].cy&&c[d].candidate==c[p].candidate&&0==c[p].distance&&c[p].foundPnt&&c[d].searchPnt.x==c[p].searchPnt.x&&c[d].searchPnt.y==c[p].searchPnt.y&&c.splice(p,1);return c}a.getRelatedLink=function(){return r},a.setRelatedLink=function(e){e&&(s=[r=e])},a.setRelatedLink(r),a.clear=function(){a.createTS=0,d.forEach((function(e){e.hide&&e.hide()})),c.length=0,d.length=0},a.getCrossings=function(e,l){return e=e||{},a.setRelatedLink(l),e.links?e.croLink&&e.links.length&&(s=s.concat(e.links)):(o==e.class&&i==e.maxDistance||(a.createTS=0),a.cStyles=e.styles||{},o=e.class),i=e.maxDistance||t._config.XTestMaxDistance||3,n=t._config.minShapeDistance,(!a.createTS||r.editState("modified")>a.createTS||e.links)&&(a.clear(),c=p(s)),d.length=0,c.forEach((function(e,t){d[t]=e.getSimplified()})),d}}var Vr,Ur=function(e){return e.getProvider().readPedestrianOnly(e)},Yr=function(e){return e.getProvider().readDirection(e)},Qr=function(e,t,r,i){var n=Yr(r);return r.getZLevels()[i]===e.getZLevels()[t]&&("BOTH"==n||(0==i?"START_TO_END":"END_TO_START")==n)},Wr=function(){function t(t,r,i,n,o,s){var a=t.objects.overlay,c=0==o?1:n.coord().length-2,d=n.coord(),l=d[o].slice(),u=d[c].slice(),p=b(l,u,8e-5),h=function(e,t,r,i){var n=function(e,t,r,i){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:i})}(e,t,r,i);return Qr(e,t,r,i)?n?"FORBIDDEN":Ur(r)?"PEDESTRIAN":"ALLOWED":"ONEWAY"}(r,i,n,o),f=a.addPath([p,l,s],null,{type:"TURN_RESTRICTION_LINE",sign:"TURN_RESTRICTION_"+h}),v=a.addImage(p,null,{type:"TURN_RESTRICTION_"+h,rotation:-e.calcBearing(l,p)});this.sign=v,this.line=f,this.overlay=a,this.to=n,this.from=r,Ye.showDirection(n),a.remove(f),v.pointerenter=function(){a.addFeature(f)},v.pointerleave=function(){a.remove(f)},v.pointerup=function(){Qr(r,i,n,o)&&!Ur(n)&&(t.objects.history.ignore((function(){!function(e,t,r,i,n){t.getProvider().writeTurnRestriction(e,{index:r,link:t},{index:n,link:i})}("ALLOWED"==h,r,i,n,o)})),h="ALLOWED"==h?"FORBIDDEN":"ALLOWED",t.objects.history.saveChanges()&&(v.properties.type="TURN_RESTRICTION_"+h,f.properties.sign=v.properties.type,t.setStyle(v),t.setStyle(f)))}}return t.prototype.hide=function(){Ye.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null},t}();!function(e){e.BOTH="BOTH",e.FROM_RN="START_TO_END",e.TO_RN="END_TO_START"}(Vr||(Vr={}));var Jr=function(){function t(e,t){var r=this,i=e._e();this._overlay=i.objects.overlay,this._trs=[];var n=function(){r.hide(),i.listeners.remove("_clearOverlay",n)};i.listeners.bind("_clearOverlay",n),this._l=e,this._i=t,this.show()}return t.prototype._hideOrigin=function(){this._origin&&this._overlay.remove(this._origin),this._origin=null},t.prototype._showOrigin=function(t,r){var i=t.coord(),n=0==r?1:i.length-2,o={geometry:{coordinates:b(i[r],i[n],1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:-e.calcBearing(i[r],i[n])}};this._origin=this._overlay.addFeature(o)},t.prototype.show=function(){var e=this,t=this._l,r=this._i,i=Yr(t),n=0==r?Vr.FROM_RN:Vr.TO_RN;if(!(i!=Vr.BOTH&&n==i||Ur(t))){var o=t.getConnectedLinks(r,!0);o.length&&this._showOrigin(t,r),this._trs=o.map((function(i){return new Wr(t._e(),t,r,i.link,i.index,e._origin.geometry.coordinates)}))}},t.prototype.hide=function(){var e=this._trs;for(var t in e)e[t].hide(),e[t]=null;e.length=0,this._hideOrigin()},t.prototype.isActive=function(){return this._trs.length>0},t}(),Zr=function(){function t(t,r,i,n){var o=r.coord(),s="END_TO_START"==i?180:0,a=[];n||a.push(t.addPoint(o[0].slice(),{type:"NAVLINK_DIRECTION_HINT_A"}),t.addPoint(o[o.length-1].slice(),{type:"NAVLINK_DIRECTION_HINT_B"}));for(var c=0;c<o.length-1;c++){var d=o[c],l=o[c+1],u={type:"BLOCKED"==i?"NAVLINK_DIRECTION_HINT_BLOCKED":"BOTH"==i?"NAVLINK_DIRECTION_HINT_2WAY":"NAVLINK_DIRECTION_HINT_1WAY"};"BLOCKED"!=i&&(u.bearing=s-e.calcBearing(d,l)),a.push(t.addPoint(w(d,l,.5),u))}this.overlay=t,this.points=a}return t.prototype.destroy=function(){this.overlay.remove(this.points),this.points=null},t}(),Xr=function(e){throw new Error(e)},qr=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.setGeoFence=function(e){(isNaN(e)||e<0)&&Xr("Geofence radius should be a positive Number"),t._e()._config.geoFence=+e},t}return f(r,e),r.prototype.coord=function(t){return e.prototype.coord.call(this,t)},r.prototype.checkCrossings=function(e){var t=Ye.private(this),r=t.xt||new Kr(this._e(),this);return t.xt=r,r.getCrossings(e)},r.prototype.showDirectionHint=function(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;var r=Ye.private(this),i=r.dh;i&&i.destroy(),r.dh=e&&new Zr(this._e().objects.overlay,this,e,t)},r.prototype.addShape=function(e,t){var r=!1,i=this._e().map.getGeoCoord(e);return i?!1!==(r=Ye.addShp(this,i,t,void 0,!0))&&Ye.markAsModified(this):Xr("Invalid coordinate"),r},r.prototype.getConnectedLinks=function(e,t){void 0===t&&(t=!1);var r,i,n=this._e(),o=this.coord(),s=o[e],a=[];if(0==e||e==o.length-1)for(var c=0,d=n.objects.getInBBox(this.bbox,this.getProvider());c<d.length;c++){var l=d[c];l.id!=this.id&&"NAVLINK"==l.class&&(i=(r=l.coord()).length-1,null!=(e=Ye.isIntersection(n,r[0],s)?0:Ye.isIntersection(n,r[i],s)?i:null)&&a.push(t?{index:e,link:l}:l))}return a},r.prototype.getZLevels=function(e){var t=this.getProvider().readZLevels(this);return"number"==typeof e?t[e]:t.slice(0)},r.prototype.setZLevels=function(e){var t=this,r=t.getZLevels(),i=t._e().objects.history,n=t.geometry.coordinates.length;e instanceof Array||Xr("Invalid 'zlevel' argument given, no array"),e.length!==n&&Xr("Given 'zlevel' argument is of an invalid size, a length of "+n+" is required!"),i.origin(t);for(var o=!1,s=0,a=void 0;s<e.length;s++)(a=0^e[s])!=r[s]&&(e[s]=a,o=!0);o&&(i.ignore((function(){t.getProvider().writeZLevels(t,e)})),Ye.refreshGeometry(this),Ye.markAsModified(this))},r.prototype.editTurnRestrictions=function(e){var t=this,r=t.coord(),i=t._e(),n=0==e||e==r.length-1?[e]:void 0===e?[0,r.length-1]:[];i.listeners.trigger("_clearOverlay");var o=n.map((function(e){return new Jr(t,e)}));return void 0===e?o:o[0]},r.prototype.prop=function(e,r){var i=this,n=i._e(),o=!1,s=arguments.length,a=i.getProvider().getFeatureProperties(i);if(0==s||1==s&&"string"==typeof e){var c=e?a[e]:a;return"object"==typeof c?t.extend(!0,new c.constructor,c):c}var d=e;if(2==s){var l={};l[e]=arguments[1],d=l}for(var u in d){var p=d[u],h="object"==typeof p,f=a[u];(h&&JSON.stringify(p)!=JSON.stringify(f)||!h&&f!==p)&&(o||(n.objects.history.origin(i),o=!0),a[u]=p)}o&&(n.setStyle(i),i.editState("selected")&&Ye.showDirection(i),Ye.markAsModified(i))},r}(ot);qr.prototype.class="NAVLINK";var $r=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return f(t,e),t.prototype.addShape=function(e,t){var r=this._e().map.getGeoCoord(e);return r?((t=ae.addCoord(this,r,t))&&ae.markAsModified(this),t):(function(e){throw new Error(e)}("Invalid coordinate"),!1)},t.prototype.coord=function(t){return e.prototype.coord.call(this,t)},t}(ot);$r.prototype.class="LINE";var ei=function(e){throw new Error(e)},ti=function(e){for(var t,r=[],i=0;i<e.length;i++)for(var n=e[i],o=r[r.length]=[],s=0;s<n.length;s++)o[s]=3==(t=n[s]).length?[t[0],t[1],t[2]]:[t[0],t[1]];return r},ri={snapCoordinates:!0},ii=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return f(t,e),t.prototype.addShape=function(e,t,r){var i=!1,n=this._e().map.getGeoCoord(e);return e?(1==arguments.length&&(t=q.getPoly(this,n)),!1!==(i=q.addShp(this,n,0^t,0,r))&&q.markAsModified(this)):ei("Invalid coordinate"),i},t.prototype.addHole=function(e){var t=this;if(e){e=this._e().map.getPixelCoord(e);for(var r=q.getPoly(this,e),i=q.getCoords(this),n=i[r],o=1/0,s=0;s<n.length;s++){var a=q.getMaxSpace(this,e,n[s]);a<o&&(o=a)}if(o!=1/0&&(o=Math.floor(.5*o))>8){var c=e[0],d=e[1],l=[[c-o,d+o],[c+o,d+o],[c+o,d-o],[c-o,d-o],[c-o,d+o]].map((function(e){return t._e().map.getGeoCoord(e)}));return q.isClockwise(n[0])||l.reverse(),n.push(l),q._setCoords(this,i,!0),q.markAsModified(this),!0}return!1}},t.prototype.behavior=function(e,t){var r=q.private(this,"b")||v({},ri);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];r=v(v({},r),e);break;case 2:r[e]=t}this.__.b=r},t.prototype.coord=function(e){var t,r=this.geometry.type;if(e instanceof Array)q.deHighlight(this),q._setCoords(this,e),q.markAsModified(this);else if(e=this.getProvider().decCoord(this),"Polygon"==r)t=ti(e);else{t=[];for(var i=0;i<e.length;i++)t[i]=ti(e[i])}return t},t}(ot);ii.prototype.class="AREA";var ni=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return f(t,e),t}(ot);ni.prototype.class="MARKER";var oi={};oi.NAVLINK="Navlink",oi.AREA="Area",oi.PLACE="Place",oi.ADDRESS="Address",oi.MARKER="Marker",oi.LINE="Line";for(var si=function(){function e(e){var r=function(e){if("number"==typeof(null!=e.x?e.x:null!=e.longitude?e.longitude:e[0]))return e;for(var t=[],i=0,n=e;i<n.length;i++){var o=n[i];t[t.length]=r(o)}return t};function i(i,n,o){"number"!=typeof i&&"string"!=typeof i?(o=n,n=i):this.id=i,this.type="Feature",this.class=e,this.properties=t.extend({"@ns:com:here:editor":new rt},o||{}),this.geometry={type:"PLACE"==e||"ADDRESS"==e||"MARKER"==e?"Point":"AREA"==e?"MultiPolygon":"LineString",coordinates:r(n)}}return i.prototype=ot.prototype,i}var r={};for(var i in oi)r[oi[i]]=e(i);return r}(),ai="here.xyz.maps.editor".split("."),ci=r,di=0;di<ai.length-1;di++)ci=ci[ai[di]]=ci[ai[di]]||{};var li=ci[ai.pop()]={Editor:Pr,features:si,PixelCoordinate:function(e,t,r){this.x=e,this.y=t,this.z=r||0},GeoCoordinate:function(e,t,r){this.longitude=e,this.latitude=t,this.z=r||0}};r.here.xyz.maps.providers.EditableFeatureProvider.prototype.getFeatureClass=function(e){switch(this.detectFeatureClass(e)){case"NAVLINK":return qr;case"PLACE":return wr;case"ADDRESS":return Or;case"AREA":return ii;case"MARKER":return ni;case"LINE":return $r;default:return this.Feature}};export default li;export{Or as Address,ii as Area,z as AreaShape,zr as Crossing,rt as DefaultEditorProperties,Pr as Editor,st as EditorEvent,ot as Feature,$r as Line,$ as LineShape,ni as Marker,qr as Navlink,Fe as NavlinkShape,wr as Place,si as features};
