/*
 * @here/xyz-maps-editor
 * (c) 2019-2021 HERE
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@here/xyz-maps-common"),require("@here/xyz-maps-core")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common","@here/xyz-maps-core"],t):t(((e=e||self).here=e.here||{},e.here.xyz=e.here.xyz||{},e.here.xyz.maps=e.here.xyz.maps||{},e.here.xyz.maps.editor={}),e.here.xyz.maps.common,e.here.xyz.maps)}(this,function(e,I,w){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)};function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var o,v=function(){return(v=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function c(e,t,r){e._e().listeners.trigger(t,e,r)}function l(e,t){var r=(r=e.__)||(e.__={isEditable:!0});return t?r[t]:r}function S(e,t,r){var i,o=(i=e,o=t[0]-i[0],i=t[1]-i[1],(o||i?(180+180*h.atan2(i,o)/s)%360:0)-180)*s/180;return[e[0]+(r||0)*h.cos(o),e[1]+(r||0)*h.sin(o)]}function p(e,t,r){return[(t[0]-e[0])*r+e[0],(t[1]-e[1])*r+e[1]]}function a(e,t){for(var r,i,o,n,s,a,c,l,d=1/0,p=t.length-1,u=0;u<p;u++){var h=(r=e,h=t[u],i=t[u+1],l=c=a=s=n=o=void 0,o=r[0],n=r[1],s=h[0],a=h[1],c=i[0],l=i[1],_([o,n],h=(i=((o-s)*(r=c-s)+(n-a)*(h=l-a))/(r*r+h*h))<0?[s,a]:1<i?[c,l]:[s+i*r,a+i*h]));h<d&&(d=h)}return d}var x,n={private:l,_evl:{pointerdown:function(){var e=l(this);e.moved=!1,e.pdm=[0,0]},pointerup:function(e){var t=l(this),r=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?n._select(this):r&&n.markAsModified(this),c(this,e,r?"dragStop":"pointerup")},pointerenter:function(e){this._e().listeners.trigger(e,this)},pointerleave:function(e){this._e().listeners.trigger(e,this)}},deHighlight:function(e){var t=l(e);t.selector&&(e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=o,t.pressmove=o)},_editable:function(e,t){var r=l(e);return t!=o&&(r.isEditable=!!t),n.deHighlight(e),r.isEditable},_select:function(n){var s,a=n._e();a.objects.selection.select(n)&&((s=l(n)).pressmove=function(e,t,r,i,o){s.isEditable&&s.isSelected&&!a._config.editRestrictions(n,1)&&(a.map.pixelMove(n,t-s.pdm[0],r-s.pdm[1]),s.pdm[0]=t,s.pdm[1]=r,c(n,e,s.moved?"dragMove":"dragStart"),s.moved=!0)},s.selector||(s.selector=a.objects.overlay.addCircle(n.coord(),o,{type:"MARKER_SELECTOR"})))},_setCoords:function(e,t){e._e().objects.history.origin(e);var r=l(e,"selector");r&&r._provider.setFeatureCoordinates(r,t),e._provider.setFeatureCoordinates(e,t.slice())},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),n.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),t!=o&&!t||e._e().objects.history.saveChanges(),e}},h=Math,s=h.PI,f=h.pow,g=h.sqrt,A=function(e,t,r,i,o){void 0===i&&(i=e.length),void 0===o&&(o=[]);var n=0,s=0;i--;for(var a,c,l,d,p=(r=void 0===r?0:r)+1;p<i;p++){var u=(a=e[r],c=e[i],l=e[p],u=d=u=void 0,u=(c[1]-a[1])/(c[0]-a[0]),d=a[1]-u*a[0],u=h.abs(l[1]-u*l[0]-d)/g(f(u,2)+1),(a=_(l,a))<u&&(u=a),u=(a=_(l,c)<u)?a:u);n<u&&(s=p,n=u)}return t<n?(A(e,t,r,s,o),A(e,t,s,i+1,o)):(o.push(e[r]),0<i-r&&o.push(e[i])),o},y=function(e,t){for(var r=999999,i=!1,o=0;o<e.length-1;o++){var n=R(e[o],e[o+1],t);!n||(n=_(n,t))<r&&(r=n,i=o)}return i},m=function(e,t,r,i,o){var n=(i[1]-r[1])*(t[0]-e[0])-(i[0]-r[0])*(t[1]-e[1]);if(0!=n){i=((i[0]-r[0])*(e[1]-r[1])-(i[1]-r[1])*(e[0]-r[0]))/n,n=((t[0]-e[0])*(e[1]-r[1])-(t[1]-e[1])*(e[0]-r[0]))/n;if(0<=i&&i<=1&&0<=n&&n<=1)return!o||[e[0]+i*(t[0]-e[0]),e[1]+i*(t[1]-e[1])]}return!1},R=function(e,t,r){if(e[0]==t[0]){var i=[e[0],r[1]];return!!k(e,t,i)&&i}if(e[1]==t[1]){var o=[r[0],e[1]];return!!k(e,t,o)&&o}var n=(t[1]-e[1])/(t[0]-e[0]),i=e[1]-n*e[0],o=-1/n,o=(r[1]-o*r[0]-i)/(n-o),i=[o,n*o+i];return!!k(e,t,i)&&i},_=function(e,t){return g(f(e[0]-t[0],2)+f(e[1]-t[1],2))},k=function(e,t,r,i){var o=r[0]-e[0],n=r[1]-e[1],r=t[0]-e[0],t=t[1]-e[1],e=(o*r+n*t)/(r*r+t*t);return(e=(r=o-(e=e<0?0:1<e?1:e)*r)*r+(t=n-e*t)*t)<(i=i||1e-7)*i},C=function(e){for(var t=0,r=0;r<e.length-1;r++)t+=_(e[r],e[r+1]);return t},b=function(e,t){for(var r,i,o,n=0,s=0;s<e.length-1;s++)if(r=e[s],i=e[s+1],t<=(n+=o=_(r,i)))return[(i[0]-r[0])*(o=(t-(n-o))/o)+r[0],(i[1]-r[1])*o+r[1]];return i};function L(e,t){for(var r=0,i=e.length-1;r<i;r++)if(function(e,t,r){for(var i=0,o=r.length-1;i<o;i++)if(m(e,t,r[i],r[i+1]))return 1}(e[r],e[r+1],t))return 1}function E(e,t,r){for(var i=0^r,o=e.length;i<o;i++)for(var n=0;n<e[i].length;n++)if(!function(e,t){for(var r=e[0],i=e[1],o=!1,n=0,s=t.length-1;n<t.length;s=n++){var a=t[n][0],c=t[n][1],l=t[s][0],d=t[s][1];i<c!=i<d&&r<(l-a)*(i-c)/(d-c)+a&&(o=!o)}return o}(e[i][n],t))return 0;return 1}function P(e,t,r,i,o){void 0===i&&(i=0),void 0===o&&(o=0);var n=x.getCoords(e),s=n[o],a=(o=s[i])[r];if(!x.willSelfIntersect(o,t,r)){if(o[r]=t,r||(o[o.length-1]=t),!function(e,t,r){for(var i=0,o=t.length;i<o;i++)if(i!=r&&L(e,t[i]))return 1}(o,s,i)&&E(s,s[0],1)){var s=x.private(e,"shapePnts"),c=x.getConnectedAreas(e,a);if(e.behavior("snapCoordinates"))for(var l=0;l<c.length;l++){var d=c[l],p=d.coordinates,u=d.polyIndex,h=d.lineIndex,f=d.coordIndex,u=p[u],h=u[h];if(d.area.behavior("snapCoordinates")){if(h[f][0]=t[0],h[f][1]=t[1],f||(h[h.length-1]=t),!(!x.willSelfIntersect(h,t,f)&&E(u,u[0],1)))return}else p.splice(l,1)}for(var g=0,v=c;g<v.length;g++){var A=v[g],y=A.area,A=A.coordinates;x._setCoords(y,A,!1)}x._setCoords(e,n,!1);for(var m=0,S=s;m<S.length;m++){var _=S[m],k=_.geometry.coordinates;k[0]==a[0]&&k[1]==a[1]&&_.getProvider().setFeatureCoordinates(_,t.slice())}}return 1}}var u,d=(t(r,u=w.Feature),r.prototype.getArea=function(){return this.__.area},r.prototype.remove=function(){return x.deleteShape(this.getArea(),this)},r.prototype.getIndex=function(){return this.properties.index},r.prototype.removeGeometry=function(){var e=this.getArea(),t=this.properties.poly,r=this.properties.hole,i=e.coord();i[t].splice(r,1),x._setCoords(e,i,!1),x.deHighlight(e),x._select(e),x.markAsModified(e)},r);function r(g,e,t,r,i){var o=this;x=i;var v,A=g._e(),r={type:"Feature",geometry:{type:"Point",coordinates:[e,t]},properties:{type:"AREA_SHAPE",poly:r[0],index:r[1],hole:r[2],AREA:{style:A.getStyle(g)}}},y=o=u.call(this,r,A.objects.overlay.layer.getProvider())||this,c=A.objects.overlay;function n(e){var t=this.properties["@ns:com:here:editor"],t="pointerleave"==e.type?(delete t.hovered,"default"):(t.hovered=!0,"move");document.body.style.cursor=t,A.setStyle(this)}function m(e,t){A.listeners.trigger(e,y,t)}var S=!1,l=0,d=0;return o.__={area:g,pointerdown:function(){S=!1,d=l=0},pressmove:function(e,t,r,i,o){S||(S=!0,x.hideShape(x.private(g,"midShapePnts"),c),m(e,"dragStart"));var n=y.getIndex(),s=y.properties.poly,a=y.properties.hole,e=A.map.translateGeo(this.geometry.coordinates,t-l,r-d);P(g,e,n,a,s)&&(l=t,d=r)},pointerup:function(e){if(S){if(g.behavior("snapCoordinates")){for(var t,r,i=A.cfg("autoConnectShapeDistance"),o=I.geotools.extendBBox(this.bbox,i),n=void 0,s=0,a=A.getLayer(g).search({rect:o});s<a.length;s++){var c=a[s];if("AREA"==c.class&&c!=g)for(var l=0,d=x.getCoords(c);l<d.length;l++)for(var p=0,u=d[l][0];p<u.length;p++){var h=u[p],f=I.geotools.distance(this.geometry.coordinates,h);f<i&&(n=h,i=f)}}n&&(t=y.getIndex(),r=y.properties.poly,o=y.properties.hole,P(g,n.slice(),t,o,r))}x.markAsModified(g)}x.addVShapes(g),m(e,S?"dragStop":v)},pointerenter:n,pointerleave:n},y}d.prototype.class="AREA_SHAPE";var O,F=(t(N,O=w.Feature),N);function N(h,e,t,r,f){var g,i=this,o=h._e(),n=o.objects.overlay,r={type:"Feature",geometry:{type:"Point",coordinates:[e,t]},properties:{type:"AREA_VIRTUAL_SHAPE",poly:r[0],index:r[1],hole:r[2],AREA:{style:o.getStyle(h)}}},v=i=O.call(this,r,n.layer.getProvider())||this;function s(e){var t=this.properties["@ns:com:here:editor"],t="pointerleave"==e.type?(delete t.hovered,"default"):(t.hovered=!0,"move");document.body.style.cursor=t,o.setStyle(this)}return v.__={pointerdown:function(){g=!1},pressmove:function(e,t,r,i,o){var n=v.properties,s=n.index+1,a=n.poly,c=v.geometry.coordinates;if(!g){g=!0;for(var l,d,p=f.private(h,"midShapePnts"),u=0;u<p.length;u++)(l=(d=p[u]).geometry.coordinates)[0]==c[0]&&l[1]==c[1]&&(d=d.properties,f.addShp(h,c.slice(),d.poly,d.hole,d.index+1));g=f.getShp(h,a,n.hole,s)}g.__.pressmove.apply(g,arguments)},pointerup:function(e){var t,r,i;g&&(t=(i=v.properties).poly,r=i.hole,i=i.index,(i=f.getShp(h,t,r,i+1)).__.pointerup.call(i,e))},pointerenter:s,pointerleave:s},i}function D(e,t){var r=(r=e.__)||(e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]});return t?r[t]:r}function B(e){var t=D(e),e=e._e().objects.overlay;V.hideShape(t.shapePnts,e),V.hideShape(t.midShapePnts,e)}function M(e,t,r,i){for(var o=e._e().objects.overlay,n=0;n<r.length;n++)for(var s=r[n],a=0;a<s.length-1;a++){var c=i(s[a],s[a+1],a,n);o.addFeature(c),t.push(c)}}function j(n){for(var e=D(n,"shapePnts"),t=V.getCoords(n),r=0;r<t.length;r++)!function(o){M(n,e,t[o],function(e,t,r,i){return new d(n,e[0],e[1],[o,r,i],V)})}(r)}function T(n){for(var e=D(n,"midShapePnts"),t=V.getCoords(n),r=0;r<t.length;r++)!function(o){M(n,e,t[o],function(e,t,r,i){return new F(n,(e[0]+t[0])/2,(e[1]+t[1])/2,[o,r,i],V)})}(r)}function G(e){D(e,"isSelected")&&(B(e),j(e),T(e))}function H(e){var t=this,r=D(t);r.allowEdit&&!r.isSelected&&(t._e().listeners.trigger(e,t),t.editState("hovered","pointerenter"==e.type),t._e().setStyle(this))}function z(e){var t=D(this);t.isSelected||this._e()._config.featureSelectionByDefault&&t.allowEdit&&V._select(this),this._e().listeners.trigger(e,this)}var U,K,V={private:D,_evl:{pointerenter:H,pointerleave:H,dbltap:z,pointerup:z},deHighlight:function(e){var t=D(e);t.isSelected&&(B(e),e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),t.isSelected=!1)},_editable:function(e,t){var r=D(e);t&&t!=r.allowEdit?document.body.style.cursor="pointer":t||t==r.allowEdit||(V.deHighlight(e),document.body.style.cursor="default"),r.allowEdit=t},_select:function(e){var t=D(e);t.isSelected||(e._e().objects.selection.select(e),e._e().dump(e,"info"),t.isSelected=!0,e.editState("selected",!0),e._e().setStyle(e),G(e))},_setCoords:function(e,t,r){for(var i=(t="number"==typeof t[0][0][0]?[t]:t).length;i--;)for(var o=t[i],n=o.length;n--;){var s=o[n];s[s.length-1]=s[0]}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),e._provider.setFeatureCoordinates(e,t),r&&G(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),V.deHighlight(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),!t&&void 0!==t||e._e().objects.history.saveChanges(),e},deleteShape:function(e,t){var r=t.properties,i=V.getCoords(e),r=i[r.poly][r.hole];return!(r.length<=4)&&(r.splice(t.getIndex(),1),V._setCoords(e,i),V.deHighlight(e),V._select(e),V.markAsModified(e),!0)},getCoords:function(e){var t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:function(e){for(var t,r=0,i=0,o=e.length-1;i<o;i++)r+=e[i][0]*e[t=(i+1)%o][1],r-=e[t][0]*e[i][1];return r<0},getMaxSpace:function(e,t,r){for(var i=e._e(),o=t[0],e=t[1],n=[[o+(s=1e5),e-s],[o-s,e+s],[o+s,e+s],[o-s,e-s]],s=1/0,a=0,c=r.length-1;a<c;a++)for(var l=(a+1)%c,d=i.map.getPixelCoord(r[a]),p=i.map.getPixelCoord(r[l]),u=0;u<4;){var h=m(n[u++],n[u++],d,p,!0);!h||(h=_(t,h))<s&&(s=0^h)}return s},getPoly:function(e,t){for(var r,i=V.getCoords(e),o=1/0,n=null,s=0;s<i.length;s++)(r=a(t,i[s][0]))<o&&(o=r,n=s);return n},addVShapes:T,getShp:function(e,t,r,i){for(var o,n=D(e,"shapePnts"),s=0;s<n.length;s++)if((o=n[s].properties).poly==t&&o.index==i&&o.hole==r)return n[s]},addShp:function(e,t,r,i,o){for(var n=V.getCoords(e),s=n[r][i],o="number"==typeof o?o:y(s,t)+1,a=0;a<s.length;a++)if(s[a][0]==t[0]&&s[a][1]==t[1])return!1;return s.splice(o,0,t),V._setCoords(e,n),G(e),o},hideShape:function(e,t){e instanceof Array||(e=[e]);for(var r=0;r<e.length;r++)t.remove(e[r]);e.length=0},willSelfIntersect:function(e,t,r){for(var i=0==r?e.length-2:r-1,o=r+1,n=0,s=void 0,a=e.length-1;n<a;n++){if(s=n+1,o==a){if(n&&n<i&&m(t,e[o],e[n],e[n+1]))return!0}else if(n!=o&&r!=(s%=a)&&n!=r&&m(t,e[o],e[n],e[s]))return!0;if(r<n){if((s%=a)!=i&&n!=i&&m(e[i],t,e[n],e[s]))return!0}else if(s<i&&n!=r&&m(e[i],t,e[n],e[s]))return!0}return!1},validateGeometry:function(e){for(var t=1;t<e.length-1;t+=1)if(V.willSelfIntersect(e,e[t],t))return!1;return!0},getConnectedAreas:function(e,t){for(var r=[],i=e._e(),o=i.getLayer(e),n=function(e){return Math.round(1e9*e)},s=n(t[0]),a=n(t[1]),c=i.objects.getInBBox([t[0],t[1],t[0],t[1]],o),l=c.length;l--;)for(var d=c[l],p=V.getCoords(d),u=p.length;u--;)for(var h=p[u].length;h--;)for(var f=p[u][h],g=f.length-1;g--;)n(f[g][0])==s&&n(f[g][1])==a&&d!=e&&r.push({area:d,polyIndex:u,lineIndex:h,coordIndex:g,coordinates:p});return r}},J=(t(Y,K=w.Feature),Y.prototype.getLine=function(){return this._l},Y.prototype.getLength=function(){return this._l.geometry.coordinates.length},Y.prototype.getIndex=function(){return this.properties.index},Y.prototype.remove=function(){U.removeCoord(this.getLine(),this.properties.index)},Y.prototype.pointerdown=function(e){var t=this.properties,r=this.geometry.coordinates,e=e.detail.display;t.moved=!1;r=e.geoToPixel.apply(e,r);t.x=r.x,t.y=r.y,U.removeShapes(this.getLine(),"vShps","LINE_VIRTUAL_SHAPE"==this.class&&this)},Y.prototype.pressmove=function(e,t,r){var i=e.detail.display,o=this.properties,n=i.pixelToGeo(o.x+t,o.y+r),i=n.longitude,t=n.latitude,r=this.getLine(),n=r.coord();o.moved||(o.moved=!0,r._e().listeners.trigger(e,this,"dragStart")),this.getProvider().setFeatureCoordinates(this,[i,t]),n[o.index][0]=i,n[o.index][1]=t,U._setCoords(r,n)},Y.prototype.pointerup=function(e){var t=this.getLine(),r=this.properties.moved;r&&U.markAsModified(t),U.displayShapes(t),t._e().listeners.trigger(e,this,r?"dragStop":void 0)},Y);function Y(e,t,r,i){var o=this;U=i;i=e._e().getStyle(e);return(o=K.call(this,{type:"Feature",properties:{index:r,LINE:{properties:e.prop(),style:i}},geometry:{type:"Point",coordinates:t}})||this)._l=e,o}J.prototype.class="LINE_SHAPE";var Q,W,Z,X=(t(q,W=J),q.prototype.pointerdown=function(e){W.prototype.pointerdown.call(this,e)},q.prototype.pressmove=function(e,t,r){var i=this.properties,o=this.getLine();i.moved||(i.index++,Q.addCoord(o,this.geometry.coordinates.slice(),i.index,!0),Q.removeShapes(o,"vShps",this)),W.prototype.pressmove.call(this,e,t,r)},q.prototype.pointerup=function(e){this.getProvider().removeFeature(this),W.prototype.pointerup.call(this,e)},q);function q(e,t,r,i){return Q=i,W.call(this,e,t,r,i)||this}function $(e,t){var r=(r=e.__)||(e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[]});return t?r[t]:r}X.prototype.class="LINE_VIRTUAL_SHAPE";function ee(e,t,r){void 0===r&&(r=!1),t&&e.editState(t,r),e._e().setStyle(e,Z)}function te(e){$(this,"isEditable")&&this._e().listeners.trigger(e,this)}function re(e,t){for(var r=0,i=0,o=0;o<t.length-1;o++){var n=t[o],s=t[o+1];0!=k(t[o],t[o+1],e)&&(i=r+_(n,e)),r+=_(n,s)}return i/r}var ie,oe,ne,se,ae={private:$,_evl:{pointerenter:te,pointerleave:te,pointerup:function(e){var t=this,r=$(t);r.isEditable&&(!r.isSelected&&t._e()._config.featureSelectionByDefault&&ae._select(t),t._e().listeners.trigger(e,t))}},addCoord:function(e,t,r,i){var o=e.coord();if(r==Z){if(!1===(r=y(o,t)))return!1;r++}return o.splice(r,0,t),ae._setCoords(e,o),i||ae.displayShapes(e),r},removeCoord:function(e,t){var r,i=e.coord(),o=i.length;return 2<o&&0<=t&&t<o&&(r=i.splice(t,1),ae._setCoords(e,i),ae.displayShapes(e)),r},createShapes:function(e,t,r,i){var o=$(e,r),n=t.length;o.length&&ae.removeShapes(e,r);for(var s=0;s<n;s++)o[s]=new i(e,[t[s][0],t[s][1]],s,ae),e._e().objects.overlay.addFeature(o[s])},createVShapes:function(e){for(var t=e.geometry.coordinates,r=[],i=1;i<t.length;i++)r.push(p(t[i-1],t[i],.5));ae.createShapes(e,r,"vShps",X)},displayShapes:function(e){var t;$(e,"isSelected")&&(t=e.geometry.coordinates,ae.createShapes(e,t,"shps",J),ae.createVShapes(e))},removeShapes:function(t,e,r){e=$(t,e);e.forEach(function(e){e!=r&&t._e().objects.overlay.remove(e)}),e.length=0},deHighlight:function(e){$(e,"isSelected")&&(ee(e,"selected",!1),ae.removeShapes(e,"shps"),ae.removeShapes(e,"vShps"))},_editable:function(e,t){var r=$(e);return t!=Z&&(r.isEditable=!!t),ae.deHighlight(e),r.isEditable},_select:function(e){e._e().objects.selection.select(e)&&(ee(e,"selected",!0),ae.displayShapes(e))},_setCoords:function(e,t){e._e().objects.history.origin(e),e.getProvider().setFeatureCoordinates(e,t)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),ae.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return e.editState("modified",Date.now()),t!=Z&&!t||e._e().objects.history.saveChanges(),e}},ce=function(e,t){this.offset=e,this.distance=t},le=function(e,t){for(var r=0,i={lenPntToLine:1/0,lenTotal:0,shp:0},o=0;o<e.length-1;o++){var n,s=e[o],a=e[o+1],c=R(e[o],e[o+1],t);0==c||(n=_(c,t))<i.lenPntToLine&&(i.shp=o,i.lenPntToLine=n,i.lenTotal=r+_(s,c)),r+=_(s,a)}for(var l=0,d={shp:-1,distancePoi:1/0,length:-1},o=0;o<e.length;o++){var p=_(e[o],t);0<o&&(l+=_(e[o],e[o-1])),p<d.distancePoi&&(d.shp=o,d.distancePoi=p,d.length=l)}return i.lenPntToLine<d.distancePoi?new ce(i.lenTotal/r,i.lenPntToLine):new ce(d.length/r,d.distancePoi)},de=function(e,t,r){if(t[0]==r[0]&&t[1]==r[1])return!1;var i=e[0]-t[0],o=e[1]-t[1],e=r[0]-t[0];return 0<i*(r[1]-t[1])-o*e?"L":"R"},pe=function(e,t,r,i){e.target=r||"display",e._e().listeners.trigger(t,e,i)};function ue(e,t){var r,i,o=null,n=e.getLink();return n&&(n=n.coord(),!1!==(e=y(n,e.coord()))&&(r=n[e],i=n[e+1]),r!==oe&&i!==oe&&(o=de(t.coord(),r,i))),o}function he(l,a,e){var r=this;ie=e;var d,i,p,c,u=this,h=l._e();function o(){this.prevDMove=null,d.moved=!1}function n(e,t,r,i,o){var n=this.prevDMove||[0,0],s=t-n[0],a=r-n[1];if(p&&!h._config.editRestrictions(l,1)){var c=h.map.getEventsMapXY(e),s=h.map.getGeoCoord(c[0]+s,c[1]+a);s.pop();c=h.objects.getNearestLine(s,[p]),a=-1!=[0,l.geometry.coordinates.length-1].indexOf(c.shpIndex);if(d.moved||(d.moved=!0,pe(l,e,"routing","dragStart")),a||u.setRoutingPoint(p,c.point),1<c.distance||a){s=h.objects.getNearestLine(s,p.getProvider(),{ignore:[p],maxDistance:10});if(s&&(s.distance<c.distance||a))return ie.defaults(p),u.setRoutingPoint(s.line,s.point),void ie.displayAsSelected(s.line,l.id,!0)}a||f()}n[0]=t,n[1]=r,this.prevDMove=n}function s(e){d.moved&&(a.setRoutingData(l),f(ue(u,l)),a.markAsModified(l)),pe(l,e,"routing",d.moved?"dragStop":oe)}function f(){var e,t,r,i;p&&(e=p.coord(),t=C(e),i=0^le(e,c).offset,r=b(e,t*i),i=b(e,t*i+(i<1?1:-1)),r[0]==i[0]&&i[1]==r[1]||d&&(u.updateStreetLine(),h.objects.overlay.setFeatureCoordinates(d,c.slice())))}u.getLink=function(){return p},u.coord=function(){return c},u.show=function(){var e,t;return p&&!d&&(e=l.class,t=-1==(t=h.display.getLayers().indexOf(h.getLayer(r.getLink())))?oe:t+1,i=h.objects.overlay.addPath([l.coord().slice(),c.slice()],oe,{type:e+"_LINE",zLayer:t}),(d=h.objects.overlay.addPoint(c.slice(),{type:e+"_ROUTING_POINT",zLayer:t})).pointerdown=o,d.pressmove=n,d.pointerup=s),p&&(f(ue(u,l)),ie.displayAsSelected(p,l.id)),p},u.hide=function(){d&&(d.pointerdown=d.pressmove=d.pointerup=oe,h.objects.overlay.remove(d),h.objects.overlay.remove(i),d=i=null)},u.updateRoutingPoint=function(){var e=a.getRoutingData(l),t=e.link,r=a.getRoutingProvider(l),i=e.position;if(p=c=null,p=t&&r?r.search(t):p){if(i){for(var o=p.coord(),n=0;n<o.length-1;n++)if(k(o[n],o[n+1],i,1e-6))return c=i,p;s=i}else s=l.coord();var s=h.objects.getNearestLine(s,[p]);s&&(p=s.line,c=s.point)}return p},u.searchLink=function(){var e=a.getRoutingProvider(l);return e&&h.objects.getNearestLine(l.coord(),e,{maxDistance:h._config.maxRoutingPointDistance})},u.setRoutingPoint=function(e,t){return c=p=null,e?(p=e,c=t):(t=u.searchLink())&&(p=t.line,c=t.point),p},u.clearRoutingPoint=function(){p=c=null,u.hide()},u.updateStreetLine=function(){var e,t;i&&(t=l.coord(),(e=a.private(l)).isSelected&&(e=(h.getStyle(e.selector)[0]||[])[1]||{},t=h.map.getGeoCoord(S(h.map.getPixelCoord(t),h.map.getPixelCoord(c),e.radius||e.width/2))),h.objects.overlay.setFeatureCoordinates(i,[c].concat([t])))}}var fe=function(e,t){var r=(r=e.__)||(e.__={isEditable:!0,allowEdit:!0,isHovered:!1,cLink:null,moved:!1,prevDMove:null});return t?r[t]:r};function ge(e){return Math.round(1e5*e)/1e5}var ve=function(e){return"PLACE"==e.class},Ae=function(e){var t=fe(e);return null==t._rp&&(t._rp=new he(e,ke,ne)),t._rp};function ye(e,t){var r=!ve(e),i=ke.getRoutingData(e).link,o=fe(e);o.isHovered=t;var n=i||r;!i&&!r||((r=Ae(e)).updateRoutingPoint()||r.setRoutingPoint())&&(o.cLink=r.show(),n&&ke.setRoutingData(e)),t&&pe(e,t)}function me(e,t){var r=fe(e,"cLink");fe(e).isHovered=!t,r&&ne.defaults(r,e.id)&&ne.private(r,"isSelected")&&ne.displayAsSelected(r),t&&pe(e,t),Ae(e).hide()}function Se(e){var t=fe(this),r="pointerenter"==e.type;t.allowEdit&&(this.editState("hovered",r),t.isSelected||(r?ye:me)(this,e))}function _e(e,t,r,i,o){var n,s,a=this,c=fe(a),l=a._e();c.isSelected&&!l._config.editRestrictions(a,1)&&(c.moved||(c.moved=!0,ke.getRoutingData(a).link!=se&&ke.connect(a,null),pe(a,e,"display","dragStart")),s=t-(n=c.prevDMove||[0,0])[0],e=r-n[1],l.map.pixelMove(a,s,e),n[0]=t,n[1]=r,c.prevDMove=n,Ae(a).updateStreetLine())}var ke={private:fe,setLinkTools:function(e){ne=e},_evl:{pointerenter:Se,pointerleave:Se,dbltap:function(e){pe(this,e)},pointerup:function(e){var t=fe(this),r=t.moved,i=this._e();t.allowEdit&&(t.isSelected||(i.dump(this),i._config.featureSelectionByDefault&&ke._select(this)),r&&(Ae(this).show(),ke.markAsModified(this)),pe(this,e,"display",r?"dragStop":se),t.moved=!1,t.prevDMove=null)},pointerdown:function(){var e=fe(this);e.allowEdit&&e.isSelected&&(e.moved=!1,e.prevDMove=null)}},deHighlight:function(e){var t=fe(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(me(e),t.pressmove=null,t.isSelected=!1,e.editState("selected",!1),t.cLink&&ne.defaults(t.cLink,e.id)),e},_editable:function(e,t){var r=fe(e);t!=r.allowEdit&&(t||(ke.deHighlight(e),r.isHovered&&(r.isHovered.type="mouseout",me(e,r.isHovered))),r.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(e.editState("selected",!0),fe(e).pressmove=_e,ke.highlight(e),ye(e))},_setCoords:n._setCoords,markAsRemoved:n.markAsRemoved,markAsModified:n.markAsModified,_props:function(e,t){var r=arguments.length,i=e.getProvider().getFeatureProperties(e);if(1<r){if(2==r&&"string"==typeof t)return i[t];3==r&&(r=t,(t={})[r]=arguments[2]),e._e().objects.history.origin(e),I.JSUtils.extend(i,t)}return i},highlight:function(e){var t=fe(e);t.selector||(t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,se,{type:e.class+"_SELECTOR"}))},getRoutingProvider:function(e){var t=e._e(),e=e.getProvider().readRoutingProvider(e,t.layers.map(function(e){return e.getProvider()}));return t.getProviderById(e)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){var t=Ae(e),r=t.getLink(),i=t.coord(),o=fe(e);o.cLink=r;var n=i?[ge(i[0]),ge(i[1]),0|i[2]]:[],s=ke.getRoutingData(e),a=s.position||[],t=r?r.id:null;s.link==t&&n[0]==ge(a[0])&&n[1]==ge(a[1])||(e._e().objects.history.ignore(function(){o.writeProp=!0,e.getProvider().writeRoutingPoint(e,r,i&&n),delete o.writeProp}),ke._setCoords(e,e.geometry.coordinates))},connect:function(e,t,r){var i,o,n,s=fe(e);s.writeProp||(i=(n=Ae(e)).getLink(),o=(ke.getRoutingData(e).position||[]).slice(),i&&ne.defaults(i),t?s.cLink=n.setRoutingPoint(t,r):(s.cLink=n.updateRoutingPoint())||!1===t||(s.cLink=n.setRoutingPoint()),(ve(e)||s.cLink)&&ke.setRoutingData(e),s.isSelected&&(s.cLink?ye:me)(e),n=ke.getRoutingData(e).position||[],i==s.cLink&&o[0]==n[0]&&o[1]==n[1]||ke.markAsModified(e,!1))},disconnect:function(e){var t=fe(e);t.writeProp||(me(e),Ae(e).clearRoutingPoint(),t.cLink=null,ve(e)||Ae(e).setRoutingPoint(),ke.setRoutingData(e),ke.markAsModified(e,!1))},getRoutingPosition:function(e){var t=Ae(e),e=t.coord();return e||(t.updateRoutingPoint(),e=t.coord()),e?[e[0],e[1],e[2]||0]:se}};function xe(e,t,r){this.isPntInFence=function(){return!0},this.isHidden=function(){return!0},this.remove=function(){}}var Ce,be,Le,Ee="@ns:com:here:editor",Pe=function(e){return e.__||(e.__={})},Ie=function(e,t){var r=e.coord()[t],i=e.getConnectedLinks(t),o=e._e();return i.push(e),null!=(o=o.objects.getNearestLine(r,e.getProvider(),{maxDistance:o._config.autoConnectShapeDistance,ignore:i.map(function(e){return e.id})}))&&((i=o.point)[2]=e.getZLevels(t)||0,null===Ce.connectShpToLink(e,t,o=o.line,i)&&(o=null)),o};function we(e,t){Pe(this).line._e().listeners.trigger(e,this,t)}function Re(){var e=Pe(this),t=e.line,r=t._e();e._cls=e.cLinks.map(function(e){return e.link}),e.drg=!1;var i=this.geometry.coordinates,o=r.display.geoToPixel.apply(r.display,i);(e=Pe(this)).x=o.x,e.y=o.y,r.dump(this),Ce.removeShapePnts(t,!0),r.listeners.trigger("_clearOverlay"),Ce.hideDirection(t),be=new xe(0,i[0],i[1])}function Oe(e,t,r){var i=Pe(this),o=i.line,n=o._e(),s=n._config,a=n.map.getGeoCoord(i.x+t,i.y+r);if(!s.editRestrictions(o,1))if(be.isPntInFence(a)){if(be.isHidden()||be.hide(),s.autoSnapShape)for(var c,l=2*(21-n.display.getZoomlevel()),d=o.getProvider().search({point:a,radius:l}),p=d.length;c=d[--p];)if(c.id!=o.id&&-1==i._cls.indexOf(c)){var u=n.map.calcCrossingAt(c.geometry.coordinates,a,s.minShapeDistance,Le,l);if(u&&u.index!=Le){a=u;break}}Ce.moveShapeAtIndexTo(o,i.index,a[0],a[1]),i.drg||(i.drg=!0,we.call(this,e,"dragStart"))}else be.isHidden()&&be.show()}function Fe(e){var t,r,i=Pe(this),o=i.index,n=i.drg,s=!1,a=i.line,c=!1,l=!1,d=i.cLinks;i._cls=null,n&&("boolean"==typeof(r=Ce.fixGeo(a,o))?c=!r:(c=0<=r,(l=o!=r)&&(o=r))),Ce.showDirection(a),(t=be.isHidden()&&!c&&n?Ie(a,o):t)||(n&&((!1===r?d:a.getConnectedLinks(o,!0)).forEach(function(e){var t=Ce.fixGeo(e.link,e.index);l="number"==typeof t||!t||l,Ce.markAsModified(e.link,!1,!1)}),s=!0),Ce.createAddShapePnts(a)),be&&be.remove(),i.drg=!1,(l||n)&&Ce.refreshGeometry(a),a._e().listeners.trigger(e,a.editState("removed")?this:Ce.private(a,"shps")[o],n?"dragStop":void 0),s&&Ce.markAsModified(a,!0,!1)}function Ne(){var e=Pe(this);document.body.style.cursor="default",e.cLinks.forEach(function(e){Ce.defaults(e.link)}),delete this.properties[Ee].hovered,e.line._e().setStyle(this)}function De(){var e=Pe(this),i=e.line._e();document.body.style.cursor="move",e.cLinks.forEach(function(e){for(var t=i.getStyle(e.link),r=0;r<t.length;r++)t[r].opacity=.5;i.setStyle(e.link,t)}),this.properties[Ee].hovered=!0,i.setStyle(this)}var Be,Me=(t(je,Be=w.Feature),je.prototype.getLink=function(){return this.properties.parent},je.prototype.isNode=function(){return this.properties.isNode},je.prototype.isOverlapping=function(){return Ce.checkOverlapping(this.properties.parent,this.getIndex())},je.prototype.getIndex=function(){return Pe(this).index},je.prototype.editTurnRestrictions=function(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]},je.prototype.getConnectedLinks=function(){return this.getLink().getConnectedLinks(this.getIndex())},je.prototype.remove=function(){var e=this.getLink();e._e()._config.editRestrictions(e||this,2)||Ce.deleteShape(e,this)},je.prototype.disconnect=function(){var e,t,r,i,o=Pe(this),n=o.line._e();this.isNode()&&o.cLinks.length&&(e=o.line,t=o.index,i=(r=e.coord())[t],o=r[t+(t?-1:1)],o=90-I.geotools.calcBearing(i,o),o=n.map.movePoint(i,n._config.disconnectShapeDistance,o),n.hooks.trigger("Navlink.disconnect",{link:e,index:t},e.getProvider()),r[t][0]=o[0],r[t][1]=o[1],Ce._setCoords(e,r),Ce.fixGeo(e),Ce.refreshGeometry(e),Ce.markAsModified(e))},je.prototype.splitLink=function(){var e,t=this.getLink(),r=t._e();return this.isNode()||(e=r.objects.splitLinkAt({link:t,index:this.getIndex()})).length&&r.objects.history.saveChanges(),e},je);function je(e,t,r,i){Ce=i;var o=e._e(),n=e.getConnectedLinks(r,!0),i=0==r||r==e.geometry.coordinates.length-1,i={type:"Feature",geometry:{type:"Point",coordinates:t.slice()},properties:{isNode:i,isConnected:!!n.length,"@ns:com:here:editor":{},NAVLINK:{properties:I.JSUtils.extend(!0,{},e.properties),style:o.getStyle(e)},parent:e}},s=Be.call(this,i,o.objects.overlay.layer.getProvider())||this,i=Pe(s);return i.index=r,i.line=e,i.drg=!1,i.cLinks=n,i.dblclick=we,i.pressmove=Oe,i.pointerdown=Re,i.pointerup=Fe,o._config.editRestrictions(e,1)||(i.pointerenter=De,i.pointerleave=Ne),s}Me.prototype.class="NAVLINK_SHAPE";var Te,Ge=(t(He,Te=w.Feature),He);function He(e,t,s,a){var c,r=this,l=e._e(),i=l.display;var d=r=Te.call(this,{type:"Feature",geometry:{type:"Point",coordinates:t.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:I.JSUtils.extend(!0,{},e.properties),style:l.getStyle(e)},parent:e}},l.objects.overlay.layer.getProvider())||this;return d.pointerdown=function(){var e=d.properties.parent;d.moved=!1,a.hideDirection(e),e=i.geoToPixel.apply(i,this.geometry.coordinates),c=new xe(0,d.x=e.x,d.y=e.y)},d.pressmove=function(e,t,r,i,o){var n=d.properties.parent,t=l.map.getGeoCoord(d.x+t,d.y+r);c.isPntInFence(t)?(c.isHidden()||c.hide(),r=a.private(n,"shps"),d.moved||(a.addShp(n,t,s,!1,!0),a.removeShapePnts(n,!0,d.id),d.pointerenter=d.pointerleave=void 0,d.moved=!0,(n=r[s]).x=d.x,n.y=d.y,n.__.pointerdown.call(n)),(r=r[s]).__.pressmove.apply(r,arguments)):c.isHidden()&&c.show()},d.pointerup=function(e){var t,r=d.properties.parent,i=a.private(r);d.moved?((t=i.shps[s]).__.pointerup.call(t,e),this.getProvider().removeFeature(this)):i.isSelected&&a.showDirection(r)},l._config.editRestrictions(e,1)||(d.pointerenter=d.pointerleave=function(e){e="pointerenter"==e.type;document.body.style.cursor=e?"move":"default",this.properties["@ns:com:here:editor"].hovered=e,l.setStyle(this)}),r}var ze,Ue=function(){},Ke=function(e,t){var r=(r=e.__)||(e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null});return t?r[t]:r};function Ve(e,t){var r=arguments.length,i=e.getProvider().getFeatureProperties(e);if(1<r){if(2==r&&"string"==typeof t)return i[t];3==r&&(r=t,(t={})[r]=arguments[2]),e._e().objects.history.origin(e),I.JSUtils.extend(i,t)}return i}function Je(e){var t=this,r=e.type;Ke(t,"allowEdit")&&t._e()._config.featureSelectionByDefault&&("dbltap"==r||"pointerup"==r)&&et._select(t),t._e().listeners.trigger(e,t)}function Ye(e,t){if(t)for(var r in t)e.editState(r,t[r]);e._e().setStyle(e,ze)}function Qe(e){var t=Ke(e);return et.getConnectedObjects(e,I.geotools.mergeBBoxes(t.prevBBox=t.prevBBox||e.bbox.slice(),e.bbox))}function We(e,t){Ke(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function Ze(e,t){if(e._e().objects.overlay.remove(t),t.class){for(var r in t)"id"!=r&&"type"!=r&&"class"!=r&&"properties"!=r&&"geometry"!=r&&(t[r]=ze);t.isDeleted=!0}}function Xe(e,t){var r=e.__.ol;e.properties.isOverlapping=t,r!=(e.__.ol=t)&&e.getLink()._e().setStyle(e,ze)}function qe(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function $e(e){var t=Ke(this);t.allowEdit&&(document.body.style.cursor="default",Je.call(this,e),t.isSelected||function(e){for(var t=et.getConnectedObjects(e),r=0;r<t.length;r++)if(ke.private(t[r],"isSelected"))return!0}(this)||Ye(this,{hovered:!1}),t.isHovered=null)}var et={private:Ke,_evl:{pointerenter:function(e){var t=Ke(this);t.allowEdit&&(document.body.style.cursor="Pointer",t.isHovered=e,Je.call(this,e),Ye(this,{hovered:!0}))},pointerleave:$e,dbltap:Je,pointerup:Je},deHighlight:function(e){return Ke(e,"isSelected")&&(Ye(e,{selected:!1,hovered:!1}),et.removeShapePnts(e),et.hideDirection(e)),e},_editable:function(e,t){var r,i=Ke(e);t!=i.allowEdit&&(t||((r=i.isHovered)&&(r.type="mouseout",$e.call(r.target,r)),et.deHighlight(e)),i.allowEdit=t)},_select:function(e){Ke(e,"isSelected")||(e._e().objects.selection.select(e),e._e().dump(e,"info"),et.refreshGeometry(e))},_setCoords:function(e,t){for(var r=t.length;r--;)t[r][2]=t[r][2]||0;Qe(e),We(e,t),et.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),et.hideDirection(e),Qe(e).forEach(function(e){ke.disconnect(e)}),et._editable(e,!1);var t=e.coord(),r=t[0],i=t[t.length-1];r[0]==i[0]&&r[1]==i[1]&&(t[0][0]+=1e-5,t[0][1]+=1e-5,We(e,t))},markAsModified:function(r,e,t){void 0===e&&(e=!0),void 0===t&&(t=!0);var i,o=r.editState("modified"),n=Ke(r);return r.editState("modified",Date.now()),n.isGeoMod&&(i=r.coord(),Qe(r).forEach(function(e){var t=b(i,C(i)*le(i,ke.getRoutingPosition(e)).offset);ke.connect(e,r,t)}),n.isGeoMod=!1),o||(Ye(r),!n.isSelected&&t&&et.defaults(r)),e&&r._e().objects.history.saveChanges(),r},_props:Ve,getConnectedObjects:function(r,e){var t=r._e();return t.objects.getInBBox(I.geotools.extendBBox(e||r.bbox,t._config.maxRoutingPointDistance)).filter(function(e){var t=e.class;if("PLACE"==t||"ADDRESS"==t)return e.getLink()==r})},refreshGeometry:function(e){et.removeShapePnts(e),Ke(e,"isSelected")&&(et.displayAsSelected(e),et.showDirection(e),et.createShapes(e),et.createAddShapePnts(e))},checkOverlapping:function(e,t){var r=e.coord(),i=t==ze,o=i?1:t,n=i?r.length-1:o+1,s=[];n==r.length&&n--;for(var a,c=e._e().objects.getInBBox(e.bbox,e.getProvider()),l=c.length;l--;)if((a=c[l]).id!=e.id&&"NAVLINK"==a.class)for(var d=o;d<n;d++)for(var p=0,u=a.coord();p<u.length;p++)if(r[d][0]==u[p][0]&&r[d][1]==u[p][1]){s.push(d);break}return i?s:!!s.pop()},createLinkShape:function(e,t,r){return e._e().objects.overlay.addFeature(new Me(e,t,r,et))},createShapes:function(r){var e=Ke(r,"shps"),t=r.geometry.coordinates,i=t.length;if(!r.editState("removed")){var o=et.checkOverlapping(r);if(e.length)e.forEach(function(e,t){e.__.cLinks=r.getConnectedLinks(t,!0)});else for(var n=0;n<i;n++){var s=et.createLinkShape(r,[t[n][0],t[n][1]],n);Xe(s,0<=o.indexOf(n)),e[n]=s}}},createAddShapePnts:function(e){var t=Ke(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,1))for(var r,i,o=e.geometry.coordinates,n=1;n<o.length;n++)r=o[n-1],i=o[n],t.push(e._e().objects.overlay.addFeature(new Ge(e,p(r,i,.5),n,et)))},removeShapePnts:function(r,e,i){function t(e){for(var t=0;t<e.length;t++)e[t].id!=i&&Ze(r,e[t]);e.length=0}var o=Ke(r),n=o.vShps;return e||t(o.shps),(n.length||e)&&t(n),r},moveShapeAtIndexTo:function(r,e,i,o,t){var n=r.coord(),s=Ke(r,"shps");n[e][0]=i,n[e][1]=o,Qe(r),We(r,n),et.hideDirection(r);s=s[e];return!t&&s&&(r._e().objects.overlay.setFeatureCoordinates(s,[i,o]),s.__.cLinks.forEach(function(e){var t=e.link;r._e()._config.editRestrictions(t,1)||et.moveShapeAtIndexTo(t,e.index,i,o)}),Xe(s,et.checkOverlapping(r,e))),n},deleteShape:function(e,t,r){var i,o,n="number"==typeof t?t:t.getIndex(),s=e.coord();2<s.length&&(s.splice(n,1),(t=(i=Ke(e)).shps).length&&(Ze(e,t[n]),t.splice(n,1),t.forEach(function(e){e.__.index-=Number(e.getIndex()>=n)})),Qe(e),We(e,s),(o=e.getZLevels()).splice(n,1),e._e().objects.history.ignore(function(){e.getProvider().writeZLevels(e,o)}),r||et.markAsModified(e),i.isSelected&&et.refreshGeometry(e))},showDirection:function(e){if(!e.editState("removed")){var t,r,i,o=(""+e.getProvider().readDirection(e)).toUpperCase(),n=void 0;if(et.hideDirection(e),"START_TO_END"==o?n=90:"END_TO_START"==o&&(n=-90),n!=ze)for(var s=Ke(e).arrows=[],a=e.geometry.coordinates,c=0;c<a.length-1;c++)t=a[c],r=a[c+1],i=I.geotools.calcBearing(t,r)-n,s.push(e._e().objects.overlay.addPoint(p(t,r,.5),{type:"NAVLINK_DIRECTION",bearing:i}))}return e},displayAsSelected:function(e,t,r){var i=Ke(e);i.isSelected||(i._cPnt=t),Ye(e,{selected:!0})},addShp:function(t,e,r,i,o,n){var s,a=t.coord(),c=t._e(),n=c.map.calcCrossingAt(a,e,c._config.minShapeDistance,n);return r="number"==typeof r?r:n.index,!n.existingShape||o?(s=t.getZLevels(),n.existingShape&&(r=y(a,e)+1),c.map.clipGeoCoord(e),a.splice(r,0,e),function(e,t){for(var r=Ve(e,"bn")||[],i=0;i<r.length;i++)r[i]+=r[i]>=t}(t,r),Qe(t),We(t,a),s.splice(r,0,e[2]||0),c.objects.history.ignore(function(){t.getProvider().writeZLevels(t,s)}),(c=Ke(t,"shps")).length&&(c.splice(r,0,et.createLinkShape(t,e,r)),c.forEach(function(e){e.__.index+=Number(e.getIndex()>r)}),c.forEach(function(e){Xe(e,et.checkOverlapping(t,e.getIndex()))})),et.refreshGeometry(t)):i||(r=!1),r},defaults:function(e,t){var r=Ke(e);return(!t||t==r._cPnt)&&(r._cPnt=null,Ye(e,{selected:!1,hovered:!1}),e)},hideDirection:function(e){var t=Ke(e,"arrows");if(t){for(var r=0;r<t.length;r++)e._e().objects.overlay.remove(t[r]);t.length=0}return e},fixGeo:rt,connectShpToLink:function(e,t,r,i,o,n){var s,a=new Ue,c=e._e().objects;if(r.id!=e.id){i=function(e,t,r,i,o){var n=e._e(),s=e.coord(),a=e.getConnectedLinks(t,!0),c=o[0],l=o[1],d=n._config.minShapeDistance,p=n.map.calcCrossingAt(r.coord(),o,d,i),u=n.map.clipGeoCoord(p.point),o=null,d=p.existingShape;d&&function(e,t){(Ve(e,"bn")||[]).indexOf(t==e.geometry.coordinates.length-1?"N":t)}(r,p.index);s[t][0]=c,s[t][1]=l,et._setCoords(e,s),null!==p.index&&(o=n.objects.splitLinkAt(d?{link:r,index:p.index,avoidSnapping:!0}:{link:r,point:u,preferSegment:i,avoidSnapping:!0}),tt(e,t,u[0],u[1]),a.forEach(function(e){var t=e.link;tt(t,e.index,u[0],u[1]),rt(t,e.index,!0),et.markAsModified(t,!1,!1),et.defaults(t)}));return o}(e,t,r,o,i);if(null===i)return null;0<t&&t<e.geometry.coordinates.length-1&&(Ke(e,"isSelected")&&qe(e._e()),et.deHighlight(e),s=c.splitLinkAt({link:e,index:t}));t=e.geometry.coordinates;2==t.length&&t[0][0]==t[1][0]&&t[0][1]==t[1][1]&&c.remove(e),et.markAsModified(e),Ke(e,"isSelected")&&et.refreshGeometry(e),i&&(a.targetSplittedInto=i),s&&(a.splittedInto=s)}return a},isIntersection:function(e,t,r){var i=Math.pow(10,e._config.intersectionScale),e=function(e){return Math.round(e*i)};return e(t[0])==e(r[0])&&e(t[1])==e(r[1])}},tt=et.moveShapeAtIndexTo;function rt(k,x,C,i){var b=k._e(),L=b.objects,E=!0===C,e=x||0,P=k.getZLevels(),t=P.length,r=x===ze?t:e+1,o=!0,I=b._config.minShapeDistance||2;function n(u){if(i==u)return!0;function h(e){return 0==e||e==m-1}function f(e){e=k.getConnectedLinks(e,!0);return e.forEach(function(e){var t=e.link;et.markAsModified(t,!1),tt(t,e.index,v[0],v[1],!0)}),e}for(var g,v,A=k.coord(),y=Ke(k),m=A.length,S=!1,_=!1,e=function(e){if(u!=e){var t=A[e],r=A[u];if(l=t,d=r,p=P[e],t=P[u],void 0===(r=I)&&(r=1),Number(p)==Number(t)&&b.map.distance(l,d)<=r){if(g=Math.abs(u-e)-1,h(e)&&h(u)?1==g?S=u:_=e:h(u)?g<=1?S=u:_=e:h(e)?(1==g&&e<u&&(S=e),0==g?S=u:0<g?_=u:S=e):0==g?S=u:_=e,!1!==_){var i,o,n=void 0;return v=A[_],2==m?(r=f(x),tt(k,u==_?e:u,v[0],v[1]),qe(k._e()),L.remove(et.deHighlight(k)),r.forEach(function(e){E||rt(e.link,e.index,!0)})):(f(u),tt(k,u,v[0],v[1]),(o=L.splitLinkAt({link:k,index:_===m-1||0===_?~~(m/2):_})).forEach(function(e,t){rt(e,ze,C.concat(k,o[Number(0==t)]))}),!(n=o[Number(_<=u)]).editState("removed")&&2<=Math.abs(u-_)&&(n.coord().forEach(function(e,t){e[0]==v[0]&&e[1]==v[1]&&(i=t)}),i&&L.splitLinkAt({link:n,index:i}))),{value:!1}}if(!1!==S){var s=A[e][0],a=A[e][1],c=!1;k.getConnectedLinks(S,!0).forEach(function(e){var t=e.link;et.markAsModified(t,!1),et.moveShapeAtIndexTo(t,e.index,s,a,!0),t=t,c=!(E||-1!=C.indexOf(t))}),tt(k,u==e?e:u,s,a,!0),et.deleteShape(k,S,!0),h(S)&&(!h(u)&&0<u-1&&tt(k,u-1,s,a,!0),y.isSelected&&et.refreshGeometry(k),c&&2<A.length&&L.splitLinkAt({link:k,index:e-Number(0===S)}));n=u-e,e=void 0;return 0<n?e=u-1-g:n<0&&(e=u+g),{value:e}}}}var l,d,p},t=0;t<m;t++){var r=e(t);if("object"==typeof r)return r.value}return!0}if(!k.editState("removed")&&e<t)for(C=E||!C?[]:C;e<r&&!0===(o=n(e));e++);return o}var it={};it.MARKER=n,it.AREA=V,it.LINE=ae;var ot=it.NAVLINK=et;function nt(e){return it[e.class]}function st(t){return function(e){e=e.class,e=it[e][t];if(e)return e.apply(e,arguments)}}(it.PLACE=it.ADDRESS=ke).setLinkTools(ot);var at,ct={getTool:function(e,t){e=nt(e);return e&&t?e[t]:e},private:st("private"),getEventListener:function(e,t){var r=nt(e);return r?r._evl[t]||r.private(e,t):e.__&&e.__[t]||e[t]}};for(at in it)for(var lt in it[at])ct[lt]||(ct[lt]=st(lt));var dt=function(){},pt=dt.prototype;pt.created=!1,pt.modified=!1,pt.removed=!1,pt.split=!1,pt.selected=!1,pt.hovered=!1;function ut(e){return 3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]]}var ht,ft=(t(gt,ht=w.Feature),gt.prototype.toString=function(){return this.class+" 🌎 "+this.id},gt.prototype.getProvider=function(){return this._provider},gt.prototype._e=function(){return this._provider._e},gt.prototype.editState=function(e,t){var r=arguments.length,i=this,o=i.properties["@ns:com:here:editor"];if(!r)return o;if(2==r){if(this._esu)return;t?o[e]=t:delete o[e],"hovered"!=e&&"selected"!=e&&i._e().objects.history.ignore(function(){i._esu=!0,i.getProvider().writeEditState(i,e),i._esu=void 0})}return o[e]},gt.prototype.style=function(e){if("string"==typeof e||0==arguments.length)return this._e().getStyle(this,void 0);this._e().setStyle(this,e,!0)},gt.prototype.prop=function(e,t){var r,i=this,o=!1,n=arguments.length,s=i.getProvider().getFeatureProperties(i);if(!n||1==n&&"string"==typeof e)return"object"==typeof(e=e?s[e]:s)?I.JSUtils.extend(!0,new e.constructor,e):e;for(r in 2==n&&((n={})[e]=t,e=n),e){var a=e[r],c="object"==typeof a,l=s[r];(c&&JSON.stringify(a)!=JSON.stringify(l)||!c&&l!==a)&&(o||(this._e().objects.history.origin(i),o=!0),s[r]=a)}o&&(this._e().setStyle(i),ct.markAsModified(i))},gt.prototype.getCoordinates=function(){return this.coord()},gt.prototype.coord=function(e){var t=this,r=t.geometry.type;if(e instanceof Array)ct.deHighlight(t),ct._setCoords(t,e),ct.markAsModified(t);else if(e=t.getProvider().decCoord(t),"Point"==r)i=ut(e);else for(var i=[],o=e.length,n=0;n<o;n++)i[n]=ut(e[n]);return i},gt.prototype.editable=function(e){return ct._editable(this,e),this.unselect(),this},gt.prototype.select=function(){ct._select(this)},gt.prototype.unselect=function(){ct.private(this,"isSelected")&&this._e().objects.selection.clearSelected()},gt.prototype.transform=function(){this._e().transformer.show(this)},gt.prototype.remove=function(){this._e().objects.remove(this,{save:!0})},gt);function gt(e,t){t=ht.call(this,e,t)||this;return t.properties=t.properties||{},t.properties["@ns:com:here:editor"]=new dt,t}var vt=ft.prototype.id=null,At=function(e,t,r,i,o,n,s){this.type=e,this.timeStamp=Date.now(),this.mapX=t,this.mapY=r,this.nativeEvent=i,this.button=o,this.target=n,this.detail=s},ot=At.prototype;ot.nativeEvent=vt,ot.detail=vt,ot.target=vt,ot.mapX=vt,ot.mapY=vt,ot.type=vt,ot.button=vt,ot.timeStamp=vt,ot.toString=function(){return"EditorEvent "+this.type};var yt,mt=(t(St,yt=w.Feature),St.prototype.remove=function(){this.__=null,this._b.removeShape(this.properties.index)},St.prototype.getLength=function(){return this._b.getLength()},St.prototype.getIndex=function(){return this.properties.index},St);function St(s,a,e,t,r){var i=yt.call(this,{type:"Feature",geometry:{type:"Point",coordinates:t},properties:{"@ns:com:here:editor":{},index:e,isMoved:!1}},s.overlay.getProvider())||this,t=s.getFeature().geojson,e=i,r=r.toUpperCase();return e.properties[r]={properties:I.JSUtils.extend(!0,{},t.properties),style:a.getStyle(t)},e._b=s,e.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=a.display.geoToPixel.apply(a.display,this.geometry.coordinates)},pressmove:function(e,t,r,i,o){var n=this.properties.p,r=a.map.getGeoCoord(n.x+t,n.y+r);s.getFeature().update(this.properties.index,r),this._provider.setFeatureCoordinates(this,r.slice()),this.isMoved=!0},pointerup:function(e){this.properties.isMoved||a.listeners.trigger(e,this)}},i.class=r+"_SHAPE",i}var _t=(kt.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),1<r.length&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(r))},kt.prototype.removeAt=function(e){this.path.splice(e,1)},kt.prototype.createGeo=function(e){if(1<e.length)return e.slice()},kt.prototype.isValid=function(e){return!!e||1<this.path.length},kt);function kt(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}var xt=(Ct.prototype.update=function(e,t){var r=this.path;t&&(r[e]=t),2<r.length&&((r=this.createGeo(r))&&this.overlay.setFeatureCoordinates(this.geojson,r))},Ct.prototype.createGeo=function(e){if(2<e.length)return[[e.concat([e[0]])]]},Ct.prototype.removeAt=function(e){this.path.splice(e,1)},Ct.prototype.isValid=function(e){return e?(e.push(e[0].slice()),e.length<4||V.validateGeometry(e)):2<this.path.length},Ct);function Ct(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}var bt=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],Lt=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function Et(e,t){e=I.JSUtils.clone(e||bt);return e.forEach(function(e){return e.zIndex=(0^e.zIndex)+t}),e}function Pt(e,t){var r=e.mode;if(e.styleGroup)n=e.styleGroup;else if("Navlink"!=r&&"Area"!=r||(t.editState=function(){return{}},t.class=r),n=e.layer.getStyleGroup(t),"Area"!=r)return(o=I.JSUtils.clone(bt))[0].fill=n[0].stroke,(s=I.JSUtils.clone(Lt))[0].stroke=(n[1]||n[0]).stroke,{feature:s,shape:o};function i(e){return-1!=["Circle","Image","Rect","Text"].indexOf(e.type)}var o,n,s=n.filter(function(e){return!i(e)});return o=n.filter(i),s.length||(s=e.layer.getStyleGroup(t)),e.styleGroup&&o.length||(o=I.JSUtils.clone(bt),t=(n=s[0]).stroke,e=void 0,"Area"==r?(e=n.fill,t&&(o[0].stroke=t)):e=t,e&&(o[0].fill=e)),{feature:s,shape:o}}var It,wt=(Rt.prototype.onBoardUp=function(){this.mousedown=!1},Rt.prototype.updateCursor=function(e){var t,r,i=this,o=i.iEdit,n=i.feature,s=i.shapes,a=i.display,c=i.cursor,l=i.mousedown,i=i.overlay;l?(r=o.map.getEventsMapXY(e),t=c.properties.prevPos,a.lockViewport().pan||a.pan(r[0]-t[0],r[1]-t[1],0,0),t[0]=r[0],t[1]=r[1]):(t=o.map.getGeoCoord(o.map.getEventsMapXY(e)),(r=s.map(function(e){return e.geometry.coordinates})).push(t),(e=n.isValid(r))!=!this.inValid&&(r=this.style.feature,e?(r=this.inValid,this.inValid=!1):(this.inValid=r,r=[v(v({},r[0]),{fill:"rgba(0,0,0,0)"})]),o.setStyle(n.geojson,r)),n.update(s.length,t),i.setFeatureCoordinates(c,t))},Rt.prototype.init=function(){var r=this,i=r.iEdit,e=r.display,t=r.overlay,o=r.updateCursor,e=e.getViewBounds(),e=[e.minLon,e.maxLat];this.feature=new this.FeatureClass(t,e);var n=t.addCircle(e,Et(bt,1));n.pointerdown=function(e){var t=n.properties;t.prevPos=i.map.getEventsMapXY(e),r.mousedown=!0,t.panned=!1},n.pressmove=function(e){o(e),n.properties.panned=!0},n.pointerup=function(e){n.properties.panned||r.addShape(i.map.getGeoCoord(e.mapX,e.mapY),It,e),r.onBoardUp()},this.cursor=n,this.inValid=!1,I.global.addEventListener("mousemove",this.updateCursor),I.global.addEventListener("mouseup",this.onBoardUp)},Rt.prototype.addShape=function(e,t,r){var i,o=this.iEdit,n=this.settings,s=this.shapes,a=this.feature;t&&(i=(this.originLink=t).geometry.coordinates,e="number"==typeof e?i[e].slice(0):(!(t=o.map.calcCrossingAt(i,e,o._config.minShapeDistance)).existingShape||0!=t.index&&t.index!=i.length-1||(this.originLink=null),t.point),this.originPos=e);o=this.overlay.addFeature(new mt(this,o,s.length,e,n.mode),Et(this.style.shape,9));return a.update(s.length,e),s.push(o),n.onShapeAdd&&n.onShapeAdd(new At("onShapeAdd",e[0],e[1],r,r&&r.button,o,{index:o.properties.index})),o},Rt.prototype.setGeom=function(e,t){var r=this.settings;if(e==this.feature.type){this.hide(),this.show(r);e="LineString"==e?t:t[0][0].slice(0,-1),t=r.onShapeAdd;r.onShapeAdd=null;for(var i=0,o=e;i<o.length;i++){var n=o[i];this.addShape(n)}r.onShapeAdd=t}},Rt.prototype.removeShape=function(e){var t=this,r=t.shapes,i=t.iEdit,o=t.overlay,n=t.feature,s=t.settings,t=r[e=e==It?r.length-1:e],i=i.map.getGeoCoord(t.geometry.coordinates);o.remove(t),r.splice(e,1),n.removeAt(e);for(var a=e;a<r.length;a++)r[a].properties.index--;n.update(),s.onShapeRemove&&s.onShapeRemove(new At("onShapeRemove",i[0],i[1],It,It,It,{index:e}))},Rt.prototype.getFeature=function(){return this.feature},Rt.prototype.getLength=function(){return this.shapes.length},Rt.prototype.setAttributes=function(e){var t,r=this,i=r.feature,o=r.iEdit,n=r.cursor,s=r.settings,r=r.shapes;e&&(I.JSUtils.extend(i.properties,e),t=Pt(s,i.geojson),this.style=t,i.geojson.class=It,o.setStyle(i.geojson,t.feature),r.concat(n).forEach(function(e){o.setStyle(e,Et(t.shape,o.getStyle(e)[0].zIndex))}))},Rt.prototype.createGeom=function(){var e=this.feature,t=this.shapes,r=this.settings,t=t.map(function(e){return e.geometry.coordinates});"Area"!=r.mode&&(t=A(t,r.generalization||1e-5));t=e.createGeo(t);if(t)return{type:e.type,coordinates:t}},Rt.prototype.create=function(e){var t=this,r=t.iEdit,i=t.FeatureClass,o=t.shapes,n=t.feature,s=t.originLink,a=t.originPos,t=t.settings;this.setAttributes(e),i==_t&&(c=o[0].geometry.coordinates,s&&a[0]==c[0]&&a[1]==c[1]&&r.objects.splitLinkAt({link:r.objects.get(s),point:c}));var c=o.map(function(e){return e.geometry.coordinates});if(n.isValid(c)){o=this.createGeom(),c=void 0;return o&&(c=r.objects.create({feature:{type:"Feature",geometry:o,properties:n.properties},provider:t.layer.getProvider()}),r.objects.history.saveChanges(),this.hide()),c}throw new Error("Invalid Geometry")},Rt.prototype.isActive=function(){return this.active},Rt.prototype.show=function(e){var t,r,i;this.active||(t=this.overlay.layer,r=this.iEdit,i=this.display,r.objects.listenDisplay(!1),i.removeLayer(t),i.addLayer(t),r.objects.listenDisplay(!0),"Area"==(this.settings=e).mode?this.FeatureClass=xt:this.FeatureClass=_t,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes))},Rt.prototype.hide=function(){var e,t=this,r=t.display,i=t.overlay,o=t.shapes,n=t.feature;t.active&&(t.active=!1,e=i.layer,r.removeLayer(e),r.addLayer(e),i.remove(n.geojson),t.feature=null,o.forEach(function(e){return i.remove(e)}),o.length=0,i.remove(t.cursor),t.cursor=null,I.global.removeEventListener("mousemove",t.updateCursor),I.global.removeEventListener("mouseup",t.onBoardUp))},Rt);function Rt(e,t,r){this.shapes=[],this.originLink=null,this.originPos=null;var i=this;i.overlay=e,i.iEdit=t,i.display=r,i.onBoardUp=i.onBoardUp.bind(i),i.updateCursor=i.updateCursor.bind(i)}var Ot="Navlink",Ft=I.global.here.xyz.maps.editor,Nt=(Dt.prototype.addShape=function(e,t){if(this._a)return this._b.addShape(this._e.map.getGeoCoord(e),t)},Dt.prototype.removeShape=function(e){this._a&&this._b.removeShape(e)},Dt.prototype.getLength=function(){return this._b.getLength()},Dt.prototype.cancel=function(){this._b.hide(),this._a=!1},Dt.prototype.setProperties=function(e){this._a&&this._b.setAttributes(e)},Dt.prototype.setAttributes=function(e){return this.setProperties(e)},Dt.prototype.create=function(e){if(this._a){e=this._b.create(e);return e&&(this._a=!1),e}},Dt.prototype.start=function(e){var t=(e=e||{}).connectTo,r="string"!=typeof(r=e.mode||Ot)?r===Ft.features.Area?"Area":Ot:r.charAt(0).toUpperCase()+r.slice(1).toLowerCase();return e.mode=r,e.attributes=e.properties||e.attributes||{},this._a||(e.layer=e.layer||this._e.getLayerForClass(r.toUpperCase()),"Area"==r&&!e.layer||(this._e.listeners.trigger("_clearOverlay"),this._b.show(e),this._a=this._b.isActive(),e.position&&this.addShape(e.position,t))),this._a},Dt.prototype.isActive=function(){return this._a},Dt.prototype.getGeometry=function(){return this._b.createGeom()},Dt.prototype.setGeometry=function(e){this._b.setGeom(e.type,e.coordinates)},Dt);function Dt(e){this._e=e,this._b=new wt(e.objects.overlay,e,e.display),this._a=!1}function Bt(e,t){var r,e=e.coord().map(function(e){e=w.webMercator.geoToPixel(e[0],e[1],1);return[e.x,e.y]});r="number"==typeof t?t:(r=w.webMercator.geoToPixel(t.longitude,t.latitude,1),le(e,[r.x,r.y]).offset);e=b(e,C(e)*r),e=w.webMercator.pixelToGeo(e[0],e[1],1);return{coordinate:[e.longitude,e.latitude],offset:r}}var Mt,jt=(t(Tt,Mt=w.Feature),Tt.prototype.updatePosition=function(e){var t=this.properties.style,r=this.ml.coord(),i=y(r,e),o=this.properties.side,n=r[i],r=r[i+1],i=r[0]-n[0],r=r[1]-n[1],s=180*-Math.atan2(r,i)/Math.PI,n=Math.sqrt(i*i+r*r),a=r,c=i;n&&(a/=n,c/=n);for(var l=0,d=t;l<d.length;l++){var p,u,h=d[l];h.rotation=s,"B"!=o&&(p=h._offsetX,u=h._offsetY,u+=h.lineOffset,h.offsetX=a*u+c*p,h.offsetY=c*u+-a*p)}return e.slice()},Tt.prototype.pressmove=function(e){var t,r=this;r.isLocked()||(t=e.detail.display,t=Bt(r.ml,t.pixelToGeo(e.mapX,e.mapY)),r.properties.relPos=t.offset,t=r.updatePosition(t.coordinate),r.getProvider().setFeatureCoordinates(r,t),r.dragMove(e),r.properties.dragged=!0)},Tt.prototype.pointerdown=function(e){this.dragStart(e),this.properties.dragged=!1},Tt.prototype.pointerup=function(e){this.properties.dragged&&this.dragEnd(e)},Tt.prototype.remove=function(){this.getProvider().removeFeature(this)},Tt.prototype.getRelPos=function(){return this.properties.relPos},Tt.prototype.getRelPosOfSubLink=function(e){var t=this.geometry.coordinates,r=e.link._e(),i=r.map.getPixelCoord(t),o=y(this.ml.coord().map(function(e){return r.map.getPixelCoord(e)}),i);if(o>=e.from&&o<e.to){t=e.link.coord().map(function(e){return r.map.getPixelCoord(e)}),t=re(i,e.reversed?t.reverse():t);return.995<t?1:Math.round(1e6*t)/1e6}return o<e.from?0:1},Tt);function Tt(e,t,r,i,o,n,s,a,c){for(var l=this,d=0,p=o=I.JSUtils.clone(o);d<p.length;d++){var u=p[d];u._offsetX=u.offsetX||0,u._offsetY=u.offsetY||0}var h=Bt(t,i).coordinate;return(l=Mt.call(this,{type:"Feature",properties:{relPos:i,side:r.toUpperCase(),dragged:!1,style:o},geometry:{type:"Point",coordinates:h}})||this).isLocked=n,l.ml=t,l.dragStart=s,l.dragMove=a,l.dragEnd=c,e.addFeature(l,l.properties.style),l.updatePosition(h),l}var Gt={L:"#ff4040",R:"#4cdd4c",B:"#35b2ee"},Ht=(zt.prototype.updateSegments=function(){this.segments=this.ml.getZoneSegments(this)},zt.prototype.remove=function(){this.overlay.remove(this.line),this.markers[0].remove(),this.markers[1].remove()},zt.prototype.locked=function(){return!!this.options.locked},zt.prototype.draw=function(){var e,t=this.markers[0].getRelPos(),r=this.markers[1].getRelPos();r<t&&(e=t,t=r,r=e);for(var i=0,o=this.style;i<o.length;i++){var n=o[i];n.from=t,n.to=r}this.overlay.layer.setStyleGroup(this.line,this.style)},zt);function zt(t,r,i){var o=this;this.options=v({dragStart:function(e,t){},dragMove:function(e,t){},dragStop:function(e,t){}},i);var e=i.id;null!=e&&(this.id=e);var n=JSON.parse(JSON.stringify(i.style||{}));this.ml=t;var s=i.side,a=n.opacity,e=n.fill,n=n.stroke;e&&!n&&(n=e,e=!1),e||(e=n,n="#fff");var c,e=e||Gt[s],c=i.lineStyle||(c=a,[{zIndex:4,type:"Line",strokeWidth:9,opacity:c=void 0===a?.75:c,stroke:e}]);this.line=r.addPath(t.coord(),this.style=c);for(var l=0,d=0,p=c;d<p.length;d++)l=p[d].offset||l;for(var u=i.markerStyle||function(e,t,r){r="R"==r?8:"L"==r?-8:0;return[{zIndex:110,type:"Rect",fill:t,width:2,height:20,alignment:"map",offsetY:r},{zIndex:111,type:"Circle",fill:e,radius:7,alignment:"map",stroke:t,strokeWidth:1,offsetY:2.5*r},{zIndex:110,type:"Circle",stroke:t,radius:5,alignment:"map"}]}(e,n,s),h=0,f=u;h<f.length;h++){var g=f[h];null==g.lineOffset&&(g.lineOffset=l)}this.markers=["from","to"].map(function(e){return new jt(r,t,s,i[e],u,function(e){o.locked()},function(e){o.options.dragStart(e,o)},function(e){o.draw(),o.updateSegments(),o.options.dragMove(e,o)},function(e){o.options.dragStop(e,o)})}),this.overlay=r,this.updateSegments()}function Ut(e,t){return e.concat(t.slice(1))}function Kt(e,t,r,i){return{zIndex:e,type:"Line",stroke:t,strokeWidth:r,strokeDasharray:i||"none",strokeLinejoin:"round",strokeLinecap:i?"butt":"round"}}function Vt(){return[Kt(0,"white",23),Kt(1,"grey",20),Kt(2,"white",3,[5,4])]}var Jt=(Yt.prototype.updateStyle=function(e){e=e||Vt(),this.style=e,this.overlay.layer.setStyleGroup(this.feature,e)},Yt.prototype.removeZones=function(){this.zones.forEach(function(e){e.remove()}),this.zones.length=0},Yt.prototype.coord=function(){return this.completePath.map(function(e){return e.slice()})},Yt.prototype.hide=function(){this.overlay.remove(this.feature)},Yt.prototype.show=function(e){var t=this,r=this.overlay;this.removeZones(),r.addFeature(this.feature,this.style),e.forEach(function(e){-1!=["L","R","B"].indexOf(e.side)&&(e=new Ht(t,r,e),t.zones.push(e),e.draw())})},Yt.prototype.addLink=function(o){var n=this,s=o.coord(),a=this.links;function e(e,t){return e[0]===t[0]&&e[1]===t[1]}et.defaults(o);function t(e,t,r){if(r&&s.reverse(),0===e){for(var i=0;i<a.length;i++)a[i].from+=t,a[i].to+=t;n.completePath=Ut(s,c)}else n.completePath=Ut(c,s);a.unshift({from:e,to:t,link:o,reversed:!!r})}var c=this.completePath;e(s[s.length-1],c[0])?t(0,s.length-1):e(s[0],c[0])?t(0,s.length-1,!0):e(s[0],c[c.length-1])?t(c.length-1,c.length+s.length-2):e(s[s.length-1],c[c.length-1])&&t(c.length-1,c.length+s.length-2,!0),this.overlay.setFeatureCoordinates(this.feature,this.completePath)},Yt.prototype.destroy=function(){this.hide(),this.removeZones()},Yt.prototype.getZones=function(){return this.zones},Yt.prototype.getZoneSegments=function(e){var r=e.markers[0],i=e.markers[1],o=[];function n(e){var t=e[0];e[0]=e[1],e[1]=t}return this.links.forEach(function(e){var t=[r.getRelPosOfSubLink(e),i.getRelPosOfSubLink(e)];t[0]>t[1]&&n(t),e.reversed&&(n(t),t[0]=1-t[0],t[1]=1-t[1]),t[0]!==t[1]&&o.push({navlink:e.link,from:t[0],to:t[1],reversed:e.reversed})}),o},Yt);function Yt(e,t,r){this.zones=[],this.links=[];var i=e.objects.overlay;if(this.iEdit=e,void 0===t)return null;e=this.completePath=t.coord(),r=this.style=r||Vt();this.overlay=i,this.feature=i.addPath(e,r),this.hide(),this.links.push({from:0,to:e.length-1,link:t,reversed:!1}),i.setFeatureCoordinates(this.feature,this.completePath)}var Qt=(Wt.prototype.isCandidate=function(e){var t,r=this.candidates;for(t in r)for(var i in r[t])if(e.id===r[t][i].link.id)return t;return null},Wt.prototype.getCollection=function(){return this.multiLink},Wt.prototype.show=function(e){this.multiLink&&this.multiLink.show(e)},Wt.prototype.hide=function(){for(var e=this.multiLink,t=this.parents,r=0;r<t.length;r++)et.defaults(t[r]);this.parents=[],this.candidates={ref:null,nref:null},e&&(e.destroy(),this.multiLink=null)},Wt.prototype.addLink=function(e){var t,r,i,o=this.multiLink,n=this.parents,s=this.candidates;if(null!=e&&(i=e.coord().length-1,(r=!n.length)&&(s.ref=e.getConnectedLinks(0,!0),s.nref=e.getConnectedLinks(i,!0),n.push(et.deHighlight(e)),this.multiLink=o=new Jt(e._e(),e,this.mlStyle)),t=this.isCandidate(e))){var a,c=n[n.length-1],l=s[t];for(a in et.deHighlight(c),l)et.defaults(l[a].link),l[a].link.id==e.id&&(s[t]=e.getConnectedLinks(0==l[a].index?i:0,!0),n.push(e),o.addLink(e))}return!(!t&&!r)},Wt.prototype.setMLStyle=function(e){this.mlStyle=e,this.multiLink&&this.multiLink.updateStyle(e)},Wt);function Wt(e){this.multiLink=null,this.candidates={ref:null,nref:null},this.parents=[],this.display=e.display}var Zt=(Xt.createEditorEvent=function(e,t,r,i){return new At(r||e.type,e.mapX,e.mapY,e.nativeEvent,e.button,t,i||e.detail)},Xt.prototype.trigger=function(e,t,r){var i,o,n=r||e.type||e;return(r=t)&&r.class?(i=e.detail,o=t):i=t,"touchend"==e.type&&(e=e.changedTouches[0]),t=this.listeners.trigger(n,Xt.createEditorEvent(e,o,n,i),"_"==n[0]),t="pointerup"==n?this.listeners.trigger("tap",[new At("tap",e.mapX,e.mapY,e.nativeEvent,e.button,o,i)],!1)||t:t},Xt.prototype.bind=function(e,t,r){return this.listeners.add(e,t,r)},Xt.prototype.remove=function(e,t,r){return this.listeners.remove(e,t,r)},Xt.prototype.supported=function(){return this.listeners.getEvents()},Xt.prototype.destroy=function(){this.listeners=null},Xt);function Xt(){this.listeners=new I.Listener(["tap","dbltap","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay"]).sync(!0)}function qt(e){var t=e.options;return{id:t.id,from:t.from,to:t.to,side:t.side,style:t.style,segments:e.segments}}var $t=(er.prototype.add=function(e){for(var t=e instanceof Array?e:[].slice.call(arguments),r=0;r<t.length;r++)t[r]instanceof ft&&this.links.addLink(t[r])},er.prototype.show=function(e){e=this.zones=e instanceof Array?e:[].slice.call(arguments);e.forEach(function(e){e.from=e.from||0,e.to=(null==e.to?1:e.to)||0;for(var t=0,r=["markerStyle","lineStyle"];t<r.length;t++){var i=r[t],o=e[i];o&&!Array.isArray(o)&&(e[i]=[o])}for(var n=0,s=["dragStart","dragMove","dragStop"];n<s.length;n++)!function(r){var i=e[r];i&&(e[r]=function(e,t){e.detail.zone=qt(t),i(Zt.createEditorEvent(e,e.target,r))})}(s[n])}),this.links.show(e)},er.prototype.hide=function(){return this.links.hide()},er.prototype.info=function(){var t=[],e=this.links.getCollection();return e&&e.getZones().forEach(function(e){t.push(qt(e))}),t},er.prototype.setStyleGroup=function(e){this.links.setMLStyle(e)},er);function er(e){this.links=new Qt(e)}function tr(a,e,r,c,t,i){var l,d,p,u,h,f,o=r.addImage(e,t);o.pressmove=function(e,t,r,i,o){l||c.visible(!(l=!0));for(var n=I.geotools.calcBearing(p,a.map.getGeoCoord(e.mapX,e.mapY))-u,s=0;s<d.length;s++)f=d[s],ct._setCoords(f,a.map.rotateGeometry(f.geometry,p,n-h));h=n},o.pointerdown=function(e){l=!1,p=c.getCenter(),u=I.geotools.calcBearing(p,a.map.getGeoCoord(e.mapX,e.mapY)),d=c.getObjects(),h=0},o.pointerup=function(){l&&(1<d.length||"Point"!=d[0].geometry.type)&&(c.markObjsAsMod(),c.objBBoxChanged()),p=d=null,c.visible(!0)},o.pointerenter=o.pointerleave=function(e){e="pointerenter"==e.type;document.body.style.cursor=e?"move":"default",a.setStyle(o,e?i:t)},this.setPosition=function(e,t){r.setFeatureCoordinates(o,[e,t])},this.hide=function(){r.hideFeature(o)},this.show=function(){r.showFeature(o)},this.remove=function(){r.remove(o)}}function rr(s,e,r,a,t,i){var c,l,d,o=r.addCircle(e,t),p=null;o.pointerdown=function(){c=!1,d=l=0,p=a.getObjects()},o.pressmove=function(e,t,r,i,o){c=!0;for(var n=0;n<p.length;n++)s.map.pixelMove(p[n],t-l,r-d);l=t,d=r,a.objBBoxChanged()},o.pointerup=function(){c&&a.markObjsAsMod(),p=null},this.setPosition=function(e,t){r.setFeatureCoordinates(o,[e,t])},this.getCenter=function(){return o.geometry.coordinates.slice()},this.hide=function(){r.hideFeature(o)},this.show=function(){r.showFeature(o)},this.remove=function(){r.remove(o)}}function ir(h,e,t,r,i,s,f,o,n){for(var g,v,A,y,m,a=[s.addRect(e,t,r,i,o)],c=[[[e,i],[r,i]],[[r,i],[r,t]],[[r,t],[e,t]],[[e,t],[e,i]]],l=0;l<c.length;l++){var d=l%2;a.push(s.addPath(c[l],[{zIndex:0,zLayer:1/0,type:"Line",opacity:.02,strokeWidth:4}],{orientation:d?"V":"H",index:l,cursor:(d?"ew":"ns")+"-resize"}))}function p(e,t,r){var i=this.properties.index,o=this.properties.orientation,n=null,s=null,a=m,c=[],l=h.map.getGeoCoord(e.mapX,e.mapY),e=f.getGap();if((1!=a.length||"Point"!=a[0].geometry.type)&&(y=!0,"V"==o&&0<v?(c[1]=g[3],c[0]=g[0]+((s=1)==i?0:v),l[0]+=1==i?-e:e,n=(v+l[0]-(g[0]+v))/v,n=3==i?1-n:n):0<A&&(c[0]=g[0],c[n=1]=g[3]-(2==i?0:A),l[1]+=2==i?e:-e,s=(A+(g[1]-l[1]))/A,s=0==i?1-s:s),n&&s)){for(var d=0;d<a.length;d++){var p=a[d],u=h.map.scaleGeometry(p.geometry,[n/this.properties.fx,s/this.properties.fy],c);ct._setCoords(p,u)}f.objBBoxChanged(),this.properties.fx=n,this.properties.fy=s}}function u(){m=f.getObjects(),y=!1,g=m.getBBox(),v=g[2]-g[0],A=g[3]-g[1],this.properties.fx=1,this.properties.fy=1}function S(){y&&f.markObjsAsMod()}function _(){document.body.style.cursor=this.properties.cursor}function k(){document.body.style.cursor="default"}for(var x=0;x<a.length;x++){var C=a[x];C.pointerdown=u,C.pressmove=p,C.pointerup=S,C.pointerenter=_,C.pointerleave=k}this.update=function(e,t,r,i){var o=[[[e,i],[r,i]],[[r,i],[r,t]],[[r,t],[e,t]],[[e,t],[e,i]]];s.modifyRect(a[0],e,t,r,i);for(var n=1;n<a.length;n++)s.setFeatureCoordinates(a[n],o[n-1])},this.hide=function(){s.hideFeature(a)},this.show=function(){s.showFeature(a)},this.remove=function(){s.remove(a)}}var or="data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs=",nr="data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=",sr=18,ar=function(e){for(var t=[1/0,1/0,-1/0,-1/0],r=0,i=e;r<i.length;r++){var o=i[r],o=o.getBBox?o.getBBox():o.bbox;o[0]<t[0]&&(t[0]=o[0]),o[1]<t[1]&&(t[1]=o[1]),o[2]>t[2]&&(t[2]=o[2]),o[3]>t[3]&&(t[3]=o[3])}return t};function cr(s){var a=s.objects.overlay,c=this,l=null,d=null,p=null,u=null,h=4e-5,o=[],f="#010B1E";function n(e){for(var t=e.length;t--;){var r=e[t];0<=o.indexOf(r.id)&&ct._editable(r,!0)}}c.markObjsAsMod=function(){for(var e=u.length,t=0;t<e;t++)ct.markAsModified(u[t],!1);e&&s.objects.history.saveChanges()},c.getObjects=function(){return u},c.visible=function(e){p&&(e?(l.show(),p.show(),d.show()):(l.hide(),p.hide(),d.hide()))},this.isActive=function(){return null!==l},this.hide=function(){l&&(l.remove(),p.remove(),d.remove()),(l=d=p=null)!=u&&(n(u),u=null)},this.objBBoxChanged=function(){var e=u.getBBox(),t=e[0]-=h,r=e[1]-=h,i=e[2]+=h,o=e[3]+=h,n=e[0]+(e[2]-e[0])/2,e=e[1]+(e[3]-e[1])/2;null!=l?l.update(t,r,i,o):(l=new ir(s,t,r,i,o,a,c,{type:"Line",zIndex:0,zLayer:1/0,strokeDasharray:[4,4],strokeWidth:2,stroke:f}),d=new rr(s,[n,e],a,c,{type:"Circle",zIndex:0,zLayer:1/0,stroke:"#FFFFFF",fill:f,strokeWidth:3,opacity:.3,radius:9}),p=new tr(s,[i,r],a,c,[{type:"Image",zIndex:4,zLayer:1/0,src:or,width:sr,height:sr}],[{type:"Image",zIndex:4,zLayer:1/0,src:nr,width:sr,height:sr}])),p.setPosition(i,r),d.setPosition(n,e)},this.getGap=function(){return h},this.getCenter=function(){return d.getCenter()},this.show=function(e){var t;s.listeners.trigger("_clearOverlay"),null!=u&&n(u),(u=e instanceof Array?e:[e]).getBBox=function(){return ar(u)},o=[];for(var r=0,i=void 0;r<u.length;r++)t=u[r],i=ct.private(t),ct.deHighlight(t),i.isSelected=!1,i.allowEdit&&(o.push(t.id),ct._editable(t,!1));c.objBBoxChanged()}}var lr=["ready","active","history.current","history.length","changes.length"],dr={ready:void 0,active:null},pr=(ur.prototype.addObserver=function(e,t,r){var i=this.val;if("*"==e)for(var o in i)this.addObserver(o,t,r);else this.listeners.add(e,t,r)},ur.prototype.removeObserver=function(e,t,r){var i=this.val;if("*"==e)for(var o in i)this.removeObserver(o,t,r);else this.listeners.remove(e,t,r)},ur.prototype.get=function(e){return this.val[e]},ur.prototype.change=function(e,t,r){var i=this.val[e];(r||i!=t&&this.get("active"))&&(this.val[e]=t,this.listeners.trigger(e,[e,t,i]))},ur);function ur(){this.listeners=new I.Listener(lr).sync(!0),this.val={};for(var e,t=this.val,r=lr.length;e=lr[--r];)t[e]=void 0!==(e=dr[e])&&e}var hr=(fr.prototype.add=function(e){ct.private(e).isSelected=!0,this.s.push(e)},fr.prototype.remove=function(e){var t=this.s;ct.private(e).isSelected=!1,t.splice(t.indexOf(e),1)},fr.prototype.select=function(e){var t=this.display.getZoomlevel(),r=e.getProvider();if(t>=r.minLevel&&t<=r.maxLevel)return this.clearSelected(),this.add(e),!0;this.zClearFeat=e},fr.prototype.getCurSelObj=function(){return this.s[0]},fr.prototype.unselectFeature=function(e){var t=this.ie;!e&&t._config.keepFeatureSelection||((e=this.getCurSelObj())&&((e=ct.private(e,"xt"))&&e.clear(),t.listeners.trigger("featureUnselected",{featureUnselected:!0})),this.clearSelected())},fr.prototype.clearSelected=function(){var r,i=this,e=this.s,t=this.ie;return t.listeners.trigger("_clearOverlay"),e.forEach(function(e){var t=ct.getTool(e,"deHighlight");t&&(t(r=e,!0),i.remove(e)),ct.private(e).isSelected=!1}),e.length=0,this.zClearFeat=null,t.transformer.hide(),r},fr);function fr(e,i){this.s=[],this.zClearFeat=null,this.ie=e,this.display=i;var o,n=this;e._config.keepFeatureSelection&&(o=i.getZoomlevel(),i.addEventListener("mapviewchangeend",function(){var e,t,r=i.getZoomlevel();r!=o&&(t=void 0,(e=n.getCurSelObj()||n.zClearFeat)&&((t=e.getProvider().minLevel)<=o?r<t&&(n.clearSelected(),n.zClearFeat=e):t<=r&&ct._select(e))),o=r}))}var gr="@ns:com:here:editor",vr=(Ar.prototype.clone=function(e){return e&&JSON.parse(JSON.stringify(e))},Ar.prototype.add=function(e,t,r){var i=this.steps[e]||{},o=i[t]=i[t]||{},t=r.id;if(!o[t])return o[t]=r,this.set(e,i),!0},Ar.prototype.remove=function(e,t,r){try{var i=this.steps[e][t],o=r.id;if(i[o])return delete i[o],this.set(e,this.steps[e]),!0}catch(e){}return!1},Ar.prototype.get=function(e){return this.clone(this.steps[e])},Ar.prototype.set=function(e,t){this.steps[e]=this.clone(t)},Ar.prototype.clear=function(){var e,t=this.steps;for(e in t)delete t[e]},Ar);function Ar(){this.steps={}}function yr(e){return e.properties[gr]}function mr(e){var t=e.toJSON(),r=yr(t);return t.class=e.class,r&&(delete r.hovered,delete r.selected),t}var Sr=(_r.prototype.updateObservers=function(e){var t=this.iEdit.observers;t.change("changes.length",this.getLength()),t.change("history.length",this.total),t.change("history.current",this.current,e)},_r.prototype.getTotal=function(){return this.total},_r.prototype.getLength=function(){var e,t=this.getChanges(),r=0;for(e in t)for(var i in t[e])yr(t[e][i]).origin||r++;return r},_r.prototype.remove=function(e){var t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)},_r.prototype.origin=function(e,t){var r=e.id,i=e.getProvider().id,o=this.storage,n=this.changes,s=this.current,a=o[s];(n[i]||(n[i]={}))[r]=e,a&&a[i]&&a[i][r]||(r=mr(e),e=yr(r),t&&(e.removed=!0),e.origin=!0,o.add(s,i,r))},_r.prototype.saveChanges=function(){var e,t,r=this,i=0;return r.active()&&(r.cached=null,(i=(e=function(e){var t,r={},i=0;for(t in e)for(var o in r[t]={},e[t])r[t][o]=mr(e[t][o]),i++;return{data:r,length:i}}(r.changes)).length)&&(t=++r.current,r.storage.set(t,e.data),t>r.total?r.total++:r.total=t,r.iEdit.dump("History step saved...",t,"warn"),r.changes={},r.updateObservers())),i},_r.prototype.getChanges=function(){if(!this.cached){for(var e,t=this.storage,r=this.current,i={},o=1;o<=r;o++)for(var n in e=t.get(o))for(var s in e[n]){var a=e[n][s];!function(e){e=yr(e);return e.created&&e.removed}(a)?function(e){e=yr(e);return e.modified||e.removed||e.split||e.created}(a)&&((i[n]=i[n]||{})[s]=a):i[n]&&i[n][s]&&delete i[n][s]}this.cached=i}return this.cached},_r.prototype.clear=function(){var e=this;e.storage.clear(),e.current=0,e.total=0,e.changes={},e.cached=null,this.updateObservers(!0)},_r.prototype.import=function(e){var t,r=this,i=r.storage;for(t in e)for(var o in e[t]){var n=r.iEdit.objects.get(o,t);n?r.origin(n):((o=(n=I.JSUtils.extend(!0,{},e[t][o])).properties[gr]=n.properties[gr]||{}).removed=!0,o.origin=!0,i.add(r.current,t,n))}r.total=++r.current,i.set(r.current,e),r.recoverViewport(0)},_r.prototype.recoverViewport=function(e,t){var r=+new Date,e=this.current+e,i=this.storage.get(e),o=this.iEdit;if(this.cached=null,0<=e&&e<=this.total){o.objects.selection.unselectFeature(),o.dump(arguments,e,"REBUILDED VIEW IN",+new Date-r,"ms"),o.objects.selection.getCurSelObj()&&o.listeners.trigger("featureUnselected",{featureUnselected:!0}),o.objects.selection.clearSelected();var n,s=[];for(n in i){var a,c=i[n];for(a in c)s["NAVLINk"==(u=c[a]).class?"unshift":"push"]({provider:o.getProviderById(n),feature:u})}for(var l=0,d=s;l<d.length;l++){var p=d[l],u=p.feature,h=p.provider,p=h.search(u.id);p&&h.removeFeature(p);var f=yr(u);if(!f.removed){for(var g in u=o.objects.create({feature:u,provider:h,history:!0}),f)u.properties[gr][g]=f[g];o.setStyle(u)}}this.current=e,t||this.updateObservers()}},_r.prototype.active=function(e){return arguments.length&&(this._a=!!e),this._a},_r.prototype.ignore=function(e){var t=this.active();this.active(!1),e(),this.active(t)},_r);function _r(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new vr}var kr,xr=(Cr.prototype.push=function(e,t){var r,i,o={};t&&"Feature"==t.type&&(e=arguments,t=void 0),null==e.length&&(e=[e]);for(var n=this._e,s=0,a=e;s<a.length;s++){var c=a[s];(i=n.objects.add(c,t,o))&&(c=i,r=!0),this[this.length++]=c}return r&&n.objects.history.saveChanges(),this.length},Cr.prototype.forEach=function(e,t){for(var r=0;r<this.length;r++)e.call(t,this[r],r)},Cr.prototype.toArray=function(){for(var e=[],t=0;t<this.length;t++)e[e.length]=this[t];return e},Cr.prototype.highlight=function(){for(var e,t=this.length;e=this[--t];)ct.highlight(e)},Cr.prototype.remove=function(){for(var e=this,t=e._e.objects,r=!1,i=e.length;i--;)r=t.remove(e[i],{animation:!1,save:!1})||r,delete e[i];r&&(e.length=0,t.history.saveChanges())},Cr.prototype.transform=function(){this.length&&this._e.transformer.show(this.toArray())},Cr.prototype.unHighlight=function(){for(var e,t=this.length;e=this[--t];)ct.deHighlight(e)},Cr.prototype.unhighlight=function(){return this.unHighlight()},Cr.prototype.pop=function(){var e=this;if(e.length){var t=e[--e.length];return delete e[e.length],t}},Cr.prototype.getBBox=function(){for(var e,t=this,r=[1/0,1/0,-1/0,-1/0],i=0;i<t.length;i++)(e=t[i].getBBox?t[i].getBBox():t[i].bbox)[0]<r[0]&&(r[0]=e[0]),e[1]<r[1]&&(r[1]=e[1]),e[2]>r[2]&&(r[2]=e[2]),e[3]>r[3]&&(r[3]=e[3]);return t.length?r:[0,0,0,0]},Cr);function Cr(e){this.type="CONTAINER",this.length=0,this._e=e}function br(e,t,r){return{geometry:{coordinates:t,type:e},type:"Feature",properties:r||{}}}function Lr(e){return e=e?e instanceof Array?e:[e]:kr}function Er(e,t,r,i){return[[[e,t],[e,i],[r,i],[r,t],[e,t]]]}var Pr=(Ir.prototype.getProvider=function(){return this.layer.getProvider()},Ir.prototype.hideFeature=function(){for(var e,t=this.layer,r=0;r<arguments.length;r++)(e=(e=arguments[r])instanceof xr?e.toArray():e)instanceof Array?this.hideFeature.apply(this,e):t.setStyleGroup(e,function(e,t){for(var r=0;r<e.length;r++)e[r].opacity!=kr&&(e[r]._opacity=e[r]._opacity||e[r].opacity),e[r].opacity=t;return e}(t.getStyleGroup(e),0))},Ir.prototype.showFeature=function(){for(var e,t=this.layer,r=0;r<arguments.length;r++)(e=(e=arguments[r])instanceof xr?e.toArray():e)instanceof Array?this.showFeature.apply(this,e):t.setStyleGroup(e,function(e){for(var t=0;t<e.length;t++)e[t].opacity=e[t]._opacity==kr?1:e[t]._opacity,delete e[t]._opacity;return e}(t.getStyleGroup(e)))},Ir.prototype.addFeature=function(e,t){t=this.layer.addFeature(e,Lr(t));return t.properties["@ns:com:here:editor"]=t.properties["@ns:com:here:editor"]||new dt,t},Ir.prototype.addCircle=function(e,t,r){return this.addFeature(br("Point",e,r),t)},Ir.prototype.remove=function(e){var t=this.layer;if(e instanceof xr)for(var r=0;r<e.length;r++)t.removeFeature(e[r]);else e&&t.removeFeature(e)},Ir.prototype.setFeatureCoordinates=function(e,t){e._provider.setFeatureCoordinates(e,t)},Ir.prototype.getStyles=function(e){return this.layer.getStyleGroup(e)},Ir.prototype.modifyRect=function(e,t,r,i,o){this.setFeatureCoordinates(e,Er(t,r,i,o))},Ir.prototype.addRect=function(e,t,r,i,o){return this.addFeature(br("Polygon",Er(e,t,r,i)),o)},Ir.prototype.addPolygon=function(e,t,r){return this.addFeature(br("Polygon",[e],r),t)},Ir.prototype.addSquare=function(e,t,r,i,o){var n=I.geotools.movePoint;return this.addPolygon([n(e,t,-45+(r^=0)),n(e,t,45+r),n(e,t,135+r),n(e,t,225+r),n(e,t,-45+r)],i,o)},Ir.prototype.addPath=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:r||{}},Lr(t))},Ir.prototype.addPoint=function(e,t,r){return t instanceof Array||(r=t,t=kr),this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}},Lr(t))},Ir.prototype.addImage=function(e,t,r){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:r||{}},Lr(t))},Ir);function Ir(e){this.layer=e}function wr(e){return e.properties["@ns:com:here:editor"].hovered}function Rr(e,t,r){return"function"==typeof e?e(t,r):e}function Or(){return[{zLayer:function(e){return e.properties.zLayer},zIndex:999990,type:"Line",strokeWidth:2,stroke:"#FF0000"}]}function Fr(){return[{zIndex:0,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20}]}function Nr(){return[{zLayer:function(e){return e.properties.zLayer},zIndex:999991,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zLayer:function(e){return e.properties.zLayer},zIndex:999992,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}]}function Dr(e){return[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:jr,strokeWidth:1.5},{zIndex:1,type:"Text",fill:jr,font:"normal 16px Arial",text:e}]}function Br(e){return[{zIndex:1,type:"Image",src:e,width:24,height:24,alignment:"map",rotation:function(e){return e.properties.rotation}}]}var Mr="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==",jr="#111111",Tr=(Gr.prototype.assign=function(e){e=e.class||e.properties.type;return void 0!==this.styleGroups[e]?e:"UNKNOWN"},Gr);function Gr(){this.styleGroups={ADDRESS_LINE:Or(),ADDRESS_ROUTING_POINT:Nr(),ADDRESS_SELECTOR:Fr(),PLACE_LINE:Or(),PLACE_ROUTING_POINT:Nr(),AREA_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:2,stroke:jr,radius:function(e){return wr(e)?6:4},fill:function(e,t){return wr(e)?jr:Rr(e.properties.AREA.style[0].fill,e,t)}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",strokeWidth:1,fill:jr,stroke:jr,radius:function(e){return wr(e)?5:3}}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style[0].strokeWidth;return Rr(r,e,t)/2+4^0},stroke:function(e,t){var r=e.properties.LINE.style.filter(function(e){return"Line"==e.type}),i=r.length-1;return 0<i?Rr(r[i].stroke,e,t):jr},fill:function(e,t){var r=e.properties.LINE.style;return 1<r.length?Rr(r[0].stroke,e,t):"#151515"},strokeWidth:2}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:function(e,t){var r=e.properties.LINE.style[0].strokeWidth;return Rr(r,e,t)/2^0},fill:"#151515"}],MARKER_SELECTOR:Fr(),PLACE_SELECTOR:Fr(),NAVLINK_SHAPE:[{zIndex:0,type:function(e){return e.properties.isConnected?"Rect":"Circle"},width:function(e){return wr(e)?18:12},rotation:45,radius:function(e){return wr(e)?9:6},strokeWidth:2,fill:function(e,t){return e.isOverlapping()?"#FFFFFF":Rr(e.properties.NAVLINK.style[0].stroke,e,t)},stroke:function(e){return e.isOverlapping()?"#FF0000":"#FFFFFF"}}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:function(e){return e.properties.NAVLINK.style[0].strokeWidth/5},opacity:.7,fill:jr,stroke:jr,strokeWidth:2}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:function(e){return e.properties.bearing},width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:Mr,rotation:90,width:24,height:24,alignment:"map"}],NAVLINK_DIRECTION_HINT_A:Dr("A"),NAVLINK_DIRECTION_HINT_B:Dr("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:function(e){return-e.properties.bearing},opacity:.7,alignment:"map"}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:Mr,width:24,height:24,rotation:90,alignment:"map"}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAMQAAAAAAAAA/wBAvwBA/wBNzBRO2ABV/wtV2gxVzgdW0wpX1ApY1Qpa3BJbyABd0Qtd4wtf6Ath6wBmzABm/wBt2wCAgACA/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABgALAAAAAAkABQAAAW/ICZiC6Ocijmu43KaqMq+aMwwT6Tv0fPANZlIAQGmaidSjeRCniKK4aPWvNFYypeveZpijqjH4quYpm5oXGna5Lq+XCHZGUtKa2Z8dKXgBvcjZVRODGOBeUheKwuIdIaHdIIzjUhvfJRdgHeRfZpfmJKXnCePm06KkKOFi6CoIoyjoYF+dZODnVeBqnafeoJhY5lnaWo4t529KFUwqzMxW3pDRX9UTAvXcJERpS5GLzc5PDo+3kdYX0ZyWHUxpSEAOw==",width:36,height:20,rotation:function(e){return e.properties.rotation},alignment:"map"}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:function(e){return"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}}],TURN_RESTRICTION_ONEWAY:Br(Mr),TURN_RESTRICTION_FORBIDDEN:Br("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:Br("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:Br("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]}}var Hr,zr=(t(Ur,Hr=w.LocalProvider),Ur);function Ur(e){var t=this;return(e=void 0===e?{}:e).name="EOP",(t=Hr.call(this,e)||this).id="EOP-"+t.id,t}function Kr(e){return e.class}var Vr,Jr="pointerenter pointerleave pointerup pressmove pointerdown dbltap",Yr="addLayer removeLayer",Qr=(Wr.prototype.onMVCStart=function(){this.selection.unselectFeature()},Wr.prototype.splitLinkAt=function(e){return function(o,e){var t,r,i=e.link,n=e.index,s=e.preferSegment,a=e.avoidSnapping,c=i.coord(),l=c.length-1,d=et._props(i),p=i.getProvider().readZLevels(i),u=o._config.minShapeDistance;if(e.point&&(t=e.point[0],r=e.point[1]),0===n||n===l||t==c[0][0]&&r==c[0][1]||t==c[l][0]&&r==c[l][1])return!1;if(o.objects.history.origin(i),void 0===n){u=o.map.calcCrossingAt(c,e.point,u,s),n=u.index;if(u.existingShape&&(0===n||n===l))return!1;n=et.addShp(i,[t,r],null,!0,null,s),c=i.coord()}et.deHighlight(i);var h=i.getProvider(),s=function(e,t,r){var i=I.JSUtils.extend(!0,{},d),e={type:"Feature",geometry:{type:"LineString",coordinates:e},properties:i};return delete i["@ns:com:here:editor"],o.objects.create({feature:e,provider:h,zLevels:t,preferIndex:r})},f=s(c.slice(0,n+1),p.slice(0,n+1),a&&n),g=s(c.slice(n),p.slice(n),a&&0),a=re(c[n],c);.995<a&&(a=1);var v,A=le(c,c[n]).offset,y=et.getConnectedObjects(i);for(v in y){var m=y[v],S=ke.getRoutingPosition(m),_=le(c,S).offset;ke.connect(m,_<A?f:g,S),ke.markAsModified(m,!1)}return o.hooks.trigger("Navlink.split",{link:i,index:n,children:[f,g],relativePosition:a},h),i.editState("split",Date.now()),o.objects.remove(i,{animation:!1,split:!0}),[f,g]}(this.iEdit,e)},Wr.prototype.destroy=function(){this.display.removeLayer(this.overlay.layer)},Wr.prototype.arrangeOverlay=function(e){var t=e&&e.detail.layer,r=this.display,i=this.overlay.layer;r.getLayers&&(e=r.getLayers(),t.getProvider()instanceof zr||(e=e.map(function(e){e=e.getProvider();return e&&e.class}).indexOf("NAVLINK"),r.removeLayer(i),0<=e?r.addLayer(i,e+1):r.addLayer(i)))},Wr.prototype.pointerListener=function(e){var t=this.iEdit,r=e.target,i=e.type;if(r){var o=e.detail.layer;if(!this.layers.has(o.id))return;o=ct.getEventListener(r,i);if(o)return e.stopPropagation(),o.apply(r,arguments)}"pointerup"!=i&&"dbltap"!=i||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)},Wr.prototype.listenDisplay=function(e){var t=this.display,r=this.listen,i=this.pointerListener,o=this.arrangeOverlay;e?r||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(Jr,i),t.addEventListener(Yr,o)):r&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(Jr,i),t.removeEventListener(Yr,o))},Wr.prototype.clear=function(){},Wr.prototype.get=function(e,t){var r=this.iEdit;return t?"object"!=typeof t&&(t=r.getLayer(t)):t=r.getLayer(e),(e="object"!=typeof e&&t?t.search(e):e)&&t?e:null},Wr.prototype.getInBBox=function(e,t){e=e||[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat];var r=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-r,e[1]-r,e[2]+r,e[3]+r];for(var i,o=[],n=0,s=(t=t||this.layers.values())instanceof Array?t:[t];n<s.length;n++)if(i=s[n].search(e))for(var a=0;a<i.length;a++)o.push(i[a]);return o},Wr.prototype.remove=function(e,t){var r=!1;if((t=t||{}).split||!this.iEdit._config.editRestrictions(e,2)){var i=null==t.animation||t.animation;i&&ct.private(e,"isSelected")&&this.selection.clearSelected(),Kr(e)&&(this.history.origin(e),ct.markAsRemoved(e,i),t.save&&this.history.saveChanges(),r=!0);t=e.getProvider();return e.editState&&!e.editState("created")&&t.blockFeature(e,!0),t.removeFeature(e),r}},Wr.prototype.add=function(e,t,r){var i=this.iEdit;if(!e.getProvider()&&(t="string"==typeof t?this.layers.get(t):t||i.getLayerForClass(Kr(e)))){var o=e.id,i=o!=Vr&&t.search(o);return o!=Vr&&i?i:this.create({feature:e,provider:t.getProvider(),idMap:r})}},Wr.prototype.create=function(e){var a=this.iEdit,c=a.objects.history,l=[],d=e.feature;Array.isArray(d)||(d=[d]);for(var p=e.idMap||{},u=e.provider,h=e.preferIndex,f=e.history,g=e.zLevels,t=function(e){var t,r,i,o,n=d[e],s=n.id;f||(n.id=Vr),n=u.prepareFeature(n),t=u.detectFeatureClass(n),s==Vr&&(s=n.id),p[s]=n.id,r=n,f&&u.blockFeature(r,!1),r=u.addFeature(r),r=u.search(r.id),f||(r.editState("created",Date.now()),ct.markAsModified(r,!1),c.origin(r,!0),g&&c.ignore(function(){u.writeZLevels(r,g)})),l.push(r),n=r,"NAVLINK"===t?(n.geometry.coordinates.forEach(function(e){e[2]=0^e[2]}),f||ct.fixGeo(n,Vr,Vr,h)):"PLACE"!==t&&"ADDRESS"!==t||(e=(i=ct.getRoutingData(n)).link,p[e]&&(s=ct.getRoutingProvider(n),o=s&&s.search(p[e]),c.ignore(function(){n.getProvider().writeRoutingPoint(n,o,i.position)})),"ADDRESS"===t&&(ct.connect(n),n.getLink()||(c.remove(n),u.removeFeature(l.pop()),a.dump("No Link found within "+a._config.maxRoutingPointDistance+" meters","warn"))))},r=0;r<d.length;r++)t(r);return 1<l.length?l:l[0]},Wr.prototype.getNearestLine=function(e,t,r){var i=this.iEdit;r=I.JSUtils.extend({ignore:[],maxDistance:1/0,shapeThreshold:0,onlyExsitingShape:!1},r||{});var o={line:null,point:null,distance:1/0,shpIndex:null,segmentNumber:null},n=e,s=r.maxDistance,a=s<1/0?I.geotools.getPointBBox(n,s):null;function c(e){return e[2]===Vr||n[2]===Vr||e[2]===n[2]?I.geotools.distance(e,n):1/0}t instanceof w.EditableFeatureProvider&&(t=this.getInBBox(a,t)),e=i.map.getPixelCoord(e);for(var l,d,p,u,h,f,g,v,A=0,y=t;A<y.length;A++){var m=y[A];if(-1==r.ignore.indexOf(m.id)&&(v=m.bbox,s==1/0||(l=a[0],d=a[2],p=a[1],u=a[3],h=v[0],f=v[2],g=v[1],v=v[3],l<=f&&h<=d&&p<=v&&g<=u))){for(var S,_=m.geometry.coordinates,k=void 0,x=r.maxDistance,C=void 0,b=[],L=void 0,E=void 0,P=0;P<_.length;P++)b[P]=i.map.getPixelCoord(S=_[P]),(E=c(S))<x&&(x=E,k=0^(0<(C=P)&&P-1),L=S);if(!r.onlyExsitingShape&&(L==Vr||x>r.shapeThreshold))for(P=0;P<b.length-1;P++)(S=R(b[P],b[P+1],e))&&(E=c([(S=i.map.getGeoCoord(S))[0],S[1]]))<x&&(x=E,C=null,k=P,L=S);L&&x<o.distance&&(o.point=L,o.distance=x,o.shpIndex=C,o.segmentNumber=k,o.line=m,s=I.geotools.distance(L,n),a=I.geotools.getPointBBox(n,s))}}return o.line?o:null},Wr);function Wr(r,e){this.listen=!1;var t=this;t.iEdit=r,t.display=e,t.history=new Sr(r),t.selection=new hr(r,e);var i,o,o=(i=r,(o=new zr)._e=function(){return i},new w.TileLayer({name:"EditorOverlay",min:1,max:28,style:new Tr,provider:o}));t.overlay=new Pr(o);var n=new I.Map([[o.id,o]]);this.layers=n,e.addLayer(o,function(e){for(var t=e.length;t--;){var r=e[t];if((r=r.getProvider())&&"NAVLINK"==r.class)return t+1}return e.length}(e.getLayers())),t.arrangeOverlay=t.arrangeOverlay.bind(t),t.pointerListener=t.pointerListener.bind(t),r.listeners.bind("_layerAdd",function(e){e=e.detail.layer;n.set(e.id,e)}),r.listeners.bind("_layerRemove",function(e){var t=e.detail.layer;n.delete(t.id);e=r.objects.selection.getCurSelObj();e&&r.getLayer(e)==t&&r.objects.selection.clearSelected()}),t.onMVCStart=t.onMVCStart.bind(t)}var Zr=(Xr.prototype.onStart=function(){var e;this.busy||(e=this.iEdit.layers,this.busy=new I.Set(e),e.length&&this.observers.change("ready",!1))},Xr.prototype.onStop=function(e){var t=e.detail.layer,e=this.busy;e&&(e.delete(t),e.size||(this.observers.change("ready",!0),this.busy=null))},Xr.prototype.start=function(){this.display.addEventListener("mapviewchangestart",this.onStart)},Xr.prototype.stop=function(){this.display.removeEventListener("mapviewchangestart",this.onStart)},Xr);function Xr(e,t){var r=this;this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.bind("_layerAdd",function(e){r.observers.change("ready",!1),r.display.setCenter(r.display.getCenter()),e.detail.layer.addEventListener("viewportReady",r.onStop)}),e.listeners.bind("_layerRemove",function(e){e.detail.layer.removeEventListener("viewportReady",r.onStop)})}function qr(r,i){function e(e,t){i&&t!=i||r(e)}return e.h=r,e}function $r(e,t){return e=e.__=e.__||String(1e9*Math.random()^0),t&&(e+=";"+t.id),e}var ei=["Navlink.split","Navlink.disconnect","Feature.remove"],ti=(ri.prototype.add=function(e,t,r){var i=$r(t,r),o=this.w.get(i);return o||this.w.set(i,o=qr(t,r)),this.h.add(e,o)},ri.prototype.remove=function(e,t,r){return this.h.remove(e,this.w.get($r(t,r)))},ri.prototype.get=function(e){return this.h.get(e).map(function(e){return e[0].h})},ri.prototype.trigger=function(e,t,r){var i=this.history,o=i.active();i.active(!1),this.h.trigger(e,[t,r]),i.active(o)},ri);function ri(e){this.h=new I.Listener(ei),this.h.sync(!0),this.history=e,this.w=new Map}var ii,oi=Math.PI/180,ni=function(e,t,r,i){this.point=[e,t],this.index=r,this.existingShape=i};function si(e,t){if("number"==typeof e[0])return t(e);for(var r=[],i=e.length;i--;)r[i]=si(e[i],t);return r}var ai=(ci.prototype.distance=function(e,t){return I.geotools.distance(e,t)},ci.prototype.rotatePoint=function(e,t,r){return this.clipGeoCoord((i=t,o=r,r=(t=e)[0]-i[0],e=t[1]-i[1],o*=oi,[i[0]+(Math.cos(o)*r-Math.sin(o)*e/Math.abs(Math.cos(i[1]*oi))),i[1]+(Math.sin(o)*r*Math.abs(Math.cos(i[1]*oi))+Math.cos(o)*e),0^t[2]]));var i,o},ci.prototype.movePoint=function(e,t,r,i){return this.clipGeoCoord(I.geotools.movePoint(e,t,r,i))},ci.prototype.scaleGeometry=function(e,t,r){var i=this;return si(e.coordinates,function(e){return i.clipGeoCoord([r[0]+(e[0]-r[0])*t[0],r[1]+(e[1]-r[1])*t[1],0^e[2]])})},ci.prototype.rotateGeometry=function(e,t,r){var i=this;return si(e.coordinates,function(e){return i.rotatePoint(e,t,r)})},ci.prototype.getClosestPoint=function(e,t,r){var i=e[0]-t[0],o=e[1]-t[1],e=e[1]*t[0]-e[0]*t[1],t=i*r[0]+o*r[1],r=1/(i*i+o*o);return[(t*i+e*o)*r,(t*o-e*i)*r]},ci.prototype.calcCrossingAt=function(e,t,r,i,o){var n,s,a,c=null,l=o||1/0,d=!1,p=null,u=null;if(i!=ii){o=this.calcCrossingAt(e.slice(i,i+2),t,r,ii,o);return o.index+=i,o}for(var h=0;h<e.length;h++)n=e[h],(a=this.distance(n,t))<=l&&(l=a,p=n[0],u=n[1],c=h,d=!0);if(r<l||!d)for(h=0;h<e.length;h++)h<e.length-1&&(s=R(e[h],e[h+1],t))&&(a=this.distance(s,t))<l&&(l=a,c=h+1,p=s[0],u=s[1],d=!1);return new ni(p,u,c,d)},ci.prototype.translateGeo=function(e,r,i){var o=this,n=o.display;return si(e,function(e){var t=n.geoToPixel(e[0],e[1]);return o.getGeoCoord(t.x+r,t.y+i,e[2])})},ci.prototype.pixelMove=function(e,t,r){var i=e.getProvider(),t=this.translateGeo(i.decCoord(e),t,r),r=ct.getTool(e,"_setCoords");r?r(e,t):i.setFeatureCoordinates(e,t)},ci.prototype.clipGeoCoord=function(e){return e[0]=Math.round(1e9*e[0])/1e9,e[1]=Math.round(1e9*e[1])/1e9,e},ci.prototype.getGeoCoord=function(e,t,r){var i,o=this.display;return 1<arguments.length?i=o.pixelToGeo(e,t):(i=e).x!=ii&&i.y!=ii?(r=i.z,i=o.pixelToGeo(i.x,i.y)):e[0]!=ii&&e[1]!=ii&&(r=i[2],i=o.pixelToGeo(i[0],i[1])),this.clipGeoCoord([i.longitude,i.latitude,0|r])},ci.prototype.getPixelCoord=function(e,t,r){var i=this.display;return 2==arguments.length?e=i.geoToPixel(e,t):e.longitude!=ii&&e.latitude!=ii?e=i.geoToPixel(e.longitude,e.latitude):e[0]!=ii&&e[1]!=ii&&(e=i.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]},ci.prototype.getEventsMapXY=function(e){var t,r,i=this.display;return r=e.mapX!=ii?(t=e.mapX,e.mapY):(r=i.getContainer().getBoundingClientRect(),t=e.pageX-r.left,e.pageY-r.top),[t,r]},ci);function ci(e){this.display=e}var li="error",di=(pi.prototype.cfg=function(e,t){switch(arguments.length){case 2:this._config[e]=t;break;case 1:return this._config[e];case 0:return this._config}},pi);function pi(e,t){this.isCommitInProcess=!1,this._config=e;var c=this;c.layers=[],c.layerMap={},c.observers=new pr,c.listeners=new Zt,c.objects=new Qr(c,t),c.hooks=new ti(c.objects.history);var r=new Zr(c,t);r.start();var e=c.objects.overlay.layer,s={};function a(e){c.listeners.trigger(li,e)}s[e.getProvider().id]=e,c.listeners.bind("_layerAdd",function(e){for(var t=e.detail.layer,r=t.getProvider(),i=0,o=["src","base","delta","id"];i<o.length;i++){var n=r[o[i]];n&&(s[n]=t)}t.removeEventListener(li,a),t.addEventListener(li,a)}),c.getLayerForClass=function(e){for(var t,r,i,o,n=0,s=c.layers;n<s.length;n++){var a=s[n];(r=(o=a.getProvider?a.getProvider():o).class)?e==r&&(i=a):t=t||a}return i||t},c.getProviderById=function(e){e=s[e];if(e)return e.getProvider()},c.getLayerById=function(e){for(var t=0,r=c.layers;t<r.length;t++){var i=r[t];if(i.id==e)return i}},c.getLayer=function(e){var t,r;return t=(e="object"==typeof e?(r=e.getProvider()).src||r.delta||r.base||r.id:e)?s[e]:t},c.getStyle=function(e,t){t=this.getLayer(e).getStyleGroup(e,void 0,t);return I.JSUtils.extend(!0,[],t)},c.setStyle=function(e,t,r){this.getLayer(e).setStyleGroup(e,t,r)},c.map=new ai(t),c.transformer=new cr(c),c.display=t,c.destroy=function(){r.stop(),c.objects.destroy(),c.listeners.destroy()},c.dump=I.JSUtils.dump}function ui(e,t,r,i){return e.getProvider().readTurnRestriction({link:e,index:t},{link:r,index:i})}function hi(e,t,r,i,o){t.getProvider().writeTurnRestriction(e,{link:t,index:r},{link:i,index:o})}function fi(s){[mi].forEach(function(e){for(var t in e)for(var r,i=0,o=r="function"==typeof(r=e[t])?[r]:r;i<o.length;i++){var n=o[i];s.hooks.add(t,n)}})}function gi(e){return e.properties["@ns:com:here:editor"]}function vi(e){return!!gi(e).created}function Ai(e){return!!gi(e).removed}var yi={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},geoFence:!1,minShapeDistance:2,autoConnectShapeDistance:2,intersectionScale:5,XTestMaxDistance:2,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,maxRoutingPointDistance:1e3,autoSnapShape:!1},mi={"Navlink.split":[function(e){for(var t=e.link,e=e.children,r=e[0],i=e[1],o=t.coord().length-1,n=r.coord().length-1,s=i.coord().length-1,a=0,c=t.getConnectedLinks(0,!0);a<c.length;a++){var l=c[a],d=l.link,p=l.index;ui(t,0,d,p)&&(hi(!0,r,0,d,p),hi(!1,i,0,d,p)),ui(d,p,t,0)&&(hi(!0,d,p,r,0),hi(!1,d,p,i,0))}for(var u=0,h=t.getConnectedLinks(o,!0);u<h.length;u++){var f=h[u],d=f.link,p=f.index;ui(t,o,d,p)&&(hi(!0,i,s,d,p),hi(!1,r,n,d,p)),ui(d,p,t,o)&&(hi(!0,d,p,i,s),hi(!1,d,p,r,n))}}],"Feature.remove":function(e){var t=e.feature;if("NAVLINK"==t.class){for(var r=t.coord().length-1,i=0,o=t.getConnectedLinks(0,!0);i<o.length;i++){var n=o[i],s=n.link,a=n.index;hi(!1,t,0,s,a)}for(var c=0,l=t.getConnectedLinks(r,!0);c<l.length;c++){var d=l[c],s=d.link,a=d.index;hi(!1,t,r,s,a)}}},"Navlink.disconnect":function(e){var r=e.link,i=e.index;r.getConnectedLinks(i,!0).forEach(function(e){var t=e.link,e=e.index;hi(!1,r,i,t,e),hi(!1,t,e,r,i)})}},Si="info",_i=(ki.prototype.reserveIds=function(e,i,o,t){var r,n=this.pIds,s=e.id,a=[];for(r in i)vi(i[r])&&(n[s][r]||a.push(i[r]));0<a.length?e.reserveId(a,function(e){for(var t in i){var r=i[t];vi(r)&&!n[s][t]&&(n[s][t]=e.shift())}o(n[s],s)},t):I.global.setTimeout(function(){o(n[s],s)},0)},ki.prototype.replaceIds=function(s,a,e){var c,t,r,i=this.pIds,l=this.iEdit,d=0,p=JSON.stringify(s);for(r in s){for(var o in d++,t=!1,s[r])if(vi(s[r][o])){t=!0;break}i[r]||(i[r]={}),t?(l.dump("REQUESTING PERMANENT IDs..",Si),this.reserveIds(l.getProviderById(r),s[r],function(e,t){var r,i,o,n="#"+I.JSUtils.String.random()+"#";for(o in e)(c=s[t][o])&&((r="number"==typeof e[o]?e[o]:'"'+e[o]+'"')!=(i="string"==typeof(i=c.id)?'"'+c.id.replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\")+'"':i)&&(p=p.replace(i+":{",n).replace(new RegExp('"link":'+i,"g"),'"link":"'+r+'"').replace(new RegExp(i,"g"),r).replace(n,r+":{")),l.dump(c.id+" -> "+r,Si));--d||a(JSON.parse(p))},e)):d--}d||a(s)},ki.prototype.send=function(e,t,r,i){var o,n=this.pIds,s=this.iEdit,a=0;function c(){--a||t(I.JSUtils.clone(n))}for(o in e){a++;var l,d,p=s.getProviderById(o),u=e[o],h=[],f=[];for(d in u)l=u[d],(Ai(l)?f:h).push(l);var g,v=n[o],A={};for(g in v)A[v[g]]=g;h.length|f.length?p.commit({put:h,remove:f},c,function(e){r&&r(e)},i):c()}},ki.prototype.submit=function(o,t,r,i){var n=this;void 0===i&&(i=I.JSUtils.String.random());var s=this.iEdit,a=s._config.services.reverseGeocoder.getISOCC,c=0;s.dump("COMMIT",i,Si);function l(){n.replaceIds(o,function(e){n.send(e,t,r,i)},r)}for(var d in o){var e,p=function(e){var t,r=o[d][e],i=s.getProviderById(d);Ai(r)?vi(r)&&delete o[d][e]:a&&(i.isoCC(r)||(c++,s.dump(r.id,"["+i.detectFeatureClass(r)+"] MISSING ISOCC -> REVERSE GEOCODING..",Si),r=function e(t){if(t)return"number"==typeof t[0]?t:e(t[0])}((t=r).geometry.coordinates),a(r[0],r[1],function(e){e&&i.isoCC(t,e),--c||l()})))};for(e in o[d])p(e)}c||l()},ki);function ki(e){this.pIds={},this.iEdit=e}function xi(e){var t=e.class;return t==Pi?Pi:String(t)+(e.src||e.base+e.delta||e.id)}function Ci(e,t,r){var i=t.hooks;if(i)for(var o in i)for(var n=i[o],s=0,a=n=!(n instanceof Array)?[n]:n;s<a.length;s++){var c=a[s];r.hooks[e](o,c,t)}}function bi(e){!function(e){var t,r,i,o=e.objects.history.getChanges(),n=[];for(i in o)for(var s in r=e.getProviderById(i),o[i])t=r.search(s),r._clearOnCommit?(t&&delete t.properties["@ns:com:here:editor"],n.push(r,o[i][s].bbox)):t&&(t.properties["@ns:com:here:editor"]={});for(var a=0;a<n.length;a+=2)(r=n[a]).clear.apply(r,n[a+1])}(e),e.objects.history.clear(),e.display.refresh()}var Li,Ei=null,Pi="NAVLINK",pt=(Ii.prototype.active=function(e){var t=this._i(),r=t.observers.get("active");return null!=e&&(e=!!e)!=r&&(t.objects.listenDisplay(r=e),t.observers.change("active",e,!0)),r},Ii.prototype.addEventListener=function(e,t,r){var i=this._i().listeners,o=i.supported().filter(function(e){return"_"!=e[0]});String(e).split(" ").forEach(function(e){-1<o.indexOf(e)?i.bind.call(i,e,t,r):I.JSUtils.dump(e+" is not a valid event. Use: "+o.join(", "),"warn")})},Ii.prototype.removeEventListener=function(e,t){var r=this._i().listeners;r.remove.apply(r,arguments)},Ii.prototype.addFeature=function(e,t,r){function o(e){return e.x!=Li&&e.y!=Li||e.longitude!=Li&&e.latitude!=Li}function i(e,t){t=t&&t.id,(p[t]=p[t]||[]).push(e)}var n,s,a=this._i(),c=arguments,l=[],d={},p={},u=function(e,t){if("number"==typeof(e=o(e)?a.map.getGeoCoord(e):e)[0])return e[0]+=t[0],e[1]+=t[1],a.map.clipGeoCoord(e);for(var r=[],i=0;i<e.length;i++)r[i]=u(e[i],t);return r};if("Feature"==e.type)i(e,t);else if(e instanceof Array)e.forEach(function(e){return i(e,t)});else for(var h in p=e)"Feature"==(e=p[h]).type&&(p[h]=[e]);s=o(r=c[c.length-1])?(r=a.map.getGeoCoord(r),c=a.display.getViewBounds(),[r[0]-c.minLon,r[1]-c.maxLat]):[0,0];for(var f in p)!function(r){p[r].forEach(function(e){var t=e.geometry;t.coordinates=u(t.coordinates,s),"Feature"!=e.type||e instanceof ft||(e=new ft(e)),(e=a.objects.add(e,"undefined"==r?Li:r,d))&&(n=!0,l.push(e))})}(f);return n&&a.objects.history.saveChanges(),1<l.length?this.createFeatureContainer.apply(this,l):l[0]},Ii.prototype.getFeature=function(e,t){return this._i().objects.get(e,t)||null},Ii.prototype.createFeatureContainer=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=new xr(this._i());return r.push(e),r},Ii.prototype.clearFeatureSelection=function(){return this._i().objects.selection.clearSelected()||null},Ii.prototype.search=function(e){var t,r=this._i(),i=[];if("object"==typeof e)for(var o=e.filter,n=e.layers||r.layers,s=n.length;s--;)for(var a=n[s].search(e),c=(a=!(a instanceof Array)?[a]:a).length;t=a[--c];)o&&!o(t)||i.push(t);return i},Ii.prototype.addLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=e.getProvider();if(i&&"FeatureProvider"==i.__type&&i.editable&&(!r[xi(i)]||i.class==Pi)){if(i._e instanceof di){if(i._e===t)return!1;throw new Error("Provider already in use by another editor")}return i._e=t,e.class=i.class,t.listeners.trigger("_layerAdd",{layer:e}),r[xi(i)]=e,t.layers.push(e),Ci("add",i,t),!0}}return!1},Ii.prototype.getLayers=function(e){var t=this._i().layers;return e?t[e]:t.slice()},Ii.prototype.removeLayer=function(e){if(e){var t=this._i(),r=t.layerMap,i=t.layers,o=e.getProvider(),n=xi(o);if("FeatureProvider"==o.__type&&o.editable&&r[n])return t.listeners.trigger("_layerRemove",{layer:e}),delete r[n],i.splice(i.indexOf(e),1),Ci("remove",o,t),delete o._e,!0}return!1},Ii.prototype.addObserver=function(e,t){this._i().observers.addObserver(e,t,arguments[2])},Ii.prototype.get=function(e){return this._i().observers.get(e)},Ii.prototype.removeObserver=function(e,t){this._i().observers.removeObserver(e,t,arguments[2])},Ii.prototype.destroy=function(){var e,t=this,r=t._i();for(e in t.getLayers().forEach(function(e){return t.removeLayer(e)}),t.active(!1),r.destroy(),t)delete t[e];return t.__proto__={},null},Ii.prototype.setZoomLevel=function(e){this._i().display.setZoomlevel(e)},Ii.prototype.getZoomLevel=function(){return this._i().display.getZoomlevel()},Ii.prototype.pixelToGeo=function(e){e=this._i().map.getGeoCoord(e);return e?new w.GeoPoint(e[0],e[1]):Ei},Ii.prototype.geoToPixel=function(e){e=this._i().map.getPixelCoord(e);return e?new w.PixelPoint(e[0],e[1]):Ei},Ii.prototype.revert=function(){for(var e=this._i(),t=e.observers.get("history.current");t--;)e.objects.history.recoverViewport(-1,!0);bi(e)},Ii.prototype.getDrawingBoard=function(){var e=this._i();return e._db=e._db||new Nt(e)},Ii.prototype.getZoneSelector=function(){var e=this._i();return e._zs=e._zs||new $t(e)},Ii.prototype.getOverlay=function(){return this._i().objects.overlay.layer},Ii.prototype.undo=function(e){for(e=Math.min(this.get("history.current"),e||1);e--;)this._i().objects.history.recoverViewport(-1,!!e)},Ii.prototype.redo=function(e){for(e=Math.min(this.get("history.length"),e||1);e--;)this._i().objects.history.recoverViewport(1,!!e)},Ii.prototype.submit=function(e){var t,r,i,o,n=!1,s=[],a=(e=e||{}).ignoreEventBlock,c=e.layer,l=e.onError,d=e.onSuccess,e=e.transactionId,p=this._i();if("function"==typeof a)throw new Error("Invalid parameter!");if(a||!p.isCommitInProcess){for(var u in c=c instanceof Array?c:[c]){u=c[u];u&&u instanceof w.TileLayer&&"MARKER"==u.type&&(u.base&&s.push(u.base),u.delta&&s.push(u.delta),u.src&&s.push(u.src))}for(var h in t=p.objects.history.getChanges())0<s.length&&s.indexOf(h)<0?delete t[h]:n=!0;if(n)return p.objects.clear(),a=t,i=function(e){bi(p),d&&d({permanentIDMap:e})},o=function(e){l&&l(e)},e=e,(r=p).isCommitInProcess||(r.objects.selection.clearSelected(),r.observers.change("ready",r.isCommitInProcess),r.isCommitInProcess=!0,new _i(r).submit(a,function(e){r.isCommitInProcess=!1,i.call(null,e)},function(e){r.isCommitInProcess=!1,o.call(null,e)},e)),!0}return!1},Ii.prototype.info=function(){var e,t=[],r=this._i().objects.history.getChanges();for(e in r)for(var i in r[e])t[t.length]=I.JSUtils.clone(r[e][i]);return t},Ii.prototype.export=function(){var e=this._i();return JSON.stringify(e.objects.history.getChanges())},Ii.prototype.import=function(e){var t=this._i();return"string"==typeof e&&(e=JSON.parse(e)),t.objects.history.import(e)},Ii.prototype.toGeoJSONCoordinates=function(e){if(Array.isArray(e)&&"number"!=typeof e[0]){for(var t=[],r=0,i=e;r<i.length;r++){var o=i[r];t.push(this.toGeoJSONCoordinates(o))}return t}return this._i().map.getGeoCoord(e)},Ii);function Ii(e,t){var r=this,i=this,o=(t=function(e){var t,r=I.JSUtils.extend(!0,{},yi);for(t in e)switch(t){case"services":I.JSUtils.extend(!0,r[t],e[t]);break;case"editRestrictions":if("function"!=typeof e[t])break;default:r[t]=e[t]}return r}(t||{})).layers;delete t.layers,I.JSUtils.loglevel=t.debug&&"debug";var n=new di(t,e);i._i=function(){return n},i.addHook=function(e,t,r){return n.hooks.add(e,t,r)},i.removeHook=function(e,t,r){return n.hooks.remove(e,t,r)},i.getHooks=function(e){return n.hooks.get(e)},fi(n),i.container=e.getContainer(),o instanceof Array&&o.forEach(function(e){return r.addLayer(e)}),i.active(!0),setTimeout(function(){var e=n.observers,t=e.get("active");e.change("active",t,t),n.layers.length||e.change("ready",!0)},0)}pt.prototype.clearObjectSelection=pt.prototype.clearFeatureSelection;var wi,vt=(t(Ri,wi=ft),Ri.prototype.coord=function(e){return wi.prototype.coord.call(this,e)},Ri.prototype.getBBox=function(){var e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]},Ri.prototype.getLink=function(){var e,t=ke.getRoutingData(this),r=t.link;return(r=r?(e=ke.getRoutingProvider(this))&&e.search(t.link):r)||null},Ri);function Ri(e,t){return wi.call(this,e,t)||this}var Oi,Fi=(t(Ni,Oi=vt),Ni.prototype.createRoutingPoint=function(){ke.getRoutingData(this).link||(ke.connect(this),ke.getRoutingData(this).link&&ke.markAsModified(this))},Ni.prototype.removeRoutingPoint=function(){ke.getRoutingData(this).link&&(ke.disconnect(this),ke.markAsModified(this))},Ni.prototype.prop=function(e,t){var r,i=this,o=arguments.length,n=i.getProvider().getFeatureProperties(i),s=!1;if(!o||1==o&&"string"==typeof e)return null!=(e=e?n[e]:n)&&"object"==typeof e?I.JSUtils.extend(!0,new e.constructor,e):e;for(r in 2==o&&((o={})[e]=t,e=o),e){var a=e[r],c="object"==typeof a,l=n[r];(c&&JSON.stringify(a)!=JSON.stringify(l)||!c&&l!==a)&&(s||(i._e().objects.history.origin(i),s=!0),n[r]=a)}ke.getRoutingData(i).link?ke.connect(i,null):ke.disconnect(i),s&&(i._e().setStyle(i),ke.markAsModified(i))},Ni);function Ni(e,t){return Oi.call(this,e,t)||this}Fi.prototype.class="PLACE";var Di,Bi,Mi=(t(ji,Di=vt),ji.prototype.prop=function(e,t){var r,i=this,o=!1,n=arguments.length,s=i.getProvider().getFeatureProperties(i);if(!n||1==n&&"string"==typeof e)return null!=(e=e?s[e]:s)&&"object"==typeof e?I.JSUtils.extend(!0,new e.constructor,e):e;for(r in 2==n&&((n={})[e]=t,e=n),e){var a=e[r],c="object"==typeof a,l=s[r];(c&&JSON.stringify(a)!=JSON.stringify(l)||!c&&l!==a)&&(o||(i._e().objects.history.origin(i),o=!0),s[r]=a)}ke.connect(i,null),o&&(i._e().setStyle(i),ke.markAsModified(i))},ji);function ji(){return null!==Di&&Di.apply(this,arguments)||this}Mi.prototype.class="ADDRESS",(ot=Bi=Bi||{}).CROSSING="CROSSING",ot.CROSSING_CANDIDATE="CROSSING_CANDIDATE";var vt="#FFFFFF",ot="#FF0000",Ti={zIndex:0,type:"Line",stroke:ot,strokeWidth:22,strokeLinecap:"round",opacity:.5},Gi={zIndex:1,type:"Line",stroke:vt,strokeWidth:18,strokeLinecap:"round",opacity:.8},Hi={zIndex:2,type:"Line",stroke:"#000000",strokeWidth:14,strokeLinecap:"round",opacity:.8},zi={zIndex:3,type:"Circle",stroke:ot,strokeWidth:1,opacity:.5,radius:12,fill:ot},Ui={zIndex:4,type:"Circle",stroke:vt,strokeWidth:2,opacity:1,radius:10,fill:vt},Ki={zIndex:5,type:"Circle",stroke:vt,radius:3,fill:vt};function Vi(e,t){for(var r=e.coord(),i=0;i<r.length;i++)if(t.x==r[i][0]&&t.y==r[i][1])return i;return y(r,[t.x,t.y])}var Ji=(Yi.prototype.getLinkIndex=function(){var e=this._.x;return Vi(e.link,e.searchPnt)},Yi.prototype.getCandidateIndex=function(){var e=this._.x;return Vi(e.candidate,e.foundPnt||e.searchPnt)},Yi.prototype.getRelatedLink=function(){return this._.x.candidate},Yi.prototype.connect=function(){var e=this.getRelatedLink(),t=this._,r=t.iEdit,i=t.xTest,o=this.getLink();if(!e.id||!o.id||e.editState("removed")||e.editState("modified")>i.createTS||o.editState("removed")||o.editState("modified")>i.createTS)return!1;var n,s,a=this.class==Bi.CROSSING_CANDIDATE,c=this.getCandidateIndex(),t=t.x.foundPnt||t.x.searchPnt,l=[];for(s in a||(n=ct.addShp(o,r.map.clipGeoCoord([t.x,t.y]),null,!0)),n=a?this.getLinkIndex():n,!1!==this.getLinkIndex()&&(a&&o.getConnectedLinks(n).forEach(function(e){ct.markAsModified(e,!1,!1)}),(ct.connectShpToLink(o,n,e,r.map.clipGeoCoord([t.x,t.y]),c,!0).splittedInto||[]).forEach(function(e){null!=e&&l.push(e)})),this.hide(),this)"type"!==s&&(this[s]=void 0);return i.getCrossings({links:l,croLink:o})},Yi.prototype.show=function(){var c=this,l=this,e=l._,d=e.iEdit,p=e.xTest,u=d.objects.overlay,t=e.x.foundPnt||e.x.searchPnt,t=e.set=e.set||function(t,r,e,i){function o(e){return d.listeners.trigger(e,l)}var n=p.cStyles,s=c._.iEdit.getStyle(e)[0].stroke,a=c._.iEdit.getStyle(i)[0].stroke,e=function(e){return u.addPath([[t.x,t.y],[r.x,r.y]],e)},i=function(e,t){return u.addCircle([e.x,e.y],t)};if(s&&a){n=[e(v(v({},Ti),n.connector1)),e(v(v({},Gi),n.connector2)),e(v(v({},Hi),n.connector3)),i(t,v(v({},zi),n.search1)),i(t,v(v(v({},Ui),{fill:s}),n.search2)),i(r,v(v(v({},Ki),{fill:a,stroke:a}),n.found))];return n.forEach(function(e){return e.pointerup=o}),n}}(e.x.searchPnt,t,this.getLink(),this.getRelatedLink());d.objects.overlay.showFeature(t)},Yi.prototype.hide=function(){var e=this._,t=e.set;t&&t.forEach(function(e){e._provider.removeFeature(e)}),e.set=null},Yi.prototype.getLink=function(){return this._.x.link},Yi.prototype.getConnectedLinks=function(){return this.class==Bi.CROSSING_CANDIDATE?this.getLink().getConnectedLinks(this.getLinkIndex()):[]},Yi);function Yi(e,t,r){this._={iEdit:e,xTest:t,x:r};var i=e.map.getPixelCoord(r.cx,r.cy);this.x=i[0],this.y=i[1];var o=r.searchPnt,n=r.foundPnt||o,t=!!r.foundPnt,i=e.display.geoToPixel(o.x,o.y),e=e.display.geoToPixel(n.x,n.y);this.distance=_([i.x,i.y],[e.x,e.y]),this.class=t?Bi.CROSSING_CANDIDATE:Bi.CROSSING,this.type="Feature",this.geometry=t?{type:"LineString",coordinates:[[o.x,o.y],[n.x,n.y]]}:{type:"Point",coordinates:[r.cx,r.cy]}}function Qi(f,r){var a,c,s,i,l,d=this,o=[],n=[],p=!1,u="CROSSING",h=u+"_CANDIDATE";function g(e,t,r,i){var o,n;if(r===l)for(var s in o=e.getConnectedLinks(t,!0),r=[e.id],o)r.push(o[s].link.id);return n=e.coord(),null!=(n=f.objects.getNearestLine(n[t],i,{ignore:r,maxDistance:a,shapeThreshold:c,onlyExsitingShape:p}))&&function(e,t){for(var r in e)if(-1!=t.indexOf(e[r].link.id))return 1}(n.line.getConnectedLinks(n.shpIndex,!0),r)?(r.push(n.line.id),g(e,t,r,i)):n}function v(e,t,r,i){var o=this,n=null,s=i||r;o.candidate=t,o.link=e,o.foundPnt=i,o.searchPnt=r,o.distance=i?_([r.x,r.y],[i.x,i.y]):0,o.cx=(s.x-r.x)/2+r.x,o.cy=(s.y-r.y)/2+r.y,o.getSimplified=function(){return n=n||new Ji(f,d,o)}}function A(p,e,t){var u,r=[],h=p.coord();function i(e){for(var t=!1,r=[],i=function(e,t){for(var r,i=[],o=0;o<e.length-1;o++)for(var n=0;n<t.length-1;n++)(r=m(e[o],e[o+1],t[n],t[n+1],!0))&&(r.s1=o+1,r.s2=n+1,i.push(r));return i}(h,e.coord()),o=0,n=0,s=i.length;o<s-1;n=++o)for(var a,c=i[o];++n<s;)a=i[n],c[0]==a[0]&&c[1]==a[1]&&Math.abs(a.s1-c.s1)<=1&&Math.abs(a.s2-c.s2)<=1&&(i.splice(n--,1),s--);for(o=0;o<i.length;o++){for(var t=!1,l=0,d=void 0;l<u.length;l++)if((d=u[l]).link.id==e.id&&et.isIntersection(f,i[o],d.link.coord()[d.index])){t=!0;break}t||r.push(new v(p,e,{x:i[o][0],y:i[o][1]}))}return r}return p.editState("removed")||(u=p.getConnectedLinks(0,!0).concat(p.getConnectedLinks(h.length-1,!0)),t.forEach(function(e){r=r.concat(i(e))})),r}d.getRelatedLink=function(){return r},d.setRelatedLink=function(e){e&&(i=[r=e])},d.setRelatedLink(r),d.clear=function(){d.createTS=0,n.forEach(function(e){e.hide&&e.hide()}),o.length=0,n.length=0},d.getCrossings=function(e,t){return e=e||{},d.setRelatedLink(t),e.links?e.croLink&&e.links.length&&(i=i.concat(e.links)):(s==e.class&&a==e.maxDistance||(d.createTS=0),d.cStyles=e.styles||{},s=e.class),a=e.maxDistance||f._config.XTestMaxDistance||3,c=f._config.minShapeDistance,(!d.createTS||r.editState("modified")>d.createTS||e.links)&&(d.clear(),o=function(e){var o,n=[];d.createTS=+new Date,(e.length==l?[e]:e).forEach(function(r){var i,e;r.editState("removed")||s&&s!=u&&s!=h||(e=I.geotools.extendBBox(r.getBBox(),a),-1!=(e=(i=f.objects.getInBBox(e,r.getProvider())).indexOf(r))&&i.splice(e,1),s!=h&&(n=n.concat(A(r,0,i))),s!=u&&r.coord().forEach(function(e,t){(o=g(r,t,l,i))&&n.push(new v(r,o.line,{x:e[0],y:e[1],index:t},{x:o.point[0],y:o.point[1],index:o.shpIndex}))}))});for(var t=0,r=void 0;t<(r=n.length);t++)for(;t<--r;)n[t].cx==n[r].cx&&n[t].cy==n[r].cy&&n[t].candidate==n[r].candidate&&0==n[r].distance&&n[r].foundPnt&&n[t].searchPnt.x==n[r].searchPnt.x&&n[t].searchPnt.y==n[r].searchPnt.y&&n.splice(r,1);return n}(i)),n.length=0,o.forEach(function(e,t){n[t]=e.getSimplified()}),n}}function Wi(e){return e.getProvider().readPedestrianOnly(e)}function Zi(e){return e.getProvider().readDirection(e)}function Xi(e,t,r,i){var o=Zi(r);return r.getZLevels()[i]===e.getZLevels()[t]&&("BOTH"==o||(0==i?"START_TO_END":"END_TO_START")==o)}var qi,$i="TURN_RESTRICTION_",eo=(to.prototype.hide=function(){et.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null},to);function to(e,n,s,a,c,t){var r,i,o,l,d,p=e.objects.overlay,u=0==c?1:a.coord().length-2,h=a.coord(),f=h[c].slice(),g=h[u].slice(),v=S(f,g,8e-5),A=(l=r=s,d=i=a,h=o=c,h=(g=u=n).getProvider().readTurnRestriction({link:g,index:l},{link:d,index:h}),Xi(u,r,i,o)?h?"FORBIDDEN":Wi(i)?"PEDESTRIAN":"ALLOWED":"ONEWAY"),y=p.addPath([v,f,t],null,{type:$i+"LINE",sign:$i+A}),m=p.addImage(v,null,{type:$i+A,rotation:-I.geotools.calcBearing(f,v)});this.sign=m,this.line=y,this.overlay=p,this.to=a,this.from=n,et.showDirection(a),p.remove(y),m.pointerenter=function(){p.addFeature(y)},m.pointerleave=function(){p.remove(y)},m.pointerup=function(){Xi(n,s,a,c)&&!Wi(a)&&(e.objects.history.ignore(function(){var e,t,r,i,o;e="ALLOWED"==A,r=s,i=a,o=c,(t=n).getProvider().writeTurnRestriction(e,{index:r,link:t},{index:o,link:i})}),A="ALLOWED"==A?"FORBIDDEN":"ALLOWED",e.objects.history.saveChanges()&&(m.properties.type=$i+A,y.properties.sign=m.properties.type,e.setStyle(m),e.setStyle(y)))}}(ot=qi=qi||{}).BOTH="BOTH",ot.FROM_RN="START_TO_END",ot.TO_RN="END_TO_START";var ro=(io.prototype._hideOrigin=function(){this._origin&&this._overlay.remove(this._origin),this._origin=null},io.prototype._showOrigin=function(e,t){var r=e.coord(),e=0==t?1:r.length-2,e={geometry:{coordinates:S(r[t],r[e],1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:-I.geotools.calcBearing(r[t],r[e])}};this._origin=this._overlay.addFeature(e)},io.prototype.show=function(){var t=this,r=this._l,i=this._i,e=Zi(r),o=0==i?qi.FROM_RN:qi.TO_RN;e!=qi.BOTH&&o==e||Wi(r)||((e=r.getConnectedLinks(i,!0)).length&&this._showOrigin(r,i),this._trs=e.map(function(e){return new eo(r._e(),r,i,e.link,e.index,t._origin.geometry.coordinates)}))},io.prototype.hide=function(){var e,t=this._trs;for(e in t)t[e].hide(),t[e]=null;t.length=0,this._hideOrigin()},io.prototype.isActive=function(){return 0<this._trs.length},io);function io(e,t){var r=this,i=e._e();this._overlay=i.objects.overlay,this._trs=[];var o=function(){r.hide(),i.listeners.remove("_clearOverlay",o)};i.listeners.bind("_clearOverlay",o),this._l=e,this._i=t,this.show()}var oo,no=(so.prototype.destroy=function(){this.overlay.remove(this.points),this.points=null},so);function so(e,t,r,i){var o=t.coord(),n="END_TO_START"==r?180:0,s=[];i||s.push(e.addPoint(o[0].slice(),{type:"NAVLINK_DIRECTION_HINT_A"}),e.addPoint(o[o.length-1].slice(),{type:"NAVLINK_DIRECTION_HINT_B"}));for(var a=0;a<o.length-1;a++){var c=o[a],l=o[a+1],d={type:"BLOCKED"==r?"NAVLINK_DIRECTION_HINT_BLOCKED":"BOTH"==r?"NAVLINK_DIRECTION_HINT_2WAY":"NAVLINK_DIRECTION_HINT_1WAY"};"BLOCKED"!=r&&(d.bearing=n-I.geotools.calcBearing(c,l)),s.push(e.addPoint(p(c,l,.5),d))}this.overlay=e,this.points=s}function ao(e){throw new Error(e)}var co,lo=(t(po,co=ft),po.prototype.coord=function(e){return co.prototype.coord.call(this,e)},po.prototype.checkCrossings=function(e){var t=et.private(this),r=t.xt||new Qi(this._e(),this);return(t.xt=r).getCrossings(e)},po.prototype.showDirectionHint=function(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;var r=et.private(this),i=r.dh;i&&i.destroy(),r.dh=e&&new no(this._e().objects.overlay,this,e,t)},po.prototype.addShape=function(e,t){var r=!1,e=this._e().map.getGeoCoord(e);return e?!1!==(r=et.addShp(this,e,t,oo,!0))&&et.markAsModified(this):ao("Invalid coordinate"),r},po.prototype.getConnectedLinks=function(e,t){void 0===t&&(t=!1);var r,i,o=this,n=o._e(),s=o.coord(),a=s[e],c=[];if(0==e||e==s.length-1)for(var l=0,d=n.objects.getInBBox(o.bbox,o.getProvider());l<d.length;l++){var p=d[l];p.id!=o.id&&"NAVLINK"==p.class&&(i=(r=p.coord()).length-1,null!=(e=et.isIntersection(n,r[0],a)?0:et.isIntersection(n,r[i],a)?i:null)&&c.push(t?{index:e,link:p}:p))}return c},po.prototype.getZLevels=function(e){var t=this.getProvider().readZLevels(this);return"number"==typeof e?t[e]:t.slice(0)},po.prototype.setZLevels=function(e){var t=this,r=t.getZLevels(),i=t._e().objects.history,o=t.geometry.coordinates.length;e instanceof Array||ao("Invalid 'zlevel' argument given, no array"),e.length!==o&&ao("Given 'zlevel' argument is of an invalid size, a length of "+o+" is required!"),i.origin(t);for(var n,s=!1,a=0;a<e.length;a++)(n=0^e[a])!=r[a]&&(e[a]=n,s=!0);s&&(i.ignore(function(){t.getProvider().writeZLevels(t,e)}),et.refreshGeometry(this),et.markAsModified(this))},po.prototype.editTurnRestrictions=function(e){var t=this,r=t.coord(),i=t._e(),r=0==e||e==r.length-1?[e]:e===oo?[0,r.length-1]:[];i.listeners.trigger("_clearOverlay");r=r.map(function(e){return new ro(t,e)});return e===oo?r:r[0]},po.prototype.prop=function(e,t){var r=this,i=r._e(),o=!1,n=arguments.length,s=r.getProvider().getFeatureProperties(r);if(0==n||1==n&&"string"==typeof e){var a=e?s[e]:s;return"object"==typeof a?I.JSUtils.extend(!0,new a.constructor,a):a}var c,l=e;for(c in 2==n&&((n={})[e]=t,l=n),l){var d=l[c],p="object"==typeof d,u=s[c];(p&&JSON.stringify(d)!=JSON.stringify(u)||!p&&u!==d)&&(o||(i.objects.history.origin(r),o=!0),s[c]=d)}o&&(i.setStyle(r),r.editState("selected")&&et.showDirection(r),et.markAsModified(r))},po);function po(){var t=null!==co&&co.apply(this,arguments)||this;return t.setGeoFence=function(e){(isNaN(e)||e<0)&&ao("Geofence radius should be a positive Number"),t._e()._config.geoFence=+e},t}lo.prototype.class="NAVLINK";var uo,ho=(t(fo,uo=ft),fo.prototype.addShape=function(e,t){e=this._e().map.getGeoCoord(e);return e?((t=ae.addCoord(this,e,t))&&ae.markAsModified(this),t):(function(e){throw new Error(e)}("Invalid coordinate"),!1)},fo.prototype.coord=function(e){return uo.prototype.coord.call(this,e)},fo);function fo(){return null!==uo&&uo.apply(this,arguments)||this}ho.prototype.class="LINE";function go(e){for(var t,r=[],i=0;i<e.length;i++)for(var o=e[i],n=r[r.length]=[],s=0;s<o.length;s++)n[s]=3==(t=o[s]).length?[t[0],t[1],t[2]]:[t[0],t[1]];return r}var vo,Ao={snapCoordinates:!0},yo=(t(mo,vo=ft),mo.prototype.addShape=function(e,t,r){var i=!1,o=this._e().map.getGeoCoord(e);return e?(1==arguments.length&&(t=V.getPoly(this,o)),!1!==(i=V.addShp(this,o,0^t,0,r))&&V.markAsModified(this)):function(e){throw new Error(e)}("Invalid coordinate"),i},mo.prototype.addHole=function(e){var t=this;if(e){e=this._e().map.getPixelCoord(e);for(var r=this,i=V.getPoly(r,e),o=V.getCoords(r),n=o[i],s=1/0,a=0;a<n.length;a++){var c=V.getMaxSpace(r,e,n[a]);c<s&&(s=c)}if(s!=1/0&&8<(s=Math.floor(.5*s))){var l=e[0],i=e[1],i=[[l-s,i+s],[l+s,i+s],[l+s,i-s],[l-s,i-s],[l-s,i+s]].map(function(e){return t._e().map.getGeoCoord(e)});return V.isClockwise(n[0])||i.reverse(),n.push(i),V._setCoords(r,o,!0),V.markAsModified(r),!0}return!1}},mo.prototype.behavior=function(e,t){var r=V.private(this,"b")||v({},Ao);switch(arguments.length){case 0:return r;case 1:if("string"==typeof e)return r[e];r=v(v({},r),e);break;case 2:r[e]=t}this.__.b=r},mo.prototype.coord=function(e){var t=this,r=t.geometry.type;if(e instanceof Array)V.deHighlight(t),V._setCoords(t,e),V.markAsModified(t);else if(e=t.getProvider().decCoord(t),"Polygon"==r)i=go(e);else for(var i=[],o=0;o<e.length;o++)i[o]=go(e[o]);return i},mo);function mo(){return null!==vo&&vo.apply(this,arguments)||this}yo.prototype.class="AREA";var So,_o=(t(ko,So=ft),ko);function ko(){return null!==So&&So.apply(this,arguments)||this}_o.prototype.class="MARKER";for(var xo,Co={NAVLINK:"Navlink",AREA:"Area",PLACE:"Place",ADDRESS:"Address",MARKER:"Marker",LINE:"Line"},ot=function(){var e,t={};for(e in Co)t[Co[e]]=function(o){var n=function(e){if("number"==typeof(e.x!=xo?e.x:e.longitude!=xo?e.longitude:e[0]))return e;for(var t=[],r=0,i=e;r<i.length;r++){var o=i[r];t[t.length]=n(o)}return t};function e(e,t,r){var i=this;"number"!=typeof e&&"string"!=typeof e?(r=t,t=e):i.id=e,i.type="Feature",i.class=o,i.properties=I.JSUtils.extend({"@ns:com:here:editor":new dt},r||{}),i.geometry={type:"PLACE"==o||"ADDRESS"==o||"MARKER"==o?"Point":"AREA"==o?"MultiPolygon":"LineString",coordinates:n(t)}}return e.prototype=ft.prototype,e}(e);return t}(),bo="here.xyz.maps.editor".split("."),Lo=I.global,Eo=0;Eo<bo.length-1;Eo++)Lo=Lo[bo[Eo]]=Lo[bo[Eo]]||{};vt=Lo[bo.pop()]={Editor:pt,features:ot,PixelCoordinate:function(e,t,r){this.x=e,this.y=t,this.z=r||0},GeoCoordinate:function(e,t,r){this.longitude=e,this.latitude=t,this.z=r||0}};I.global.here.xyz.maps.providers.EditableFeatureProvider.prototype.getFeatureClass=function(e){switch(this.detectFeatureClass(e)){case"NAVLINK":return lo;case"PLACE":return Fi;case"ADDRESS":return Mi;case"AREA":return yo;case"MARKER":return _o;case"LINE":return ho;default:return this.Feature}},e.Address=Mi,e.Area=yo,e.AreaShape=d,e.Crossing=Ji,e.DefaultEditorProperties=dt,e.Editor=pt,e.EditorEvent=At,e.Feature=ft,e.Line=ho,e.LineShape=J,e.Marker=_o,e.Navlink=lo,e.NavlinkShape=Me,e.Place=Fi,e.default=vt,e.features=ot,Object.defineProperty(e,"__esModule",{value:!0})});
